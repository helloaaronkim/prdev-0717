<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<meta name="author" content="Mule runtime 4.4">
<title>Anypoint Platform Development: Production-Ready Development Practices - Student Manual</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: #fff; color: #222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: black; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00A1DF; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #000000; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Verdana, "Helvetica Neue", Helvetica, Arial, sans-serif; font-weight: 400; font-style: normal; color: #00A1DF; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.6125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #414042; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #ddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: black; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 0; }
ul.no-bullet, ol.no-bullet { margin-left: 0; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #ddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #ddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #1ba3e1; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #1ba3e1; }

blockquote, blockquote p { line-height: 1.6; color: #00A1DF; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #ddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.8; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: #fff; margin-bottom: 1.25em; border: solid 1px #ddd; }
table thead, table tfoot { background: #f5f5f5; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

body { tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.8; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 0; line-height: inherit; }

pre, pre > code { line-height: 1.6; color: #333; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

.keyseq { color: #333333; }

kbd { font-family: Consolas, "Liberation Mono", Courier, monospace; display: inline-block; color: black; font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: #000; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #ddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #ddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #1ba3e1; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #00A1DF; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #00A1DF; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: #000; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 0 solid #eee; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Verdana, "Helvetica Neue", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: black; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f5f5f5; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #eee; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #eee; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: gainsboro; margin-bottom: 1.25em; padding: 1.25em; background: #f5f5f5; -webkit-border-radius: 3px; border-radius: 3px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 0 solid #eee; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #00A1DF; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #0d516f; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: #000; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Verdana, "Helvetica Neue", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #ddd; color: #1ba3e1; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #d5d5d5; margin-bottom: 1.25em; padding: 1.25em; background: #eee; -webkit-border-radius: 3px; border-radius: 3px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: gainsboro; margin-bottom: 1.25em; padding: 1.25em; background: #f5f5f5; -webkit-border-radius: 3px; border-radius: 3px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: black; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #f8f8f8; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; word-wrap: break-word; padding: 0.75em 0.75em 0.625em 0.75em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #f8f8f8; background-color: #333; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.75em 0.75em 0.625em 0.75em; -webkit-border-radius: 3px; border-radius: 3px; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.6; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #ddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 0.75em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #00A1DF; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: black; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #1ba3e1; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 0.75em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #00A1DF; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: #1ba3e1; }

.quoteblock.abstract { margin: 0 0 0.75em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #ddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: #f5f5f5; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 0.25em; }

ul li ol { margin-left: 0; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1em; font-size: 0.85em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { width: 1em; position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 0.75em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px #fff; -webkit-box-shadow: 0 0 0 1px #ddd; box-shadow: 0 0 0 1px #ddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.05em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: black; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

body { font-family: Verdana, Georgia, "Times New Roman", Times, serif; padding-top: 5em; padding-bottom: 5em; }
body h1, body h2 { color: #00A1DF; }
body h3, body #toctitle, body .sidebarblock > .content > .title, body h4, body h5, body h6 { color: #1784bd; }

#header, #content { background-color: #fff; -moz-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); -webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); }

#content { -moz-border-radius: 0 0 6px 6px; -webkit-border-radius: 0; border-radius: 0 0 6px 6px; }

#header { background: url('images/MuleSoft_logo_299C.png'); -moz-border-radius: 6px 6px 0 0; -webkit-border-radius: 6px; border-radius: 6px 6px 0 0; margin-top: 2em; margin-bottom: 0; padding-bottom: 0.625em; padding-top: 300px; padding-bottom: 100px; background-size: 733px 216px; background-repeat: no-repeat; background-position: center top; }

#footer-text { text-align: center; }

#toc { margin-top: 2em; }

#toctitle { color: #00A1DF; }

.imageblock > .content { text-align: center; }
.imageblock > .title { text-align: center; font-style: italic; font-weight: normal; color: black; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Anypoint Platform Development: Production-Ready Development Practices - Student Manual</h1>
<div class="details">
<span id="author" class="author">Mule runtime 4.4</span><br>
<span id="revdate">May 17, 2023</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#module-welcome">Introducing the course</a>
<ul class="sectlevel2">
<li><a href="#course-goals">Course goals and objectives</a></li>
<li><a href="#_product_component_and_tool_inventory">Product, component, and tool inventory</a></li>
<li><a href="#wt-begin-0">Walkthrough: Set up your development environment</a></li>
<li><a href="#_how_to_install_a_walkthrough_solution_project">How to install a walkthrough solution project</a></li>
<li><a href="#module-case-study">Introducing the AnyAirline case study</a></li>
</ul>
</li>
<li><a href="#module-exposing-apis">Module 1: Provisioning API-related artifacts</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-111">Walkthrough 1-1: Export, import, and publish an API specification and manage an API instance in Anypoint Platform</a></li>
<li><a href="#wt-begin-112">Walkthrough 1-2: Implement an HTTPs API</a></li>
</ul>
</li>
<li><a href="#module-software-principles">Module 2: Applying basic software engineering principles</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-121">Walkthrough 2-1: Apply and follow coding conventions</a></li>
<li><a href="#wt-begin-122">Walkthrough 2-2: Remove redundancy</a></li>
<li><a href="#wt-begin-123">Walkthrough 2-3: Build and deploy Mule applications with Maven</a></li>
<li><a href="#wt-begin-124">Walkthrough 2-4: Configure secure environment properties</a></li>
</ul>
</li>
<li><a href="#module-operational-concerns">Module 3: Developing for Operational Concerns</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-131">Walkthrough 3-1: Implement operational logging</a></li>
<li><a href="#wt-begin-132">Walkthrough 3-2: Expose and monitor health check endpoints</a></li>
<li><a href="#wt-begin-133">Walkthrough 3-3: Extract reusable Mule app code into a library</a></li>
</ul>
</li>
<li><a href="#module-munit">Module 4: Automating unit-testing with MUnit</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-141">Walkthrough 4-1: Enable MUnit</a></li>
<li><a href="#wt-begin-142">Walkthrough 4-2: Perform basic unit testing</a></li>
<li><a href="#wt-begin-143">Walkthrough 4-3: Mock and spy external dependencies</a></li>
<li><a href="#wt-begin-144">Walkthrough 4-4: Automate the creation of MUnit Tests using MUnit Test Recorder</a></li>
</ul>
</li>
<li><a href="#module-coding-conventions">Appendix A: Coding conventions</a>
<ul class="sectlevel2">
<li><a href="#_general">A.1. General</a></li>
<li><a href="#_raml_definitions_and_api_designer_projects">A.2. RAML definitions and API Designer projects</a></li>
<li><a href="#_mule_apps">A.3. Mule apps</a></li>
<li><a href="#_cloudhub_deployments">A.4. CloudHub deployments</a></li>
<li><a href="#_api_manager">A.5. API Manager</a></li>
<li><a href="#_functional_monitors">A.6. Functional Monitors</a></li>
<li><a href="#_anypoint_mq">A.7. Anypoint MQ</a></li>
</ul>
</li>
<li><a href="#module-bibliography">Bibliography</a></li>
<li><a href="#module-colophon">Version history</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="module-welcome"><a class="anchor" href="#module-welcome"></a><a class="link" href="#module-welcome">Introducing the course</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This course is for developers who have already internalized the basics of creating Mule apps with Studio and Anypoint Platform and now want to apply these skills in the context of professional software development projects, creating production-ready Mule apps.</p>
</div>
<div class="paragraph">
<p>In this course, students focus on configuration, build, test, and deployment of Mule apps following these themes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automation with Maven-based tooling of build, unit-test and deployment of Mule apps.</p>
</li>
<li>
<p>Full lifecycle, multi-environment configuration and deployment.</p>
</li>
<li>
<p>Unit-testing with MUnit.</p>
</li>
<li>
<p>Security: data protection at rest (in Mule app configuration files and Runtime Manager) and in transit (using HTTPS).</p>
</li>
<li>
<p>Monitoring and observability of Mule apps through health checks and operational logging.</p>
</li>
<li>
<p>Coding standards and naming conventions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In covering these topics, this course teaches the foundations for applying a DevOps mindset to Mule app development projects — but it does not cover DevOps or CI/CD in itself, it only lays the necessary foundation.</p>
</div>
<div class="sect2">
<h3 id="course-goals"><a class="anchor" href="#course-goals"></a><a class="link" href="#course-goals">Course goals and objectives</a></h3>
<div class="paragraph">
<p>At the end of this course, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand and execute the fundamental API-related workflows in Anypoint Platform.</p>
</li>
<li>
<p>Expose APIs from Mule apps over HTTPS.</p>
</li>
<li>
<p>Configure Mule apps succinctly and securely for different deployment environments.</p>
</li>
<li>
<p>Automate, configure, and secure Mule app deployments to CloudHub.</p>
</li>
<li>
<p>Manage complex Maven dependency relationships of Mule apps.</p>
</li>
<li>
<p>Improve operational logging and monitorability of Mule apps.</p>
</li>
<li>
<p>Implement simple reusable libraries of Mule app code.</p>
</li>
<li>
<p>Unit-test successful and erroneous execution of Mule flows with MUnit.</p>
</li>
<li>
<p>Structure MUnit test code and data for reuse and maintainability.</p>
</li>
<li>
<p>Run MUnit tests in Studio and as part of Maven builds.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_product_component_and_tool_inventory"><a class="anchor" href="#_product_component_and_tool_inventory"></a><a class="link" href="#_product_component_and_tool_inventory">Product, component, and tool inventory</a></h3>
<div class="paragraph">
<p>This course uses the following products, components, and tools.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Product, Component, or Tool</th>
<th class="tableblock halign-left valign-top">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anypoint Platform control plane</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MuleSoft-hosted U.S. production version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Studio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.15.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mule runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.4.0-20230522 EE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mule Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.8.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange Mule Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0.18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MUnit and MUnit Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3.16</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">APIkit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.9.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure Configuration Properties module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure Properties tool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tracing module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. MuleSoft products, components, and tools used in this course</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Product, Component or Tool</th>
<th class="tableblock halign-left valign-top">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenJDK 8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Maven</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3 to 3.8.6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maven Resources plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recent</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="course-prerequs"><a class="anchor" href="#course-prerequs"></a><a class="link" href="#course-prerequs">Course prerequisites</a></h4>
<div class="ulist">
<div class="title">Third-party products, components, and tools used in this course</div>
<ul>
<li>
<p><a href="https://training.mulesoft.com/instructor-led-training/apdev-fundamentals4">Anypoint Platform Development: Fundamentals (Mule 4)</a></p>
</li>
<li>
<p>Solid understanding of essential Maven concepts.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.baeldung.com/maven">Apache Maven Tutorial</a></p>
</li>
<li>
<p><a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">Maven in 5 Minutes</a></p>
</li>
<li>
<p><a href="https://maven.apache.org/guides/getting-started/index.html">Maven Getting Started Guide</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_understanding_the_approach_of_this_course"><a class="anchor" href="#_understanding_the_approach_of_this_course"></a><a class="link" href="#_understanding_the_approach_of_this_course">Understanding the approach of this course</a></h4>
<div class="paragraph">
<p>This course uses a case study — AnyAirline — to illustrate the topics it addresses.</p>
</div>
<div class="paragraph">
<p>The course revolves around walkthroughs, which are broken down into sections and steps.
You are expected to follow all walkthroughs in the given order, including all sections and all steps in each section.</p>
</div>
<div class="paragraph">
<p>The course&#8217;s source code distribution contains two source directory trees, one strictly mirroring the walkthroughs, and another for the complete, final solution to the case study, irrespective of any walkthroughs.</p>
</div>
<div class="paragraph">
<p>Each walkthrough step typically specifies <em>what</em> to achieve rather than <em>how</em> to achieve it.
This means, for example, that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API invocations are specified in terms of cURL commands, because this is a succinct, portable, text-only way of doing so. But this does not imply that you must use cURL. Use whatever tool you prefer to send HTTP requests and inspect HTTP responses, such as <a href="https://install.advancedrestclient.com/install">Advanced REST Client</a> or <a href="https://www.getpostman.com/">Postman</a>.</p>
</li>
<li>
<p>File-level operations are expressed in Unix-style and for bash. Again, this is because it is a precise, text-only way of doing so. But you can use any other means of achieving the same result, such as a different Unix shell, the Windows command prompt, or any file explorer on any operating system. The only important thing is that the outcome is the same as when the given bash commands were executed.</p>
</li>
<li>
<p>Editing of file contents that does not require Studio should be done in whatever text editor you prefer. This may well be Studio itself (which embeds capable XML and JSON editors) or any Eclipse plugin installed into Studio.</p>
</li>
<li>
<p>Mule flows are specified by their XML code. This does not mean that code must or should be entered in XML form. Use whatever approach works best for you, including, but not limited to, coding Mule apps entirely in the visual Mule config flow editor, or the Mule config flow XML editor, or a combination thereof, or even outside of Studio in a Mule-agnostic editor (if you really prefer that). All that matters is that the XML code you produce in this fashion is equivalent to the code shown here. Mule flow XML code is also what matters at runtime and what you will typically see when doing code reviews in GitHub and the like. So it is essential to be confident in reading Mule flow XML code.</p>
</li>
<li>
<p>For brevity, Mule flow XML code reproduced here omits doc:name and doc:id attributes and other code elements that have no effect at runtime. Your Mule app code does not have to — and probably should not — omit doc:name, doc:id and similar.</p>
</li>
<li>
<p>For brevity, Mule flow XML code reproduced here omits XML namespace declarations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some walkthrough steps are declared as Homework. These are steps that have already been performed in previous steps or walkthroughs in a similar fashion, so they are repetitive and there is nothing new to learn. Also, these steps are not strictly necessary for the successful continuation of the current and later walkthroughs. On the other hand, in a real-world project, these steps would be performed and, in fact, the walkthrough solutions in the source code distribution do contain the result of performing these steps. You are therefore advised to perform these steps if at all possible.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-0"><a class="anchor" href="#wt-begin-0"></a><a class="link" href="#wt-begin-0">Walkthrough: Set up your development environment</a></h3>
<div class="paragraph">
<p>In this walkthrough, you set up the local development environment you will use throughout class. It is essential that your development environment conforms in all aspects to the outcome of following this walkthrough.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new <strong>Anypoint Platform trial account</strong> and remember its <strong>username</strong> and <strong>password</strong>.</p>
</li>
<li>
<p>Assign the <strong>Anypoint Monitoring User</strong> and <strong>Visualizer Editor</strong> <strong>permissions</strong> to that Anypoint Platform user.</p>
</li>
<li>
<p>Install a recent build of <strong><a href="https://adoptopenjdk.net">OpenJDK 8</a></strong>, add both the JVM and the compiler to your <strong>path</strong>, and verify the installation from a command-line interface:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">java <span style="color: #b58900">-version</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">javac <span style="color: #b58900">-version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Both these commands must show the exact same build version — otherwise, you will inadvertently be using two different JDK installations.</em></p>
</div>
</div>
</div>
</li>
<li>
<p>Install a recent Maven version (3.6.3 to 3.8.6), add it to your path, and verify the installation from a command-line interface:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This shows the Maven home (installation directory), which you will need shortly for configuring Studio.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This shows the Java version and installation directory used by Maven: The former must once more show the exact same JDK build version as in the previous step, while the latter you will need shortly for configuring Studio.</em></p>
</div>
</div>
</div>
</li>
<li>
<p>Back up and remove your local Maven configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> ~/.m2/
<span style="color: #586e75">mv</span> <span style="color: #b58900">-f</span> settings.xml settings.xml.before-apdevl2
<span style="color: #586e75">mv</span> <span style="color: #b58900">-f</span> repository repository.before-apdevl2</code></pre>
</div>
</div>
</li>
<li>
<p>Install Studio <strong>7.15.0</strong>, the Studio version required for this course, after downloading it from <strong><a href="https://www.mulesoft.com/lp/dl/studio" class="bare">https://www.mulesoft.com/lp/dl/studio</a></strong>.</p>
</li>
<li>
<p>Create a new empty Studio workspace and assign its absolute path to environment variable <strong>APDL2WS</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">export </span><span style="color: #586e75">APDL2WS</span><span style="color: #93a1a1">=</span>/path/to/studio/workspace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bat"><span style="color: #cb4b16">set</span> <span style="color: #cb4b16">APDL2WS</span><span style="color: #93a1a1">=</span><span style="color: #cb4b16">C</span>:\path\to\studio\workspace</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Launch</strong> and <strong>configure</strong> Studio:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the <strong>above workspace</strong>.</p>
</li>
<li>
<p>Select the <strong>above JDK</strong> in Installed JREs, using the JDK (not just JRE) installation directory shown as part of the Maven verification earlier.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Studio 7.15.0 has its own embedded JDK, but you use the one installed earlier for consistency with command-line interface usage.</em></p>
</div>
</li>
<li>
<p>Use the <strong>above Maven</strong> installation by pointing Studio at the Maven home shown earlier, and test it; this must display the same output as the earlier Maven verification from the command-line interface.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Studio has its own embedded Maven, but you use the one installed earlier for consistency with command-line interface usage.</em></p>
</div>
</li>
<li>
<p>Install <strong>Mule runtime 4.4.0 EE</strong> into Studio if it is not already installed; all Studio projects must be created with this version of the Mule runtime.</p>
</li>
<li>
<p>Under XML &gt; <strong>XML Files</strong> &gt; Editor, set line width 140, clear all blank lines, don&#8217;t format comments, don&#8217;t insert white space before closing tag, and indent using two spaces.</p>
</li>
<li>
<p>Authenticate to Anypoint Platform using the <strong>trial account</strong> credentials obtained above.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a new, trivial Mule app project in Studio and run it to confirm your setup is functional. Ensure that this and all future Studio projects use Mule runtime 4.4.0 EE.</p>
</li>
<li>
<p>Install an application for sending HTTP requests and inspecting HTTP responses, such as cURL, <a href="https://install.advancedrestclient.com/install">Advanced REST Client</a>, or <a href="https://www.getpostman.com/">Postman</a>.</p>
</li>
<li>
<p>Install/choose a text editor for editing XML files and the like.</p>
</li>
<li>
<p>Locate your course enrollment email and follow the instructions to download the student files ZIP.</p>
</li>
<li>
<p>Unpack the source code distribution package of this course revision and assign the absolute path of the filesystem directory to environment <strong>variable APDL2DIST</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span>     /path/to/course/directory
unzip  APDevPRDev<span style="color: #6c71c4">*</span>_studentFiles_<span style="color: #6c71c4">*</span>.zip
<span style="color: #586e75">cd     </span>APDevPRDev<span style="color: #6c71c4">*</span>_studentFiles_<span style="color: #6c71c4">*</span>
<span style="color: #586e75">export </span><span style="color: #586e75">APDL2DIST</span><span style="color: #93a1a1">=</span><span style="color: #d33682">$(</span><span style="color: #586e75">pwd</span><span style="color: #d33682">)</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Familiarize yourself with the <strong>source code distribution</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The source code distribution contains two code directory trees, one for the complete, "final" solution to the AnyAirline case study, including all Mule apps, and other artifacts, the other for the solutions and starters for individual walkthroughs, each one relating directly to a walkthrough in this document, and addressing the aspects of the final solution under consideration in that walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Install API Catalog CLI:</strong> In a command-line interface, run the npm install command for API Catalog CLI:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">npm <span style="color: #586e75">install</span> <span style="color: #b58900">-g</span> api-catalog-cli@latest</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If the command is not recognized, install Git and Node.js, then run the install command again.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="wt-end-0"></a>&#160;</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_how_to_install_a_walkthrough_solution_project"><a class="anchor" href="#_how_to_install_a_walkthrough_solution_project"></a><a class="link" href="#_how_to_install_a_walkthrough_solution_project">How to install a walkthrough solution project</a></h3>
<div class="paragraph">
<p>Under $APDL2DIST/walkthroughs, you find individual project directories for the solutions of all walkthroughs and the starters for some walkthroughs.</p>
</div>
<div class="paragraph">
<p>Typically, the solution to one walkthrough is the starter for the next walkthrough — unless a walkthrough has its own, explicit starter projects. When you follow the course from start to finish, you only have to install the explicit starter projects, and this is explained step-by-step as part of the walkthroughs that come with starter projects. However, when you cannot follow a walkthrough, you will typically have to install the solution projects for this walkthrough, so that you can continue with the subsequent walkthrough — unless that subsequent walkthrough has its own explicit starter projects.</p>
</div>
<div class="paragraph">
<p>Follow these steps to install the solution projects for a particular walkthrough — for example, walkthrough 3-1 — into your Studio workspace.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Discover the solution projects and files for the given walkthrough; for example, $APDL2DIST/walkthroughs/devprd/module03/wt3-1_solution has one subdirectory, for check-in-papi, and so walkthrough 3-1 only comprises that one solution project, which captures the state of check-in-papi at the end of walkthrough 3-1. Files such as parent-pom/pom.xml and pom.xml complete the Maven build setup for all solution projects of this walkthrough.</p>
</li>
<li>
<p>Copy all solution projects and files into your Studio workspace:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">mkdir </span>before-wt3-1
<span style="color: #586e75">mv</span> <span style="color: #6c71c4">*</span> before-wt3-1/
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devprd/module02/wt2-5_solution/<span style="color: #6c71c4">*</span> ./</code></pre>
</div>
</div>
</li>
<li>
<p>Edit <strong>pom.xml</strong> in the newly copied project directories, following any <code>students:</code>-instructions in those files.</p>
</li>
<li>
<p>Edit the newly copied <strong>parent-pom/pom.xml</strong>, following any <code>students:</code>-instructions in that file.</p>
</li>
<li>
<p>Install <strong>bom/pom.xml and parent-pom/pom.xml</strong> into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>bom/pom.xml        <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>bom/pom.xml
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Build the solution projects in the required order (if applicable):</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Import the solution projects into Studio, without copying them into the workspace.</p>
</li>
<li>
<p>Create a Studio <strong>run configuration</strong> for the newly imported projects, setting <strong>VM arguments</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345
<span style="color: #b58900">-M-Danypoint</span>.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#160;</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="module-case-study"><a class="anchor" href="#module-case-study"></a><a class="link" href="#module-case-study">Introducing the AnyAirline case study</a></h3>
<div class="paragraph">
<p>AnyAirline is a regional airline and an existing MuleSoft customer. It uses the MuleSoft-hosted Anypoint Platform control plane, and CloudHub to support a mobile app and a few other, ad-hoc integrations.</p>
</div>
<div class="paragraph">
<p>This case study focuses on a small selected number of use cases within this system landscape.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="sect3">
<h4 id="section-requirements"><a class="anchor" href="#section-requirements"></a><a class="link" href="#section-requirements">Requirements</a></h4>
<div class="paragraph">
<p>The following systems are already deployed and functional, and form the immutable system landscape for this project, not to be changed but rather integrated with.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>mobile app:</strong> AnyAirline’s native mobile app, the main strategic driver for this project.</p>
</li>
<li>
<p><strong>PayPal:</strong> For customer/passenger payments.</p>
</li>
<li>
<p><strong>Flights Management system:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Accessible via SOAP web services over mutually authenticated HTTPS.</p>
</li>
<li>
<p>Deployed on-premises in the AnyAirline data center.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Passenger Data system:</strong></p>
<div class="ulist">
<ul>
<li>
<p>In-house legacy PostgreSQL database to be accessed directly.</p>
</li>
<li>
<p>Deployed on-premises in the AnyAirline data center.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Salesforce CRM:</strong> Recently introduced.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_functional_requirements"><a class="anchor" href="#_functional_requirements"></a><a class="link" href="#_functional_requirements">Functional requirements</a></h5>
<div class="sect5">
<h6 id="_terminology"><a class="anchor" href="#_terminology"></a><a class="link" href="#_terminology">Terminology</a></h6>
<div class="ulist">
<ul>
<li>
<p><strong>Record Locator:</strong> A six- or seven-digit <a href="https://en.wikipedia.org/wiki/Record_locator">alphanumeric code that identifies a data record in an airline reservation system</a>, for example, RW4TAB or KZVGX5. The term Record Locator is usually used to refer to a PNR. In this case study we do not make use of the term Record Locator itself.</p>
</li>
<li>
<p><strong>PNR:</strong> <a href="https://en.wikipedia.org/wiki/Passenger_name_record">Passenger Name Record</a> contains personal information about a passenger, as well as their itinerary (for example, flights). For simplicity, in this case study, itineraries consist of only one flight, so that each PNR identifies exactly one passenger and their flight. Furthermore, in this case study, we do not deal with the Passenger Name Records themselves, just with Record Locators identifying those Passenger Name Records. Therefore, in this case study, the term PNR is used to always mean Record Locator referring to a Passenger Name Record.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_actors"><a class="anchor" href="#_actors"></a><a class="link" href="#_actors">Actors</a></h6>
<div class="ulist">
<ul>
<li>
<p><strong>Passenger:</strong> A customer of AnyAirline, in possession of an AnyAirline ticket.</p>
</li>
<li>
<p><strong>Third party check-in partner company:</strong> An external company that partners with AnyAirline to provide third party check-in for AnyAirline passengers.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_user_stories"><a class="anchor" href="#_user_stories"></a><a class="link" href="#_user_stories">User stories</a></h6>
<div class="paragraph">
<p>The following user stories will be designed and implemented in this project.</p>
</div>
<div class="openblock">
<div class="title"><a id="us1"></a>US1: mobile Check-In</div>
<div class="content">
<div class="paragraph">
<p>As a passenger, I want to be able to check in to an AnyAirline flight using the mobile app, by providing my PNR and last name and paying for any baggage using PayPal.</p>
</div>
<div class="paragraph">
<p>Preconditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Passenger holds an AnyAirline ticket and knows its PNR.</p>
</li>
<li>
<p>Passenger has a PayPal account.</p>
</li>
<li>
<p>Passenger has mobile app installed.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="title"><a id="us2"></a>US2: Flight Cancellation mobile Notifications</div>
<div class="content">
<div class="paragraph">
<p>As a passenger, I want to be notified through the mobile app if a flight to which I&#8217;ve checked in is canceled.</p>
</div>
<div class="paragraph">
<p>Preconditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Passenger has checked in to the flight using the mobile app.</p>
</li>
<li>
<p>This flight is canceled.</p>
</li>
<li>
<p>AnyAirline is notified of the flight cancellation by an external party via the Flights Management system.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="title"><a id="us3"></a>US3: Offline Check-In Submissions</div>
<div class="content">
<div class="paragraph">
<p>As a Third party check-in partner company ("company" for short), I want to be able to submit all check-in data that was accumulated while being offline.</p>
</div>
<div class="paragraph">
<p>Context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check-in must continue even if systems are offline due to an outage, so that normal online check-in using AnyAirline’s online systems cannot be performed.</p>
</li>
<li>
<p>After coming online again, the Third party check-in partner company must submit to AnyAirline data about all check-ins performed during the offline period.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Preconditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Company is a known partner of AnyAirline providing, check-in to AnyAirline passengers using AnyAirline online check-in services.</p>
</li>
<li>
<p>Company has suffered an outage so that it can&#8217;t use AnyAirlines' online check-in services.</p>
</li>
<li>
<p>Company has continued checking in passengers while offline.</p>
</li>
<li>
<p>Company has since restored full connectivity.</p>
</li>
<li>
<p>Company now wants to send all check-in data accumulated during the offline period to AnyAirline.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_nonfunctional_requirements"><a class="anchor" href="#_nonfunctional_requirements"></a><a class="link" href="#_nonfunctional_requirements">Nonfunctional requirements</a></h5>
<div class="paragraph">
<p>This is a small subset of nonfunctional requirements, namely those that are directly relevant to this project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>NFR1:</strong> Application components interacting directly with on-premises systems (Flights Management system, Passenger Data system) must be deployed on-premises in the AnyAirline data center. This applies, for example, to System APIs.</p>
</li>
<li>
<p><strong>NFR2:</strong> All application components interacting only with cloud-hosted systems (PayPal, Salesforce CRM) or APIs must be deployed to CloudHub 2.0.</p>
</li>
<li>
<p><strong>NFR3:</strong> All data must be encrypted in flight (for example, using HTTPS).</p>
</li>
<li>
<p><strong>NFR4:</strong> API-led connectivity should be followed unless performance considerations suggest otherwise.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect3">
<h4 id="section-aa-solution-arch"><a class="anchor" href="#section-aa-solution-arch"></a><a class="link" href="#section-aa-solution-arch">Solution architecture</a></h4>
<div class="paragraph">
<p>Abbreviations used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAPI for System API</p>
</li>
<li>
<p>PAPI for Process API</p>
</li>
<li>
<p>EAPI for Experience API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please note that, for the purpose of simplicity, this section does not differentiate between an API and its API implementation. For example, Flights Management SAPI is used to denote both the REST API — defined via a RAML definition or OpenAPI definition — as well as the Mule app implementing and exposing that REST API. (However, later sections will differentiate; for example, the API implementation of Flights Management SAPI will be called flights-management-sapi.)</p>
</div>
<div class="sect4">
<h5 id="aa-high-level-arch"><a class="anchor" href="#aa-high-level-arch"></a><a class="link" href="#aa-high-level-arch">High-level architecture</a></h5>
<div class="paragraph">
<p>The following diagram gives an overview of the relevant components and artifacts for this project, and where they interact to realize the use cases of this project. Deployment aspects of this diagram describe the production environment.</p>
</div>
<div id="img-case-study-sketch" class="imageblock">
<div class="content">
<img src="./images/case-study-sketch.png" alt="case study sketch" width="100%">
</div>
<div class="title">Figure 1. Components and artifacts under design and development in this project (yellow and blue), to be integrated with but not changed (grey), or out-of-scope for this project (transparent). A static view of all interactions between these components and artifacts is shown by arrows pointing from active to passive participant in the interaction. Dotted arrows signify interactions not directly addressed in this project. Deployment asepcts are for the production environment.</div>
</div>
</div>
<div class="sect4">
<h5 id="_user_story_realizations"><a class="anchor" href="#_user_story_realizations"></a><a class="link" href="#_user_story_realizations">User story realizations</a></h5>
<div class="sect5">
<h6 id="aa-us1-realization"><a class="anchor" href="#aa-us1-realization"></a><a class="link" href="#aa-us1-realization">US1: mobile Check-In</a></h6>
<div class="openblock">
<div class="title"><a id="us1-overview"></a>Overview</div>
<div class="content">
<div class="paragraph">
<p>The following diagram explains on a high level of detail the business process underlying US1: mobile Check-In.</p>
</div>
<div id="img-check-in-process" class="imageblock">
<div class="content">
<img src="./images/check-in-process.png" alt="check in process" width="100%">
</div>
<div class="title">Figure 2. Flowchart visualizing the process by which US1: mobile Check-In is to be realized on a high level. Processing steps and decisions that do not require human interaction are shown as rectangles and rhombi, respectively.</div>
</div>
</div>
</div>
<div id="pp-payments" class="openblock">
<div class="title"><a id="pp-payments"></a>PayPal payments</div>
<div class="content">
<div class="paragraph">
<p>Payments are implemented via PayPal. This affects and is visible to the API implementations processing payments, the mobile app, and the passenger.</p>
</div>
<div class="paragraph">
<p>Integration with PayPal as designed here uses v1 of the PayPal REST API, which is deprecated as of early 2019.</p>
</div>
<div class="paragraph">
<p>The general approach for integrating with PayPal is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the PayPal v1 REST APIs from the PayPal SAPI to first <a href="https://developer.paypal.com/docs/api/payments/v1/#payment_create">create a PayPal payment</a> and then, after approval by the passenger, to <a href="https://developer.paypal.com/docs/api/payments/v1/#payment_execute">execute that PayPal payment</a>.</p>
</li>
<li>
<p>Use the web-based <a href="https://developer.paypal.com/docs/checkout/how-to/server-integration/#1-set-up-your-client-to-call-your-server">PayPal Check-Out Button</a> from the mobile app to allow the passenger to <a href="https://developer.paypal.com/docs/integration/direct/payments/paypal-payments/#get-payment-approval">approve</a> a previously created PayPal payment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specifically, a PayPal payment must first be created by PayPal SAPI via a PayPal REST API invocation. The Payment ID created in the process by PayPal must then be used in the mobile app to present the passenger with a UI to approve that payment. In approving the payment, PayPal identifies the payer and hands its Payer ID to the mobile app. Finally, to execute a PayPal payment, PayPal SAPI must pass both the Payment ID and the Payer ID to PayPal in a PayPal REST API invocation.</p>
</div>
<div class="paragraph">
<p>Authentication of PayPal API clients follows the <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0 client credentials grant type</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At development time, a PayPal app representing the PayPal API client, which is PayPal SAPI, must be created or egistered with PayPal. In the process, PayPal generates a pair of client ID and secret for PayPal SAPI, for both the PayPal Sandbox and Production environments.</p>
</li>
<li>
<p>At runtime, client ID and secret must be <a href="https://developer.paypal.com/reference/get-an-access-token/">exchanged for a temporary bearer access token</a>. All further PayPal REST API invocations must then <a href="https://developer.paypal.com/docs/api/overview/#make-rest-api-calls">present that bearer access token</a> in the HTTP Authorization header. This process must be repeated once the bearer access token has expired.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="openblock">
<div class="title"><a id="detailed-interactions"></a>Detailed component interactions</div>
<div class="content">
<div class="paragraph">
<p>The following diagram shows how US1: mobile Check-In is realized through the interaction of all relevant components in the case where payment for bags needs to be made. In the case where there are no bags and no payment, the interaction simplifies accordingly.</p>
</div>
<div id="img-check-in" class="imageblock">
<div class="content">
<img src="./images/check-in.svg" alt="check in" width="100%">
</div>
<div class="title">Figure 3. Sequence diagram visualizing the detailed interaction of components in the realization of US1: mobile Check-In. The depicted case is when the number of bags is positive and hence payment needs to be collected.</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="aa-us2-realization"><a class="anchor" href="#aa-us2-realization"></a><a class="link" href="#aa-us2-realization">US2: Flight Cancellation mobile Notifications</a></h6>
<div class="paragraph">
<p>From AnyAirline’s perspective, flight cancellations materialize from outside of AnyAirline in the Flights Management system.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SOAP clients to the Flights Management system, such as Flights Management SAPI, can register an HTTP callback (webhook), which will then be invoked by the Flights Management system when a flight cancellation occurs. That registration should occur at startup of Flights Management SAPI (duplicate registrations are ignored).</p>
</li>
<li>
<p>The HTTP callback delivers cancellation notifications from the Flights Management system to Flights Management SAPI in the form of a HTTP POST requests from the former to the latter.</p>
</li>
<li>
<p>One cancellation notification for each previously successful check-in, now affected by the cancellation, is sent per HTTP POST request. Each cancellation notification contains the PNR and last name of the passenger in XML format:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;CancellationNotification&gt;</span>
  <span style="color: #b58900">&lt;PNR&gt;</span>PNR123<span style="color: #b58900">&lt;/PNR&gt;</span>
  <span style="color: #b58900">&lt;PassengerLastName&gt;</span>Mule<span style="color: #b58900">&lt;/PassengerLastName&gt;</span>
<span style="color: #b58900">&lt;/CancellationNotification&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Flights Management SAPI uses the reliability pattern to accept a cancellation notification and immediately publish it onto a persistent VM queue. Then, asynchronously — in an XA transaction if supported by the message broker — the System API unqueues the notification, transforms it to a backend-neutral flight canceled event and publishes that event to an Anypoint MQ exchange (or, potentially, a JMS topic). A flight canceled event is JSON-formatted:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="json"><span style="color: #93a1a1">{</span><span style="color: #586e75">
 </span><span style="color: #586e75">"pnr"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"RW4TAB"</span><span style="color: #93a1a1">,</span><span style="color: #586e75">
 </span><span style="color: #586e75">"lastNameOfPassenger"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"Smith"</span><span style="color: #586e75">
</span><span style="color: #93a1a1">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Because the HTTP callback processes cancellation notifications asynchronously rather than synchronously, it returns a HTTP 202 ACCEPTED rather than a 200 OK response code to the Flights Management system, to inform it of that fact.</p>
</li>
<li>
<p>flight canceled events are then delivered via publish-subscribe messaging to an Experience-layer mobile app, mobile Notifications EApp, which delivers them to the mobile app via native mobile notifications (such as Apple’s APNs).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The component interactions to realize the first part of these steps, up to the publishing of flight canceled events to the Anypoint MQ exchange, are shown in the following sequence diagram.</p>
</div>
<div id="img-notifications-callbacks" class="imageblock">
<div class="content">
<img src="./images/notifications-callbacks.svg" alt="notifications callbacks" width="100%">
</div>
<div class="title">Figure 4. Sequence diagram visualizing the first part of the realization of US2: Flight Cancellation mobile Notifications: the registration of Flights Management SAPI with the Flights Management system to receive cancellation notifications, the delivery and transformation of cancellation notifications to flight canceled events, and the publishing of the latter to an Anypoint MQ exchange.</div>
</div>
</div>
<div class="sect5">
<h6 id="aa-us3-realization"><a class="anchor" href="#aa-us3-realization"></a><a class="link" href="#aa-us3-realization">US3: Offline Check-In Submissions</a></h6>
<div class="paragraph">
<p>Offline Check-In Submission Handler has a similar role to Check-In PAPI, with the difference that the former:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Processes batches of check-ins submitted in a flat file,</p>
</li>
<li>
<p>Does not deal with payments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Files are submitted per SFTP and are in CSV format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each submissions file contains zero to arbitrary many (typically tens of thousands) of records with one record on each line.</p>
</li>
<li>
<p>Each record contains data about a passenger’s check-in.</p>
</li>
<li>
<p>Each record is independent of all other records. There is no need to deal with records that pertain to duplicate check-ins of the same passenger to the same flight.</p>
</li>
<li>
<p>Each record must be individually passed to Flights Management SAPI via an API invocation, similar to what Check-In PAPI does.</p>
</li>
<li>
<p>Batches of records must be inserted into the Passenger Data system, similar to what Passenger Data SAPI does (but in batches, for efficiency).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="aa-deployment"><a class="anchor" href="#aa-deployment"></a><a class="link" href="#aa-deployment">Deployment</a></h5>
<div class="paragraph">
<p>All Mule apps are deployed to CloudHub 2.0 in the shared space in usa-e1 (N. Virginia) or usa-e2 (Ohio) under the control of the MuleSoft-hosted Anypoint Platform control plane in the U.S.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-exposing-apis"><a class="anchor" href="#module-exposing-apis"></a><a class="link" href="#module-exposing-apis">Module 1: Provisioning API-related artifacts</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you use the Anypoint Platform web UI and Studio <a href="#Ref9">[Ref9]</a> to create and configure all fundamental artifacts for exposing an API over HTTPS from a Mule app.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recap the fundamental API-related workflows in Anypoint Platform.</p>
</li>
<li>
<p>Export, import, and publish an API specification.</p>
</li>
<li>
<p>Manage an API instance in API Manager.</p>
</li>
<li>
<p>Implement an API as a Mule app.</p>
</li>
<li>
<p>Expose an HTTPS endpoint from a Mule app.</p>
</li>
<li>
<p>Register an API implementation using autodiscovery.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-111"><a class="anchor" href="#wt-begin-111"></a><a class="link" href="#wt-begin-111">Walkthrough 1-1: Export, import, and publish an API specification and manage an API instance in Anypoint Platform</a></h3>
<div class="paragraph">
<p>In this walkthrough, you create the basic API-related artifacts for Check-In PAPI in Exchange <a href="#Ref4">[Ref4]</a>, and API Manager <a href="#Ref3">[Ref3]</a>. This is a prerequisite for implementing this API in a later walkthrough. Instead of creating the API specification from scratch you export it from the <a href="https://anypoint.mulesoft.com/exchange/portals/anyairline/">AnyAirline public developer portal</a> <a href="#Ref4">[Ref4]</a> and publish it to Exchange using the API Catalog CLI.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_export_an_api_specification_in_oas_format_from_a_public_developer_portal">Export the Simplified Check-In PAPI API specification in OpenAPI Specification (OAS) format from the <a href="https://anypoint.mulesoft.com/exchange/portals/anyairline/">AnyAirline public developer portal</a></a>.</p>
</li>
<li>
<p><a href="#_modify_the_api_specification_and_prepare_it_for_publishing">Modify the API specification and prepare it for publishing</a>.</p>
</li>
<li>
<p><a href="#_publish_the_api_specification_to_exchange">Publish the Check-In PAPI API specification to Exchange</a>.</p>
</li>
<li>
<p><a href="#_create_anypoint_platform_environments_for_the_complete_software_development_lifecycle">Create Anypoint Platform environments for dev, test, and prod</a>.</p>
</li>
<li>
<p><a href="#_apply_an_automated_policy_for_logging">Apply an automated policy for logging</a>.</p>
</li>
<li>
<p><a href="#_create_an_api_instance_in_api_manager">Create an API instance for Check-In PAPI in API Manager</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_export_an_api_specification_in_oas_format_from_a_public_developer_portal"><a class="anchor" href="#_export_an_api_specification_in_oas_format_from_a_public_developer_portal"></a><a class="link" href="#_export_an_api_specification_in_oas_format_from_a_public_developer_portal">Export an API specification in OAS format from a public developer portal</a></h4>
<div class="paragraph">
<p>In this section, you export the Simplified Check-In PAPI API specification from the <a href="https://anypoint.mulesoft.com/exchange/portals/anyairline/">AnyAirline public developer portal</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Browse to API specification:</strong> In the <a href="https://anypoint.mulesoft.com/exchange/portals/anyairline/">AnyAirline public developer portal</a> at <strong><a href="https://anypoint.mulesoft.com/exchange/portals/anyairline/" class="bare">https://anypoint.mulesoft.com/exchange/portals/anyairline/</a></strong> locate <strong>Simplified Check-In PAPI</strong>.</p>
</li>
<li>
<p><strong>Download API specification:</strong> From the main page of the Simplified Check-In PAPI entry, download the API specification as <strong>OAS</strong>; this should download a zip file.</p>
<div class="paragraph">
<p><em>Note:</em> <em>The Simplified Check-In PAPI API specification was originally defined in RAML, so the OAS version is annotated as generated.</em></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_modify_the_api_specification_and_prepare_it_for_publishing"><a class="anchor" href="#_modify_the_api_specification_and_prepare_it_for_publishing"></a><a class="link" href="#_modify_the_api_specification_and_prepare_it_for_publishing">Modify the API specification and prepare it for publishing</a></h4>
<div class="paragraph">
<p>In this section, you adapt the Check-In PAPI API specification for your organization and prepare to publish the API specification using the API Catalog CLI.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Extract API specification:</strong> Unpack the API specification package to a directory of your choosing:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">mkdir </span>check-in-papi-spec
unzip simplified-check-in-papi-1.0.2-oas.zip <span style="color: #b58900">-d</span> check-in-papi-spec</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Personalize Spec:</strong> In a text editor, change the endpoint so that the CloudHub 2.0 <strong>region</strong> sub-domain is <strong>usa-e2 (Ohio)</strong> and it includes a temporary placeholder for a unique id and shard to the application name so that the URL resembles <a href="https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1" class="bare">https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1</a> and change the API title to Check-In PAPI:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="json"><span style="color: #93a1a1">{</span><span style="color: #586e75">
  </span><span style="color: #586e75">"swagger"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"2.0"</span><span style="color: #93a1a1">,</span><span style="color: #586e75">
  </span><span style="color: #586e75">"info"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #93a1a1">{</span><span style="color: #586e75">
    </span><span style="color: #586e75">"title"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"Check-In PAPI"</span><span style="color: #586e75">
  </span><span style="color: #93a1a1">},</span><span style="color: #586e75">
  </span><span style="color: #586e75">"host"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"check-in-papi-uniqid.shard.usa-e2.cloudhub.io"</span><span style="color: #586e75">
</span><span style="color: #93a1a1">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The uniqid and shard in the URL is just a placeholder for now. The complete URL with the unique id for your application will be generated once you deploy to CloudHub 2.0 in a later walkthrough. You will update this value later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By convention, the endpoint URL stated in an API specification is understood to refer to the production deployment of the API and its implementation.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>CloudHub trial accounts can only deploy to usa-e2 (Ohio).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Verify you have the API Catalog CLI installed:</strong> In a command-line interface, run the API Catalog CLI help command:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">api-catalog</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Installing API Catalog CLI is a part of the class setup guide steps. If the command is not recognized,
install Git and Node.js, then install API Catalog CLI with the following command: npm install -g api-catalog-cli@latest</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If there are any issues using the API Catalog CLI — create a new API specification project for <strong>Check-In PAPI</strong> using the code editor and language <strong>OAS 2.0 (JSON)</strong>, manually import your modified API specification, and publish to Exchange from Design Center instead.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create an Exchange descriptor file:</strong>  In a command-line interface, navigate to the API specification directory, and run the API Catalog CLI create descriptor command to create a named descriptor file in the current path:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd </span>check-in-papi-spec

api-catalog create-descriptor <span style="color: #b58900">--file</span> catalog.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Before you run the commands to publish your APIs, you must create a descriptor file that has the information Exchange needs to catalog the APIs. You can create the descriptor file using the CLI or you can create it manually.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Typically you should create the file using the CLI and if you need to set more options to control how the assets are published, you can update the file manually.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Modify Exchange descriptor file:</strong> In a text editor, update the generated descriptor file, adapting the assetId to <strong>check-in-papi</strong> and adding a versionStrategy that starts the major version at 1.0.0:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #657b83">#%Catalog Descriptor 1.0</span>
<span style="color: #268bd2">projects</span><span style="color: #93a1a1">:</span>
  <span style="color: #93a1a1">-</span> <span style="color: #268bd2">main</span><span style="color: #93a1a1">:</span> <span style="color: #859900">api.json</span>
    <span style="color: #268bd2">assetId</span><span style="color: #93a1a1">:</span> <span style="color: #859900">check-in-papi</span>
    <span style="color: #268bd2">version</span><span style="color: #93a1a1">:</span> <span style="color: #859900">1.0.0</span>
    <span style="color: #268bd2">apiVersion</span><span style="color: #93a1a1">:</span> <span style="color: #859900">v1</span>
    <span style="color: #268bd2">versionStrategy</span><span style="color: #93a1a1">:</span> <span style="color: #859900">majorIncrease</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Each API found is added to the apis element in the catalog. Each entry includes the path to the spec file to publish, and the assetId to create in Exchange.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The original assetId is generated from the API title in API specification.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The API Catalog CLI is ideal for when the sheer quantity of APIs are too large to catalog manually or when APIs are not developed using MuleSoft.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There are many other YAML tags used to describe the APIs you want to catalog. Refer to the documentation for a comprehensive list: <a href="https://docs.mulesoft.com/exchange/apicat-create-descriptor-file-manually#descriptor-yaml" class="bare">https://docs.mulesoft.com/exchange/apicat-create-descriptor-file-manually#descriptor-yaml</a></em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The versionStrategy chosen here searches for the latest version that matches the version field in the descriptor and increases the major version. If the asset is in the development lifecycle state, the version is increased and the asset stays in development. If the asset is a stable version, a new stable version is published. This can also be configured for minor, patch and snapshot development versions. More details can be found in the api-catalog documentation: <a href="https://docs.mulesoft.com/exchange/apicat-create-descriptor-file-manually" class="bare">https://docs.mulesoft.com/exchange/apicat-create-descriptor-file-manually</a></em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There is also versionStrategyConditions configuration options that enable you to use the same api-catalog publish-asset command in your CI/CD scripts for each of your branches or environments and pass parameters to the command to control the version strategy of the APIs that are published.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reflect:</strong> Compare the Check-In PAPI API specification to the solution design for US1: mobile Check-In in <a href="#aa-us1-realization">US1: mobile Check-In</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_publish_the_api_specification_to_exchange"><a class="anchor" href="#_publish_the_api_specification_to_exchange"></a><a class="link" href="#_publish_the_api_specification_to_exchange">Publish the API specification to Exchange</a></h4>
<div class="paragraph">
<p>In this section, you publish the Check-In PAPI API specification to Exchange using the API Catalog CLI, in your own Anypoint Platform organization using a Connected App.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p><strong>Create API Catalog Contributor Connected App:</strong> In <strong>Anypoint Access Management</strong>, create a new <strong>Connected App</strong> that acts on its <strong>own behalf (client credentials)</strong>, for reading assets from Exchange, adding the <strong>API Catalog Contributor</strong> and  <strong>View Environment</strong> scopes and retrieve its client ID and secret.
.</p>
</li>
<li>
<p><strong>Publish API specification:</strong> Publish the modified Check-In PAPI API specification to Exchange using the API Catalog CLI publish asset command, providing your Anypoint Platform organization ID and the client id the Connected App created previously:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd </span>check-in-papi-spec

api-catalog publish-asset <span style="color: #b58900">--organization</span><span style="color: #93a1a1">=</span>&lt;insert-your-ap-org-id&gt; <span style="color: #b58900">--client_id</span><span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-id&gt; <span style="color: #b58900">--client_secret</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When prompted, enter the client secret the Connected App created previously.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can also use Anypoint Platform credentials for an account of your Anypoint Platform organization with the same permission. However, it is best practice to use a Connected App for security.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can embed the publish asset command in your automation tools, such as a CI/CD pipeline or custom scripts, to automatically trigger the cataloging of your API assets.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Exchange entry:</strong> Inspect the newly created Check-In PAPI Exchange entry, comparing what Exchange displays to the API specification itself.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_anypoint_platform_environments_for_the_complete_software_development_lifecycle"><a class="anchor" href="#_create_anypoint_platform_environments_for_the_complete_software_development_lifecycle"></a><a class="link" href="#_create_anypoint_platform_environments_for_the_complete_software_development_lifecycle">Create Anypoint Platform environments for the complete software development lifecycle</a></h4>
<div class="paragraph">
<p>In this section, you create dev, test, and prod environments in your Anypoint Platform organization.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><strong>Rename Sandbox:</strong> In Anypoint Access Management, rename the Sandbox environment to <strong>dev</strong>.</p>
</li>
<li>
<p><strong>Create environments:</strong> Create environments <strong>test</strong> and <strong>prod</strong> of type Sandbox.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The names of the environments must match Mule app configurations created in later walkthroughs.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The prod environment is created as a Sandbox environment to avoid Anypoint Platform vCore restrictions for trial accounts.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_apply_an_automated_policy_for_logging"><a class="anchor" href="#_apply_an_automated_policy_for_logging"></a><a class="link" href="#_apply_an_automated_policy_for_logging">Apply an automated policy for logging</a></h4>
<div class="paragraph">
<p>In this section, you apply Message Logging as an automated policy to the prod environment.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p><strong>Apply automated policy:</strong> In the API Manager <strong>prod</strong> environment, apply a new automated policy.</p>
<div class="paragraph">
<p><em>Note:</em> <em>You work in prod until you introduce environment-specific configuration in a later walkthrough. This is not typical but streamlines the workflow in this and later walkthroughs.</em></p>
</div>
</li>
<li>
<p><strong>Configure Message Logging:</strong> Select the latest Message Logging API policy, logging all attributes before and after calling the API, and matching the widest possible range of Mule runtime versions:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="rust"><span style="color: #586e75">#[attributes]</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_an_api_instance_in_api_manager"><a class="anchor" href="#_create_an_api_instance_in_api_manager"></a><a class="link" href="#_create_an_api_instance_in_api_manager">Create an API instance in API Manager</a></h4>
<div class="paragraph">
<p>In this section, you create an API instance for Check-In PAPI in the prod environment based on the API&#8217;s Exchange entry.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p><strong>Manage API:</strong> In the API Manager <strong>prod</strong> environment, manage an API from Exchange.</p>
</li>
<li>
<p><strong>Configure API instance:</strong> Select the <strong>Check-In PAPI</strong> API specification version you have been working with so far and manage it as a <strong>basic endpoint</strong> deployed to a Mule 4 runtime; remember the <strong>API ID</strong> assigned by API Manager.</p>
</li>
<li>
<p><strong>Set consumer endpoint:</strong> Copy the <strong>implementation URL</strong> into the API&#8217;s consumer endpoint.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The implementation URL was taken from the API specification and therefore is suitable for the prod environment.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because no API proxy is involved, the URL of the implementation and the endpoint seen by consumers are identical.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-112"><a class="anchor" href="#wt-begin-112"></a><a class="link" href="#wt-begin-112">Walkthrough 1-2: Implement an HTTPs API</a></h3>
<div class="paragraph">
<p>In the previous walkthrough you have published Check-In PAPI to Exchange, thereby assigning it a well-defined asset version, and you have created an API instance in API Manager.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you create a Mule app called check-in-papi that implements this version of Check-In PAPI by importing it from Exchange and registering it with the API instance. The Mule app is kept as simple as possible and does not yet implement real integration logic: it will be tidied-up and completed in later walkthroughs.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_create_a_mule_app_that_implements_an_api_specification_available_in_exchange">Create a Mule app that implements the Check-In PAPI API specification published to Exchange</a>.</p>
</li>
<li>
<p><a href="#create-cert-and-keystore-for-exposing-https">Create a self-signed certificate and keystore</a>.</p>
</li>
<li>
<p><a href="#_expose_an_api_over_https">Expose Check-In PAPI over HTTPS</a>.</p>
</li>
<li>
<p><a href="#_register_an_api_implementation_with_an_api_instance_using_autodiscovery">Register the API implementation with an API instance in API Manager using autodiscovery</a>.</p>
</li>
<li>
<p><a href="#_manually_deploy_an_api_implementation_to_a_cloudhub_2_0_shared_space">Manually deploy an API implementation to a CloudHub 2.0 shared space</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file"><a class="anchor" href="#_solution_file"></a><a class="link" href="#_solution_file">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module01/wt1-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_mule_app_that_implements_an_api_specification_available_in_exchange"><a class="anchor" href="#_create_a_mule_app_that_implements_an_api_specification_available_in_exchange"></a><a class="link" href="#_create_a_mule_app_that_implements_an_api_specification_available_in_exchange">Create a Mule app that implements an API specification available in Exchange</a></h4>
<div class="paragraph">
<p>In this section, you use Studio to import the Check-In PAPI API specification from Exchange and implement it as a new Mule app check-in-papi. For now you keep almost all the code generated by Studio, such as for exposing the API over HTTP.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Generate API implementation:</strong> In Studio, create a new Mule app project named <strong>check-in-papi</strong> adding a dependency to the Exchange entry for the <strong>Check-In PAPI</strong> version published previously.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>You must be <strong>logged-in</strong> with an account of your Anypoint Platform organization to be able to search your Exchange.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By convention, you chose the API implementation name (check-in-papi) to be identical to the asset ID (artifact ID) of the API specification (Check-In PAPI) it implements.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Mule app:</strong> Inspect the Mule app, its dependencies and its Mule flows.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Studio generates (scaffolds) Mule flows that implement the chosen API by returning hard-coded sample data extracted from the API specification.</em></p>
</div>
</li>
<li>
<p><strong>Update Maven coordinates:</strong> Update pom.xml adapting the Maven coordinates to match the <strong>groupId</strong> of your Anypoint Platform organization ID and appending <strong>-app</strong> to the <strong>artifactId</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>check-in-papi-app<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You modify &lt;groupId /&gt; and &lt;artifactId /&gt; as this artifact will later be published to Exchange where the groupID is required to be the Anypoint Platform organization ID to which it is deployed and you have already deployed the API specification with the same artifactId which must be unique.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update listener paths:</strong> Change the &lt;http:listener /&gt; paths for exposing the <strong>API</strong> and <strong>API Console</strong> to include the API major version:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-main"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"..."</span>
    <span style="color: #268bd2">path=</span><span style="color: #859900">"/api/v1/*"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/http:listener&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-console"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"..."</span>
    <span style="color: #268bd2">path=</span><span style="color: #859900">"/console/v1/*"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/http:listener&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This follows a convention by which the API endpoint URL path (/api/v1) but not the API implementation name (check-in-papi) identifies the version of the API specification, and only the major version is announced in this way.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This allows more than one major version of the same API to be exposed by the same API implementation — if this should be required in the future.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app and invoke the API through API Console; confirm that the HTTP responses returned by the API invocations match the payload set in the respective Mule flows.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>In all following walkthroughs, until you properly implement the integration logic of check-in-papi, these are the HTTP responses you will see when an API invocation was successful — so remember them.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-cert-and-keystore-for-exposing-https"><a class="anchor" href="#create-cert-and-keystore-for-exposing-https"></a><a class="link" href="#create-cert-and-keystore-for-exposing-https">Create a self-signed certificate and keystore for exposing an HTTPS endpoint</a></h4>
<div class="paragraph">
<p>In this section, you create a self-signed certificate and keystore, which will be needed to expose Check-In PAPI over an HTTPS rather than an HTTP endpoint.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p><strong>Go to project resources directory:</strong> In a command-line interface, navigate to the <strong>src/main/resources</strong> directory of <strong>check-in-papi</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi/src/main/resources</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Create keypair in keystore:</strong> Create a standard PKCS12 keystore <strong>check-in-papi.p12</strong> with a new public/private RSA keypair, using shell variables to explain the command configuration:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">PASS</span><span style="color: #93a1a1">=</span><span style="color: #859900">"mule12345"</span>
<span style="color: #586e75">APP</span><span style="color: #93a1a1">=</span><span style="color: #859900">"check-in-papi"</span>
<span style="color: #586e75">HOST</span><span style="color: #93a1a1">=</span><span style="color: #859900">"localhost"</span>
<span style="color: #586e75">ALTNAMES</span><span style="color: #93a1a1">=</span><span style="color: #859900">"DNS:</span><span style="color: #586e75">$HOST</span><span style="color: #859900">,IP:127.0.0.1"</span>
<span style="color: #586e75">KEYSTORE</span><span style="color: #93a1a1">=</span><span style="color: #859900">"</span><span style="color: #586e75">$APP</span><span style="color: #859900">.p12"</span>
<span style="color: #586e75">DNAME</span><span style="color: #93a1a1">=</span><span style="color: #859900">"cn=</span><span style="color: #586e75">$HOST</span><span style="color: #859900">, ou=Training, o=MuleSoft, c=US"</span>

keytool <span style="color: #b58900">-v</span> <span style="color: #b58900">-genkeypair</span> <span style="color: #b58900">-keyalg</span> RSA <span style="color: #b58900">-dname</span> <span style="color: #859900">"</span><span style="color: #586e75">$DNAME</span><span style="color: #859900">"</span> <span style="color: #d33682">\</span>
  <span style="color: #b58900">-ext</span> <span style="color: #586e75">SAN</span><span style="color: #93a1a1">=</span><span style="color: #859900">"</span><span style="color: #586e75">$ALTNAMES</span><span style="color: #859900">"</span> <span style="color: #b58900">-validity</span> 365 <span style="color: #b58900">-alias</span> server <span style="color: #d33682">\</span>
  <span style="color: #b58900">-keystore</span> <span style="color: #859900">"</span><span style="color: #586e75">$KEYSTORE</span><span style="color: #859900">"</span> <span style="color: #b58900">-storetype</span> pkcs12 <span style="color: #b58900">-storepass</span> <span style="color: #859900">"</span><span style="color: #586e75">$PASS</span><span style="color: #859900">"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bat"><span style="color: #cb4b16">set</span> <span style="color: #cb4b16">PASS</span><span style="color: #93a1a1">=</span><span style="color: #859900">"mule12345"</span>
<span style="color: #cb4b16">set</span> <span style="color: #cb4b16">APP</span><span style="color: #93a1a1">=</span><span style="color: #859900">"check-in-papi"</span>
<span style="color: #cb4b16">set</span> <span style="color: #cb4b16">HOST</span><span style="color: #93a1a1">=</span><span style="color: #859900">"localhost"</span>
<span style="color: #cb4b16">set</span> <span style="color: #cb4b16">ALTNAMES</span><span style="color: #93a1a1">=</span><span style="color: #859900">"DNS:</span><span style="color: #586e75">%HOST%</span><span style="color: #859900">,IP:127.0.0.1"</span>
<span style="color: #cb4b16">set</span> <span style="color: #cb4b16">KEYSTORE</span><span style="color: #93a1a1">=</span><span style="color: #859900">"</span><span style="color: #586e75">%APP%</span><span style="color: #859900">.p12"</span>
<span style="color: #cb4b16">set</span> <span style="color: #cb4b16">DNAME</span><span style="color: #93a1a1">=</span><span style="color: #859900">"cn=</span><span style="color: #586e75">%HOST%</span><span style="color: #859900">, ou=Training, o=MuleSoft, c=US"</span>

<span style="color: #cb4b16">keytool</span> <span style="color: #268bd2">-v -genkeypair -keyalg </span><span style="color: #cb4b16">RSA</span> <span style="color: #268bd2">-dname </span><span style="color: #586e75">%DNAME%</span> <span style="color: #d33682">^
</span>  <span style="color: #268bd2">-ext </span><span style="color: #cb4b16">SAN</span><span style="color: #93a1a1">=</span><span style="color: #586e75">%ALTNAMES%</span> <span style="color: #268bd2">-validity </span><span style="color: #859900">365</span> <span style="color: #268bd2">-alias </span><span style="color: #cb4b16">server</span> <span style="color: #d33682">^
</span>  <span style="color: #268bd2">-keystore </span><span style="color: #586e75">%KEYSTORE%</span> <span style="color: #268bd2">-storetype </span><span style="color: #cb4b16">pkcs12</span> <span style="color: #268bd2">-storepass </span><span style="color: #586e75">%PASS%</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Following PKCS12, both key and keystore share the same password.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Only the keystore name depends on the Mule app name (check-in-papi) — the keypair and keystore contents, such as the distinguished and alternative names, do not include the Mule app name.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This certificate is suitable for local development and deployment to CloudHub, although it uses simplistic host names.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_expose_an_api_over_https"><a class="anchor" href="#_expose_an_api_over_https"></a><a class="link" href="#_expose_an_api_over_https">Expose an API over HTTPS</a></h4>
<div class="paragraph">
<p>In this section, you replace the Studio-generated HTTP Listener configuration such that Check-In PAPI is exposed only over HTTPS on port 8081, making use of the certificate and keystore created previously.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p><strong>Switch to HTTPS:</strong> In Studio, change the HTTP Listener configuration to HTTPS on port <strong>8081</strong>, providing a global TLS configuration using the previously created keystore:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;tls:context</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiTLSContext"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;tls:key-store</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"pkcs12"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"check-in-papi.p12"</span>
    <span style="color: #268bd2">password=</span><span style="color: #859900">"mule12345"</span> <span style="color: #268bd2">keyPassword=</span><span style="color: #859900">"mule12345"</span> <span style="color: #268bd2">alias=</span><span style="color: #859900">"server"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/tls:context&gt;</span>
<span style="color: #b58900">&lt;http:listener-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"..."</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener-connection</span> <span style="color: #268bd2">host=</span><span style="color: #859900">"0.0.0.0"</span>
    <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span> <span style="color: #268bd2">port=</span><span style="color: #859900">"8081"</span> <span style="color: #268bd2">tlsContext=</span><span style="color: #859900">"apiTLSContext"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/http:listener-config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The hardcoded passwords and other configuration will be externalized in a later walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Port 8081 follows CloudHub 2.0 conventions for publicly accessible HTTPS endpoints.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The TLS configuration belongs to an XML namespace that had so far not been used in this Mule flow config file. This means that a new XML namespace declaration must be added to the root element of this Mule flow config file (api.xml). Adding this namespace declaration directly in the Mule config flow XML editor is tedious and error-prone in the current version of Studio. By contrast, the visual Mule config flow editor adds XML namespace declarations automatically and transparently. It is therefore best to always use the visual Mule config flow editor to add the first instance of any Mule flow configuration element to any given Mule flow config file, and then, if desired, switch to the Mule config flow XML editor — which will then also perform code-completion as expected.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app and invoke the API through API Console; you may have to make your browser accept the self-signed certificate.</p>
</li>
<li>
<p><strong>Invoke:</strong> In API Console, find the cURL command to invoke the API and use that as the starting point to invoke the API without the help of API Console, such as from a command-line interface, supplying an arbitrary PNR and example JSON request body:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The <code>-i</code> flag instructs cURL to include HTTP response headers and status code in the output.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The <code>-k</code> flag instructs cURL to not validate the certificate of the HTTPS endpoint.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>From now on, all invocations of APIs will be specified through cURL commands, but of course all other means of sending the same HTTP requests are equally valid.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_register_an_api_implementation_with_an_api_instance_using_autodiscovery"><a class="anchor" href="#_register_an_api_implementation_with_an_api_instance_using_autodiscovery"></a><a class="link" href="#_register_an_api_implementation_with_an_api_instance_using_autodiscovery">Register an API implementation with an API instance using autodiscovery</a></h4>
<div class="paragraph">
<p>In this section, you add autodiscovery to check-in-papi such that it automatically registers with the Check-In PAPI API instance created previously in API Manager in the prod environment. You then start check-in-papi in Studio with the client ID and secret Java system properties required by the uplink to the Anypoint Platform control plane.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><strong>Add autodiscovery:</strong> In Studio, add a global configuration for API autodiscovery using the <strong>API ID</strong> for the API instance created in API Manager earlier, pointing to the Mule flow with the &lt;http:listener /&gt;:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;api-gateway:autodiscovery</span> <span style="color: #268bd2">apiId=</span><span style="color: #859900">"15678353"</span> <span style="color: #268bd2">flowRef=</span><span style="color: #859900">"api-main"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Use your API ID instead of the one shown above.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>An API ID implicitly refers to an environment (here: prod) in the Anypoint Platform organization for which it is valid.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Ensure your Mule flow containing the &lt;http:listener /&gt; is indeed called api-main. The flowRef attribute must reference a Mule flow where an &lt;http:listener /&gt; is defined.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the API via cURL as before; this should fail with an HTTP 5xx error response and you should see a log entry similar to the following:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="text">WARN  2019-04-08 17:55:17,885 [WrapperListener_start_runner] com.mulesoft.mule.runtime.gw.client.provider.ApiPlatformClientProvider: Client ID or Client Secret were not provided. API Platform client is DISABLED.</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Get client ID and secret:</strong> In <strong>Anypoint Access Management</strong>, navigate to Business Groups and click on the name of your Anypoint Platform organization and navigate to the Settings tab to retrieve its client ID and secret.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Following the principle of least privilege, it is typically recommended to use the client ID and secret for a specific environment rather than the entire Anypoint Platform organization: the latter gives access to all environments of that Anypoint Platform organization, whereas the former gives access only to that one environment. Nevertheless, to avoid confusion through multiple pairs of client ID and secret, this course will continue using organization-wide client ID and secret.</em></p>
</div>
</li>
<li>
<p><strong>Update run config:</strong> In Studio, stop the Mule app and change its run configuration by adding the following <strong>VM arguments</strong> for client ID and secret:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Danypoint</span>.platform.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-client-id&gt;
<span style="color: #b58900">-M-Danypoint</span>.platform.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-client-secret&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This sets Java system properties with the given names and values.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run:</strong> Run the Mule app; a <strong>log entry</strong> similar to the following should appear:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="text">INFO  2019-04-08 18:39:02,120 [agw-policy-set-deployment.01] com.mulesoft.mule.runtime.gw.policies.lifecyle.GateKeeper: API ApiKey{id='15678353'} is now unblocked (available).</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the API via cURL as before; this should return a HTTP 200 OK response with whatever response body was extracted by APIkit from the API specification.</p>
</li>
<li>
<p><strong>Check log:</strong> Inspect the log entries created by the <strong>Message Logging</strong> automated policy.</p>
</li>
<li>
<p><strong>Check API instance:</strong> In <strong>API Manager</strong>, the status of the corresponding API instance should now be active/green.</p>
</li>
<li>
<p><strong>Stop:</strong> Stop the Mule app.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_manually_deploy_an_api_implementation_to_a_cloudhub_2_0_shared_space"><a class="anchor" href="#_manually_deploy_an_api_implementation_to_a_cloudhub_2_0_shared_space"></a><a class="link" href="#_manually_deploy_an_api_implementation_to_a_cloudhub_2_0_shared_space">Manually deploy an API implementation to a CloudHub 2.0 shared space</a></h4>
<div class="paragraph">
<p>In this section, you use the Runtime Manager web UI to deploy check-in-papi to the CloudHub prod environment using a hostname that matches the endpoint URL in the Check-In PAPI API specification. You set the CloudHub properties for client ID and secret required by the uplink to the Anypoint Platform control plane.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="20">
<li>
<p><strong>Locate deployable archive:</strong> Locate the check-in-papi deployable archive in the <strong>target</strong> sub-directory of the check-in-papi base directory.</p>
</li>
<li>
<p><strong>Configure deployment to CloudHub 2.0 prod:</strong> In <strong>Runtime Manager</strong>, launch the UI for deploying the check-in-papi archive to the prod environment, selecting the <strong>CloudHub 2.0 US East Ohio Shared Space</strong> as a deployment target and setting the application name to <strong>check-in-papi</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>When deploying to the CloudHub 2.0 deployment target, the domain for the public endpoint is always app-name-uniq-id.shard.region.cloudhub.io.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To ensure that names are unique and avoid domain conflicts, CloudHub 2.0 adds a six-character unique id to the application name that you specify in the public endpoint URL.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The application name identifies your application not only in Runtime Manager but also in the public cloudhub.io domain. For example, an application named myapp is accessible at <a href="http://myapp-uniq-id.shard.usa-w2.cloudhub.io" class="bare">http://myapp-uniq-id.shard.usa-w2.cloudhub.io</a>.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Configure Last-mile security:</strong> In the <strong>Ingress</strong> tab, check the Last-Mile Security option.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>As the application exposes a HTTPs endpoint itself, this option must be checked to forward the traffic from the CloudHub Shared Space Load Balancer to the application itself. This ensures the "Last-Mile" traffic between the CloudHub Shared Space Load Balancer and the application are encrypted.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Configure and trigger deployment:</strong> In the <strong>Properties tab</strong>, enter client ID and secret of your Anypoint Platform organization as before, but in plain properties key=value format, then trigger the actual deployment:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="properties"><span style="color: #586e75">anypoint.platform.client_id</span><span style="color: #93a1a1">=</span><span style="color: #859900">&lt;insert-your-client-id&gt;</span>
<span style="color: #586e75">anypoint.platform.client_secret</span><span style="color: #93a1a1">=</span><span style="color: #859900">&lt;insert-your-client-secret&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This sets Java system properties with the given names and values.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Wait and observe:</strong> Observe the Mule app&#8217;s logs and wait for it to completely start up.</p>
</li>
<li>
<p><strong>Locate fully qualified domain name:</strong> In the Runtime Manager dashboard, check the fully qualified domain name of the Mule app and copy the API&#8217;s endpoint URL with the additional six-character uniq-id and shard.</p>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the API via cURL using this endpoint URL; this should return a HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-i</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The <code>-k</code> cURL option is no longer needed as the certificate exposed by the HTTPS endpoint is that of the CloudHub Shared Space Load Balancer. The CloudHub Shared Space Load Balancer in turn invokes the API endpoint exposed by the Mule app.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To test Runtime Fabric and CloudHub 2.0 applications via their API Console, ensure you append a trailing "/" to the console URL, for example: <a href="https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1/console/" class="bare">https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1/console/</a>. Without the trailing "/", it will be redirected to the Runtime Fabric local service DNS.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Check log:</strong> Inspect the log entries created by the Message Logging automated policy.</p>
</li>
<li>
<p><strong>Check API instance:</strong> In <strong>API Manager</strong>, the status of the corresponding API instance should (again) be active/green.</p>
</li>
<li>
<p><strong>Set consumer and implementation endpoints:</strong> in API Manager, update the implementation URL and consumer endpoint to match your generated fully qualified domain name.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>These endpoints are optional and are used for informational purposes to let clients know how to interact with your API, including surfacing these endpoints in Exchange.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-software-principles"><a class="anchor" href="#module-software-principles"></a><a class="link" href="#module-software-principles">Module 2: Applying basic software engineering principles</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you apply these essential software engineering principles to a Mule app and its Maven build: repeatability through convention and automation, security through encryption, separation of concerns, and non-redundancy of code and configuration.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apply and follow coding conventions.</p>
</li>
<li>
<p>Securely parameterize a Mule app and its Maven build for different runtime environments.</p>
</li>
<li>
<p>Deploy to CloudHub from a Maven build.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-121"><a class="anchor" href="#wt-begin-121"></a><a class="link" href="#wt-begin-121">Walkthrough 2-1: Apply and follow coding conventions</a></h3>
<div class="paragraph">
<p>The code for check-in-papi at this point is essentially that generated by Studio. There are two fundamentally different approaches for dealing with generated code: One approach is to keep generated code clearly separate from hand-written code, making as few changes as possible to generated code, and applying coding conventions only to hand-written code. The other approach is to see code generation as a shortcut to writing "normal" code, and consequently treat generated code the same way as hand-written code, applying the same coding conventions to all code. It is this latter approach that AnyAirline follows and that you start enforcing in this walkthrough.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you establish the following basic coding conventions (a sub-set of those given in <a href="#module-coding-conventions"><em>Coding conventions</em></a>), apply them to check-in-papi, and lay the foundation for following them in all future development:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Don&#8217;t repeat yourself: avoid duplication.</p>
</li>
<li>
<p>Abbreviate when space is constrained: SAPI=System API, PAPI=Process API, EAPI=Experience API.</p>
</li>
<li>
<p>For Mule apps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Studio project name = Maven artifact ID = Maven project name, for example check-in-papi.</p>
</li>
<li>
<p>Formatting: standard Eclipse XML editor settings with width 140 characters and do not format comments.</p>
</li>
<li>
<p>Flows and global error handlers: for example check-in-by-pnr or api-error-handler.</p>
</li>
<li>
<p>Global element names: for example apiHttpListenerConfig.</p>
</li>
<li>
<p>Mule flow config files: global.xml, api.xml, main.xml, error.xml, health.xml.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You will add to these basic coding conventions in later walkthroughs as and when needed (see <a href="#module-coding-conventions"><em>Coding conventions</em></a>).</p>
</div>
<div class="paragraph">
<p>For conciseness, all doc:name attributes are omitted from Mule flow code shown in this document.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_apply_coding_conventions_to_a_studio_generated_api_implementation">Apply these coding conventions retroactively to check-in-papi</a>.</p>
</li>
<li>
<p><a href="#_deploy_a_reusable_template_to_exchange">Deploy a reusable template to Exchange</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_2"><a class="anchor" href="#_solution_file_2"></a><a class="link" href="#_solution_file_2">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file"><a class="anchor" href="#_starting_file"></a><a class="link" href="#_starting_file">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module01/wt1-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apply_coding_conventions_to_a_studio_generated_api_implementation"><a class="anchor" href="#_apply_coding_conventions_to_a_studio_generated_api_implementation"></a><a class="link" href="#_apply_coding_conventions_to_a_studio_generated_api_implementation">Apply coding conventions to a Studio-generated API implementation</a></h4>
<div class="paragraph">
<p>In this section, you refactor check-in-papi: rename global configuration elements and move them to global.xml, rename global error handlers and move them to error.xml, extract all main integration logic to flows in main.xml, and separate flows related to exposing Check-In PAPI in api.xml.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Rename Mule flow config file:</strong> In Studio, rename your only Mule flow config file <strong>api.xml</strong>.</p>
</li>
<li>
<p><strong>Rename global elements:</strong> In <strong>api.xml</strong>, change all global element names to follow the naming convention:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;tls:context</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiTLSContext"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;http:listener-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiHttpListenerConfig"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;apikit:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiConfig"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is best to do this be search-replace so as not to miss any references to the old names, for example to the &lt;apikit:config /&gt; name from flow names that process API invocations.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Move global elements:</strong> Move all global elements from api.xml to <strong>global.xml</strong>; only Mule flows remain in api.xml.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The global.xml file only contains global configuration elements that are not error handlers.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To avoid XML namespace issues entirely, consider copying api.xml to global.xml and then deleting unwanted XML elements from both files.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract and move error handlers:</strong> In the <strong>Mule config flow XML editor</strong>, from <strong>api.xml</strong> extract the two local error handlers in the Studio-generated Mule flows <strong>api-main</strong> and <strong>api-console</strong> into two global error handlers called <strong>api-error-handler</strong> and <strong>api-console-error-handler</strong>, respectively, in <strong>error.xml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">error.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;error-handler</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-error-handler"</span><span style="color: #b58900">&gt;</span>
  ...
<span style="color: #b58900">&lt;/error-handler&gt;</span>

<span style="color: #b58900">&lt;error-handler</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-console-error-handler"</span><span style="color: #b58900">&gt;</span>
  ...
<span style="color: #b58900">&lt;/error-handler&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-main"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler</span> <span style="color: #268bd2">ref=</span><span style="color: #859900">"api-error-handler"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-console"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler</span> <span style="color: #268bd2">ref=</span><span style="color: #859900">"api-console-error-handler"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The error.xml file only contains global error handlers.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The error handler references are currently neither visible nor editable in the visual Mule config flow editor.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To avoid XML namespace issues entirely, consider copying api.xml to error.xml and then deleting unwanted XML elements from both files.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Currently, the APIkit-generated api-error-handler does not contain a catch-all error handler: this is a shortcoming that you will correct in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract and move main flows:</strong> In <strong>api.xml</strong>, using the visual Mule config flow editor, locate the  two Mule flows  generated by APIkit to process the two HTTP requests and use the <strong>extract to flow</strong> refactoring to extract (only) the setting of the payload (the last Transform Message component in each flow) to two new private flows <strong>check-in-by-pnr</strong> and <strong>payment-approval-by-pnr</strong> in <strong>main.xml</strong>, such that they are called by &lt;flow-ref /&gt; elements from the request processing flows in api.xml; you will extend these extracted flows in future walkthroughs to perform the main integration logic of Check-In PAPI:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"put:..."</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"put:..."</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"payment-approval-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span>...<span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"payment-approval-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span>...<span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule flows in main.xml are now essentially pure integration logic independent of the fact that this logic is exposed via an API, whereas the latter aspect is handled by the Mule flows in api.xml.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is good practice to set the doc:name attribute of &lt;flow-ref /&gt; elements to the name of the flow being invoked (see <a href="#module-coding-conventions"><em>Coding conventions</em></a>). But this document omits all doc:name attributes for conciseness.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Each Mule flow is encapsulated and can be referenced by many calling Mule flows. Therefore it is necessary to define the interface of each invokable Mule flow via its metadata. This interface can be left implicit, set manually on each Mule flow, or set via the Metadata assistant when using the extract to flow option in the visual Mule config flow editor.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Metadata assistant automatically detects the actual metadata of your existing Mule flow and enables you to propagate the existing metadata to the Mule flow you are referencing.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Once the metadata is defined for the child Mule flow, it can no longer be automatically updated if you modify the actual metadata in the calling parent Mule flow.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Using the Metadata assistant encourages a coding style of developing large self-contained Mule flows and refactoring over time into smaller, reusable Mule flows. This coding style is supplemented by unit testing to make sure existing code doesn’t break when later refactored. You will learn how to unit test Mule apps in later walkthroughs.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run:</strong> Confirm that the Mule app still starts up without errors in Studio.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_a_reusable_template_to_exchange"><a class="anchor" href="#_deploy_a_reusable_template_to_exchange"></a><a class="link" href="#_deploy_a_reusable_template_to_exchange">Deploy a reusable template to Exchange</a></h4>
<div class="paragraph">
<p>In this section, you deploy check-in-papi as a reusable project template to Exchange — allowing other developers to use this canonical project to bootstrap other API projects in future.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p><strong>Bootstrap check-in-papi-template:</strong> Copy <strong>check-in-papi</strong> to <strong>check-in-papi-template</strong> in the workspace directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp</span> <span style="color: #b58900">-R</span> check-in-papi check-in-papi-template</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> In Studio, import the check-in-papi-template project as a Mule app, without copying it into the workspace, because it is already there; confirm that the import succeeded.</p>
</li>
<li>
<p><strong>Modify Maven coordinates:</strong> Update pom.xml adapting the <strong>artifactId</strong> and <strong>name</strong> to the new project name: check-in-papi-template and increasing the <strong>version</strong> to a non-SNAPSHOT release version.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi-template</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>check-in-papi-template<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>check-in-papi-template<span style="color: #b58900">&lt;/name&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Although Exchange supports SNAPSHOT versions for template projects, at the time of writing Studio does not. You can however use the Exchange Mule Maven plugin which will be discussed in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create Category metadata</strong>: In <strong>Exchange</strong>, navigate to <strong>Settings</strong> and create a new category: <strong>Tier</strong> with values for each API layer: <strong>System Tier</strong>, <strong>Process Tier</strong> and <strong>Experience Tier</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Categories allow you to organize Exchange assets into groups to improve asset browsing and discovery.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy template to Exchange:</strong> In Studio, from the Anypoint menu: <strong>Publish to Exchange</strong>, choosing <strong>Template</strong> as the project type and click <strong>Next</strong>.</p>
</li>
<li>
<p><strong>Set metadata</strong>: From the next screen, add a tag: <strong>check-in</strong>, and add the <strong>Process Tier</strong> category created previously.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>You must be <strong>logged-in</strong> with an account of your Anypoint Platform organization to be able to deploy to your Exchange.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study pom.xml:</strong> Notice the addition of the properties for the various metadata:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi-template</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>check-in-papi-template<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;packaging&gt;</span>mule-application<span style="color: #b58900">&lt;/packaging&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>check-in-papi-template<span style="color: #b58900">&lt;/name&gt;</span>
  ...
  <span style="color: #b58900">&lt;properties&gt;</span>
    <span style="color: #b58900">&lt;tags&gt;</span>check-in<span style="color: #b58900">&lt;/tags&gt;</span>
    <span style="color: #b58900">&lt;categories&gt;</span>[{"key":"Tier","value":"Process Tier"}]<span style="color: #b58900">&lt;/categories&gt;</span>
  <span style="color: #b58900">&lt;/properties&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You will look more in-detail at deploying various asset types to Exchange with Maven in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Exchange asset:</strong> Navigate to your Exchange, download the asset jar for check-in-papi-template, and extract the contents. Study the pom.xml file and notice the <strong>Mule Maven plugin configuration</strong> is configured to create an artifact with &lt;classifier /&gt; <strong>mule-application-template</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi-template</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>check-in-papi-template<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;packaging&gt;</span>mule-application<span style="color: #b58900">&lt;/packaging&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>check-in-papi-template<span style="color: #b58900">&lt;/name&gt;</span>

  ...
 <span style="color: #b58900">&lt;plugin&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;version&gt;</span>${mule.maven.plugin.version}<span style="color: #b58900">&lt;/version&gt;</span>
    <span style="color: #b58900">&lt;extensions&gt;</span>true<span style="color: #b58900">&lt;/extensions&gt;</span>
    <span style="color: #b58900">&lt;configuration&gt;</span>
      <span style="color: #b58900">&lt;classifier&gt;</span>mule-application-template<span style="color: #b58900">&lt;/classifier&gt;</span>
    <span style="color: #b58900">&lt;/configuration&gt;</span>
  <span style="color: #b58900">&lt;/plugin&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This configuration is not automatically added your pom.xml, you will need to manually add this configuration if you intend to deploy the template via Maven outside of Studio.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You will look more in-detail at deploying various asset types to Exchange with Maven in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-122"><a class="anchor" href="#wt-begin-122"></a><a class="link" href="#wt-begin-122">Walkthrough 2-2: Remove redundancy</a></h3>
<div class="paragraph">
<p>When creating the check-in-papi Mule app in the previous walkthrough, you have hard-coded all configuration values directly in the Mule app source code. Furthermore, the Mule app utilizes a Maven build configuration generated by Studio, which also contains configuration values that partially overlap with values hard-coded in the Mule app source code.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you identify all configuration values of check-in-papi and its Maven build and extract them into suitable configuration files of the Maven build and in check-in-papi to reduce redundancy and improve maintainability and reuse.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_extract_mule_app_configuration_values_into_a_properties_file">Extract Mule app configuration values into a properties file</a>.</p>
</li>
<li>
<p><a href="#_remove_configuration_redundancy_using_maven_resource_filtering">Remove configuration redundancy using Maven resource filtering</a>.</p>
</li>
<li>
<p><a href="#wt2-2-introduce-ppom">Remove build redundancy and increase build reproducibility by introducing a parent POM</a>.</p>
</li>
<li>
<p><a href="#wt2-2-introduce-bom">Centralize Maven dependency and plugin versions in a BOM</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_3"><a class="anchor" href="#_solution_file_3"></a><a class="link" href="#_solution_file_3">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_2"><a class="anchor" href="#_starting_file_2"></a><a class="link" href="#_starting_file_2">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_extract_mule_app_configuration_values_into_a_properties_file"><a class="anchor" href="#_extract_mule_app_configuration_values_into_a_properties_file"></a><a class="link" href="#_extract_mule_app_configuration_values_into_a_properties_file">Extract Mule app configuration values into a properties file</a></h4>
<div class="paragraph">
<p>In this section, you extract all configuration values from the check-in-papi Mule app code into a single configuration file properties.yaml.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Identify config values:</strong> In Studio, study the Mule flow config files of check-in-papi and identify all configuration values.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Consider all values that might change over time or that might differ between environments to be configuration values.</em></p>
</div>
</li>
<li>
<p><strong>Study APIkit api attribute:</strong> Identify the constituent parts of the &lt;apikit:config /&gt; api attribute and determine their <strong>meaning</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;apikit:config</span> <span style="color: #268bd2">api=</span><span style="color: #859900">"resource::6ebe1206-ddb1-4f2a-b06e-dca3244ebbad:check-in-papi:1.0.0:oas:zip:api.json"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Some of these values will be different for you. This remains true for the entire walkthrough and will not be repeated.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Copy config values to props file:</strong> Create a new file <strong>properties.yaml</strong> in <strong>src/main/resources</strong> and add all configuration values, suitably named and organized:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">groupId</span><span style="color: #93a1a1">:</span>      <span style="color: #859900">"</span><span style="color: #859900">6ebe1206-ddb1-4f2a-b06e-dca3244ebbad"</span>
  <span style="color: #268bd2">artifactId</span><span style="color: #93a1a1">:</span>   <span style="color: #859900">"</span><span style="color: #859900">check-in-papi"</span>
  <span style="color: #268bd2">version</span><span style="color: #93a1a1">:</span>      <span style="color: #859900">"</span><span style="color: #859900">1.0.0"</span>
  <span style="color: #268bd2">spec</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">resource::${api.groupId}:${api.artifactId}:${api.version}:oas:zip:api.json"</span>
  <span style="color: #268bd2">majorVersion</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">v1"</span>
  <span style="color: #268bd2">id</span><span style="color: #93a1a1">:</span>           <span style="color: #859900">"</span><span style="color: #859900">15678353"</span>

<span style="color: #268bd2">https</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">port</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">8081"</span>

<span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">type</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">pkcs12"</span>
  <span style="color: #268bd2">path</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">check-in-papi.p12"</span>
  <span style="color: #268bd2">alias</span><span style="color: #93a1a1">:</span>       <span style="color: #859900">"</span><span style="color: #859900">server"</span>
  <span style="color: #268bd2">password</span><span style="color: #93a1a1">:</span>    <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span>
  <span style="color: #268bd2">keyPassword</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Break-down the complicated api.spec value into its constituent parts, as shown here.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Read props file:</strong> Near the top of <strong>global.xml</strong>, read <strong>properties.yaml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;configuration-properties</span> <span style="color: #268bd2">file=</span><span style="color: #859900">"properties.yaml"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reference config props:</strong> Replace all configuration values with references to the corresponding properties:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;tls:context</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiTLSContext"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;tls:key-store</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"${tls.keystore.type}"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"${tls.keystore.path}"</span>
    <span style="color: #268bd2">password=</span><span style="color: #859900">"${tls.keystore.password}"</span>
    <span style="color: #268bd2">keyPassword=</span><span style="color: #859900">"${tls.keystore.keyPassword}"</span>
    <span style="color: #268bd2">alias=</span><span style="color: #859900">"${tls.keystore.alias}"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/tls:context&gt;</span>

<span style="color: #b58900">&lt;http:listener-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiHttpListenerConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener-connection</span> <span style="color: #268bd2">host=</span><span style="color: #859900">"0.0.0.0"</span>
    <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span> <span style="color: #268bd2">port=</span><span style="color: #859900">"${https.port}"</span> <span style="color: #268bd2">tlsContext=</span><span style="color: #859900">"apiTLSContext"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/http:listener-config&gt;</span>

<span style="color: #b58900">&lt;apikit:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiConfig"</span> <span style="color: #268bd2">api=</span><span style="color: #859900">"${api.spec}"</span>
  <span style="color: #268bd2">outboundHeadersMapName=</span><span style="color: #859900">"outboundHeaders"</span>
  <span style="color: #268bd2">httpStatusVarName=</span><span style="color: #859900">"httpStatus"</span> <span style="color: #b58900">/&gt;</span>

<span style="color: #b58900">&lt;api-gateway:autodiscovery</span> <span style="color: #268bd2">apiId=</span><span style="color: #859900">"${api.id}"</span> <span style="color: #268bd2">flowRef=</span><span style="color: #859900">"api-main"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-main"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"apiHttpListenerConfig"</span>
    <span style="color: #268bd2">path=</span><span style="color: #859900">"/api/${api.majorVersion}/*"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/http:listener&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-console"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"apiHttpListenerConfig"</span>
    <span style="color: #268bd2">path=</span><span style="color: #859900">"/console/${api.majorVersion}/*"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/http:listener&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the reserved property https.port for the port to expose the API on which is overriden by CloudHub. The value is assigned automatically by the platform services when deployed to CloudHub. CloudHub 2.0 assigns 8081 as the value, but you can use a different value locally if needed.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the API as before; this should return a HTTP 200 OK response and the hard-coded response body:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_remove_configuration_redundancy_using_maven_resource_filtering"><a class="anchor" href="#_remove_configuration_redundancy_using_maven_resource_filtering"></a><a class="link" href="#_remove_configuration_redundancy_using_maven_resource_filtering">Remove configuration redundancy using Maven resource filtering</a></h4>
<div class="paragraph">
<p>In this section, you introduce Maven resource filtering to check-in-papi such that configuration values that must be defined in the Maven POM do not have to be repeated in the Mule app code.</p>
</div>
<div class="paragraph">
<p>Resource filtering is a feature of the standard Maven Resources plugin. A more appropriate name would be "resource preprocessing", because it consists in references to Maven property names in resource files being replaced with the values of these properties as defined in the Maven POM.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p><strong>Detect build and configuration repetition:</strong> Inspect <strong>pom.xml</strong> in general and in particular the Maven dependency on the Check-In PAPI API specification in OAS format; note the duplication with <strong>properties.yaml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>6ebe1206-ddb1-4f2a-b06e-dca3244ebbad<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>check-in-papi-app<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>oas<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;type&gt;</span>zip<span style="color: #b58900">&lt;/type&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">properties.yaml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">groupId</span><span style="color: #93a1a1">:</span>      <span style="color: #859900">"</span><span style="color: #859900">6ebe1206-ddb1-4f2a-b06e-dca3244ebbad"</span>
  <span style="color: #268bd2">artifactId</span><span style="color: #93a1a1">:</span>   <span style="color: #859900">"</span><span style="color: #859900">check-in-papi"</span>
  <span style="color: #268bd2">version</span><span style="color: #93a1a1">:</span>      <span style="color: #859900">"</span><span style="color: #859900">1.0.0"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This duplication means that every change to the API specification being implemented by this Mule app requires a synchronized change to pom.xml and properties.yaml.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Configure Maven Resources plugin resource filtering:</strong> In pom.xml, add to the <strong>&lt;build /&gt;</strong> element configuration for the standard Maven Resources plugin to perform Maven resource filtering of files in <strong>src/main/resources</strong> and <strong>src/test/resources</strong>, excluding known binary files:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;build&gt;</span>
  <span style="color: #b58900">&lt;resources&gt;</span>
    <span style="color: #b58900">&lt;resource&gt;</span>
      <span style="color: #b58900">&lt;directory&gt;</span>src/main/resources<span style="color: #b58900">&lt;/directory&gt;</span>
      <span style="color: #b58900">&lt;filtering&gt;</span>true<span style="color: #b58900">&lt;/filtering&gt;</span>
    <span style="color: #b58900">&lt;/resource&gt;</span>
  <span style="color: #b58900">&lt;/resources&gt;</span>
  <span style="color: #b58900">&lt;testResources&gt;</span>
    <span style="color: #b58900">&lt;testResource&gt;</span>
      <span style="color: #b58900">&lt;directory&gt;</span>src/test/resources<span style="color: #b58900">&lt;/directory&gt;</span>
      <span style="color: #b58900">&lt;filtering&gt;</span>true<span style="color: #b58900">&lt;/filtering&gt;</span>
    <span style="color: #b58900">&lt;/testResource&gt;</span>
  <span style="color: #b58900">&lt;/testResources&gt;</span>
  <span style="color: #b58900">&lt;plugins&gt;</span>
    <span style="color: #b58900">&lt;plugin&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>maven-resources-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;version&gt;</span>3.3.1<span style="color: #b58900">&lt;/version&gt;</span>
      <span style="color: #b58900">&lt;configuration&gt;</span>
        <span style="color: #b58900">&lt;nonFilteredFileExtensions&gt;</span>
          <span style="color: #b58900">&lt;nonFilteredFileExtension&gt;</span>p12<span style="color: #b58900">&lt;/nonFilteredFileExtension&gt;</span>
          <span style="color: #b58900">&lt;nonFilteredFileExtension&gt;</span>crt<span style="color: #b58900">&lt;/nonFilteredFileExtension&gt;</span>
          <span style="color: #b58900">&lt;nonFilteredFileExtension&gt;</span>pem<span style="color: #b58900">&lt;/nonFilteredFileExtension&gt;</span>
        <span style="color: #b58900">&lt;/nonFilteredFileExtensions&gt;</span>
      <span style="color: #b58900">&lt;/configuration&gt;</span>
    <span style="color: #b58900">&lt;/plugin&gt;</span>
    ...
  <span style="color: #b58900">&lt;/plugins&gt;</span>
<span style="color: #b58900">&lt;build&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Merge the above into the existing &lt;build /&gt; element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If binary files were not excluded they would garbled by the filtering process.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Maven Resources plugin is a standard Maven plugin and unrelated to MuleSoft.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add Maven props:</strong> Add to the <strong>&lt;properties /&gt;</strong> element the configuration properties common to pom.xml and properties.yaml, copying their values from the &lt;dependencies /&gt; section:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;api.groupId&gt;</span>6ebe1206-ddb1-4f2a-b06e-dca3244ebbad<span style="color: #b58900">&lt;/api.groupId&gt;</span>
<span style="color: #b58900">&lt;api.artifactId&gt;</span>check-in-papi<span style="color: #b58900">&lt;/api.artifactId&gt;</span>
<span style="color: #b58900">&lt;api.version&gt;</span>1.0.0<span style="color: #b58900">&lt;/api.version&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Maven resource filtering replaces references to Maven properties in resource files with their values defined in the Maven build configuration, such as in pom.xml.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reference props in build:</strong> Change the Maven dependency on the Check-In PAPI to use these properties:</p>
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>${api.groupId}<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>${api.artifactId}<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>${api.version}<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>oas<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;type&gt;</span>zip<span style="color: #b58900">&lt;/type&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Reference props in config:</strong> In <strong>properties.yaml</strong>, similarly replace the values with references to these Maven properties:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">groupId</span><span style="color: #93a1a1">:</span>      <span style="color: #859900">"</span><span style="color: #859900">${api.groupId}"</span>
  <span style="color: #268bd2">artifactId</span><span style="color: #93a1a1">:</span>   <span style="color: #859900">"</span><span style="color: #859900">${api.artifactId}"</span>
  <span style="color: #268bd2">version</span><span style="color: #93a1a1">:</span>      <span style="color: #859900">"</span><span style="color: #859900">${api.version}"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Maven resource filtering replaces these property references with their values during the process-resources and process-test-resources life-cycle phases of the Maven build.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the API as before; this should return an HTTP 200 OK response.</p>
</li>
<li>
<p><strong>Study filtered props file:</strong> Compare the filtered (pre-processed) contents of <strong>properties.yaml</strong> in <strong>target/classes</strong> to the source in src/main/resources.</p>
<div class="paragraph">
<p><em>Note:</em> <em>If target/classes does not exist then briefly run the Mule app in Studio, as this performs a Maven build. Or you can simply run a Maven build from a command-line interface, as will be done in later walkthroughs.</em></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt2-2-introduce-ppom"><a class="anchor" href="#wt2-2-introduce-ppom"></a><a class="link" href="#wt2-2-introduce-ppom">Remove build redundancy and increase build reproducibility by introducing a parent POM</a></h4>
<div class="paragraph">
<p>In this section, you extract all Maven build configuration that is not specific to check-in-papi from pom.xml into a reusable parent POM within its own directory parent-pom/pom.xml. You then transform pom.xml into a child POM of parent-pom/pom.xml.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p><strong>Identify reusable build config:</strong> In <strong>pom.xml</strong> and identify the configuration that is likely to be the same across related Mule apps.</p>
<div class="paragraph">
<p><em>Note:</em> <em>This includes the versions of Maven dependencies and Maven plugins, the configuration of plugins like the Mule Maven plugin and Maven Resources plugin, the resource filtering configuration, and the declaration (location) of Maven repositories from which to download dependencies.</em></p>
</div>
</li>
<li>
<p><strong>Bootstrap parent POM:</strong> Copy <strong>pom.xml</strong> to <strong>parent-pom/pom.xml</strong> in the parent directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">mkdir </span>parent-pom
<span style="color: #586e75">cp </span>check-in-papi/pom.xml parent-pom/pom.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Typically, parent POMs are located in the parent directory of a Maven project. Because a parent POM is not related to a specific project, this approach is only viable if a monorepository is used, that is, if all related projects are located in the same source code (Git) repository <a href="#Ref14">[Ref14]</a>. Then parent POMs can also be located in that monorepo, in a parent directory of the Maven projects. This is the approach taken by AnyAirline.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If every project is maintained in its own repository — the opposite of a monorepo, sometimes called polyrepository or multirepository — then parent POMs are typically also maintained in distinct repos. Because the relative filesystem location of these parent POMs to the Maven projects that use them can then no longer be guaranteed, parent POMs must in this case be installed in a Maven repository and loaded from there.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update dependencies:</strong> In <strong>parent-pom/pom.xml</strong> update if necessary the versions of these dependencies: <strong>Mule Maven plugin</strong> to 3.8.2, APIkit to 1.9.1, and HTTP Connector to 1.7.3.</p>
</li>
<li>
<p><strong>Turn into parent POM:</strong> Change parent-pom/pom.xml into a parent POM by adapting its Maven coordinates including setting the groupId to your Anypoint Platform organization ID and retaining only build configuration common to similar Mule apps, wrapping &lt;dependencies /&gt; into <strong>&lt;dependencyManagement /&gt;</strong>, and wrapping &lt;plugins /&gt; into <strong>&lt;pluginManagement /&gt;</strong>, and also introducing an additional <strong>property</strong> for the <strong>Mule runtime version</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml (outline)</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;modelVersion&gt;</span>4.0.0<span style="color: #b58900">&lt;/modelVersion&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;packaging&gt;</span>pom<span style="color: #b58900">&lt;/packaging&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/name&gt;</span>

  <span style="color: #b58900">&lt;properties&gt;</span>
    ...
    <span style="color: #b58900">&lt;app.runtime.semver&gt;</span>4.4.0<span style="color: #b58900">&lt;/app.runtime.semver&gt;</span>
    <span style="color: #b58900">&lt;app.runtime&gt;</span>4.4.0-20230522<span style="color: #b58900">&lt;/app.runtime&gt;</span>
    ...
  <span style="color: #b58900">&lt;/properties&gt;</span>

  <span style="color: #b58900">&lt;build&gt;</span>
    <span style="color: #b58900">&lt;resources&gt;</span>...<span style="color: #b58900">&lt;/resources&gt;</span>
    <span style="color: #b58900">&lt;testResources&gt;</span>...<span style="color: #b58900">&lt;/testResources&gt;</span>
    <span style="color: #b58900">&lt;pluginManagement&gt;</span>
      <span style="color: #b58900">&lt;plugins&gt;</span>...<span style="color: #b58900">&lt;/plugins&gt;</span>
    <span style="color: #b58900">&lt;/pluginManagement&gt;</span>
  <span style="color: #b58900">&lt;/build&gt;</span>

  <span style="color: #b58900">&lt;dependencyManagement&gt;</span>
    <span style="color: #b58900">&lt;dependencies&gt;</span>...<span style="color: #b58900">&lt;/dependencies&gt;</span>
  <span style="color: #b58900">&lt;/dependencyManagement&gt;</span>

  <span style="color: #b58900">&lt;repositories&gt;</span>...<span style="color: #b58900">&lt;/repositories&gt;</span>
  <span style="color: #b58900">&lt;pluginRepositories&gt;</span>...<span style="color: #b58900">&lt;/pluginRepositories&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">parent-pom/pom.xml (more detail)</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;modelVersion&gt;</span>4.0.0<span style="color: #b58900">&lt;/modelVersion&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;packaging&gt;</span>pom<span style="color: #b58900">&lt;/packaging&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/name&gt;</span>

  <span style="color: #b58900">&lt;properties&gt;</span>
    <span style="color: #b58900">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span style="color: #b58900">&lt;/project.build.sourceEncoding&gt;</span>
    <span style="color: #b58900">&lt;project.reporting.outputEncoding&gt;</span>
      UTF-8
    <span style="color: #b58900">&lt;/project.reporting.outputEncoding&gt;</span>
    <span style="color: #b58900">&lt;app.runtime.semver&gt;</span>4.4.0<span style="color: #b58900">&lt;/app.runtime.semver&gt;</span>
    <span style="color: #b58900">&lt;app.runtime&gt;</span>4.4.0-20230522<span style="color: #b58900">&lt;/app.runtime&gt;</span>
    <span style="color: #b58900">&lt;mule.maven.plugin.version&gt;</span>3.8.2<span style="color: #b58900">&lt;/mule.maven.plugin.version&gt;</span>
  <span style="color: #b58900">&lt;/properties&gt;</span>

  <span style="color: #b58900">&lt;build&gt;</span>
    <span style="color: #b58900">&lt;resources&gt;</span>
      <span style="color: #b58900">&lt;resource&gt;</span>
        <span style="color: #b58900">&lt;directory&gt;</span>src/main/resources<span style="color: #b58900">&lt;/directory&gt;</span>
        <span style="color: #b58900">&lt;filtering&gt;</span>true<span style="color: #b58900">&lt;/filtering&gt;</span>
      <span style="color: #b58900">&lt;/resource&gt;</span>
    <span style="color: #b58900">&lt;/resources&gt;</span>
    <span style="color: #b58900">&lt;testResources&gt;</span>
      <span style="color: #b58900">&lt;testResource&gt;</span>
        <span style="color: #b58900">&lt;directory&gt;</span>src/test/resources<span style="color: #b58900">&lt;/directory&gt;</span>
        <span style="color: #b58900">&lt;filtering&gt;</span>true<span style="color: #b58900">&lt;/filtering&gt;</span>
      <span style="color: #b58900">&lt;/testResource&gt;</span>
    <span style="color: #b58900">&lt;/testResources&gt;</span>
    <span style="color: #b58900">&lt;pluginManagement&gt;</span>
      <span style="color: #b58900">&lt;plugins&gt;</span>
        <span style="color: #b58900">&lt;plugin&gt;</span>
          <span style="color: #b58900">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #b58900">&lt;/groupId&gt;</span>
          <span style="color: #b58900">&lt;artifactId&gt;</span>maven-resources-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
          <span style="color: #b58900">&lt;version&gt;</span>3.3.1<span style="color: #b58900">&lt;/version&gt;</span>
          <span style="color: #b58900">&lt;configuration&gt;</span>
            <span style="color: #b58900">&lt;nonFilteredFileExtensions&gt;</span>
              <span style="color: #b58900">&lt;nonFilteredFileExtension&gt;</span>p12<span style="color: #b58900">&lt;/nonFilteredFileExtension&gt;</span>
              <span style="color: #b58900">&lt;nonFilteredFileExtension&gt;</span>crt<span style="color: #b58900">&lt;/nonFilteredFileExtension&gt;</span>
              <span style="color: #b58900">&lt;nonFilteredFileExtension&gt;</span>pem<span style="color: #b58900">&lt;/nonFilteredFileExtension&gt;</span>
            <span style="color: #b58900">&lt;/nonFilteredFileExtensions&gt;</span>
          <span style="color: #b58900">&lt;/configuration&gt;</span>
        <span style="color: #b58900">&lt;/plugin&gt;</span>
        <span style="color: #b58900">&lt;plugin&gt;</span>
          <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
          <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
          <span style="color: #b58900">&lt;version&gt;</span>${mule.maven.plugin.version}<span style="color: #b58900">&lt;/version&gt;</span>
          <span style="color: #b58900">&lt;extensions&gt;</span>true<span style="color: #b58900">&lt;/extensions&gt;</span>
          <span style="color: #b58900">&lt;configuration&gt;</span>
          <span style="color: #b58900">&lt;/configuration&gt;</span>
        <span style="color: #b58900">&lt;/plugin&gt;</span>
      <span style="color: #b58900">&lt;/plugins&gt;</span>
    <span style="color: #b58900">&lt;/pluginManagement&gt;</span>
  <span style="color: #b58900">&lt;/build&gt;</span>

  <span style="color: #b58900">&lt;dependencyManagement&gt;</span>
    <span style="color: #b58900">&lt;dependencies&gt;</span>
      <span style="color: #b58900">&lt;dependency&gt;</span>
        <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
        <span style="color: #b58900">&lt;artifactId&gt;</span>mule-http-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
        <span style="color: #b58900">&lt;version&gt;</span>1.7.3<span style="color: #b58900">&lt;/version&gt;</span>
        <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
      <span style="color: #b58900">&lt;/dependency&gt;</span>
      <span style="color: #b58900">&lt;dependency&gt;</span>
        <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
        <span style="color: #b58900">&lt;artifactId&gt;</span>mule-apikit-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
        <span style="color: #b58900">&lt;version&gt;</span>1.9.1<span style="color: #b58900">&lt;/version&gt;</span>
        <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
      <span style="color: #b58900">&lt;/dependency&gt;</span>
    <span style="color: #b58900">&lt;/dependencies&gt;</span>
  <span style="color: #b58900">&lt;/dependencyManagement&gt;</span>

  <span style="color: #b58900">&lt;repositories&gt;</span>
    <span style="color: #b58900">&lt;repository&gt;</span>
      <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3<span style="color: #b58900">&lt;/id&gt;</span>
      ...
    <span style="color: #b58900">&lt;/repository&gt;</span>
    <span style="color: #b58900">&lt;repository&gt;</span>
      <span style="color: #b58900">&lt;id&gt;</span>mulesoft-releases<span style="color: #b58900">&lt;/id&gt;</span>
      ...
    <span style="color: #b58900">&lt;/repository&gt;</span>
  <span style="color: #b58900">&lt;/repositories&gt;</span>
  <span style="color: #b58900">&lt;pluginRepositories&gt;</span>
    <span style="color: #b58900">&lt;pluginRepository&gt;</span>
      <span style="color: #b58900">&lt;id&gt;</span>mulesoft-releases<span style="color: #b58900">&lt;/id&gt;</span>
      ...
    <span style="color: #b58900">&lt;/pluginRepository&gt;</span>
  <span style="color: #b58900">&lt;/pluginRepositories&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM uses the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API does not support dynamic parameters within groupIds such as ${aa.ap.org.id} and it requires the value to be the hardcoded Anypoint Platform organization ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API does not support dynamic parameters, such as setting the asset version to 1.0.${revision}.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In rare circumstances, such as when a hotfix to a Mule runtime is released, there is a need to distinguish between the full version of the runtime (4.4.0-20230522) and the simplified version of that same runtime (4.4.0, which follows semantic versioning (semver) rules). You anticipate this need by defining two separate Maven properties for the Mule runtime version.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By wrapping &lt;dependencies /&gt; into &lt;dependencyManagement /&gt; you default the version of these dependencies for all child projects, while allowing child projects to bring in these dependencies as needed.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By defining the Mule Maven plugin inside &lt;pluginManagement /&gt; you default the version and configuration of this plugin for all child projects, while allowing child projects to execute this plugins as needed. Mule apps will always want to execute this plugin, while other Maven projects will not.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By defining the Maven Resources plugin inside &lt;pluginManagement /&gt; you default the version and configuration of this plugin for all child projects. But this is a standard Maven plugin that is always executed during a normal Maven build, so child projects do not have to explicitly request execution of this plugin, like they have to do for the Mule Maven plugin.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This parent POM does not impose any actual dependencies or plugin executions on its child POMs.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Do not manage the dependency on check-in-papi in the parent POM: there is currently no value in doing so. Shortly you will simply define the un-managed dependency in check-in-papi&#8217;s pom.xml.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Do not manage the dependency on the Sockets Connector in the parent POM, as this is added automatically as a transitive dependency of the HTTP Connector. Shortly you will also remove the Sockets Connector from check-in-papi&#8217;s pom.xml.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Turn POM into child POM:</strong> Change <strong>pom.xml</strong> into a child POM by defining <strong>parent-pom/pom.xml</strong> as its parent POM and removing all configuration inherited from that parent POM, such as dependency versions:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;modelVersion&gt;</span>4.0.0<span style="color: #b58900">&lt;/modelVersion&gt;</span>
  <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
    <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
  <span style="color: #b58900">&lt;/parent&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>a63e6d25-8aaf-4512-b36d-d91b90a55c4a<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>check-in-papi-app<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;packaging&gt;</span>mule-application<span style="color: #b58900">&lt;/packaging&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>check-in-papi<span style="color: #b58900">&lt;/name&gt;</span>

  <span style="color: #b58900">&lt;properties&gt;</span>
    <span style="color: #b58900">&lt;api.groupId&gt;</span>6ebe1206-ddb1-4f2a-b06e-dca3244ebbad<span style="color: #b58900">&lt;/api.groupId&gt;</span>
    <span style="color: #b58900">&lt;api.artifactId&gt;</span>check-in-papi<span style="color: #b58900">&lt;/api.artifactId&gt;</span>
    <span style="color: #b58900">&lt;api.version&gt;</span>1.0.0<span style="color: #b58900">&lt;/api.version&gt;</span>
  <span style="color: #b58900">&lt;/properties&gt;</span>

  <span style="color: #b58900">&lt;build&gt;</span>
    <span style="color: #b58900">&lt;plugins&gt;</span>
      <span style="color: #b58900">&lt;plugin&gt;</span>
        <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
        <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;/plugin&gt;</span>
    <span style="color: #b58900">&lt;/plugins&gt;</span>
  <span style="color: #b58900">&lt;/build&gt;</span>

  <span style="color: #b58900">&lt;dependencies&gt;</span>
    <span style="color: #b58900">&lt;dependency&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>${api.groupId}<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>${api.artifactId}<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;version&gt;</span>${api.version}<span style="color: #b58900">&lt;/version&gt;</span>
      <span style="color: #b58900">&lt;classifier&gt;</span>oas<span style="color: #b58900">&lt;/classifier&gt;</span>
      <span style="color: #b58900">&lt;type&gt;</span>zip<span style="color: #b58900">&lt;/type&gt;</span>
    <span style="color: #b58900">&lt;/dependency&gt;</span>
    <span style="color: #b58900">&lt;dependency&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>mule-http-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
    <span style="color: #b58900">&lt;/dependency&gt;</span>
    <span style="color: #b58900">&lt;dependency&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>mule-apikit-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
    <span style="color: #b58900">&lt;/dependency&gt;</span>
  <span style="color: #b58900">&lt;/dependencies&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because you use a monorepo, the POM can safely load the parent POM through its relative path in the parent directory.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You define a dependency on the Check-In PAPI API specification, which is not managed in the parent POM, and must therefore include the &lt;version /&gt; element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You define dependencies on APIkit and HTTP Connector, which are managed in the parent POM, and therefore do not require a &lt;version /&gt; element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Due to a current limitation in Mule Maven tooling, the dependency on the HTTP Connector must be defined before the dependency on APIkit.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You define the execution of the Mule Maven plugin without repeating its configuration, because that is inherited from the parent POM.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the API as before; this should return an HTTP 200 OK response.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt2-2-introduce-bom"><a class="anchor" href="#wt2-2-introduce-bom"></a><a class="link" href="#wt2-2-introduce-bom">Centralize Maven dependency and plugin versions in a BOM</a></h4>
<div class="paragraph">
<p>The parent POM introduced in the previous section combines plugin configuration and the definition ("management") of versions of dependencies and plugins. Configuration and version management typically change on a different timescale: once a project has matured, it is more common to update the version of dependencies or plugins, than it is to change the configuration of plugins.</p>
</div>
<div class="paragraph">
<p>In this section, you separate version management of Maven dependencies and Maven plugins into its own special kind of parent POM — a BOM. Instead of building the BOM by hand, however, you use AnyAirline&#8217;s standard BOM for Mule apps. This is a BOM that manages the complete set of Maven dependencies and plugins used by AnyAirline and in all walkthroughs of this course.</p>
</div>
<div class="paragraph">
<p>A BOM — short for Bill Of Materials — is, by convention, a kind of parent POM that only defines the versions of Maven dependencies, including the versions of Maven plugin dependencies.
A generic parent POM, on the other hand, has a broader purpose than a BOM and may also define configurations for Maven plugins and other elements of the build that go beyond simply managing versions. If a BOM is used together with a generic parent POM, like here, then it is good practice that the parent POM contains no version management at all, as this is done exclusively in the BOM.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="20">
<li>
<p><strong>Identify dependency versions:</strong> In <strong>parent-pom/pom.xml</strong> and identify all <strong>&lt;version /&gt;</strong> elements of dependencies, either of a Maven plugin or normal Maven dependency.</p>
</li>
<li>
<p><strong>Copy AnyAirline&#8217;s BOM:</strong> Copy AnyAirline&#8217;s complete <strong>bom/pom.xml</strong> into an new <strong>bom</strong> directory within the Studio workspace directory; from now on you will be using this BOM, which already manages all relevant dependencies:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">mkdir </span>bom
<span style="color: #586e75">cp</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devprd/module02/wt2-2_solution/bom/pom.xml bom</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is AnyAirline&#8217;s BOM, which manages all dependencies defined in your current parent POM — and many more.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Both parent-pom/pom.xml and bom/pom.xml now reside in the parent directory of the check-in-papi project.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study BOM:</strong> Browse the content of the bom/pom.xml, identifying the overlap with parent-pom/pom.xml in terms of the definition of Maven properties, &lt;dependencyManagement /&gt;, &lt;pluginManagement /&gt;, and the repositories where these dependencies can be retrieved from.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Defining Maven properties for all versions makes changing these versions even easier.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>BOMs by convention never impose any actual dependencies or plugin executions on their child projects — they just tie down dependency versions.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update groupId:</strong> Update bom/pom.xml adapting the Maven coordinates to match the groupId of your Anypoint Platform organization ID:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-bom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM uses the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Turn parent POM into child POM of BOM:</strong> Change <strong>parent-pom/pom.xml</strong> into a child POM of bom/pom.xml by defining <strong>bom/pom.xml</strong> as its parent POM and removing all configuration now inherited from the BOM: &lt;dependencyManagement /&gt;, &lt;repositories /&gt;, and all &lt;version /&gt; elements of Maven plugins:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;modelVersion&gt;</span>4.0.0<span style="color: #b58900">&lt;/modelVersion&gt;</span>
  <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-bom<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
    <span style="color: #b58900">&lt;relativePath&gt;</span>../bom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
  <span style="color: #b58900">&lt;/parent&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;packaging&gt;</span>pom<span style="color: #b58900">&lt;/packaging&gt;</span>
  <span style="color: #b58900">&lt;name&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/name&gt;</span>

  <span style="color: #b58900">&lt;build&gt;</span>
    <span style="color: #b58900">&lt;resources&gt;</span>...<span style="color: #b58900">&lt;/resources&gt;</span>
    <span style="color: #b58900">&lt;testResources&gt;</span>...<span style="color: #b58900">&lt;/testResources&gt;</span>
    <span style="color: #b58900">&lt;pluginManagement&gt;</span>
      <span style="color: #b58900">&lt;plugins&gt;</span>
        <span style="color: #b58900">&lt;plugin&gt;</span>
          <span style="color: #b58900">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color: #b58900">&lt;/groupId&gt;</span>
          <span style="color: #b58900">&lt;artifactId&gt;</span>maven-resources-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
          <span style="color: #b58900">&lt;configuration&gt;</span>...<span style="color: #b58900">&lt;/configuration&gt;</span>
        <span style="color: #b58900">&lt;/plugin&gt;</span>
        <span style="color: #b58900">&lt;plugin&gt;</span>
          <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
          <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
          <span style="color: #b58900">&lt;extensions&gt;</span>true<span style="color: #b58900">&lt;/extensions&gt;</span>
          <span style="color: #b58900">&lt;configuration</span> <span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;/plugin&gt;</span>
      <span style="color: #b58900">&lt;/plugins&gt;</span>
    <span style="color: #b58900">&lt;/pluginManagement&gt;</span>
  <span style="color: #b58900">&lt;/build&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM is both a parent POM of check-in-papi&#8217;s POM as well as a child POM of the BOM. It has no &lt;version /&gt; elements for plugins or dependencies because it inherits all those from the BOM.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM uses the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The configuration of the Mule Maven plugin will soon get much more involved, making it more obvious why it is beneficial to encapsulate it into this parent POM rather than repeating it in all child POMs.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the API as before; this should return an HTTP 200 OK response.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-123"><a class="anchor" href="#wt-begin-123"></a><a class="link" href="#wt-begin-123">Walkthrough 2-3: Build and deploy Mule applications with Maven</a></h3>
<div class="paragraph">
<p>The check-in-papi Mule app you have developed so far relies on Studio populating the local Maven repository with artifacts (libraries) that are needed for the Maven build of Mule apps. For many real-world scenarios, additional Maven configuration is needed to perform Maven builds reproducibly and independently of Studio. Another common feature of real-world Maven builds of Mule apps is automated deployment to CloudHub 2.0.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you address both of these common requirements for your Maven build of check-in-papi and future Mule apps.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_install_a_maven_settings_xml">Install a Maven settings.xml</a>.</p>
</li>
<li>
<p><a href="#wt2-3-deploy-to-ch">Deploy to CloudHub using the Mule Maven plugin</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_4"><a class="anchor" href="#_solution_file_4"></a><a class="link" href="#_solution_file_4">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_3"><a class="anchor" href="#_starting_file_3"></a><a class="link" href="#_starting_file_3">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_install_a_maven_settings_xml"><a class="anchor" href="#_install_a_maven_settings_xml"></a><a class="link" href="#_install_a_maven_settings_xml">Install a Maven settings.xml</a></h4>
<div class="paragraph">
<p>In this section, you create a global Maven settings.xml that allows a Maven build outside of Studio to retrieve artifacts — such as the Check-In PAPI API specification — from your Anypoint Platform organization&#8217;s Exchange.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of check-in-papi and run a Maven build of this Mule app; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If Studio had not populated the local Maven repository with all required artifacts, this build would have failed (unless you already have a suitable settings.xml installed). You will prove this by deleting the local Maven repository at ~/.m2/repository and re-running the build.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Discover remote Maven repos:</strong> Inspect <strong>bom/pom.xml</strong> and note the Maven repositories which Studio added when creating the Mule app project; one of these repositories is Exchange, the other a MuleSoft public repository — the former requires authentication.</p>
</li>
<li>
<p><strong>Delete local Maven repo:</strong> From your local Maven repository, delete some artifacts that were put there by Studio:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">rm</span> <span style="color: #b58900">-rf</span> ~/.m2/repository/<span style="color: #6c71c4">*</span>-<span style="color: #6c71c4">*</span>-<span style="color: #6c71c4">*</span>-<span style="color: #6c71c4">*</span>-<span style="color: #6c71c4">*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This command is likely to delete all artifacts downloaded from any Exchange.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You refrain from deleting the entire local Maven repository, because re-populating it just by downloading Maven dependencies would take too long. The above partial delete suffices to prove the point.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Re-run the Maven build from a command-line interface; this should now fail due to unresolvable dependencies.</p>
</li>
<li>
<p><strong>Create Exchange Viewer Connected App:</strong> In <strong>Anypoint Access Management</strong>, create a new <strong>Connected App</strong> that acts on its <strong>own behalf (client credentials)</strong>, for reading assets from Exchange, adding the <strong>Exchange Viewer</strong> scope and retrieve its client ID and secret.</p>
</li>
<li>
<p><strong>Create settings.xml:</strong> In a text editor, create <strong>settings.xml</strong> in <strong>~/.m2/</strong> with credentials for reading from your Anypoint Platform organization&#8217;s Exchange as a Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;settings&gt;</span>
  <span style="color: #b58900">&lt;servers&gt;</span>
    <span style="color: #b58900">&lt;server&gt;</span>
      <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3<span style="color: #b58900">&lt;/id&gt;</span>
      <span style="color: #b58900">&lt;username&gt;</span>~~~Client~~~<span style="color: #b58900">&lt;/username&gt;</span>
      <span style="color: #b58900">&lt;password&gt;</span>your-capp-viewer-cid~?~your-capp-viewer-secret<span style="color: #b58900">&lt;/password&gt;</span>
    <span style="color: #b58900">&lt;/server&gt;</span>
  <span style="color: #b58900">&lt;/servers&gt;</span>
<span style="color: #b58900">&lt;/settings&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can also use Anypoint Platform credentials for an account of your Anypoint Platform organization with which you were able to search your Exchange — such as the trial account credentials created previously. However, it is best practice to use a Connected App for security.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To use Connected App authentication, provide basic authentication and define the username as ~~~Client~~~ and the password as clientID~?~clientSecret. Replace clientID with the client ID. Replace clientSecret with the client secret.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Maven allows passwords in settings.xml to be encrypted, but this is not done here for simplicity&#8217;s sake.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The server entry in settings.xml and the repository entry in the BOM are matched by the common ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>All Exchange Maven repositories use the same URL (and, by default, also the same ID); their content is determined by the credentials used.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because the above settings.xml entry uses the default Exchange repository ID, it is dangerous: whenever this user-wide Maven configuration is in use, all default Exchange repository definitions (which use the default repository ID) in any POM, regardless of what project the POM belongs to, will access your Anypoint Platform organization&#8217;s Exchange. For this reason, it is typically recommended to change repository IDs to be unique to the actual Exchange being accessed, for example by appending the organization ID to the repository ID. You will do this in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, re-run a Maven build of check-in-papi as before; this should now succeed.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt2-3-deploy-to-ch"><a class="anchor" href="#wt2-3-deploy-to-ch"></a><a class="link" href="#wt2-3-deploy-to-ch">Deploy to CloudHub using the Mule Maven plugin</a></h4>
<div class="paragraph">
<p>In this section, you extend the existing Maven build configuration to perform automated deployments to CloudHub 2.0. To do so you add the relevant configuration for the Mule Maven plugin to the parent POM and create a Connected App for authentication. You then deploy check-in-papi to Exchange and the CloudHub 2.0 prod environment from the Maven command-line interface, passing the client ID and secret required by the uplink to the Anypoint Platform control plane as command-line arguments to Maven.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p><strong>Configure CloudHub 2.0 deployment:</strong> Add to the <strong>parent POM</strong> the <strong>Mule Maven plugin</strong> configuration for a simple deployment to a CloudHub 2.0 Shared Space, utilising Object Store v2:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;configuration&gt;</span>
  <span style="color: #b58900">&lt;cloudhub2Deployment&gt;</span>
    <span style="color: #b58900">&lt;businessGroup/&gt;</span>
    <span style="color: #b58900">&lt;environment&gt;</span>prod<span style="color: #b58900">&lt;/environment&gt;</span>
    <span style="color: #b58900">&lt;muleVersion&gt;</span>${app.runtime.semver}<span style="color: #b58900">&lt;/muleVersion&gt;</span>
    <span style="color: #b58900">&lt;target&gt;</span>Cloudhub-US-East-2<span style="color: #b58900">&lt;/target&gt;</span>
    <span style="color: #b58900">&lt;provider&gt;</span>MC<span style="color: #b58900">&lt;/provider&gt;</span>
    <span style="color: #b58900">&lt;replicas&gt;</span>1<span style="color: #b58900">&lt;/replicas&gt;</span>
    <span style="color: #b58900">&lt;vCores&gt;</span>0.1<span style="color: #b58900">&lt;/vCores&gt;</span>
    <span style="color: #b58900">&lt;applicationName&gt;</span>${project.name}<span style="color: #b58900">&lt;/applicationName&gt;</span>
    <span style="color: #b58900">&lt;connectedAppClientId&gt;</span>${ap.ca.client_id}<span style="color: #b58900">&lt;/connectedAppClientId&gt;</span>
    <span style="color: #b58900">&lt;connectedAppClientSecret&gt;</span>${ap.ca.client_secret}<span style="color: #b58900">&lt;/connectedAppClientSecret&gt;</span>
    <span style="color: #b58900">&lt;connectedAppGrantType&gt;</span>client_credentials<span style="color: #b58900">&lt;/connectedAppGrantType&gt;</span>
    <span style="color: #b58900">&lt;properties&gt;</span>
      <span style="color: #b58900">&lt;anypoint.platform.client_id&gt;</span>${ap.client_id}<span style="color: #b58900">&lt;/anypoint.platform.client_id&gt;</span>
      <span style="color: #b58900">&lt;anypoint.platform.client_secret&gt;</span>${ap.client_secret}<span style="color: #b58900">&lt;/anypoint.platform.client_secret&gt;</span>
    <span style="color: #b58900">&lt;/properties&gt;</span>
    <span style="color: #b58900">&lt;deploymentSettings&gt;</span>
      <span style="color: #b58900">&lt;http&gt;</span>
        <span style="color: #b58900">&lt;inbound&gt;</span>
          <span style="color: #b58900">&lt;lastMileSecurity&gt;</span>true<span style="color: #b58900">&lt;/lastMileSecurity&gt;</span>
        <span style="color: #b58900">&lt;/inbound&gt;</span>
      <span style="color: #b58900">&lt;/http&gt;</span>
    <span style="color: #b58900">&lt;/deploymentSettings&gt;</span>
    <span style="color: #b58900">&lt;integrations&gt;</span>
      <span style="color: #b58900">&lt;services&gt;</span>
        <span style="color: #b58900">&lt;objectStoreV2&gt;</span>
          <span style="color: #b58900">&lt;enabled&gt;</span>true<span style="color: #b58900">&lt;/enabled&gt;</span>
        <span style="color: #b58900">&lt;/objectStoreV2&gt;</span>
      <span style="color: #b58900">&lt;/services&gt;</span>
    <span style="color: #b58900">&lt;/integrations&gt;</span>
  <span style="color: #b58900">&lt;/cloudhub2Deployment&gt;</span>
<span style="color: #b58900">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This configuration applies by default to all Maven child projects.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This configuration uses a Connected App client ID and secret for authentication, which you will create shortly.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Instead of using Connected Apps, you can use a &lt;server /&gt; that refers to an entry in settings.xml to authenticate using an Anypoint Platform account. However, this does not support using Connected App client ID and secret as Maven credentials.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You explicitly deploy to the master (root) Anypoint Platform organization, rather than a business group therein, by leaving &lt;businessGroup /&gt; empty.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule runtime version must be specified via the simplified, semantic version (4.4.0) rather than the full version (4.4.0-20230522). Of course, this only applies in the rare cases where there is a difference between these two version strings.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>client ID and secret are directly passed to the Mule app, but need to be set on the Maven command-line interface.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The prod environment is hard-coded for the moment, and you will correct this in a later walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Anypoint Platform trial accounts can only deploy to 1 worker in usa-e2 (Ohio), so these values are hard-coded.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To use as few vCores as possible, you hard-code deployment to 0.1.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study and update BOM distributionManagement:</strong> Notice and update the Maven property: <strong>student.deployment.ap.orgid</strong>, replacing the entire value with your Anypoint Platform organization used to configure the <strong>&lt;distributionManagement /&gt;</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;student.deployment.ap.orgid&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/student.deployment.ap.orgid&gt;</span>
<span style="color: #b58900">&lt;/properties&gt;</span>
...
<span style="color: #b58900">&lt;repositories&gt;</span>
  <span style="color: #b58900">&lt;repository&gt;</span>
    <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
    <span style="color: #b58900">&lt;name&gt;</span>Anypoint Exchange<span style="color: #b58900">&lt;/name&gt;</span>
    <span style="color: #b58900">&lt;url&gt;</span>https://maven.anypoint.mulesoft.com/api/v3/maven<span style="color: #b58900">&lt;/url&gt;</span>
  <span style="color: #b58900">&lt;/repository&gt;</span>
  ...
<span style="color: #b58900">&lt;/repositories&gt;</span>

<span style="color: #b58900">&lt;distributionManagement&gt;</span>
  <span style="color: #b58900">&lt;repository&gt;</span>
    <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
    <span style="color: #b58900">&lt;name&gt;</span>AnyAirline Anypoint Exchange<span style="color: #b58900">&lt;/name&gt;</span>
    <span style="color: #b58900">&lt;url&gt;</span>https://maven.anypoint.mulesoft.com/api/v3/organizations/${student.deployment.ap.orgid}/maven<span style="color: #b58900">&lt;/url&gt;</span>
    <span style="color: #b58900">&lt;layout&gt;</span>default<span style="color: #b58900">&lt;/layout&gt;</span>
  <span style="color: #b58900">&lt;/repository&gt;</span>
<span style="color: #b58900">&lt;/distributionManagement&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Replace the entire contents of the property with your value and not any other properties the value currently references.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create Exchange Contributor Connected App:</strong> In <strong>Anypoint Access Management</strong>, create a new <strong>Connected App</strong> that acts on its <strong>own behalf (client credentials)</strong>, for writing assets to Exchange, adding the <strong>Exchange Contributor</strong> scope and retrieve its client ID and secret.</p>
</li>
<li>
<p><strong>Update settings.xml:</strong> Change in settings.xml the credentials of the matching <strong>server</strong> entry for the repository defined in the distributionManagement section of the bom/pom.xml to use the Connected App credentials created previously for writing to that repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;server&gt;</span>
  <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
  <span style="color: #b58900">&lt;username&gt;</span>~~~Client~~~<span style="color: #b58900">&lt;/username&gt;</span>
  <span style="color: #b58900">&lt;password&gt;</span>your-capp-contributor-cid~?~your-capp-contributor-secret<span style="color: #b58900">&lt;/password&gt;</span>
<span style="color: #b58900">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Only the Exchange Connected App is configured the Maven settings.xml, not the CloudHub Connected App as the Mule Maven plugin does not support using Connected App client ID and secret as Maven credentials and must be configured directly in the plugin configuration.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can also use Anypoint Platform credentials for an account of your Anypoint Platform organization with which you were able to search your Exchange — such as the trial account credentials created previously. However, it is best practice to use a Connected App for security.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To use Connected App authentication, provide basic authentication and define the username as ~~~Client~~~ and the password as clientID~?~clientSecret. Replace clientID with the client ID. Replace clientSecret with the client secret.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Ensure parent POMs use release versions:</strong> Ensure the <strong>BOM</strong>, <strong>parent POM</strong> and check-in-papi artifact version is a release version and not a SNAPSHOT:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-bom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../bom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Although Exchange supports SNAPSHOT versions, not all Anypoint Platform components support them such as RTF. Therefore, for consistency you will use release versions for all dependencies and release and increase version numbers before every CloudHub 2.0 deployment.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy application to Exchange:</strong> Deploy check-in-papi to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean deploy</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><em>
<em>Note:</em> <em>With CloudHub 1.0 and Standalone Mule runtimes, applications are deployed to a Mule runtime directly. CloudHub 2.0 and Runtime Fabric are container based platforms and require the application binary to be deployed to Exchange first as a persistent store so the application can be retrieved and used to scale containers or recover failed containers.</em>
</em></p>
</div>
</li>
<li>
<p><strong>Create CloudHub Deployment Connected App:</strong> In <strong>Anypoint Access Management</strong>, create a new <strong>Connected App</strong> that acts on its <strong>own behalf (client credentials)</strong>, for deployment to CH, adding the <strong>Cloudhub Organization Admin</strong>, <strong>Create Applications</strong>, <strong>Delete Applications</strong>, <strong>Read Applications</strong>, <strong>View Environment</strong>, <strong>View Organization</strong> and <strong>Design Center Developer</strong> scopes and applying to all environments and retrieve its client ID and secret.</p>
</li>
<li>
<p><strong>Maven-deploy:</strong> In a command-line interface, deploy to CloudHub 2.0 using the Mule Maven plugin, supplying the same client ID and secret of your Anypoint Platform organization as previously and the client ID and secret of your CloudHub Deployment Connected App; this should result in a successful build:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">-DmuleDeploy</span> deploy <span style="color: #b58900">-Dap</span>.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-client-id&gt; <span style="color: #b58900">-Dap</span>.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-client-secret&gt;
  <span style="color: #b58900">-Dap</span>.ca.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-id&gt; <span style="color: #b58900">-Dap</span>.ca.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-secret&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The supplied system properties match the Mule Maven plugin configuration.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>For the Mule Maven plugin to execute a deployment, the Maven lifecycle phase and the shown system property must both be specified.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This triggers a deploy or re-deploy, depending on whether a CloudHub deployment with the given name already exists or not.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Locate fully qualified domain name:</strong> In <strong>Runtime Manager</strong>, verify the successful deployment of check-in-papi to the <strong>prod</strong> environment and copy the API&#8217;s endpoint URL with the additional six-character uniq-id and shard.</p>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the API using this endpoint URL; this should return an HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Ensure to replace the placeholders for the six-character unique id and shard for your individual application.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Check log:</strong> In <strong>Runtime Manager</strong>, inspect the log entries as before.</p>
</li>
<li>
<p><strong>Check API instance:</strong> In <strong>API Manager</strong>, the status of the corresponding API instance should (still) be active/green.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-124"><a class="anchor" href="#wt-begin-124"></a><a class="link" href="#wt-begin-124">Walkthrough 2-4: Configure secure environment properties</a></h3>
<div class="paragraph">
<p>The current implementation of check-in-papi supports configuration for and deployment to just one environment — and where necessary you have chosen this to be the prod environment. In this walkthrough, you extend check-in-papi and its Maven build to support additional environments. Furthermore, you will protect sensitive property values in Runtime Manager by stopping the cleartext display for these values.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_configure_a_mule_app_for_different_runtime_environments">Configure a Mule app for different runtime environments</a>.</p>
</li>
<li>
<p><a href="#wt2-4-encrypt-sensitive-props">Encrypt sensitive Mule app configuration properties</a>.</p>
</li>
<li>
<p><a href="#_protect_sensitive_mule_app_configuration_properties_in_runtime_manager">Protect sensitive Mule app configuration properties in Runtime Manager</a>.</p>
</li>
<li>
<p><a href="#_deploy_the_same_mule_app_to_different_cloudhub_environments">Deploy the same Mule app to different CloudHub environments</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_5"><a class="anchor" href="#_solution_file_5"></a><a class="link" href="#_solution_file_5">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_4"><a class="anchor" href="#_starting_file_4"></a><a class="link" href="#_starting_file_4">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configure_a_mule_app_for_different_runtime_environments"><a class="anchor" href="#_configure_a_mule_app_for_different_runtime_environments"></a><a class="link" href="#_configure_a_mule_app_for_different_runtime_environments">Configure a Mule app for different runtime environments</a></h4>
<div class="paragraph">
<p>In this section, you introduce environment-specific configuration to check-in-papi. You extract all environment-specific configuration properties, including the filenames and passwords of keystores, into their respective environment-specific properties file. You then create API instances for Check-In PAPI in the dev and test Anypoint Platform environments and complete the autodiscovery configuration of check-in-papi for these environments.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Add env property:</strong> In Studio, near the top of <strong>global.xml</strong>, define a property env that will at runtime always hold the identifier of the environment in which the Mule app currently executes, and default this value to dev:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;global-property</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"env"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"dev"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Every Mule runtime in which check-in-papi executes has to identify the environment to which it belongs by setting env, otherwise it will be taken to be in the dev environment.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Read env-dependent props file:</strong> Just below, read from a properties file whose name contains the current environment, such as <strong>dev-properties.yaml</strong>; these files will contain environment-dependent properties:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;configuration-properties</span> <span style="color: #268bd2">file=</span><span style="color: #859900">"${env}-properties.yaml"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;configuration-properties</span> <span style="color: #268bd2">file=</span><span style="color: #859900">"properties.yaml"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>With this ordering, environment-dependent properties are defined before, and take precedence over, environment-independent properties. Also, the latter can refer to the former, but not the other way round.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create prod-dependent props file:</strong> Create prod-dependent configuration file <strong>prod-properties.yaml</strong> in <strong>src/main/resources</strong> to add explicit support for the prod environment and move all environment-dependent properties from <strong>properties.yaml</strong> to <strong>prod-properties.yaml</strong>, because so far you have only made use of the prod environment:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">prod-properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">id</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">15678353"</span>

<span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">type</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">pkcs12"</span>
  <span style="color: #268bd2">path</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">check-in-papi.p12"</span>
  <span style="color: #268bd2">alias</span><span style="color: #93a1a1">:</span>       <span style="color: #859900">"</span><span style="color: #859900">server"</span>
  <span style="color: #268bd2">password</span><span style="color: #93a1a1">:</span>    <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span>
  <span style="color: #268bd2">keyPassword</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You hereby assume — very realistically — that different environments use independent certificates and keystores for exposing HTTPS endpoints.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create keystores for dev and test:</strong> Copy <strong>check-in-papi.p12</strong> to <strong>check-in-papi-dev.p12</strong> and <strong>check-in-papi-test.p12</strong>; this simulates the creation of independent certificates and keystores for all three environments.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>This "simulation" leads to keystores and passwords (for keystores and keys) that are the same in all environments, which is of course not generally recommended.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If time permits actually create independent keypairs and keystores as <a href="#create-cert-and-keystore-for-exposing-https">before</a>.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The naming convention for certificates, as applied here, is the same as for CloudHub hostnames: the dev and test environments use the respective environment suffix -dev and -test, respectively, while the prod environment does not use a suffix. This is just a convention.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Move keystores:</strong> Move all keystores to a new directory <strong>src/main/resources/certs</strong> to separate properties files from keystores.</p>
</li>
<li>
<p><strong>Update path property:</strong> Correct the keystore path in <strong>prod-properties.yaml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">prod-properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">path</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">certs/check-in-papi.p12"</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create dev-dependent props file:</strong> Copy <strong>prod-properties.yaml</strong> to <strong>dev-properties.yaml</strong> and change the latter to add explicit support for the dev environment:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">dev-properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">id</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">"</span>

<span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">type</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">pkcs12"</span>
  <span style="color: #268bd2">path</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">certs/check-in-papi-dev.p12"</span>
  <span style="color: #268bd2">alias</span><span style="color: #93a1a1">:</span>       <span style="color: #859900">"</span><span style="color: #859900">server"</span>
  <span style="color: #268bd2">password</span><span style="color: #93a1a1">:</span>    <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span>
  <span style="color: #268bd2">keyPassword</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You don&#8217;t know the API ID in dev yet.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The passwords are the same in all environments because you just copied the keystores.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create test-dependent props file:</strong> Copy <strong>prod-properties.yaml</strong> to <strong>test-properties.yaml</strong> and change the latter to add explicit support for the test environment:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">test-properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">id</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">"</span>

<span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">type</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">pkcs12"</span>
  <span style="color: #268bd2">path</span><span style="color: #93a1a1">:</span>        <span style="color: #859900">"</span><span style="color: #859900">certs/check-in-papi-test.p12"</span>
  <span style="color: #268bd2">alias</span><span style="color: #93a1a1">:</span>       <span style="color: #859900">"</span><span style="color: #859900">server"</span>
  <span style="color: #268bd2">password</span><span style="color: #93a1a1">:</span>    <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span>
  <span style="color: #268bd2">keyPassword</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You don&#8217;t know the API ID in test yet.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The passwords are the same in all environments because you just copied the keystores.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create API instance in test:</strong> In <strong>API Manager</strong>, go to the <strong>test</strong> environment and create a new API instance for Check-In PAPI by promoting the existing instance from the <strong>prod</strong> environment and then fixing the implementation and consumer URLs by appending <strong>-test</strong> to the hostname, such as check-in-papi-test; remember the API ID of this API instance.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The -test hostname suffix is the same as for the respective keystore above, and its necessity will become clear shortly.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Promotion is typically done from a lower environment (test) to a higher environment (prod) not the other way round like here. You do "reverse promotion" here because you started in prod.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create API instance in dev:</strong> In <strong>API Manager</strong>, go to the <strong>dev</strong> environment and create a new API instance for Check-In PAPI by promoting the existing instance from the <strong>test</strong> environment and then fixing the implementation and consumer URLs by appending <strong>-dev</strong> to the hostname, such as check-in-papi-dev; remember the API ID of this API instance.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The -dev hostname suffix is the same as for the respective keystore above, and its necessity will become clear shortly.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Promotion is typically done from a lower environment (dev) to a higher environment (test) not the other way round like here.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Apply automated policies in dev and test:</strong> Create <strong>automated policies</strong> in the dev and test environments, mirroring those in the prod environment.</p>
</li>
<li>
<p><strong>Update API IDs:</strong> Update <strong>dev-properties.yaml</strong> and <strong>test-properties.yaml</strong> with the API IDs for the newly created API instances in the dev and test environments, respectively.</p>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the API as before; this should return an HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This uses the default dev environment configuration.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Switch to test config:</strong> In Studio, change the <strong>run configuration</strong> by adding the following <strong>VM argument</strong> for <strong>env</strong>, to explicitly load the configuration for the test environment, then re-start the check-in-papi:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Denv</span><span style="color: #93a1a1">=</span><span style="color: #586e75">test</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Check API instance:</strong> In <strong>API Manager</strong>, the status of the corresponding API instance in the test environment, should now be active/green; this may take a few minutes; watch-out for the "unblocked" log entry in Runtime Manager, as before.</p>
</li>
<li>
<p><strong>Switch back to dev:</strong> Change to Studio run configuration back to the dev environment either by deleting the <strong>env</strong> VM argument or by changing its value to dev:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Denv</span><span style="color: #93a1a1">=</span>dev</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt2-4-encrypt-sensitive-props"><a class="anchor" href="#wt2-4-encrypt-sensitive-props"></a><a class="link" href="#wt2-4-encrypt-sensitive-props">Encrypt sensitive Mule app configuration properties</a></h4>
<div class="paragraph">
<p>In this section, you add the Secure Configuration Properties module to the Maven build and check-in-papi and use it to protect the values of sensitive properties, such as passwords. To do so you introduce environment-specific secure properties files, which contain values encrypted with the Secure Properties tool, and which are read and decrypted by the Secure Configuration Properties module. You start check-in-papi in Studio with the encryption key required by the Secure Configuration Properties module supplied as a Java system property.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="17">
<li>
<p><strong>Add Secure Configuration Properties module:</strong> In Studio, install from Exchange the Secure Configuration Properties module; this adds support for encrypted (secure) values in properties files.</p>
</li>
<li>
<p><strong>Locate Maven dependency:</strong> Locate in <strong>pom.xml</strong> the Maven dependency to Secure Configuration Properties module added by Studio.</p>
</li>
<li>
<p><strong>Use managed dependency:</strong> Locate in <strong>bom/pom.xml</strong> the existing entry in &lt;dependencyManagement /&gt; that defines the (default) version of Secure Configuration Properties module, and remove the corresponding &lt;version /&gt; from pom.xml.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>mule-secure-configuration-property-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You do not have to increment the version number of pom.xml itself, despite changing this file, because it uses a snapshot version.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Download Secure Properties tool:</strong> Download the Secure Properties tool from <strong><a href="https://docs.mulesoft.com/mule-runtime/4.4/_attachments/secure-properties-tool.jar" class="bare">https://docs.mulesoft.com/mule-runtime/4.4/_attachments/secure-properties-tool.jar</a></strong> to a filesystem location of your choice, such as /tmp:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl https://docs.mulesoft.com/mule-runtime/4.4/_attachments/secure-properties-tool.jar <span style="color: #b58900">-o</span> /tmp/secure-properties-tool.jar</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Move sensitive props:</strong> Extract all sensitive properties from <strong>dev-properties.yaml</strong> to a new file <strong>dev-secure-properties.yaml</strong>:</p>
<div class="listingblock">
<div class="title">dev-secure-properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">password</span><span style="color: #93a1a1">:</span>    <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span>
  <span style="color: #268bd2">keyPassword</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">mule12345"</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Encrypt secure props file for dev:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of check-in-papi and use <strong>Secure Properties tool</strong> to encrypt the values in <strong>dev-secure-properties.yaml</strong>, using Blowfish and CBC for encryption:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi/src/main/resources
java <span style="color: #b58900">-cp</span> /tmp/secure-properties-tool.jar com.mulesoft.tools.SecurePropertiesTool file encrypt Blowfish CBC secure12345 dev-secure-properties.yaml tmp.yaml
<span style="color: #586e75">mv </span>tmp.yaml dev-secure-properties.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Secure Properties tool does not allow you to change a properties file in place.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study encrypted values:</strong> Inspect the encrypted values in <strong>dev-secure-properties.yaml</strong>, to understand their syntax:</p>
<div class="listingblock">
<div class="title">dev-secure-properties.yaml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">tls.keystore</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">password</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">![c72bREVng+8ns4IMHA/S2Q==]"</span>
  <span style="color: #268bd2">keyPassword</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">![c72bREVng+8ns4IMHA/S2Q==]"</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Create secure props files for test and prod:</strong> Copy dev-secure-properties.yaml to <strong>test-secure-properties.yaml</strong> and <strong>prod-secure-properties.yaml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cp </span>dev-secure-properties.yaml test-secure-properties.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cp </span>dev-secure-properties.yaml prod-secure-properties.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the same encryption key (secure12345) for all environments: this is purely for simpliciy&#8217;s sake and not generally recommended.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because the encryption details and sensitive properties are the same in all environments, the encrypted secure properties files are also identical between environments.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Read secure props file:</strong> In Studio, in global.xml, add a global element to read the encrypted environment-dependent properties file for the current environment, using a new property <strong>encrypt.key</strong> for the encryption key:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;secure-properties:config</span> <span style="color: #268bd2">file=</span><span style="color: #859900">"${env}-secure-properties.yaml"</span>
  <span style="color: #268bd2">key=</span><span style="color: #859900">"${encrypt.key}"</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"secureEnvPropsConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;secure-properties:encrypt</span> <span style="color: #268bd2">algorithm=</span><span style="color: #859900">"Blowfish"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/secure-properties:config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must specify Blowfish because it is not the default algorithm, whereas CBC is the default and does not need to be mentioned.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Secure and normal properties cannot reference each other, so the order relative to each other does not matter.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reference secure props:</strong> <strong>Prefix</strong> all references to secure properties with <strong>secure::</strong> as follows:</p>
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;tls:context</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiTLSContext"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;tls:key-store</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"${tls.keystore.type}"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"${tls.keystore.path}"</span>
    <span style="color: #268bd2">password=</span><span style="color: #859900">"${secure::tls.keystore.password}"</span>
    <span style="color: #268bd2">keyPassword=</span><span style="color: #859900">"${secure::tls.keystore.keyPassword}"</span>
    <span style="color: #268bd2">alias=</span><span style="color: #859900">"${tls.keystore.alias}"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/tls:context&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Update run config:</strong> In Studio, change the <strong>run configuration</strong> of check-in-papi by setting the <strong>VM arguments</strong> for <strong>encrypt.key</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because encrypt.key is not — and should not be — defaulted, the Mule app will not start unless this property is set by the Mule runtime in every environment — includig CloudHub, which will be addressed shortly.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Due to a current limitation in Studio, DataSense metadata support fails due to the Studio tooling instance not being able to locate the encrypt.key that&#8217;s only passed at runtime. During development, there are temporary workarounds such as setting a temporary global env to provide the runtime property to the Studio tooling instance, but caution should be exercised to not deploy this change or commit to any SCM.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run:</strong> Run check-in-papi in Studio and verify that it starts up correctly.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_protect_sensitive_mule_app_configuration_properties_in_runtime_manager"><a class="anchor" href="#_protect_sensitive_mule_app_configuration_properties_in_runtime_manager"></a><a class="link" href="#_protect_sensitive_mule_app_configuration_properties_in_runtime_manager">Protect sensitive Mule app configuration properties in Runtime Manager</a></h4>
<div class="paragraph">
<p>In this section, you protect sensitive properties that must be set as Java system properties, such as encrypt.key and the Anypoint Platform client ID and secret, in the Runtime Manager web UI and by extending the Maven build configuration in the parent POM to automatically protect these value upon deployment.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="29">
<li>
<p><strong>Review unprotected properties:</strong> In the Runtime Manager dashboard, navigate to the Properties tab of check-in-papi. Note that all properties are visible in plain text.</p>
</li>
<li>
<p><strong>Protect sensitive properties:</strong> Add the <strong>encrypt.key</strong> property, click <strong>Protect</strong> and apply the changes.</p>
</li>
<li>
<p><strong>Confirm protected properties:</strong> On the Properties tab, confirm the value for property that you just protected is now no longer visible.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>These protected application values are encrypted and stored in the Anypoint Security secrets manager, which, in turn, is encrypted per user organization.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Properties set only in properties files, including secure/encrypted properties, do not have to be included here, as they are not visible in Runtime Manager.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update CloudHub 2.0 deployment config:</strong> Change the Mule Maven plugin configuration to protect the sensitive properties: <strong>encrypt.key</strong> and the Anypoint Platform <strong>client ID and secret</strong>, moving them to their own <strong>secureProperties</strong> configuration element:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;configuration&gt;</span>
  <span style="color: #b58900">&lt;cloudhub2Deployment&gt;</span>
    ...
    <span style="color: #b58900">&lt;properties&gt;</span>
    ...
    <span style="color: #b58900">&lt;/properties&gt;</span>
    <span style="color: #b58900">&lt;secureProperties&gt;</span>
      <span style="color: #b58900">&lt;encrypt.key&gt;</span>${encrypt.key}<span style="color: #b58900">&lt;/encrypt.key&gt;</span>
      <span style="color: #b58900">&lt;anypoint.platform.client_id&gt;</span>${ap.client_id}<span style="color: #b58900">&lt;/anypoint.platform.client_id&gt;</span>
      <span style="color: #b58900">&lt;anypoint.platform.client_secret&gt;</span>${ap.client_secret}<span style="color: #b58900">&lt;/anypoint.platform.client_secret&gt;</span>
    <span style="color: #b58900">&lt;/secureProperties&gt;</span>
    ...
  <span style="color: #b58900">&lt;/cloudhub2Deployment&gt;</span>
<span style="color: #b58900">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You will validate these values are protected in Runtime Manager when you deploy via the Mule Maven plugin in the next section.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_the_same_mule_app_to_different_cloudhub_environments"><a class="anchor" href="#_deploy_the_same_mule_app_to_different_cloudhub_environments"></a><a class="link" href="#_deploy_the_same_mule_app_to_different_cloudhub_environments">Deploy the same Mule app to different CloudHub environments</a></h4>
<div class="paragraph">
<p>In this section, you extend the Maven build configuration in the parent POM to perform automated CloudHub deployments via Mule Maven plugin to different environments. You give deployments to the CloudHub dev and test environments a hostname suffix to denote the respective environment, and thereby make the hostnames unique. You also pass the environment name and encryption key as Java system properties to the Mule app, so that it can start-up in CloudHub with the appropriate environment-specific configuration. You then deploy check-in-papi to all environments using the Maven command-line interface.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="33">
<li>
<p><strong>Add env config to parent POM:</strong> Add <strong>properties</strong> to <strong>parent-pom/pom.xml</strong> that capture the environment and formalize the variations of CloudHub deployment/application names between different environments; this includes the same hostname prefix as before plus a new hostname suffix:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #657b83">&lt;!-- Exchange demands a name for deployment --&gt;</span>
<span style="color: #b58900">&lt;name&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/name&gt;</span>
<span style="color: #b58900">&lt;properties&gt;</span>
  <span style="color: #657b83">&lt;!-- Not explicitly used but needed for deployment to Exchange, otherwise Exchange cannot determine the asset type --&gt;</span>
  <span style="color: #b58900">&lt;type&gt;</span>custom<span style="color: #b58900">&lt;/type&gt;</span>
  <span style="color: #657b83">&lt;!-- for automated deployments --&gt;</span>
  <span style="color: #b58900">&lt;deployment.env&gt;</span>set with -Ddeployment.env=...<span style="color: #b58900">&lt;/deployment.env&gt;</span>
  <span style="color: #b58900">&lt;deployment.suffix&gt;</span>-${deployment.env}<span style="color: #b58900">&lt;/deployment.suffix&gt;</span>
  <span style="color: #b58900">&lt;deployment.name&gt;</span>${project.name}${deployment.suffix}<span style="color: #b58900">&lt;/deployment.name&gt;</span>
  <span style="color: #657b83">&lt;!-- requires AP environments to have the same name as the env property value in Mule apps (which determines the property files to load) --&gt;</span>
  <span style="color: #b58900">&lt;ap.environment&gt;</span>${deployment.env}<span style="color: #b58900">&lt;/ap.environment&gt;</span>
  <span style="color: #b58900">&lt;ap.client_id&gt;</span>set with -Dap.client_id=...<span style="color: #b58900">&lt;/ap.client_id&gt;</span>
  <span style="color: #b58900">&lt;ap.client_secret&gt;</span>set with -Dap.client_secret=...<span style="color: #b58900">&lt;/ap.client_secret&gt;</span>
  <span style="color: #b58900">&lt;ap.ca.client_id&gt;</span>set with -Dap.ca.client_id=...<span style="color: #b58900">&lt;/ap.ca.client_id&gt;</span>
  <span style="color: #b58900">&lt;ap.ca.client_secret&gt;</span>set with -Dap.ca.client_secret=...<span style="color: #b58900">&lt;/ap.ca.client_secret&gt;</span>
  <span style="color: #657b83">&lt;!-- set encrypt.key for decrypting secure (encryped) properties files (but don't set it here!) --&gt;</span>
<span style="color: #b58900">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The same Mule app deployed to different CloudHub environments in the same region must be given distinct names to avoid duplicate fully qualified domain names.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In prod you will continue using no hostname suffix, as is common usage, by setting the suffix property to the empty string.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You define two separate Maven properties related to environments: Firstly, a Maven property for the name by which Mule apps identify the current environment, for the purpose of selecting environment-specific configuration; this will be passed to the Mule app through the env property. Secondly, a Maven property for the name of the Anypoint Platform (and therefore CloudHub) environment to which the Mule app is to be deployed. You also make explicit your chosen convention that these two properties hold the same value, while keeping the option of departing from this convention if necessary, by maintaining two separate Maven properties.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update CloudHub 2.0 deployment config:</strong> Change the Mule Maven plugin configuration to make use of the name and environment <strong>properties</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;configuration&gt;</span>
  <span style="color: #b58900">&lt;cloudhub2Deployment&gt;</span>
    ...
    <span style="color: #b58900">&lt;environment&gt;</span>${ap.environment}<span style="color: #b58900">&lt;/environment&gt;</span>
    ...
    <span style="color: #b58900">&lt;applicationName&gt;</span>${deployment.name}<span style="color: #b58900">&lt;/applicationName&gt;</span>
    ...
    <span style="color: #b58900">&lt;properties&gt;</span>
      ...
      <span style="color: #b58900">&lt;env&gt;</span>${deployment.env}<span style="color: #b58900">&lt;/env&gt;</span>
    <span style="color: #b58900">&lt;/properties&gt;</span>
  <span style="color: #b58900">&lt;/cloudhub2Deployment&gt;</span>
<span style="color: #b58900">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You instruct the Mule Maven plugin to deploy to the CloudHub environment identified by the respective Maven property, set previously.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You set the env property of the Mule app from the Maven property that identifies the environment. By default, as set above, this is the name of the CloudHub environment.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Bump check-in-papi Maven artifact version:</strong> In <strong>pom.xml</strong>, update the version to a release version:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;version&gt;</span>1.0.1<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy application to Exchange:</strong> Deploy check-in-papi to your remote Exchange repository, this time passing in the required encryption key:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean deploy <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-deploy:</strong> In a command-line interface, deploy check-in-papi to all supported CloudHub environments, supplying the same client ID and secret of your Anypoint Platform organization as before, and only deploying to Exchange once, reusing the already packaged application from Exchange for subsequent deployments:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">-DmuleDeploy</span> deploy <span style="color: #b58900">-Dap</span>.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-client-id&gt; <span style="color: #b58900">-Dap</span>.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-client-secret&gt; <span style="color: #b58900">-Dap</span>.ca.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-id&gt; <span style="color: #b58900">-Dap</span>.ca.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-secret&gt;
  <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345 <span style="color: #b58900">-Ddeployment</span>.env<span style="color: #93a1a1">=</span>dev</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">-DmuleDeploy</span> deploy <span style="color: #b58900">-Dap</span>.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-client-id&gt; <span style="color: #b58900">-Dap</span>.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-client-secret&gt; <span style="color: #b58900">-Dap</span>.ca.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-id&gt; <span style="color: #b58900">-Dap</span>.ca.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-secret&gt;
  <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345 <span style="color: #b58900">-Ddeployment</span>.env<span style="color: #93a1a1">=</span><span style="color: #586e75">test</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">-DmuleDeploy</span> deploy <span style="color: #b58900">-Dap</span>.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-client-id&gt; <span style="color: #b58900">-Dap</span>.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-client-secret&gt; <span style="color: #b58900">-Dap</span>.ca.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-id&gt; <span style="color: #b58900">-Dap</span>.ca.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-secret&gt;
  <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345 <span style="color: #b58900">-Ddeployment</span>.env<span style="color: #93a1a1">=</span>prod <span style="color: #b58900">-Ddeployment</span>.suffix<span style="color: #93a1a1">=</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As per the chosen convention, the deployment/hostname suffix for prod is empty.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If you were to use environment-level rather than organization-level client ID and secret, then the values for client ID and secret in each of these statements would be different.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Wait and observe:</strong> In <strong>Runtime Manager</strong> and <strong>API Manager</strong>, follow the deployment process and verify its success.</p>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the Check-In PAPI endpoints in all environments to verify the successful deployments:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The hostnames will be different for you.</em>
<em>Note:</em> <em>Append the -dev or -test suffix to the application name in the URL for the corresponding environment.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Confirm protected properties:</strong> On the Properties tab, confirm the values for each property that you protected earlier are now no longer visible.
and the Anypoint Platform client ID and secret.</p>
</li>
<li>
<p><strong>Set consumer and implementation endpoints:</strong> in API Manager, update the implementation URL and consumer endpoint to match your generated fully qualified domain name.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>These endpoints are optional and are used for informational purposes to let clients know how to interact with your API, including surfacing these endpoints in Exchange.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-operational-concerns"><a class="anchor" href="#module-operational-concerns"></a><a class="link" href="#module-operational-concerns">Module 3: Developing for Operational Concerns</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you improve operational observability by implementing operational logging and monitorability of Mule apps and applying the previous non-redundancy of code principle to implement a reusable health check library for Mule apps.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement operational logging</p>
</li>
<li>
<p>Expose health check endpoints and monitor a Mule app from Anypoint Platform</p>
</li>
<li>
<p>Extract reusable Mule app code into a library</p>
</li>
<li>
<p>Extract reusable error handling and health check code into a library</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-131"><a class="anchor" href="#wt-begin-131"></a><a class="link" href="#wt-begin-131">Walkthrough 3-1: Implement operational logging</a></h3>
<div class="paragraph">
<p>Logging should add minimal performance overhead to production operation yet provide enough context or information for traceability.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you tune the Log4J configuration generated by Studio for performance and enrich logging messages for traceability using the Tracing module and logging variables.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_use_asynchronous_logging_in_production_and_synchronous_logging_at_debug_level_in_unit_tests">Use asynchronous logging in production and synchronous logging at DEBUG level in unit tests</a>.</p>
</li>
<li>
<p><a href="#_enrich_logging_with_mapped_diagnostic_context_and_logging_variables">Enrich logging with Mapped Diagnostic Context and logging variables</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_6"><a class="anchor" href="#_solution_file_6"></a><a class="link" href="#_solution_file_6">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module03/wt3-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_5"><a class="anchor" href="#_starting_file_5"></a><a class="link" href="#_starting_file_5">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module02/wt2-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_asynchronous_logging_in_production_and_synchronous_logging_at_debug_level_in_unit_tests"><a class="anchor" href="#_use_asynchronous_logging_in_production_and_synchronous_logging_at_debug_level_in_unit_tests"></a><a class="link" href="#_use_asynchronous_logging_in_production_and_synchronous_logging_at_debug_level_in_unit_tests">Use asynchronous logging in production and synchronous logging at DEBUG level in unit tests</a></h4>
<div class="paragraph">
<p>In this section, you inspect and tune the Log4J configuration generated by Studio when you created check-in-papi. You must ensure that logging in prod is asynchronous, so that it adds minimal latency to normal event processing. On the other hand, when running unit tests it is convenient to use synchronous logging, and so you change log4j2-test.xml to a synchronous configuration. Also, log entries written by unit tests should typically be down to DEBUG level, which would add prohibitive overhead in production.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study log configs:</strong> Inspect <strong>log4j2.xml</strong> and <strong>log4j2-test.xml</strong>, the former is used in all normal deployments, while the latter is used only when running unit — such as, MUnit — tests; note that with the exception of the log appender (file versus console), both log configurations are essentially identical and perform logging asynchronously.</p>
</li>
<li>
<p><strong>Tune test log config:</strong> Change <strong>log4j2-test.xml</strong> to use <strong>synchronous</strong> logging and show DEBUG log entries created by the <strong>default logger</strong>, and the <strong>Message Logging</strong> API policy:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">log4j2-test.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;Configuration</span> <span style="color: #268bd2">status=</span><span style="color: #859900">"WARN"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;Appenders&gt;</span>
    <span style="color: #b58900">&lt;Console</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"Console"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"SYSTEM_OUT"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;PatternLayout</span> <span style="color: #268bd2">pattern=</span><span style="color: #859900">"%-5p %d [%t] %c: %m%n"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/Console&gt;</span>
  <span style="color: #b58900">&lt;/Appenders&gt;</span>
  <span style="color: #b58900">&lt;Loggers&gt;</span>
    <span style="color: #b58900">&lt;Root</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;AppenderRef</span> <span style="color: #268bd2">ref=</span><span style="color: #859900">"Console"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/Root&gt;</span>
    ...
    <span style="color: #b58900">&lt;Logger</span>
      <span style="color: #268bd2">name=</span><span style="color: #859900">"org.mule.runtime.core.internal.processor.LoggerMessageProcessor"</span>
      <span style="color: #268bd2">level=</span><span style="color: #859900">"DEBUG"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;Logger</span>
      <span style="color: #268bd2">name=</span><span style="color: #859900">"org.mule.runtime.logging"</span>
      <span style="color: #268bd2">level=</span><span style="color: #859900">"DEBUG"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/Loggers&gt;</span>
<span style="color: #b58900">&lt;/Configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The default logger, and Message Logging API policy all use different loggers/categories.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You will see this synchronous logging configuration in action when you run MUnit tests in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study or tune log config:</strong> In <strong>log4j2.xml</strong>, you need to make no changes, as the configuration is already asynchronous, but you may want to bring the structure of this file in line with the structure of log4j2-test.xml. Similarly, you may apply Maven resource filtering to reuse the Maven configuration in the log filename configuration:</p>
<div class="listingblock">
<div class="title">log4j2.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;Configuration</span> <span style="color: #268bd2">status=</span><span style="color: #859900">"WARN"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;Appenders&gt;</span>
    <span style="color: #b58900">&lt;RollingFile</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"File"</span>
      <span style="color: #268bd2">fileName=</span><span style="color: #859900">"${sys:mule.home}${sys:file.separator}logs${sys:file.separator}${project.name}.log"</span>
      <span style="color: #268bd2">filePattern=</span><span style="color: #859900">"${sys:mule.home}${sys:file.separator}logs${sys:file.separator}${project.name}-%i.log"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;PatternLayout</span> <span style="color: #268bd2">pattern=</span><span style="color: #859900">"%-5p %d [%t] [event: %X{correlationId}] %c: %m%n"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;SizeBasedTriggeringPolicy</span> <span style="color: #268bd2">size=</span><span style="color: #859900">"10 MB"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;DefaultRolloverStrategy</span> <span style="color: #268bd2">max=</span><span style="color: #859900">"10"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/RollingFile&gt;</span>
  <span style="color: #b58900">&lt;/Appenders&gt;</span>
  <span style="color: #b58900">&lt;Loggers&gt;</span>
    <span style="color: #b58900">&lt;AsyncRoot</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;AppenderRef</span> <span style="color: #268bd2">ref=</span><span style="color: #859900">"File"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/AsyncRoot&gt;</span>
    ...
    <span style="color: #b58900">&lt;AsyncLogger</span>
      <span style="color: #268bd2">name=</span><span style="color: #859900">"org.mule.runtime.core.internal.processor.LoggerMessageProcessor"</span>
      <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;AsyncLogger</span>
      <span style="color: #268bd2">name=</span><span style="color: #859900">"org.mule.runtime.logging"</span>
      <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/Loggers&gt;</span>
<span style="color: #b58900">&lt;/Configuration&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_enrich_logging_with_mapped_diagnostic_context_and_logging_variables"><a class="anchor" href="#_enrich_logging_with_mapped_diagnostic_context_and_logging_variables"></a><a class="link" href="#_enrich_logging_with_mapped_diagnostic_context_and_logging_variables">Enrich logging with Mapped Diagnostic Context and logging variables</a></h4>
<div class="paragraph">
<p>In this section, you inspect and configure the Log4J configuration generated by Studio and add a new Tracing module to check-in-papi that allows you to enrich log messages automatically by adding variables to the logging context for a given Mule event.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p><strong>Study log configs:</strong> Inspect <strong>log4j2.xml</strong> and note the existing <strong>File</strong> appender and the pattern layout that currently logs the <strong>correlationId</strong>.</p>
</li>
<li>
<p><strong>Configure MDC config:</strong> Change <strong>log4j2.xml</strong>, updating the <strong>PatternLayout</strong> for the existing <strong>File</strong> appender and temporarily adding a new <strong>Console</strong> appender with the same PatternLayout that instructs Mule to automatically add the MDC context:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">log4j2.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;Configuration</span> <span style="color: #268bd2">status=</span><span style="color: #859900">"WARN"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;Appenders&gt;</span>
    <span style="color: #b58900">&lt;RollingFile</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"File"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;PatternLayout</span> <span style="color: #268bd2">pattern=</span><span style="color: #859900">"%-5p %d [%t] [%MDC] %c: %m%n"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/RollingFile&gt;</span>
    <span style="color: #b58900">&lt;Console</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"Console"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"SYSTEM_OUT"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;PatternLayout</span> <span style="color: #268bd2">pattern=</span><span style="color: #859900">"%-5p %d [%t] [%MDC] %c: %m%n"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/Console&gt;</span>
  <span style="color: #b58900">&lt;/Appenders&gt;</span>
  <span style="color: #b58900">&lt;Loggers&gt;</span>
    ...
    <span style="color: #b58900">&lt;AsyncRoot</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;AppenderRef</span> <span style="color: #268bd2">ref=</span><span style="color: #859900">"File"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;AppenderRef</span> <span style="color: #268bd2">ref=</span><span style="color: #859900">"Console"</span><span style="color: #b58900">/&gt;</span>
      ...
    <span style="color: #b58900">&lt;/AsyncRoot&gt;</span>
  <span style="color: #b58900">&lt;/Loggers&gt;</span>
<span style="color: #b58900">&lt;/Configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, Mule logs two MDC entries: processor, which shows the location of the current event, and event, which shows the correlation ID of the event.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Console appender is only used to make the log context available in the Studio console. This is not advised for production environments.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Studio console is not completely controlled by the <strong>log4j2.xml</strong>. Studio itself only uses part of the <strong>log4j2.xml</strong> and does not use the configuration defined in the File appender. The full log file created by the File appender can be found by navigating to the &lt;MULE_HOME&gt;/logs directory of the Studio embedded Mule runtime. You can find the MULE_HOME location by searching for MULE_HOME in a running Studio console</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add managed library dependency:</strong> Locate the existing dependency management of mule-tracing-module in the <strong>BOM</strong> and add a matching entry to the check-in-papi <strong>POM</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>mule-tracing-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add logging variables to the context:</strong> add a logging variable at the beginning of <strong>check-in-by-pnr</strong> for PNR:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;tracing:set-logging-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"PNR"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[vars.PNR default '']"</span><span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Tracing module enables you to enhance your logs by adding, removing, and clearing variables from the logging context for a given Mule event.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This logging context affects any output of a Logger component and any internal logging that the Mule runtime produces. Therefore, you can add more context to the event that Mule is processing if you need additional information for tracking down any potential issue, for example, when an unexpected error occurs.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The logging context exists for the entire execution of the corresponding event. Once a variable is set, it will continue to be logged for an event until it is removed using the corresponding remove operation or until all variables are removed using the clear operation.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app from Studio and invoke the API via cURL as before and study the log entries noting the <strong>correlationId</strong> and the new variables set in the logging context.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-132"><a class="anchor" href="#wt-begin-132"></a><a class="link" href="#wt-begin-132">Walkthrough 3-2: Expose and monitor health check endpoints</a></h3>
<div class="paragraph">
<p>It is common practice that Mule apps should expose health check endpoints that can be invoked from the outside to probe the functioning of the Mule app.
CloudHub adds such health checks for its own purposes, to drive automated restart of Mule apps, for instance, but these health checks are only available when deploying to CloudHub and are generic, that is, without knowledge of any implementation details of a Mule app.</p>
</div>
<div class="paragraph">
<p>An independent but related concern is that Mule apps should also be represented in the graphical application network view provided by Visualizer, and show up in the correct architecture layer, following API-led connectivity.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you add two types of health check endpoints to check-in-papi, following a convention used, for example, by Kubernetes: Firstly, a liveness endpoint that can be invoked over HTTP/S to perform a liveness check of the Mule app. Mule apps that fail the liveness check are not in a runnable state and should be restarted. Secondly, a readiness endpoint that can be invoked over HTTP/S to perform readiness checks of the Mule app. Mule apps that fail the readiness check but not the liveness check are themselves running fine, but at least one of their required downstream dependencies — such as an API invoked by the Mule app — is not ready. Restarting such a Mule app is pointless, but it is nevertheless not ready to service requests. Furthermore, you extend check-in-papi and the Maven build to assign Mule apps to the correct architectural layer in Visualizer and have Visualizer use a concise name for the Mule app.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_expose_liveness_and_readiness_endpoints">Expose liveness and readiness endpoints</a>.</p>
</li>
<li>
<p><a href="#_make_a_mule_app_announce_its_tier_and_concise_name_to_visualizer">Make a Mule app announce its tier and concise name to Visualizer</a>.</p>
</li>
<li>
<p><a href="#_configure_a_functional_monitor_to_invoke_health_check_endpoints">Configure a Functional Monitor to invoke health check endpoints</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_7"><a class="anchor" href="#_solution_file_7"></a><a class="link" href="#_solution_file_7">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module03/wt3-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_6"><a class="anchor" href="#_starting_file_6"></a><a class="link" href="#_starting_file_6">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module03/wt3-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_expose_liveness_and_readiness_endpoints"><a class="anchor" href="#_expose_liveness_and_readiness_endpoints"></a><a class="link" href="#_expose_liveness_and_readiness_endpoints">Expose liveness and readiness endpoints</a></h4>
<div class="paragraph">
<p>In this section, you add healtheck endpoints in the form of a liveness and a rudimentary readiness endpoint to check-in-papi, using the same HTTP Listener configuration also used for exposing Check-In PAPI. These health check endpoints respond to a HTTP GET with a HTTP 200 response (and a payload of UP) in case all is well, or a HTTP 500 response (and a payload of DOWN) if not.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Create Mule flow config file:</strong> In Studio, add to check-in-papi a Mule flow config file <strong>health.xml</strong>.</p>
</li>
<li>
<p><strong>Implement liveness endpoint:</strong> Add to health.xml a new Mule flow <strong>api-alive</strong> for the liveness endpoint, referring to the same HTTP Listener configuration that is also used to expose the API, using a path of <strong>/alive</strong> and setting the response to 200 and UP under normal conditions, or 500 and DOWN in case of error:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-alive"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"apiHttpListenerConfig"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/alive"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:response</span> <span style="color: #268bd2">statusCode=</span><span style="color: #859900">"200"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;http:error-response</span> <span style="color: #268bd2">statusCode=</span><span style="color: #859900">"500"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;http:body&gt;</span>DOWN<span style="color: #b58900">&lt;/http:body&gt;</span>
    <span style="color: #b58900">&lt;/http:error-response&gt;</span>
  <span style="color: #b58900">&lt;/http:listener&gt;</span>
  <span style="color: #b58900">&lt;set-payload</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"UP"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Using the same HTTP Listener configuration for the health check endpoints as for exposing the API makes the health checks more meaningful.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>health check endpoints are not part of the business-centric API defined in an API specification and therefore listen to an endpoint and path not covered by the API specification.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is difficult to construct a scenario where the above liveness endpoint implementation would return the configured error response.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Implement readiness endpoint:</strong> Add to health.xml a new Mule flows <strong>api-ready</strong> for the readiness endpoint, which for the time being does not have any downstream dependencies to check:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-ready"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"apiHttpListenerConfig"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/ready"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:response</span> <span style="color: #268bd2">statusCode=</span><span style="color: #859900">"200"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;http:error-response</span> <span style="color: #268bd2">statusCode=</span><span style="color: #859900">"500"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;http:body&gt;</span>DOWN<span style="color: #b58900">&lt;/http:body&gt;</span>
    <span style="color: #b58900">&lt;/http:error-response&gt;</span>
  <span style="color: #b58900">&lt;/http:listener&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;set-payload</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"UP"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Mule flows are not allowed to be empty, so to make check-all-dependencies-are-alive valid you add an empty logger.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the health check endpoints; this should return a HTTP 200 response with UP in both cases:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_make_a_mule_app_announce_its_tier_and_concise_name_to_visualizer"><a class="anchor" href="#_make_a_mule_app_announce_its_tier_and_concise_name_to_visualizer"></a><a class="link" href="#_make_a_mule_app_announce_its_tier_and_concise_name_to_visualizer">Make a Mule app announce its tier and concise name to Visualizer</a></h4>
<div class="paragraph">
<p>In this section, you extend the Maven build to set a Java system property that informs Visualizer to which tier a given Mule app belongs. You assign check-in-papi to the Process tier. Visualizer calls tiers layers and predefines the Experience, Process, and System layers.</p>
</div>
<div class="paragraph">
<p>By default, Visualizer uses the CloudHub application name of a CloudHub-deployed Mule app (such as check-in-papi-dev) to represent that Mule app in its application network rendering. This is slightly longer than required and hence makes Visualizer renderings unnecessarily busy: you tell Visualizer to use a more concise display name for check-in-papi by setting a Java system property.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p><strong>Add Visualizer props to CloudHub deployment config:</strong> To the <strong>parent POM</strong> add to the <strong>Mule Maven plugin</strong> configuration three properties, one for setting the Visualizer layer, one for setting the Visualizer display name, and another one to allow the Anypoint Platform control plane to collect relevant runtime analytics:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;cloudhub2Deployment&gt;</span>
  ...
  <span style="color: #b58900">&lt;properties&gt;</span>
    <span style="color: #b58900">&lt;anypoint.platform.config.analytics.agent.enabled&gt;</span>
      true
    <span style="color: #b58900">&lt;/anypoint.platform.config.analytics.agent.enabled&gt;</span>
    <span style="color: #b58900">&lt;anypoint.platform.visualizer.displayName&gt;</span>
      ${project.name}
    <span style="color: #b58900">&lt;/anypoint.platform.visualizer.displayName&gt;</span>
    <span style="color: #b58900">&lt;anypoint.platform.visualizer.layer&gt;</span>
      ${api.layer}
    <span style="color: #b58900">&lt;/anypoint.platform.visualizer.layer&gt;</span>
    ...
  <span style="color: #b58900">&lt;/properties&gt;</span>
  ...
<span style="color: #b58900">&lt;/cloudhub2Deployment&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The collection of runtime analytics may already be enabled for the CloudHub image you are deploying to, so the above is not always strictly necessary. But it is highly recommended.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>With this, Visualizer will render any Mule app using the &lt;artifactId /&gt; of the child project (such as check-in-papi) rather than the CloudHub application name (such as check-in-papi-dev). The former is sufficient because Visualizer only displays the application network for a given Anypoint Platform organization.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This configuration relies on the api.layer property, which is fixed for every Mule app.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Define layer name props:</strong> To the <strong>parent POM</strong> add top-level properties that fix the allowed layer names:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
	...
	<span style="color: #b58900">&lt;name&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/name&gt;</span>
  <span style="color: #b58900">&lt;properties&gt;</span>
    <span style="color: #b58900">&lt;api.layer.eapi&gt;</span>Experience<span style="color: #b58900">&lt;/api.layer.eapi&gt;</span>
    <span style="color: #b58900">&lt;api.layer.papi&gt;</span>Process<span style="color: #b58900">&lt;/api.layer.papi&gt;</span>
    <span style="color: #b58900">&lt;api.layer.sapi&gt;</span>System<span style="color: #b58900">&lt;/api.layer.sapi&gt;</span>
    <span style="color: #b58900">&lt;api.layer.backend&gt;</span>Backend<span style="color: #b58900">&lt;/api.layer.backend&gt;</span>
    <span style="color: #b58900">&lt;api.layer.none&gt;</span>None<span style="color: #b58900">&lt;/api.layer.none&gt;</span>
    ...
  <span style="color: #b58900">&lt;/properties&gt;</span>
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The values Experience, Process, and System are well-known to Visualizer, but Visualizer accepts arbtirary layer names, such as Backend.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>These properties are available to all child POMs/projects.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Set layer prop:</strong> In the <strong>POM</strong> for check-in-papi, set the value of the <strong>api.layer</strong> property, such that it is available in the Mule Maven plugin configuration in the parent POM:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;api.layer&gt;</span>${api.layer.papi}<span style="color: #b58900">&lt;/api.layer&gt;</span>
<span style="color: #b58900">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because the layer name is taken from a property inherited from the parent POM, it reduces redundancy and the risk of typos.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Bump Maven artifact version:</strong> In <strong>pom.xml</strong>, bump the patch version of check-in-papi:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;version&gt;</span>1.0.2<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-deploy:</strong> In a command-line interface, deploy the application to Exchange and subsequently the CloudHub <strong>dev</strong> environment using the Mule Maven plugin, supplying the same command-line arguments as before; this should result in a successful deployment:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean deploy <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">-DmuleDeploy</span> deploy <span style="color: #b58900">-Dap</span>.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-client-id&gt; <span style="color: #b58900">-Dap</span>.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-client-secret&gt; <span style="color: #b58900">-Dap</span>.ca.client_id<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-id&gt; <span style="color: #b58900">-Dap</span>.ca.client_secret<span style="color: #93a1a1">=</span>&lt;insert-your-ca-client-secret&gt; <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345 <span style="color: #b58900">-Ddeployment</span>.env<span style="color: #93a1a1">=</span>dev</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the health check endpoints; this should return a HTTP 200 response in both cases:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-i</span> https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-i</span> https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The hostname will be different for you.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Check Visualizer layer:</strong> In Visualizer, under Sandbox environments, confirm that check-in-papi in the dev environment is indeed assigned to the Process layer.</p>
<div class="paragraph">
<p><em>Note:</em> <em>It can take several minutes for Visualizer to reflect the latest configuration.</em></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configure_a_functional_monitor_to_invoke_health_check_endpoints"><a class="anchor" href="#_configure_a_functional_monitor_to_invoke_health_check_endpoints"></a><a class="link" href="#_configure_a_functional_monitor_to_invoke_health_check_endpoints">Configure a Functional Monitor to invoke health check endpoints</a></h4>
<div class="paragraph">
<p>In this module, you — using an account with sufficient entitlements, or an instructor, create a Functional Monitor in Anypoint Monitoring to implement a liveness and readiness probe on check-in-papi. The Functional Monitor sends HTTP GET requests on a regular basis to check-in-papi and raises an alert if either fails. This is a licensed feature that is not available with trial accounts, which is why you must have an account with sufficient entitlements or demonstrated by an instructor.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p><strong>Navigate to Anypoint Monitoring:</strong> Using credentials with sufficient permissions, log in an organization with sufficient entitlements or as instructor to the AnyAirline Anypoint Platform organization and navigate to Anypoint Monitoring.</p>
</li>
<li>
<p><strong>Create Functional Monitor:</strong> Create a Functional Monitor for <strong>check-in-papi</strong> in the dev environment sending an HTTP <strong>GET</strong> request every <strong>15 minutes</strong> your CloudHub deployed check-in-papi endpoint, asserting that the HTTP status is <strong>200</strong> and notifying you via <strong>email</strong> to your email address of any failures.</p>
<div class="paragraph">
<p><em>Note:</em> <em>You can switch to the code editor, to create a monitor written in BAT, a Behavior Driven Development (BDD) language.</em></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Additionally, you can upload custom test suites written in BAT via the Anypoint Platform APIs.</em></p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-133"><a class="anchor" href="#wt-begin-133"></a><a class="link" href="#wt-begin-133">Walkthrough 3-3: Extract reusable Mule app code into a library</a></h3>
<div class="paragraph">
<p>Reflecting on the check-in-papi Mule app code, it becomes apparent that parts of it are likely to be re-usable in other similar Mule apps and API implementations. Examples are the global error handlers in error.xml and all of the health check endpoints in their current form in health.xml. In future walkthroughs you will identify other reusable Mule flows or configuration elements.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you extract reusable Mule app code from check-in-papi into a separate project apps-commons, which builds a library-style Mule plugin, that can be imported into any Mule app that needs this functionality. The apps-commons project is the first of many projects that can reuse parts of the Maven build configuration encapsulated in the parent POM and BOM.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_identify_reusable_mule_app_code_elements">Identify reusable Mule app code elements</a>.</p>
</li>
<li>
<p><a href="#wt3-3-extract-config-into-lib">Extract reusable Mule app flows and configuration elements into a new Maven project</a>.</p>
</li>
<li>
<p><a href="#_import_mule_app_code_elements_from_a_library">Import Mule app code elements from a library</a>.</p>
</li>
<li>
<p><a href="#_deploy_maven_artifacts_to_exchange_as_custom_assets">Deploy Maven artifacts to Exchange as custom assets</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_8"><a class="anchor" href="#_solution_file_8"></a><a class="link" href="#_solution_file_8">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module03/wt3-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_7"><a class="anchor" href="#_starting_file_7"></a><a class="link" href="#_starting_file_7">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module03/wt3-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_identify_reusable_mule_app_code_elements"><a class="anchor" href="#_identify_reusable_mule_app_code_elements"></a><a class="link" href="#_identify_reusable_mule_app_code_elements">Identify reusable Mule app code elements</a></h4>
<div class="paragraph">
<p>In this section, you inspect check-in-papi and identify code elements that could be reused by other, similar Mule apps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Reflect:</strong> In Studio, inspect <strong>error.xml</strong> and think on how the global error handlers therein were created and under what circumstances they could be reused in other Mule apps.</p>
</li>
<li>
<p><strong>Reflect:</strong> Inspect <strong>health.xml</strong> and think on how api-alive and api-ready differ between check-in-papi and other similar Mule apps.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt3-3-extract-config-into-lib"><a class="anchor" href="#wt3-3-extract-config-into-lib"></a><a class="link" href="#wt3-3-extract-config-into-lib">Extract reusable Mule app flows and configuration elements into a new Maven project</a></h4>
<div class="paragraph">
<p>In this section, you create a new Maven project apps-commons with the code from error.xml and health.xml in check-in-papi. The apps-commons Maven project is structured like a Mule app, with Mule flow config files in src/main/mule, but builds an artifact with Maven classifier mule-plugin. This type of Mule plugin could be called a "library-style Mule plugin" to distinguish it from other, more sophisticated Mule plugins like connectors or XML SDK modules — all of which use the Maven classifier mule-plugin. By contrast, a library-style Mule plugin just contains simple resources like Mule flow config files and is built from a Maven project with &lt;packaging /&gt; mule-application and &lt;classifier /&gt; mule-plugin.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Create new library project:</strong> In Studio, create a new standard Mule app project named <strong>apps-commons</strong>; this creates the apps-commons project directory in your Studio workspace directory.</p>
</li>
<li>
<p><strong>Delete auto-created Mule flow config file:</strong> Delete the Mule flow config file automatically created by Studio in the new apps-commons project.</p>
</li>
<li>
<p><strong>Copy reusable Mule flow config files:</strong> In a command-line interface or Studio, copy the previously identified reusable Mule flow config files from check-in-papi to apps-commons, appending <strong>-common</strong> to their filenames:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp </span>check-in-papi/src/main/mule/health.xml  apps-commons/src/main/mule/health-common.xml
<span style="color: #586e75">cp </span>check-in-papi/src/main/mule/error.xml  apps-commons/src/main/mule/error-common.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By convention, you append -common to all Mule flow config files in apps-commons, so that these filenames are unlikely to conflict with filenames in any Mule app that includes apps-commons.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Studio might show an error that the HTTP Listener configuration used in health-common.xml is missing. This will be corrected shortly.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Adapt POM:</strong> Change the pom.xml of apps-commons into a child POM by defining <strong>parent-pom/pom.xml</strong> as its parent POM, adapting the Maven coordinates to match the <strong>groupId</strong> of your Anypoint Platform organization ID, removing <strong>repositories</strong> and adding the <strong>Mule Maven plugin configuration</strong> to create an artifact with &lt;classifier /&gt; <strong>mule-plugin</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>a63e6d25-8aaf-4512-b36d-d91b90a55c4a<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
<span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
<span style="color: #b58900">&lt;groupId&gt;</span>a63e6d25-8aaf-4512-b36d-d91b90a55c4a<span style="color: #b58900">&lt;/groupId&gt;</span>
<span style="color: #b58900">&lt;artifactId&gt;</span>apps-commons<span style="color: #b58900">&lt;/artifactId&gt;</span>
<span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
<span style="color: #b58900">&lt;packaging&gt;</span>mule-application<span style="color: #b58900">&lt;/packaging&gt;</span>
<span style="color: #b58900">&lt;name&gt;</span>apps-commons<span style="color: #b58900">&lt;/name&gt;</span>
<span style="color: #b58900">&lt;build&gt;</span>
  <span style="color: #b58900">&lt;plugins&gt;</span>
    <span style="color: #b58900">&lt;plugin&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;configuration&gt;</span>
        <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
      <span style="color: #b58900">&lt;/configuration&gt;</span>
    <span style="color: #b58900">&lt;/plugin&gt;</span>
  <span style="color: #b58900">&lt;/plugins&gt;</span>
<span style="color: #b58900">&lt;/build&gt;</span>
<span style="color: #b58900">&lt;dependencies&gt;</span>
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>mule-http-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
    <span style="color: #657b83">&lt;!-- must be provided by enclosing Mule app --&gt;</span>
    <span style="color: #b58900">&lt;scope&gt;</span>provided<span style="color: #b58900">&lt;/scope&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must ensure to remove the repository definitions as they will conflict with the BOM and cause deployment failures later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM uses the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The &lt;packaging /&gt; element remains mule-application but the supplied Mule Maven plugin configuration changes the created artifact to be a Mule plugin via the &lt;classifier /&gt; element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule Maven plugin configuration is inherited in its entirety from the parent POM, and only the &lt;classifier /&gt; value is overridden in this child POM.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule flow config files in apps-commons — and therefore apps-commons itself — currently depend on the HTTP Connector, just like check-in-papi from which they originate. You make this fact explicit by defining these two dependencies in provided scope, meaning they must be provided (packaged) by all Mule apps that include apps-commons. To define these dependencies, you make use of the already configured version management in the BOM.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Remove non-reusable flow:</strong> In Studio, open <strong>health-common.xml</strong> and cut <strong>check-all-dependencies-are-alive</strong> because this Mule flow cannot be implemented in a common library; Studio should now show an error that this Mule flow is invoked from a &lt;flow-ref /&gt; in api-ready but missing.</p>
</li>
<li>
<p><strong>Create stubs:</strong> Create a new Mule flow config file called <strong>stubs.xml</strong> in <strong>src/test/resources</strong> (drag it from src/main/mule if necessary) that contains stubs (placeholders) for configuration elements expected to exist in the including Mule app but missing from apps-commons, paste <strong>check-all-dependencies-are-alive</strong> into it, and add a placeholder HTTP Listener configuration:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">stubs.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:listener-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"apiHttpListenerConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener-connection</span> <span style="color: #268bd2">host=</span><span style="color: #859900">"0.0.0.0"</span> <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTP"</span> <span style="color: #268bd2">port=</span><span style="color: #859900">"8081"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/http:listener-config&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The stubs.xml file is in the test source branch and is therefore available at development time but is not packaged in the resulting apps-commons library. This serves merely to eliminate the error(s) shown in Studio.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The details of these configuration elements do not matter, only their type and name. They will never be instantiated.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Navigate to the base directory of apps-commons and run a Maven build to install apps-commons into your local Maven repo; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Installing apps-commons into your local Maven repository with this statement is essential, otherwise Maven will not be able to resolve dependencies to apps-commons in later walkthroughs.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Install parent POMs:</strong> Install the <strong>BOM</strong> and <strong>parent POM</strong> used by apps-commons and check-in-papi into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>bom/pom.xml        <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>bom/pom.xml
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is necessary because the POM of apps-commons depends on both the parent POM and BOM, yet in the previous step only apps-commons was installed into the local Maven repository. When a dependency on apps-commons is resolved, the POM of apps-commons is loaded from the local Maven repo, and so the parent POM and BOM — which are required to interpret the POM of apps-commons — must also be loaded from the local Maven repo.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_import_mule_app_code_elements_from_a_library"><a class="anchor" href="#_import_mule_app_code_elements_from_a_library"></a><a class="link" href="#_import_mule_app_code_elements_from_a_library">Import Mule app code elements from a library</a></h4>
<div class="paragraph">
<p>In this section, you import apps-commons as a Maven dependency into check-in-papi to reuse the Mule app code from that library.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><strong>Add managed library dependency:</strong> Locate the existing dependency management of apps-commons in the <strong>BOM</strong> and add a matching entry to the check-in-papi <strong>POM</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>${student.deployment.ap.orgid}<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>apps-commons<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The BOM defines a Maven property, available in all child POMs, to hold your Anypoint Platform organization ID, which is the &lt;groupId /&gt; for the apps-commons retrieved from the Exchange of that Anypoint Platform organization.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Refresh Studio project:</strong> In Studio, close and reopen the <strong>check-in-papi</strong> project; Studio should resolve the apps-commons dependency and show it as a project dependency.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If Studio does not find apps-commons then you may need to force reloading Maven dependencies from a command-line interface with the <code>-U</code> option, and then close and reopen the check-in-papi Studio project:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn clean verify <span style="color: #b58900">-U</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Replace error handlers with import:</strong> In <strong>error.xml</strong> of check-in-papi replace the code that has been extracted to apps-commons — which is all Mule app code in that file — with an import of the relevant Mule flow config file from apps-commons:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">error.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;mule&gt;</span>
  <span style="color: #b58900">&lt;import</span> <span style="color: #268bd2">file=</span><span style="color: #859900">"error-common.xml"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/mule&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Do not delete the XML namespace-related attributes from the root element in this Mule flow config file — they are omitted here just for brevity!</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Mule flow config files from the Mule app itself are always implicitly available in that Mule app, but files packaged in a library must be imported explicitly, such as here.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Replace health check endpoints with import:</strong> In <strong>health.xml</strong> of check-in-papi replace the code that has been extracted to apps-commons with an import of the relevant Mule flow config file from apps-commons:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;mule&gt;</span>
  <span style="color: #b58900">&lt;import</span> <span style="color: #268bd2">file=</span><span style="color: #859900">"health-common.xml"</span> <span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/sub-flow&gt;</span>
<span style="color: #b58900">&lt;/mule&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Do not delete the XML namespace-related attributes from the root element in this Mule flow config file — they are omitted here just for brevity!</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The check-all-dependencies-are-alive Mule flow inoked from api-ready in apps-commons but missing from that library must be implemented in health.xml, otherwise check-in-papi would fail at runtime and Studio should also show an error at development time.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app from Studio and invoke the health check endpoints; this should return a HTTP 200 response in both cases:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_maven_artifacts_to_exchange_as_custom_assets"><a class="anchor" href="#_deploy_maven_artifacts_to_exchange_as_custom_assets"></a><a class="link" href="#_deploy_maven_artifacts_to_exchange_as_custom_assets">Deploy Maven artifacts to Exchange as custom assets</a></h4>
<div class="paragraph">
<p>Mule 4 Extensions that declare dependencies that don’t exist in Maven Central or the MuleSoft Maven repositories, are not currently supported. Therefore any extension type artifact deployed to Exchange that relies on a custom asset such as the parent POM and BOM introduced in the previous sections, are required to deployed to Exchange prior.</p>
</div>
<div class="paragraph">
<p>The steps to publish an asset with Maven are slightly different for each asset type, and different assets use different Maven plugins. In this case you will use Exchange Mule Maven plugin each POM as a custom asset.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p><strong>Study BOM:</strong> Browse the content of the bom/pom.xml, identifying the <strong>Exchange Mule Maven plugin</strong> configuration located in a Maven profile <strong>deploy-to-exchange-v3</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;profile&gt;</span>
  <span style="color: #b58900">&lt;id&gt;</span>deploy-to-exchange-v3<span style="color: #b58900">&lt;/id&gt;</span>
  <span style="color: #b58900">&lt;build&gt;</span>
    <span style="color: #b58900">&lt;plugins&gt;</span>
      <span style="color: #b58900">&lt;plugin&gt;</span>
        <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
        <span style="color: #b58900">&lt;artifactId&gt;</span>exchange-mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
        <span style="color: #b58900">&lt;version&gt;</span>${exchange.mule.maven.plugin.version}<span style="color: #b58900">&lt;/version&gt;</span>
        <span style="color: #b58900">&lt;executions&gt;</span>
          <span style="color: #b58900">&lt;execution&gt;</span>
            <span style="color: #b58900">&lt;id&gt;</span>validate<span style="color: #b58900">&lt;/id&gt;</span>
            <span style="color: #b58900">&lt;phase&gt;</span>validate<span style="color: #b58900">&lt;/phase&gt;</span>
            <span style="color: #b58900">&lt;goals&gt;</span>
              <span style="color: #b58900">&lt;goal&gt;</span>exchange-pre-deploy<span style="color: #b58900">&lt;/goal&gt;</span>
            <span style="color: #b58900">&lt;/goals&gt;</span>
          <span style="color: #b58900">&lt;/execution&gt;</span>
          <span style="color: #b58900">&lt;execution&gt;</span>
            <span style="color: #b58900">&lt;id&gt;</span>deploy<span style="color: #b58900">&lt;/id&gt;</span>
            <span style="color: #b58900">&lt;phase&gt;</span>deploy<span style="color: #b58900">&lt;/phase&gt;</span>
            <span style="color: #b58900">&lt;goals&gt;</span>
              <span style="color: #b58900">&lt;goal&gt;</span>exchange-deploy<span style="color: #b58900">&lt;/goal&gt;</span>
            <span style="color: #b58900">&lt;/goals&gt;</span>
          <span style="color: #b58900">&lt;/execution&gt;</span>
        <span style="color: #b58900">&lt;/executions&gt;</span>
      <span style="color: #b58900">&lt;/plugin&gt;</span>
    <span style="color: #b58900">&lt;/plugins&gt;</span>
  <span style="color: #b58900">&lt;/build&gt;</span>
<span style="color: #b58900">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The exchange-pre-deploy goal must be run to pre-validate the asset with Exchange where it checks various pre-conditions such as unique asset versions. Without explicitly running this goal, the Exchange API will return a status code of 412 (Precondition Failed). It can be bound to other phases such as the validate phase, but it is set to the deploy phase in this course to not interfere with local builds.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This plugin is applied directly to the BOM and configured not to be inherited by Maven child projects so that the Exchange pre-validation steps are not applied to projects that will not be deployed to Exchange.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API does not support dynamic parameters within groupIds such as ${aa.ap.org.id} and it requires the value to be the hardcoded Anypoint Platform organization ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API requires that every asset deployed must have an artifact name element defined in the POM.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API requires a Maven property named type with the value set custom for custom assets.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add Maven property to parent POMs:</strong> Add to the parent POMs a property to instruct the Exchange Mule Maven plugin plugin that this is a custom asset:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;type&gt;</span>custom<span style="color: #b58900">&lt;/type&gt;</span>
  ...
<span style="color: #b58900">&lt;properties&gt;</span>
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;type&gt;</span>custom<span style="color: #b58900">&lt;/type&gt;</span>
  ...
<span style="color: #b58900">&lt;properties&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This property is not explicitly used but is used internally by the Exchange Mule Maven plugin and needed for deployment to Exchange, otherwise Exchange cannot determine the asset type.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy parent POMs to Exchange:</strong> Deploy the <strong>BOM</strong> and <strong>parent POM</strong> used by apps-commons to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/bom
mvn deploy <span style="color: #b58900">-f</span> pom.xml <span style="color: #b58900">-Pdeploy-to-exchange-v3</span>

<span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/parent-pom
mvn deploy <span style="color: #b58900">-f</span> pom.xml <span style="color: #b58900">-Pdeploy-to-exchange-v3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a SNAPSHOT version is deployed to Exchange, it is created in the development lifecycle phase allowing the asset version to be overwritten and permanently deleted, whenever. When a stable asset version is deployed, Exchange will treat the asset as a production asset and enforce the standard Exchange rules upon it. Such as locking the version number so it cannot be overwritten and only allowing permanent deletion within the first 7 days.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy custom library to Exchange:</strong> Deploy apps-commons to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule Maven plugin is automatically integrated with Exchange Mule Maven plugin, therefore there is no need to define the Exchange Mule Maven plugin configuration as well. It is only needed to directly reference the Exchange Mule Maven plugin when deploying non-Mule artifacts such as custom libraries and POMs. If both are configured, deployment will happen twice, and the second deployment will fail with a conflict.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API enables you to both create your asset and set the mutable data describing it in the same request. The mutable data of an asset includes tags, custom fields, categories, and documentation pages. The final solution includes a complete example of creating a API policy with documentation and tags.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Refresh Studio project:</strong> In Studio, close and reopen the <strong>check-in-papi</strong> project; Studio should resolve the apps-commons dependency and show it as a project dependency.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If Studio does not find apps-commons then you may need to force reloading Maven dependencies from a command-line interface with the <code>-U</code> option, and then close and reopen the check-in-papi Studio project:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn clean verify <span style="color: #b58900">-U</span></code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-munit"><a class="anchor" href="#module-munit"></a><a class="link" href="#module-munit">Module 4: Automating unit-testing with MUnit</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you develop a unit test suite for a Mule app using the MUnit framework, and execute these tests interactively from Studio and automatically from every Maven build.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable a Mule app for unit testing with MUnit.</p>
</li>
<li>
<p>Perform basic unit testing of integration functionality.</p>
</li>
<li>
<p>Mock external dependencies.</p>
</li>
<li>
<p>Spy on the data exchanged with external dependencies.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-141"><a class="anchor" href="#wt-begin-141"></a><a class="link" href="#wt-begin-141">Walkthrough 4-1: Enable MUnit</a></h3>
<div class="paragraph">
<p>The check-in-papi Mule app so far implements no real integration logic. Before you start adding integration logic, you must enable unit testing support, so that integration logic can be unit tested with minimal friction.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you add support for MUnit testing to check-in-papi and its Maven build. You also have Studio generate some basic MUnit tests for the code in check-in-papi. At the end of this walkthrough your parent POM will be sufficiently mature to be reusable in all Mule apps and Maven projects created in the remainder of this course.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#wt4-1-add-munit">Add fundamental MUnit support and basic MUnit tests to check-in-papi and its parent POMs</a>.</p>
</li>
<li>
<p><a href="#_analyze_munit_test_coverage">Analyze MUnit test coverage</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_9"><a class="anchor" href="#_solution_file_9"></a><a class="link" href="#_solution_file_9">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_8"><a class="anchor" href="#_starting_file_8"></a><a class="link" href="#_starting_file_8">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module03/wt3-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="wt4-1-add-munit"><a class="anchor" href="#wt4-1-add-munit"></a><a class="link" href="#wt4-1-add-munit">Add fundamental MUnit support and basic MUnit tests to a Mule app</a></h4>
<div class="paragraph">
<p>In this section, you use Studio features to add MUnit support to check-in-papi and generate a basic MUnit test suite for the Mule flows in main.xml. You also pass the encryption key when MUnit tests are run, so that secure properties files can be decrypted.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Add MUnit Maven config:</strong> In Studio, on the <strong>check-in-papi</strong> project, execute <strong>Configure MUnit Maven support</strong>; this adds the MUnit Maven plugin and supporting Maven dependencies to the POM.</p>
</li>
<li>
<p><strong>Use managed dependencies:</strong> Locate in the <strong>BOM</strong> the already existing &lt;dependencyManagement /&gt; entries for all MUnit-related dependencies, then delete their <strong>&lt;version /&gt;</strong> elements from the <strong>POM</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;build&gt;</span>
  <span style="color: #b58900">&lt;plugins&gt;</span>
    ...
    <span style="color: #b58900">&lt;plugin&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.munit.tools<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>munit-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;executions&gt;</span>...<span style="color: #b58900">&lt;/executions&gt;</span>
      <span style="color: #b58900">&lt;configuration&gt;</span>...<span style="color: #b58900">&lt;/configuration&gt;</span>
    <span style="color: #b58900">&lt;/plugin&gt;</span>
  <span style="color: #b58900">&lt;/plugins&gt;</span>
<span style="color: #b58900">&lt;/build&gt;</span>

<span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.munit<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>munit-runner<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
    <span style="color: #b58900">&lt;scope&gt;</span>test<span style="color: #b58900">&lt;/scope&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.munit<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>munit-tools<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
    <span style="color: #b58900">&lt;scope&gt;</span>test<span style="color: #b58900">&lt;/scope&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.weave<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>assertions<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;scope&gt;</span>test<span style="color: #b58900">&lt;/scope&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>These MUnit Maven dependencies must be defined in test scope, otherwise the Mule app will no longer execute successfully.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Pull-up refined plugin config:</strong> Copy the <strong>MUnit Maven plugin</strong> configuration to the <strong>parent POM</strong> under <strong>&lt;pluginManagement /&gt;</strong> so that it is available for all related Mule apps and specify MUnit tests to run on <strong>4.4.0-20230522 EE</strong> with the correct <strong>encrypt.key</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;plugin&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.munit.tools<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>munit-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;executions&gt;</span>
    <span style="color: #b58900">&lt;execution&gt;</span>
      <span style="color: #b58900">&lt;id&gt;</span>test<span style="color: #b58900">&lt;/id&gt;</span>
      <span style="color: #b58900">&lt;phase&gt;</span>test<span style="color: #b58900">&lt;/phase&gt;</span>
      <span style="color: #b58900">&lt;goals&gt;</span>
        <span style="color: #b58900">&lt;goal&gt;</span>test<span style="color: #b58900">&lt;/goal&gt;</span>
        <span style="color: #b58900">&lt;goal&gt;</span>coverage-report<span style="color: #b58900">&lt;/goal&gt;</span>
      <span style="color: #b58900">&lt;/goals&gt;</span>
    <span style="color: #b58900">&lt;/execution&gt;</span>
  <span style="color: #b58900">&lt;/executions&gt;</span>
  <span style="color: #b58900">&lt;configuration&gt;</span>
    <span style="color: #b58900">&lt;runtimeVersion&gt;</span>${app.runtime}<span style="color: #b58900">&lt;/runtimeVersion&gt;</span>
    <span style="color: #b58900">&lt;runtimeProduct&gt;</span>MULE_EE<span style="color: #b58900">&lt;/runtimeProduct&gt;</span>
    <span style="color: #b58900">&lt;environmentVariables&gt;</span>
      <span style="color: #657b83">&lt;!-- this implies that all tests run in the same Maven build must use the same encrypt.key --&gt;</span>
      <span style="color: #b58900">&lt;encrypt.key&gt;</span>${encrypt.key}<span style="color: #b58900">&lt;/encrypt.key&gt;</span>
    <span style="color: #b58900">&lt;/environmentVariables&gt;</span>
    <span style="color: #b58900">&lt;coverage&gt;</span>
      <span style="color: #b58900">&lt;runCoverage&gt;</span>true<span style="color: #b58900">&lt;/runCoverage&gt;</span>
      <span style="color: #b58900">&lt;formats&gt;</span>
        <span style="color: #b58900">&lt;format&gt;</span>console<span style="color: #b58900">&lt;/format&gt;</span>
        <span style="color: #b58900">&lt;format&gt;</span>html<span style="color: #b58900">&lt;/format&gt;</span>
      <span style="color: #b58900">&lt;/formats&gt;</span>
    <span style="color: #b58900">&lt;/coverage&gt;</span>
  <span style="color: #b58900">&lt;/configuration&gt;</span>
<span style="color: #b58900">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You omit the version of the MUnit Maven plugin because it is inherited from the BOM.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You configure the MUnit Maven plugin in &lt;pluginManagement /&gt; so that each child project can decide whether to execute it or not.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Runtime version and product used to run MUnit tests have defaults taken from mule-artifact.json, but can also be specified explicitly, like here. This is recommended when a precise version of the Mule runtime is targeted, as is often the case.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule runtime version must be specified via its full version (4.4.0-20230522) rather than the simplified, semantic version (4.4.0). Of course, this only applies in the rare cases where there is a difference between these two version strings.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>MUnit tests would fail at launch if the encrypt.key property were not supplied to the embedded Mule runtime executing the tests.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Test coverage reports will be produced in HTML format and printed to the console.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Simplify plugin config in POM:</strong> In the POM, delete everything now inherited from the parent POM and BOM, retaining just what is needed to execute the already configured <strong>MUnit Maven plugin</strong> (in addition to the Mule Maven plugin), and keeping the MUnit-related dependencies without version in test scope:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;build&gt;</span>
  <span style="color: #b58900">&lt;plugins&gt;</span>
    <span style="color: #b58900">&lt;plugin&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;/plugin&gt;</span>
    <span style="color: #b58900">&lt;plugin&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.munit.tools<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>munit-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;/plugin&gt;</span>
  <span style="color: #b58900">&lt;/plugins&gt;</span>
<span style="color: #b58900">&lt;/build&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Generate MUnit tests:</strong> Using the New MUnit test wizard (<strong>File &gt; New &gt; MUnit Test</strong>), generate MUnit test skeletons for all Mule flows in <strong>main.xml</strong> into a new file <strong>main-test-suite.xml</strong>.</p>
</li>
<li>
<p><strong>Study and clean tests:</strong> Inspect and clean-up the generated MUnit tests to follow your coding conventions.</p>
</li>
<li>
<p><strong>MUnit-test:</strong> In Studio, run the test suite; this should fail.</p>
</li>
<li>
<p><strong>Update run config:</strong> Edit the run configuration generated by Studio for the MUnit test suite by adding the <strong>encryption key</strong> as a <strong>VM argument</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is a direct argument to the JVM, not to the Mule runtime.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Locate repos:</strong> In <strong>BOM</strong>, find in <strong>&lt;pluginRepositories /&gt;</strong> the existing entry for the Maven repository to download the <strong>EE</strong> Mule runtime from.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The normal MuleSoft releases repository is always required both under &lt;repositories /&gt; and &lt;pluginRepositories /&gt;.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The MuleSoft EE releases repository is required under &lt;pluginRepositories /&gt; because the MUnit Maven plugin has been configured to run tests on the EE version of the Mule runtime. If EE-only Mule plugins or connectors were used, which is currently not the case, then it would also be required under &lt;repositories /&gt;.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Install parent POMs:</strong> Install the <strong>BOM</strong> and <strong>parent POM</strong> into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is necessary because MUnit Maven tooling currently does not resolve parent POMs from the filesystem location given in &lt;relativePath /&gt;.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You have already installed the parent POM in a previous walkthrough, for different reasons, but parent-pom/pom.xml has changed in the meantime.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add repository credentials:</strong> In <strong>settings.xml</strong>, add the credentials required to access the MuleSoft EE releases repository:</p>
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;server&gt;</span>
  <span style="color: #b58900">&lt;id&gt;</span>releases-ee<span style="color: #b58900">&lt;/id&gt;</span>
  <span style="color: #b58900">&lt;username&gt;</span>muletraining.nexus<span style="color: #b58900">&lt;/username&gt;</span>
  <span style="color: #b58900">&lt;password&gt;</span>eApHMgTm<span style="color: #b58900">&lt;/password&gt;</span>
<span style="color: #b58900">&lt;/server&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, run a full Maven build including the MUnit test suite, passing the encryption key; this should succeed, all unit tests should pass, and a coverage report should be output to the console:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> In Studio, run the MUnit test suite, using the run configuration that includes the encryption key; this should succeed and all unit tests should pass.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_analyze_munit_test_coverage"><a class="anchor" href="#_analyze_munit_test_coverage"></a><a class="link" href="#_analyze_munit_test_coverage">Analyze MUnit test coverage</a></h4>
<div class="paragraph">
<p>In this section, you briefly compare the visual test coverage indicators in Studio and the textual test coverage report produced by the MUnit Maven plugin.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p><strong>Study coverage report:</strong> Inspect the test coverage report output to the console in the previous step.</p>
</li>
<li>
<p><strong>Study Studio coverage:</strong> In Studio, open <strong>main.xml</strong> and, for example, <strong>api.xml</strong>, and confirm that the visual test coverage indicators match the coverage report.</p>
</li>
<li>
<p><strong>Reflect:</strong> Discuss desired coverage limits for the different Mule flow config files and Mule flows, which could be enforced by the MUnit Maven plugin.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-142"><a class="anchor" href="#wt-begin-142"></a><a class="link" href="#wt-begin-142">Walkthrough 4-2: Perform basic unit testing</a></h3>
<div class="paragraph">
<p>The MUnit tests generated for check-in-papi in the previous walkthrough are just skeletons.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you first realize that there is value in simply asserting that a Mule app deploys and starts successfully. You then proceed to implement simple unit tests for the check-in functionality of check-in-papi, ignoring the payment approval functionality of that API implementation.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_test_deployment_and_startup_of_the_mule_app_under_test">Test deployment and startup of check-in-papi</a>.</p>
</li>
<li>
<p><a href="#wt4-2-prepare-test-data">Prepare and pass test data to Mule flows under test</a>.</p>
</li>
<li>
<p><a href="#_assert_the_output_of_executing_mule_flows">Assert the output of executing these Mule flows</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_10"><a class="anchor" href="#_solution_file_10"></a><a class="link" href="#_solution_file_10">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_9"><a class="anchor" href="#_starting_file_9"></a><a class="link" href="#_starting_file_9">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_deployment_and_startup_of_the_mule_app_under_test"><a class="anchor" href="#_test_deployment_and_startup_of_the_mule_app_under_test"></a><a class="link" href="#_test_deployment_and_startup_of_the_mule_app_under_test">Test deployment and startup of the Mule app under test</a></h4>
<div class="paragraph">
<p>In this section, you implement the simplest possible MUnit test and realize that even this serves an important purpose, namely the verification that the Mule app is syntactically correct, has all required dependencies, and is starts up without errors. Every Mule app that does not implement a proper MUnit test suite should at least provide such a "start-up test".</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study test execution:</strong> Inspect <strong>main-test-suite.xml</strong> and match it with the log output of executing this test suite.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The Mule app under test — check-in-papi — was deployed to an embedded Mule runtime and started.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a test case and tests generated by Studio executes, it invokes its respective flow-under-test without preparing test data or asserting any end state.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Invoking flows-under-test without preparing test data cannot in general be expected to succeed, so the fact that these tests pass is a fortunate conincidence. This is why the generated tests are only skeletons — starting points for implementing tests.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Implement startup test only:</strong> Temporarily comment-out all generated tests and add the simplest possible test case:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"start-up-test"</span> <span style="color: #268bd2">description=</span><span style="color: #859900">"..."</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>
    <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:execution&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The &lt;munit:execution /&gt; section must not be empty.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This test case does nothing (but log the current message) and is completely independent of check-in-papi.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the test suite; this should pass.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If check-in-papi were misconfigured — a missing properties file, an invalid Mule flow config file, a missing or incorrect encrypt.key, etc. — the test suite would have failed.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Even the simplest possible MUnit test, whose code is completely independent of the Mule app under test, verifies that the Mule app is syntactically correct, not missing any dependencies, and deploys and starts successfully.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Revert to generated tests:</strong> Undo the changes to <strong>main-test-suite.xml</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt4-2-prepare-test-data"><a class="anchor" href="#wt4-2-prepare-test-data"></a><a class="link" href="#wt4-2-prepare-test-data">Prepare and pass test data to Mule flows under test</a></h4>
<div class="paragraph">
<p>In this section, you prepare test data as input for check-in-by-pnr, the flow-under-test. Because this flow is in main.xml, and not in api.xml, it does not expose an HTTP-based interface and the input test data is therefore not a HTTP request. Rather than hard-coding complex test data in the MUnit tests, you load it from a file.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p><strong>Determine expected test input:</strong> Open <strong>main.xml</strong> and explore the input expected by <strong>check-in-by-pnr</strong> by tracing back to its calling flow in api.xml and the API specification for Check-In PAPI.</p>
<div class="paragraph">
<p><em>Note:</em> <em>check-in-by-pnr requires a variable PNR and a JSON payload with last name and number of bags, as defined by the API specification.</em></p>
</div>
</li>
<li>
<p><strong>Create test data file:</strong> Create a new directory and file <strong>json/check-in-by-pnr-request.json</strong> under <strong>src/test/resources</strong> to hold the payload test data for check-in-by-pnr:</p>
<div class="listingblock">
<div class="title">json/check-in-by-pnr-request.json of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="json"><span style="color: #93a1a1">{</span><span style="color: #586e75"> </span><span style="color: #586e75">"lastName"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"Mule"</span><span style="color: #93a1a1">,</span><span style="color: #586e75"> </span><span style="color: #586e75">"numBags"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">2</span><span style="color: #586e75"> </span><span style="color: #93a1a1">}</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Set test input data from file:</strong> In <strong>main-test-suite.xml</strong> edit the tests generated before to implement a happy-path test that sets the input test data for check-in-by-pnr using &lt;munit:set-event /&gt;, reading the payload from the previously created data file:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span>
  <span style="color: #268bd2">description=</span><span style="color: #859900">"..."</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>
    <span style="color: #b58900">&lt;munit:set-event&gt;</span>
      <span style="color: #b58900">&lt;munit:payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- read(MunitTools::getResourceAsString('json/check-in-by-pnr-request.json'), 'application/json')]"</span>
      <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;munit:variables&gt;</span>
        <span style="color: #b58900">&lt;munit:variable</span> <span style="color: #268bd2">key=</span><span style="color: #859900">"PNR"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"N123"</span> <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/munit:variables&gt;</span>
    <span style="color: #b58900">&lt;/munit:set-event&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:execution&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The content-type application/json of the payload data read from file must be stated repeatedly, once when reading and parsing the file content and once when specifying the output media type of the DataWeave expression.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Setting the output media type of the DataWeave expression is sufficient for setting the payload value in MUnit test suites. The same is not true when setting the value of a variable or attribute to a non-primitive value (that is, other than here), where the media type must be (redundantly) specified as an XML attribute even if the DataWeave expression for the value already specifies the output media type.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>&lt;munit:set-event /&gt; can be used in both &lt;munit:behavior /&gt; and &lt;munit:execution /&gt;. When used in &lt;munit:behavior /&gt;, it must be the last action configured, as mocks and spies defined after can interfere.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The above message payload and variable are passed as input to check-in-by-pnr.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, MUnit does not start any of the event sources (flow sources such as triggers, and listeners). If the Mule flow under test requires interacting via a listener, then flow sources must be enabled via munit:enable-flow-sources.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test and check log:</strong> Run the MUnit test; confirm in the log output the successful setting of the input data.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_assert_the_output_of_executing_mule_flows"><a class="anchor" href="#_assert_the_output_of_executing_mule_flows"></a><a class="link" href="#_assert_the_output_of_executing_mule_flows">Assert the output of executing Mule flows</a></h4>
<div class="paragraph">
<p>In this section, you add assertions to your unit test to confirm that the output of check-in-by-pnr, the flow-under-test, is as expected.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p><strong>Determine expected test output:</strong> Open <strong>main.xml</strong> and explore the output created by <strong>check-in-by-pnr</strong>.</p>
</li>
<li>
<p><strong>Assert test output:</strong> In <strong>main-test-suite.xml</strong> add to the happy-path test for check-in-by-pnr an assertion of the expected payload:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"..."</span> <span style="color: #268bd2">description=</span><span style="color: #859900">"..."</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>...<span style="color: #b58900">&lt;/munit:execution&gt;</span>
  <span style="color: #b58900">&lt;munit:validation&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:assert-that</span>
      <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[payload]"</span>
      <span style="color: #268bd2">is=</span><span style="color: #859900">"#[MunitTools::equalTo({paymentID: 'PAY-1AKD7482FAB9STATKO'})]"</span>
    <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:validation&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You construct in-line an object to compare to the payload. This could also have been read from a file.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test; this should succeed and all tests should pass.</p>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, run a Maven build including the MUnit test suite as before; this should succeed and all unit tests should pass:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-143"><a class="anchor" href="#wt-begin-143"></a><a class="link" href="#wt-begin-143">Walkthrough 4-3: Mock and spy external dependencies</a></h3>
<div class="paragraph">
<p>The current implementation of check-in-papi does not actually invoke any external dependencies, such as downstream APIs. But before this will be done in later walkthroughs, it is important that the check-in-papi unit tests are first prepared so that external dependencies are not actually invoked from unit tests. Instead, it is good practice that unit tests substitute all external dependencies with MUnit mocks, so that the unit tests run independently of external dependencies, and therefore also run in environments that do not provide these dependencies. Furthermore, unit tests should also validate data that would have been sent to, and — to a lesser degree — returned from external dependencies, but is instead actually exchanged with the corresponding mock: this validation is achieved using MUnit spies.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you implement a basic MUnit test suite for the core check-in functionality of check-in-papi, encapsulating the future invocation of downstream System APIs in private Mule flows and then mocking and spying on the invocation of those Mule flows. You do not only cover the happy path but also a simple exception path of this use case.</p>
</div>
<div class="paragraph">
<p>Importantly, if integration logic is properly encapsulated in small Mule flows, then mocking and spying on the invocation of Mule flows is by far the most important mocking technique needed.</p>
</div>
<div class="paragraph">
<p>You initially follow a Test-Driven Development (TDD) approach. This means you assume that integration logic has been implemented and first write the unit test that depends on that integration logic. After the unit test fails as expected, you actually implement the integration logic in the simplest possible way, such that the unit test then passes. In later parts of this walkthrough, and in future walkthroughs, you take a more pragmatic, not strictly TDD-based approach, where unit tests are implemented after the integration logic they test.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_mock_and_verify_the_invocation_of_mule_flows">Mock and verify the invocation of Mule flows</a>.</p>
</li>
<li>
<p><a href="#_validate_data_exchanged_with_invoked_mule_flows">Validate data exchanged with invoked Mule flows</a>.</p>
</li>
<li>
<p><a href="#wt4-3-refactoring">Refactor MUnit tests to remove code smells</a>.</p>
</li>
<li>
<p><a href="#_mock_and_require_errors_raised_by_the_invocation_of_mule_flows">Mock and require errors raised by the invocation of Mule flows</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_11"><a class="anchor" href="#_solution_file_11"></a><a class="link" href="#_solution_file_11">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_10"><a class="anchor" href="#_starting_file_10"></a><a class="link" href="#_starting_file_10">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mock_and_verify_the_invocation_of_mule_flows"><a class="anchor" href="#_mock_and_verify_the_invocation_of_mule_flows"></a><a class="link" href="#_mock_and_verify_the_invocation_of_mule_flows">Mock and verify the invocation of Mule flows</a></h4>
<div class="paragraph">
<p>In this section, you assume the existence of three private Mule flows that invoke the three System APIs on which check-in-papi depends. You set-up MUnit mocks for the invocation of those Mule flows and assert that the mocks are indeed called. You then confirm that the unit test fails as expected, add the Mule flows and their invocations, and finally confirm that the unit test now passes.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study System APIs invoked by check-in-papi:</strong> Review the <a href="#section-aa-solution-arch">Solution architecture</a> and in particular the <a href="#aa-high-level-arch">High-level architecture</a> and the <a href="#aa-us1-realization">design of US1: mobile Check-In</a>; note the dependencies of Check-In PAPI on Flights Management SAPI, Passenger Data SAPI, and PayPal SAPI for the core check-in functionality being implemented in check-in-by-pnr.</p>
</li>
<li>
<p><strong>Assume flows invoking System APIs:</strong> Assume that check-in-by-pnr invokes the following three Mule flows, which in turn invoke the aforementioned System APIs: check-in-flights-management, register-passenger-data, and create-payment-for-bags.</p>
</li>
<li>
<p><strong>Mock flow invocations:</strong>  Add to <strong>main-test-suite.xml</strong> in the <strong>&lt;munit:behavior /&gt;</strong> section of the happy-path test for check-in-by-pnr three MUnit mocks for the invocation of these three private Mule flows via &lt;flow-ref /&gt; elements, returning empty payloads for now:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;munit-tools:mock-when</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"check-in-flights-management"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:then-return&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {}]"</span>
      <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:then-return&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:mock-when&gt;</span>

  <span style="color: #b58900">&lt;munit-tools:mock-when</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"register-passenger-data"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:then-return&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {}]"</span>
      <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:then-return&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:mock-when&gt;</span>

  <span style="color: #b58900">&lt;munit-tools:mock-when</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"create-payment-for-bags"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:then-return&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {}]"</span>
      <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:then-return&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:mock-when&gt;</span>
<span style="color: #b58900">&lt;/munit:behavior&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The MUnit mock configuration mirrors the invocation of a private Mule flow with &lt;flow-ref /&gt;.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a &lt;flow-ref /&gt; matching one of these mocks is executed, the mock directly returns the configured payload instead of invoking the Mule flow.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The mocked payloads are not currently used so you can return empty placeholder JSON payloads.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Assert number of flow invocations:</strong> Add to the <strong>&lt;munit:validation /&gt;</strong> section of the happy-path test for check-in-by-pnr three <strong>&lt;munit-tools:verify-call /&gt;</strong> elements that assert that each Mule flow is called exactly once:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:validation&gt;</span>
  <span style="color: #b58900">&lt;munit-tools:verify-call</span> <span style="color: #268bd2">times=</span><span style="color: #859900">"1"</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"check-in-flights-management"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:verify-call&gt;</span>

  <span style="color: #b58900">&lt;munit-tools:verify-call</span> <span style="color: #268bd2">times=</span><span style="color: #859900">"1"</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"register-passenger-data"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:verify-call&gt;</span>

  <span style="color: #b58900">&lt;munit-tools:verify-call</span> <span style="color: #268bd2">times=</span><span style="color: #859900">"1"</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"create-payment-for-bags"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:verify-call&gt;</span>

  <span style="color: #b58900">&lt;munit-tools:assert-that</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[payload]"</span> <span style="color: #268bd2">is=</span><span style="color: #859900">"..."</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/munit:validation&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The mocks and &lt;munit-tools:verify-call /&gt; elements are formally independent, but follow the same logic and syntax and augment each other naturally. Each could be used without the other, though.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite; all tests should run without error but the happy-path test for check-in-by-pnr should fail due to an assertion violation.</p>
<div class="paragraph">
<p><em>Note:</em> <em>The flow-under-test (check-in-by-pnr) is invoked, but its implementation does not actually call the three Mule flows verified by the &lt;munit:validation /&gt; section of the MUnit test.</em></p>
</div>
</li>
<li>
<p><strong>Make test pass:</strong> To <strong>main.xml</strong> add the three missing Mule flows and invoke them from check-in-by-pnr without any special consideration for inputs and outputs:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-passenger-data"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags"</span> <span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span>...<span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-passenger-data"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You leave the setting of the payload in check-in-by-pnr to a hard-coded value in place.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In true TDD style, this is the simplest possible integration logic that will make the test pass, but it is not a functional implementation of check-in-by-pnr.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite; this should succeed and all tests should now pass.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The test so far makes no use of the placeholder payloads returned by the three mocks.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_validate_data_exchanged_with_invoked_mule_flows"><a class="anchor" href="#_validate_data_exchanged_with_invoked_mule_flows"></a><a class="link" href="#_validate_data_exchanged_with_invoked_mule_flows">Validate data exchanged with invoked Mule flows</a></h4>
<div class="paragraph">
<p>In this section, you spy on and validate the data that would be passed by check-in-by-pnr to one of the private Mule flows, create-payment-for-bags. In actual fact, the invocation of create-payment-for-bags is intercepted by the corresponding mock set-up previously. You start by capturing the payload sent to check-in-by-pnr in a variable which will be passed to create-payment-for-bags, and then validate the content of that variable upon invocation of create-payment-for-bags using an MUnit spy. Using the same spy you could also validate the data returned by create-payment-for-bags — or rather, the corrsponding mock.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p><strong>Store input payload:</strong> In <strong>main.xml</strong>, store the payload sent to <strong>check-in-by-pnr</strong> into a variable:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"checkIn"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[payload]"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This makes it explicit that the payload sent to check-in-by-pnr is a check-in command, and it also isolates that input data from future changes to the payload.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This variable will be the input to create-payment-for-bags — it forms part of the contract with create-payment-for-bags.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Assert input to flow invocation:</strong> Add an MUnit spy to the <strong>&lt;munit:behavior /&gt;</strong> section of the happy-path test for check-in-by-pnr, after the mocks, to assert this variable value at the point of invoking create-payment-for-bags:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:behavior&gt;</span>
  ...
  <span style="color: #b58900">&lt;munit-tools:spy</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes</span> <span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"create-payment-for-bags"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:before-call&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:assert-that</span>
        <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[vars.checkIn]"</span>
        <span style="color: #268bd2">is=</span><span style="color: #859900">"#[MunitTools::equalTo(read(MunitTools::getResourceAsString('json/check-in-by-pnr-request.json'), 'application/json'))]"</span>
      <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:before-call&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:spy&gt;</span>
<span style="color: #b58900">&lt;/munit:behavior&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The assertion value is the exact same expression that was used to set the payload before invoking check-in-by-pnr from the unit test.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In the same spy you could also validate the output returned by the create-payment-for-bags mock.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The mock and spy elements are formally independent, but follow the same logic and syntax and augment each other naturally. Each could be used without the other, though.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>MUnit spies contain assertions but are configured in the &lt;munit:behavior /&gt; section, not the &lt;munit:validation /&gt; section.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Assert input to remaining flow invocations:</strong> Set-up spies with input data validation for the invocation of the other two mocked Mule flows, check-in-flights-management and register-passenger-data.</p>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite; this should succeed and all tests should now pass.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wt4-3-refactoring"><a class="anchor" href="#wt4-3-refactoring"></a><a class="link" href="#wt4-3-refactoring">Refactor MUnit tests to remove code smells</a></h4>
<div class="paragraph">
<p>In this section, you inspect the MUnit test suite of check-in-papi and discover that it is not of the desired code quality. Recognizing that test code must be maintained just like production code, you refactor the test code to raise its quality while keeping its functionality unchanged — the definition of refactoring. You apply two refactoring techniques: shortening a long Mule flow by extracting parts of its integration logic into one or more private Mule flows or subflows; and extracting duplicate DataWeave variables and functions into a DataWeave module.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p><strong>Identify code smells:</strong> Inspect <strong>main-test-suite.xml</strong> of check-in-papi and identify <a href="https://en.wikipedia.org/wiki/Code_smell">code smells</a>.</p>
<div class="paragraph">
<p><em>Note:</em> <em>At the very least, you should identify duplicate Mule app code, including duplicate DataWeave code, and overly long Mule flows.</em></p>
</div>
</li>
<li>
<p><strong>Extract mock config:</strong> Extract the set-up of all mocks into a new subflow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:behavior&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"setup-happy-sapi-mocks"</span> <span style="color: #b58900">/&gt;</span>
    ...
  <span style="color: #b58900">&lt;/munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>...<span style="color: #b58900">&lt;/munit:execution&gt;</span>
  <span style="color: #b58900">&lt;munit:validation&gt;</span>...<span style="color: #b58900">&lt;/munit:validation&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"setup-happy-sapi-mocks"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit-tools:mock-when</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/munit-tools:mock-when&gt;</span>
  ...
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract spy config:</strong> Extract the set-up of all spies into a new subflow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:behavior&gt;</span>
    ...
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"spy-all-mocks"</span> <span style="color: #b58900">/&gt;</span>
    ...
  <span style="color: #b58900">&lt;/munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>...<span style="color: #b58900">&lt;/munit:execution&gt;</span>
  <span style="color: #b58900">&lt;munit:validation&gt;</span>...<span style="color: #b58900">&lt;/munit:validation&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"spy-all-mocks"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit-tools:spy</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/munit-tools:spy&gt;</span>
  ...
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract setting input data:</strong> Extract the setting of the input data for check-in-by-pnr into a new subflow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:behavior&gt;</span>...<span style="color: #b58900">&lt;/munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"set-check-in-event"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:execution&gt;</span>
  <span style="color: #b58900">&lt;munit:validation&gt;</span>...<span style="color: #b58900">&lt;/munit:validation&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"set-check-in-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:set-event&gt;</span>
    ...
  <span style="color: #b58900">&lt;/munit:set-event&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract call verifications:</strong> Extract the verification of all invocations of mocked Mule flows into a new subflow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:behavior&gt;</span>...<span style="color: #b58900">&lt;/munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>...<span style="color: #b58900">&lt;/munit:execution&gt;</span>
  <span style="color: #b58900">&lt;munit:validation&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"verify-all-mocks-are-called-once"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:assert-that</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[payload]"</span> <span style="color: #268bd2">is=</span><span style="color: #859900">"..."</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:validation&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"verify-all-mocks-are-called-once"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit-tools:verify-call</span> <span style="color: #268bd2">times=</span><span style="color: #859900">"1"</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/munit-tools:verify-call&gt;</span>
  ...
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Load test data in DataWeave module:</strong> Copy all occurrences of test data — especially when that data is read from a file — into variables in a new DataWeave module <strong>TestData.dwl</strong> in <strong>src/test/resources</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">TestData.dwl of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="javascript"><span style="color: #6c71c4">import</span> <span style="color: #586e75">getResourceAsString</span> <span style="color: #6c71c4">from</span> <span style="color: #586e75">MunitTools</span> 

<span style="color: #cb4b16">var</span> <span style="color: #586e75">pnr</span>              <span style="color: #93a1a1">=</span> <span style="color: #859900">"</span><span style="color: #859900">N123</span><span style="color: #859900">"</span>
<span style="color: #cb4b16">var</span> <span style="color: #586e75">checkIn</span>          <span style="color: #93a1a1">=</span> <span style="color: #586e75">read</span><span style="color: #93a1a1">(</span><span style="color: #586e75">getResourceAsString</span><span style="color: #93a1a1">(</span><span style="color: #859900">'</span><span style="color: #859900">json/check-in-by-pnr-request.json</span><span style="color: #859900">'</span><span style="color: #93a1a1">),</span> <span style="color: #859900">'</span><span style="color: #859900">application/json</span><span style="color: #859900">'</span><span style="color: #93a1a1">)</span>
<span style="color: #cb4b16">var</span> <span style="color: #586e75">checkInByPNRResp</span> <span style="color: #93a1a1">=</span> <span style="color: #93a1a1">{</span> <span style="color: #268bd2">paymentID</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">PAY-1AKD7482FAB9STATKO</span><span style="color: #859900">"</span> <span style="color: #93a1a1">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This defines a DataWeave module with the name given by the filename TestData.dwl and with global availability in the containing Mule app.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Such a DataWeave module not only encapsulates the provisioning of test data but also ensures that test data is initialized only once — including files being read only once.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Other promising ways of storing this data, such as in variables set in &lt;munit:before-suite /&gt; or &lt;munit:before-test /&gt; do not reliably work in all execution scenarios of the MUnit test suite and the flow-under-test!</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Replace test data with DataWeave references:</strong> Replace all occurrences of test data in main-test-suite.xml with references to variables from this DataWeave module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;munit:validation&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"verify-all-mocks-are-called-once"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:assert-that</span>
      <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[payload]"</span>
      <span style="color: #268bd2">is=</span><span style="color: #859900">"#[MunitTools::equalTo(TestData::checkInByPNRResp)]"</span>
    <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:validation&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"spy-all-mocks"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;munit-tools:spy</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"create-payment-for-bags"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:before-call&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:assert-that</span>
        <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[vars.checkIn]"</span>
        <span style="color: #268bd2">is=</span><span style="color: #859900">"#[MunitTools::equalTo(TestData::checkIn)]"</span>
      <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:before-call&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:spy&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"set-check-in-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:set-event&gt;</span>
    <span style="color: #b58900">&lt;munit:payload</span>
      <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- TestData::checkIn]"</span>
    <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;munit:variables&gt;</span>
      <span style="color: #b58900">&lt;munit:variable</span>
        <span style="color: #268bd2">key=</span><span style="color: #859900">"PNR"</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[TestData::pnr]"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit:variables&gt;</span>
  <span style="color: #b58900">&lt;/munit:set-event&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>All custom DataWeave modules on the Java classpath — such as those located in src/main/resources and src/test/resources — are automatically available in DataWeave code blocks even without an explicit import. An import is only needed when references to members of these DataWeave modules should be shortened, such as by omitting the package name, or omitting the DataWeave module when referring to a member. None of this is helpful for the usages of this test data DataWeave module, so import statements are not required and therefore omitted.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite; this should succeed and all tests should still pass.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_mock_and_require_errors_raised_by_the_invocation_of_mule_flows"><a class="anchor" href="#_mock_and_require_errors_raised_by_the_invocation_of_mule_flows"></a><a class="link" href="#_mock_and_require_errors_raised_by_the_invocation_of_mule_flows">Mock and require errors raised by the invocation of Mule flows</a></h4>
<div class="paragraph">
<p>In this section, you start testing an exception path in the invocation of create-payment-for-bags. Because this Mule flow will ultimately invoke a remote API, PayPal SAPI, it is essential that the caller of create-payment-for-bags, check-in-by-pnr, is prepared to deal with errors in create-payment-for-bags. For now you just assume that create-payment-for-bags abstracts from all underlying API invocation errors by raising a custom application error, APP:CANT_CREATE_PAYMENT, and that check-in-by-pnr propagates that error. You therefore mock the invocation of create-payment-for-bags to raise that error and define the MUnit test of check-in-by-pnr so that it requires that error to be thrown. (In a later walkthrough you will implement retries after transient errors, so that APP:CANT_CREATE_PAYMENT will be refined to signal a permanent, non-retryable error in creating a payment.)</p>
</div>
<div class="paragraph">
<p>It turns out that you can&#8217;t write an MUnit test for a custom error type that is never defined (mentioned) in the Mule app under test. You therefore extend create-payment-for-bags by actually raising APP:CANT_CREATE_PAYMENT if any error occurs in this Mule flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="20">
<li>
<p><strong>Add exception path test:</strong> Add a new MUnit test to <strong>main-test-suite.xml</strong> for testing the exception path of <strong>check-in-by-pnr</strong> and require it to raise APP:CANT_CREATE_PAYMENT:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-exception-path-test"</span>
  <span style="color: #268bd2">expectedErrorType=</span><span style="color: #859900">"APP:CANT_CREATE_PAYMENT"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;munit:behavior&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"setup-happy-sapi-mocks"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;munit:execution&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"set-check-in-event"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/munit:execution&gt;</span>
<span style="color: #b58900">&lt;/munit:test&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You create mocks and set the input data for the flow-under-test as before.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>With these mocks this test would not raise an error and hence fail because it expects an error.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There is no need for spies in this test scenario.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There is no need for an &lt;munit:validation /&gt; section because the flow-under-test will not return normally but raise an error.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Mock flow invocation to raise error:</strong> Override the mock for the invocation of <strong>create-payment-for-bags</strong> to raise <strong>APP:CANT_CREATE_PAYMENT</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:behavior&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"setup-happy-sapi-mocks"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;munit-tools:mock-when</span> <span style="color: #268bd2">processor=</span><span style="color: #859900">"flow-ref"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:with-attributes&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:with-attribute</span>
        <span style="color: #268bd2">attributeName=</span><span style="color: #859900">"name"</span>
        <span style="color: #268bd2">whereValue=</span><span style="color: #859900">"create-payment-for-bags"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:with-attributes&gt;</span>
    <span style="color: #b58900">&lt;munit-tools:then-return&gt;</span>
      <span style="color: #b58900">&lt;munit-tools:error</span> <span style="color: #268bd2">typeId=</span><span style="color: #859900">"APP:CANT_CREATE_PAYMENT"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/munit-tools:then-return&gt;</span>
  <span style="color: #b58900">&lt;/munit-tools:mock-when&gt;</span>
<span style="color: #b58900">&lt;/munit:behavior&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This defines two mocks for the &lt;flow-ref /&gt; invoking create-payment-for-bags and the last one defined (the one raising the error) overrides the previous one.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This test would fail because the check-in-papi Mule app never defines APP:CANT_CREATE_PAYMENT, that is, never raises or even mentions that error type.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Define error:</strong> In <strong>main.xml</strong>, change <strong>create-payment-for-bags</strong> by making it raise APP:CANT_CREATE_PAYMENT whenever any error occurs in the Mule flow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue&gt;</span>
      <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:CANT_CREATE_PAYMENT"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In its current form, create-payment-for-bags never actually raises APP:CANT_CREATE_PAYMENT, but it defines it as a custom application error.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Now that the custom application error APP:CANT_CREATE_PAYMENT is defined in this Mule app it can be used in the MUnit tests implemented earlier.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You don&#8217;t have to change check-in-by-pnr because by default it propagates all errors.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test and check log:</strong> Run the MUnit test suite; this should succeed, all tests should now pass, and the logs should indicate that the exception path test of check-in-by-pnr succeeded because APP:CANT_CREATE_PAYMENT was indeed raised (by the mock).</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-144"><a class="anchor" href="#wt-begin-144"></a><a class="link" href="#wt-begin-144">Walkthrough 4-4: Automate the creation of MUnit Tests using MUnit Test Recorder</a></h3>
<div class="paragraph">
<p>In the current main-test-suite.xml, you focused solely on the check-in-by-pnr Mule flow, manually creating each test — including all input/output data and assertions.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you implement an MUnit test for the core functionality of the payment-approval-by-pnr Mule flow, by automatically generating the test — including its test data and assertions — using the MUnit Test Recorder.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_setup_the_required_mule_flows_and_stubs">Setup the required Mule flows and stubs</a>.</p>
</li>
<li>
<p><a href="#_generate_a_pre_configured_munit_test_using_munit_test_recorder">Generate a pre-configured MUnit test using MUnit Test Recorder</a>.</p>
</li>
<li>
<p><a href="#_study_and_refactor_generated_artifacts">Study and refactor generated artifacts</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_12"><a class="anchor" href="#_solution_file_12"></a><a class="link" href="#_solution_file_12">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_11"><a class="anchor" href="#_starting_file_11"></a><a class="link" href="#_starting_file_11">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devprd/module04/wt4-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setup_the_required_mule_flows_and_stubs"><a class="anchor" href="#_setup_the_required_mule_flows_and_stubs"></a><a class="link" href="#_setup_the_required_mule_flows_and_stubs">Setup the required Mule flows and stubs</a></h4>
<div class="paragraph">
<p>In this section, you create two private Mule flows that invoke the downstream System API and implement internal logic on which payment-approval-by-pnr depends.</p>
</div>
<div class="paragraph">
<p>In a previous walkthrough, you followed a modified Test-Driven Development (TDD) approach, whereby you assumed that integration logic had been implemented (although that was not actually the case) and you first wrote the unit tests that depended on that integration logic. However, MUnit Test Recorder requires the integration logic has already been implemented (at least to a certain extent) in order to generate MUnit tests. Therfore it is required to setup the intitial skeleton implementation and stub data first, in order to take advantage of MUnit Test Recorder.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study System APIs invoked by check-in-papi:</strong> Review the <a href="#section-aa-solution-arch">Solution architecture</a> and in particular the <a href="#aa-high-level-arch">High-level architecture</a> and the <a href="#aa-us1-realization">design of US1: mobile Check-In</a>; note the dependency of Check-In PAPI on PayPal SAPI for the core payment approval functionality being implemented in payment-approval-by-pnr and the logic required to display a boarding pass is contained within check-in-papi without dependencies.</p>
</li>
<li>
<p><strong>Decide flows to implement:</strong> Assume that payment-approval-by-pnr invokes the following two Mule flows, which in turn invoke the aforementioned PayPal SAPI or internal logic: <strong>update-approvals</strong> and <strong>get-boarding-pass</strong> respectively.</p>
</li>
<li>
<p><strong>Implement flows:</strong> To <strong>main.xml</strong> add two Mule flows and invoke them from <strong>payment-approval-by-pnr</strong> moving the setting of the payload (the Transform Message component in the flow) to the new <strong>get-boarding-pass</strong> Mule flow and adding a new Transform Message component to return the expected status response from PayPal SAPI to the <strong>update-approvals</strong> Mule flow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"payment-approval-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"update-approvals"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-boarding-pass"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"update-approvals"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/json
      ---
      {
        status: "Payment Executed"
      }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-boarding-pass"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span>...<span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You move the setting of the payload from payment-approval-by-pnr to get-boarding-pass as this transform represents the final boarding pass to be returned.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is the simplest possible integration logic that will allow you to generate a meaningful test, but it is not a functional implementation of payment-approval-by-pnr.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run:</strong> Run the Mule app in Studio.</p>
</li>
<li>
<p>Invoke the API via cURL, supplying an arbitrary PNR and example JSON request body; this should return a HTTP 200 OK response:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span>  <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">PAY-1AKD7482FAB9STATKO</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://localhost:8081/api/v1/tickets/N123/paymentApproval</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_generate_a_pre_configured_munit_test_using_munit_test_recorder"><a class="anchor" href="#_generate_a_pre_configured_munit_test_using_munit_test_recorder"></a><a class="link" href="#_generate_a_pre_configured_munit_test_using_munit_test_recorder">Generate a pre-configured MUnit test using MUnit Test Recorder</a></h4>
<div class="paragraph">
<p>In this section, you use Studio features to record real input/output data and generate an MUnit test for the payment-approval-by-pnr Mule flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p><strong>Use the MUnit Test Recorder:</strong> In Studio, on the <strong>payment-approval-by-pnr</strong> Mule flow, execute <strong>Record test for this flow</strong>; this should fail.</p>
</li>
<li>
<p><strong>Update run config:</strong> Edit the <strong>MUnit Test Recording</strong> run configuration generated by Studio for the MUnit Test Recorder by adding the <strong>encryption key</strong> as a <strong>VM argument</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345
<span style="color: #b58900">-M-Danypoint</span>.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>These are arguments to a temporary embedded Mule runtime that executes check-in-papi for the purpose of recording MUnit tests.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is recommended to disable gatekeeper, because the uplink to API Manager is irrelevant for recording MUnit tests and might interfere with MUnit Test Recorder.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Disabling gatekeeper does not stop any previously downloaded policies from being applied. If you need to, you can remove the locally cached policies from the &lt;MULE_HOME&gt;/policies directory.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The policies directory contains any API policies automatically downloaded from Exchange when using autodiscovery or any custom offline API policies manually added to this directory.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can find the MULE_HOME location by searching for MULE_HOME in a running Studio console.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Due to a current limitation in MUnit Test Recorder, you should <strong>apply and close</strong> the run configuration dialogue and <strong>not run</strong> the Mule app from that dialogue.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Record test:</strong> In Studio, on the <strong>payment-approval-by-pnr</strong> Mule flow, execute <strong>Record test for this flow</strong> again; this should now succeed, deploy check-in-papi to the embedded Mule runtime configured above, and start it, waiting for the payment-approval-by-pnr Mule flow to be executed.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Any trigger of Mule flow execution is supported, not just an &lt;http:listener /&gt;.</em></p>
</div>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the API as before; this should return an 'Empty reply from server'.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Even though the invocation of Check-In PAPI and the subsequent execution of payment-approval-by-pnr succeed, the resulting HTTP response is consumed by MUnit Test Recorder and not returned to the API client.</em></p>
</div>
</li>
<li>
<p><strong>MUnit Test Recorder stops:</strong> In Studio notice the request has been captured and the embedded Mule runtime stopped.</p>
</li>
<li>
<p><strong>Generate MUnit test:</strong> Follow the MUnit Test Recorder wizard back in Studio to create <strong>payment-approval-by-pnr-happy-path-test</strong> in <strong>main-test-suite.xml</strong>.</p>
<div class="paragraph">
<p><em>Note:</em> <em>If you want to create an exception path test for payment-approval-by-pnr, MUnit Test Recorder cannot generate tests for flows with Mule errors raised inside the Mule flow or already existing in the incoming event, not even if they are handled by an on-error-continue error handler.</em></p>
</div>
</li>
<li>
<p><strong>Mock flow invocations that depend on System APIs:</strong>  During the wizard, select the &lt;flow-ref /&gt; element for <strong>update-approvals</strong> Mule flow and choose to <strong>Mock this processor</strong> selecting payload to be mocked with the captured value.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The mock data is defaulted to what was captured by the MUnit Test Recorder.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can only choose one test behaviour per processor at this point, others can be added manually as seen in previous walkthroughs.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The mock uses the doc:id attribute automatically to decide which processor to mock. It is best practice to refactor mocks to use another attribute such as the name attribute for &lt;flow-ref /&gt; as seen in previous walkthroughs.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> In Studio, run the test suite; this should pass.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_study_and_refactor_generated_artifacts"><a class="anchor" href="#_study_and_refactor_generated_artifacts"></a><a class="link" href="#_study_and_refactor_generated_artifacts">Study and refactor generated artifacts</a></h4>
<div class="paragraph">
<p>In this section, you study the generated artifacts and optionally refactor them to follow the coding conventions laid out in previous walkthroughs.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p><strong>Study tests:</strong> Inspect the generated MUnit test added to <strong>main-test-suite.xml</strong>. Review the Behavior, Execution and Validation scopes of the test — paying close attention to the type of assertion and the input/output test data configuration.</p>
</li>
<li>
<p><strong>Study test resources:</strong> Review the <strong>src/test/resources</strong> directory, in particular the newly created package named after the generated test.</p>
<div class="paragraph">
<p><em>Note:</em> <em>In previous walkthroughs, you created test data files using the raw JSON payload. In contrast, the test data generated by MUnit Test Recorder are DataWeave objects.</em></p>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Refactor tests:</strong> Clean-up the generated test for payment-approval-by-pnr to follow your coding conventions similar to that of check-in-by-pnr. Look at adding spies and verifications, extracting mock config and setting of input data into new or existing Mule flows.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Review your use of the previous DataWeave module to not only encapsulate the provisioning of test data but also ensure that test data is initialized only once — including files being read only once. Refactor the new generated test data into the existing DataWeave module.</em></p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-coding-conventions"><a class="anchor" href="#module-coding-conventions"></a><a class="link" href="#module-coding-conventions">Appendix A: Coding conventions</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_general"><a class="anchor" href="#_general"></a><a class="link" href="#_general">A.1. General</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Importing API specifications into a Studio project:</strong> Don’t import from API Designer but import a well-defined version of the API specification (RAML definition or OpenAPI definition) from Exchange using the API Sync feature available in Studio 7.4.0 or later.</p>
</li>
<li>
<p><strong>Abbreviations:</strong> Use wherever space is limited, such as for API Designer project names, Mule app names, and the like:</p>
<div class="ulist">
<ul>
<li>
<p>SAPI for System API</p>
</li>
<li>
<p>PAPI for Process API</p>
</li>
<li>
<p>EAPI for Experience API</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Definition of Done:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Implementation meets all functional and nonfunctional requirements.</p>
</li>
<li>
<p>Readiness endpoint checks liveness of all the Mule app&#8217;s dependencies.</p>
</li>
<li>
<p>MUnit tests assert all functional requirements and all tests pass.</p>
</li>
<li>
<p>Functional Monitors source code checked in to src/test/funmon.</p>
</li>
<li>
<p>Mule app deployed to all CloudHub environments using Maven and scripts to invoke Maven.</p>
</li>
<li>
<p>Functional Monitors deployed for all Anypoint Platform environments and all statuses displayed in green.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_raml_definitions_and_api_designer_projects"><a class="anchor" href="#_raml_definitions_and_api_designer_projects"></a><a class="link" href="#_raml_definitions_and_api_designer_projects">A.2. RAML definitions and API Designer projects</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>API Designer project</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Use a business-friendly project name, choose name of dominant RAML object and keep all other naming defaults:</p>
<div class="ulist">
<ul>
<li>
<p>Project name for RAML definition: Passenger Data SAPI</p>
<div class="ulist">
<ul>
<li>
<p>title: Passenger Data SAPI</p>
</li>
<li>
<p>Defaults:</p>
<div class="ulist">
<ul>
<li>
<p>RAML file: passenger-data-sapi.raml (visible in API implementation)</p>
</li>
<li>
<p>Exchange asset ID: passenger-data-sapi</p>
</li>
<li>
<p>Exchange name: Passenger Data SAPI (visible to all Exchange users)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Project name for RAML type or RAML library containing that type: PaymentApproval</p>
<div class="ulist">
<ul>
<li>
<p>Type name: PaymentApproval</p>
</li>
<li>
<p>Defaults:</p>
<div class="ulist">
<ul>
<li>
<p>RAML file: paymentapproval.raml</p>
</li>
<li>
<p>Exchange asset ID: paymentapproval</p>
</li>
<li>
<p>Exchange name: PaymentApproval (visible to all Exchange users)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Combine RAML type with examples into a <strong>RAML library</strong>, don&#8217;t just use a RAML type fragment</p>
</li>
<li>
<p>Use subdirectories within project:</p>
<div class="ulist">
<ul>
<li>
<p>For RAML type: types</p>
</li>
<li>
<p>For examples: examples</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>API specification attributes:</strong></p>
<div class="ulist">
<ul>
<li>
<p>title: Check-In PAPI, see above</p>
</li>
<li>
<p>version: v1</p>
</li>
<li>
<p>baseUri: use the one from the prod environment, for example <a href="https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1" class="bare">https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_mule_apps"><a class="anchor" href="#_mule_apps"></a><a class="link" href="#_mule_apps">A.3. Mule apps</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Project-level:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Maven &lt;groupId /&gt;: com.mulesoft.training.anyairline</p>
</li>
<li>
<p>Studio project name = Maven &lt;artifactId /&gt; = Maven project name:</p>
<div class="ulist">
<ul>
<li>
<p>For API implementation: passenger-data-sapi = Exchange asset ID of API exposed by that API implementation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Mule flows:</strong> check-all-dependencies-are-alive, register-passenger-data</p>
<div class="ulist">
<ul>
<li>
<p>Also correct names autogenerated by Studio</p>
</li>
<li>
<p><strong>Prefer subflows</strong> over flows where possible, for example, unless error handling or a message source is needed in the flow</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Global config elements:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use camelCase: apiHttpListenerConfig</p>
</li>
<li>
<p>With the exception of global error handlers (which are conceptually more like flows): api-error-handler</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>doc:name:</strong></p>
<div class="ulist">
<ul>
<li>
<p>For event processors: sentence case without punctuation: "Set PNR from query param”</p>
<div class="ulist">
<ul>
<li>
<p>Such that the entire graphical representation of each flow reads as much as possible like a paragraph in a story</p>
</li>
</ul>
</div>
</li>
<li>
<p>For &lt;set-variable /&gt; include the name of the variable and further detail only if really helpful) "origPayload"</p>
</li>
<li>
<p>For &lt;raise-error /&gt; use the type of error being raised, omitting the APP namespace but including all other namespaces</p>
</li>
<li>
<p>For &lt;flow-ref /&gt; use the name of the flow being invoked: check-all-dependencies-are-alive</p>
<div class="ulist">
<ul>
<li>
<p>Flow names should be descriptive already</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>File-level:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use double quotes (") for XML attributes and single quotes for DataWeave strings (so that an XML formatter can enforce XML file layout):</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;set-payload</span>
  <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {message: 'Invalid passenger name record given.'}]"</span>
  <span style="color: #268bd2">doc:name=</span><span style="color: #859900">"error"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Mule flow config files:</p>
<div class="ulist">
<ul>
<li>
<p>error.xml for global error handlers</p>
</li>
<li>
<p>global.xml for global definitions that are not error handlers</p>
</li>
<li>
<p>api.xml for top-level, API-related Mule flows called from APIkit</p>
</li>
<li>
<p>main.xml for main integration logic (and additional Mule flow config files if helpful)</p>
</li>
<li>
<p>health.xml for liveness and readiness endpoints (see below)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configuration properties files:</p>
<div class="ulist">
<ul>
<li>
<p>properties.yaml for environment-independent config</p>
</li>
<li>
<p>dev-properties.yaml, dev-secure-properties.yaml for env-dependent config for the dev environment</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Endpoints:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use <strong>http.port</strong> or  <strong>https.port</strong> for the name of the configuration property that holds the port at which the API is exposed</p>
</li>
<li>
<p>API endpoint for the one API exposed by an API implementation: /api/v1 for the API itself and /console/v1 for API Console for that API (assuming major version v1)</p>
</li>
<li>
<p>Health check endpoints: Mule apps expose endpoints for Kubernetes-style "probes":</p>
<div class="ulist">
<ul>
<li>
<p>For a liveness probe at /alive, returning 200 if alive or 500 if not</p>
</li>
<li>
<p>For a readiness probe at /ready, returning 200 if ready or 500 if not</p>
<div class="ulist">
<ul>
<li>
<p>Readiness requires the Mule app to verify that all its dependencies are alive. For API dependencies, this means invoking /alive</p>
</li>
</ul>
</div>
</li>
<li>
<p>These should use the same HTTP Listener configuration as the main API endpoints</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Logging:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Merge two or more subsequent loggers into one</p>
</li>
<li>
<p>Log-levels:</p>
<div class="ulist">
<ul>
<li>
<p>INFO for start and end of externally visible flow, but not those delegated to by APIkit because they use Message Logging API policy</p>
</li>
<li>
<p>INFO before and after every invocation of an external system</p>
</li>
<li>
<p>INFO before raising error</p>
</li>
<li>
<p>DEBUG for internal flows and other log entries</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Error handling:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use descriptive error types: APP:INVALID_CHECKIN_RESPONSE</p>
</li>
<li>
<p>By default, define all custom application error types in the APP namespace</p>
<div class="ulist">
<ul>
<li>
<p>Omit that namespace in doc:name and the like because it is assumed to be the most common namespace</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define all custom application errors that should be communicated to a client (if possible) in the EXT namespace and always supply description for client: EXT:CANT_CHECKIN, EXT:BAD_REQUEST etc.</p>
</li>
<li>
<p>Raise errors only for error conditions, not to control happy-path message processing</p>
</li>
<li>
<p>Reuse common error response creation encapsulated in error-common.xml in apps-commons</p>
<div class="ulist">
<ul>
<li>
<p>Specially handles EXT:BAD_REQUEST and all errors in the EXT namespace</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>MUnit tests:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Do not test the APIkit-generated main flow (containing the APIkit Router) and console flow</p>
</li>
<li>
<p>Do not test for validations already performed by APIkit: required parameters, data types of parameters, payload message format, etc.</p>
</li>
<li>
<p>Do not “enable flow sources” for HTTP/S and do not test APIs by invoking them over HTTP/S. Instead, refactor Mule flows that do actual work so that they are easy to test and independent of APIkit, and then test those flows directly</p>
</li>
<li>
<p>In general, do not accept any incoming network communication and do not perform any outgoing network communication from unit tests: MUnit tests must run in isolation in a sandboxed Mule runtime without connectivity or dependency on remote components</p>
</li>
<li>
<p>Use a synchronous logger configuration for tests, with all relevant log levels set to DEBUG</p>
</li>
<li>
<p>Testable Mule flows:</p>
<div class="ulist">
<ul>
<li>
<p>Avoid nested XML elements in event processors: they can’t be mocked or spied on in MUnit tests. Instead, make them trivial so that they can’t fail</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Functional Monitors:</strong></p>
<div class="ulist">
<ul>
<li>
<p>To be implemented in code and checked in underneath src/test/funmon for each environment the Mule app is deployed to</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Reconnection strategies:</strong></p>
<div class="ulist">
<ul>
<li>
<p>All global configurations for connectors that are likely to pool or cache connections (Database Connector, JMS Connector, etc.) should define a modest, finite reconnection strategy, such as reconnect 3 times with 1 second intervals. This then applies by default to all operations using this connector config and blocks the operation until completed</p>
<div class="ulist">
<ul>
<li>
<p>No other global connector configurations should define a reconnection strategy</p>
</li>
<li>
<p>Most connector operations require retry logic using Until Successful scope and Try scope, irrespective of any reconnection strategy</p>
</li>
</ul>
</div>
</li>
<li>
<p>All listeners should define &lt;reconnect-forever /&gt; with a realistic interval locally to the listener itself, thereby overriding any globally defined reconnection strategy</p>
<div class="ulist">
<ul>
<li>
<p>The only exception is listeners that cannot realistically re-establish connectivity once lost, such as &lt;http:listener /&gt;</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>General:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Avoid absolute file system paths in Mule apps if at all possible; most often, a relative path suffices</p>
<div class="ulist">
<ul>
<li>
<p>Relative paths do not work for the sslrootcert in the PostgreSQL JDBC URL</p>
</li>
</ul>
</div>
</li>
<li>
<p>Reconnection strategies: Do not fail deployment when backend systems are down, and don’t retry forever as this blocks requests when the backend system is down</p>
</li>
<li>
<p>Use Choice router for content-based routing, not to validate dynamic data</p>
</li>
<li>
<p>Use the Validation module validators to validate dynamic data and specifically to enforce invariants, preconditions, postconditions, assertions, expected service responses, and the like</p>
<div class="ulist">
<ul>
<li>
<p>Raise descriptive custom application errors from within the validators (by error mapping all errors to such a custom error)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cloudhub_deployments"><a class="anchor" href="#_cloudhub_deployments"></a><a class="link" href="#_cloudhub_deployments">A.4. CloudHub deployments</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>CloudHub deployment names:</strong></p>
<div class="ulist">
<ul>
<li>
<p>tngaa-flights-management-sapi-dev for a Mule app called flights-management-sapi deployed to the dev environment</p>
</li>
<li>
<p>tngaa-flights-management-sapi for the same Mule app deployed to the prod environment</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_api_manager"><a class="anchor" href="#_api_manager"></a><a class="link" href="#_api_manager">A.5. API Manager</a></h3>
<div class="ulist">
<ul>
<li>
<p>Use <strong>automated policies</strong> as much as possible, instead of repetitively defining the same policies on every API instance</p>
</li>
<li>
<p>Set the <strong>consumer endpoint</strong> of every API instance to the correct endpoint URL of the CloudHub deployment of the API implementation in that environment: <a href="https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/v1" class="bare">https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/v1</a> for Flights Management SAPI in dev environment</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_functional_monitors"><a class="anchor" href="#_functional_monitors"></a><a class="link" href="#_functional_monitors">A.6. Functional Monitors</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Functional Monitors names</strong> and <strong>asset IDs</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>flights-management-sapi-dev-funmon for flights-management-sapi in dev</p>
</li>
<li>
<p>flights-management-sapi-prod-funmon for the same Mule app in prod (which exposes its API on <a href="https://tngaa-flights-management-sapi-zkvtif.rajrd4-1.usa-e1.cloudhub.io/api/v1" class="bare">https://tngaa-flights-management-sapi-zkvtif.rajrd4-1.usa-e1.cloudhub.io/api/v1</a>)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Functional Monitors must execute in a <strong>different CloudHub/AWS region</strong> than the Mule app they are monitoring is deployed to: usa-e2 (Ohio) if Mule app runs in usa-e1 (N. Virginia)</p>
</li>
<li>
<p>Report violations by posting to appropriate <strong>Slack channel</strong> via webhook</p>
</li>
<li>
<p>For any Mule app that supports it, Functional Monitors should invoke the <strong>liveness and readiness endpoints</strong> exposed by that Mule app</p>
</li>
<li>
<p>For Experience APIs, Functional Monitors should also invoke a real, read-only business transaction that exercises as many nodes in the application network as possible</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_anypoint_mq"><a class="anchor" href="#_anypoint_mq"></a><a class="link" href="#_anypoint_mq">A.7. Anypoint MQ</a></h3>
<div class="ulist">
<ul>
<li>
<p>Consider <strong>encrypting</strong> messages in prod but not in dev and test</p>
</li>
<li>
<p>Every "normal" Anypoint MQ queue should be associated with a <strong>Dead Letter Queue</strong>, the TTL of which should be as long as possible (currently 14 days)</p>
</li>
<li>
<p><strong>Anypoint MQ exchange names:</strong></p>
<div class="ulist">
<ul>
<li>
<p>cancelled-flights-exchg-dev for an Anypoint MQ exchange in the dev environment</p>
</li>
<li>
<p>cancelled-flights-exchg for the equivalent Anypoint MQ exchange in the prod environment</p>
<div class="ulist">
<ul>
<li>
<p>Note that technically the same name could be used in all environments</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Anypoint MQ queue and corresponding Dead Letter Queue names:</strong></p>
<div class="ulist">
<ul>
<li>
<p>cancelled-flights-mobile-queue-dev for an Anypoint MQ queue in dev</p>
</li>
<li>
<p>cancelled-flights-mobile-queue for the equivalent Anypoint MQ queue in prod</p>
<div class="ulist">
<ul>
<li>
<p>Note that technically the same name could be used in all environments</p>
</li>
</ul>
</div>
</li>
<li>
<p>cancelled-flights-mobile-dlq for the Dead Letter Queue belonging to cancelled-flights-mobile-queue (and therefore in prod)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-bibliography"><a class="anchor" href="#module-bibliography"></a><a class="link" href="#module-bibliography">Bibliography</a></h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="Ref1"></a>[Ref1] MuleSoft, "Mule Runtime", <a href="https://docs.mulesoft.com/mule-runtime" class="bare">https://docs.mulesoft.com/mule-runtime</a>. 2019.</p>
</li>
<li>
<p><a id="Ref2"></a>[Ref2] MuleSoft, "Design Center", <a href="https://docs.mulesoft.com/design-center" class="bare">https://docs.mulesoft.com/design-center</a>. 2019.</p>
</li>
<li>
<p><a id="Ref3"></a>[Ref3] MuleSoft, "API Manager", <a href="https://docs.mulesoft.com/api-manager" class="bare">https://docs.mulesoft.com/api-manager</a>. 2019.</p>
</li>
<li>
<p><a id="Ref4"></a>[Ref4] MuleSoft, "Anypoint Exchange", <a href="https://docs.mulesoft.com/exchange" class="bare">https://docs.mulesoft.com/exchange</a>. 2019.</p>
</li>
<li>
<p><a id="Ref5"></a>[Ref5] MuleSoft, "Runtime Manager", <a href="https://docs.mulesoft.com/runtime-manager" class="bare">https://docs.mulesoft.com/runtime-manager</a>. 2019.</p>
</li>
<li>
<p><a id="Ref6"></a>[Ref6] MuleSoft, "Access Management", <a href="https://docs.mulesoft.com/access-management" class="bare">https://docs.mulesoft.com/access-management</a>. 2019.</p>
</li>
<li>
<p><a id="Ref7"></a>[Ref7] MuleSoft, "Anypoint Monitoring", <a href="https://docs.mulesoft.com/monitoring" class="bare">https://docs.mulesoft.com/monitoring</a>. 2019.</p>
</li>
<li>
<p><a id="Ref8"></a>[Ref8] MuleSoft, "Anypoint MQ", <a href="https://docs.mulesoft.com/mq" class="bare">https://docs.mulesoft.com/mq</a>. 2019.</p>
</li>
<li>
<p><a id="Ref9"></a>[Ref9] MuleSoft, "Anypoint Studio", <a href="https://docs.mulesoft.com/studio" class="bare">https://docs.mulesoft.com/studio</a>, 2019.</p>
</li>
<li>
<p><a id="Ref10"></a>[Ref10] MuleSoft, "MUnit", <a href="https://docs.mulesoft.com/munit" class="bare">https://docs.mulesoft.com/munit</a>, 2019.</p>
</li>
<li>
<p><a id="Ref11"></a>[Ref11] MuleSoft, "API Functional Monitoring", <a href="https://docs.mulesoft.com/api-functional-monitoring" class="bare">https://docs.mulesoft.com/api-functional-monitoring</a>, 2019.</p>
</li>
<li>
<p><a id="Ref12"></a>[Ref12] MuleSoft, "APIkit", <a href="https://docs.mulesoft.com/apikit" class="bare">https://docs.mulesoft.com/apikit</a>, 2019.</p>
</li>
<li>
<p><a id="Ref13"></a>[Ref13] MuleSoft, "Object Store v2", <a href="https://docs.mulesoft.com/object-store" class="bare">https://docs.mulesoft.com/object-store</a>, 2019.</p>
</li>
<li>
<p><a id="Ref14"></a>[Ref14] Wikipedia, "Monorepo", <a href="https://en.wikipedia.org/wiki/Monorepo" class="bare">https://en.wikipedia.org/wiki/Monorepo</a>, 2020.</p>
</li>
<li>
<p><a id="Ref15"></a>[Ref15] M.T. Nygard, <em>Release It! Second Edition</em>. Raleigh, NC: Pragmatic Bookshelf, 2018.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-colophon"><a class="anchor" href="#module-colophon"></a><a class="link" href="#module-colophon">Version history</a></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-05-17</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.4.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">API Manager CH2 support;upgraded dependencies;minor bug fixes;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-11-23</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.3.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;Minor bug fixes;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-10-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.2.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.14.0;Minor bug fixes;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-09-07</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.0.1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">Minor bug fixes and studentFiles use flat RAMLs;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-08-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.0.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">CloudHub 2.0 Overhaul;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-08-04</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.3.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.13.0;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-06-27</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.2.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;bump MMP and update for version 3.6.3+ as no longer needs build parameter -DskipASTValidations;added back all wt and module numbering;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-05-20</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.1.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.12.1;Bump MMP and update for version 3.6.0+ to include an additional build parameter -DskipASTValidations;Removed steps where student logs in to AA org, this is due to upcoming MFA. Any client creds required are now directly provided in the manual;Use new api-catalog cli to publish spec to Exchange;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-05-04</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.0.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">restructured Applying basic software engineering principles into two modules: Applying basic software engineering principles and Developing for Operational Concerns; removed domains module; removed all numbering from walkthroughs and modules except for student file solutions;upgraded dependencies;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-03-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.4.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.12;New step to include new metadata support in Studio when publishing template to Exchange in <a href="#wt-begin-121">walkthrough 2-1</a>;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-03-09</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.3.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;Exchange Lifecycle support for SNAPSHOT dependencies; New step to deploy template in <a href="#wt-begin-121">walkthrough 2-1</a>;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-01-10</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.2.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies incl. Studio 7.11.1, app.runtime and munit post Log4j resolutions;parent-pom.xml refactored to correct pom.xml naming convention contained in its own directory parent-pom/pom.xml;bom.xml refactored to correct pom.xml naming convention contained in its own directory bom/pom.xml;editorial updates so the courses work for self-paced without instructor demos;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-11-08</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.1.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;added Windows compatible commands;changed client keystore passwords;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-10-05</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.0.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies, incl. Studio 7.11.0; added Mule 4.4 tracing module and logging variable section to <a href="#wt-begin-131">walkthrough 3-1</a>; Removed json-logger from walkthrough 3-1; Added Exchange V3 and deployment of apps-commons and parent POMs to <a href="#wt3-3-extract-config-into-lib">walkthrough 3-3</a>; Switch to use Connected Apps instead of credentials in <a href="#wt3-3-extract-config-into-lib">walkthrough 3-3</a> and <a href="#wt2-3-deploy-to-ch">WT 2-3</a>;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-08-03</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.9.1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">fixed student files</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-07-30</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.9</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">emphasized extract-to-flow refactoring to capitalize on metadata assistant in <a href="#wt-begin-121">walkthrough 2-1</a>; added project/app name to all code snippets; upgraded dependencies, incl. Studio 7.10.0</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-04-29</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.8</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies, incl. Studio 7.9.0</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-03-29</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.7</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies, removed step in <a href="#wt-begin-144">walkthrough 4-4</a> to manually remove local API Policy from embedded MULE_HOME, simplified domain walkthroughs, introduced new Exchange location for json logger wt3-1</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-10-30</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.6</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies, added step to <a href="#wt-begin-144">walkthrough 4-4</a> to manually remove local API Policy from embedded MULE_HOME</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-07-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.5</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">added a wt3-1-log-performance-and-security-in-prod; new formatting; upgraded dependencies, incl. to Studio 7.6.0</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-06-05</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.4</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">new naming pattern for source code distribution package affecting the <a href="#wt-begin-0">setup walkthrough</a>; simplified WT solution installation instructions and related directory layout; added <a href="#wt-begin-144">walkthrough 4-4</a>; upgraded dependencies, incl. to Studio 7.5.1</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-05-06</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.3</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">corrected steps in <a href="#wt3-3-extract-config-into-lib">walkthrough 3-3</a>; adapted to new way of running Secure Properties tool in <a href="#wt2-4-encrypt-sensitive-props">walkthrough 2-4</a>; added &lt;businessGroup /&gt; to Mule Maven plugin config in <a href="#wt2-3-deploy-to-ch">WT 2-3</a>; upgraded dependencies, incl. to Mule runtime 4.3.0 and Studio 7.5.0</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-04-23</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.2.1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">adapted the <a href="#wt-begin-0">setup walkthrough</a> to Studio bringing its own JDK; downgraded Mule runtime to 4.2.2 and APIkit to 1.3.9 because of known issues; fixed PDF formatting issues; upgraded dependencies</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-04-09</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">renamed shell variable APDL2REPO to {GitRepoDirEnvVar}; put parent POM in parent directory right from the start, affecting sections of walkthroughs <a href="#wt2-2-introduce-ppom">2-2</a> and &lt;<a href="#wt-begin-133">3-3</a>; using provided BOM rather than building it up, affecting sections of walkthroughs <a href="#wt2-2-introduce-bom">2-2</a>, <a href="#wt2-4-encrypt-sensitive-props">2-4</a>, <a href="#wt4-1-add-munit">4-1</a>; using <code>mvn install</code> only where necessary, <code>mvn verify</code> otherwise; new walkthrough solutions/starters directory layout and build approach affecting the <a href="#wt-begin-0">setup walkthrough</a> and the installation of all walkthrough solutions and starters; set Visualizer display name in <a href="#wt-begin-132">walkthrough 3-2</a>; set &lt;applyLatestRuntimePatch /&gt; in <a href="#wt2-3-deploy-to-ch">walkthrough 2-3</a>; &lt;munit:set-event /&gt; now done in &lt;munit:execution /&gt; instead of &lt;munit:behavior /&gt; in walkthroughs <a href="#wt4-2-prepare-test-data">4-2</a> and <a href="#wt4-3-refactoring">4-3</a>; apps-commons is now library-style Mule plugin instead of simple JAR, affecting sections of walkthroughs <a href="#wt3-3-extract-config-into-lib">3-3</a>; upgraded dependencies</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2020-01-15</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">renamed course; renamed ; upgraded dependencies</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2019-12-06</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">first public release, based on Mule runtime 4.2.2 and Studio 7.4.1</span></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>