<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<meta name="author" content="Mule runtime 4.4">
<title>Anypoint Platform Development: Production-Ready Integrations - Student Manual</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: #fff; color: #222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: black; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00A1DF; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #000000; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Verdana, "Helvetica Neue", Helvetica, Arial, sans-serif; font-weight: 400; font-style: normal; color: #00A1DF; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.6125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #414042; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #ddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: black; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 0; }
ul.no-bullet, ol.no-bullet { margin-left: 0; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #ddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #ddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #1ba3e1; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #1ba3e1; }

blockquote, blockquote p { line-height: 1.6; color: #00A1DF; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #ddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.8; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: #fff; margin-bottom: 1.25em; border: solid 1px #ddd; }
table thead, table tfoot { background: #f5f5f5; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

body { tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.8; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 0; line-height: inherit; }

pre, pre > code { line-height: 1.6; color: #333; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

.keyseq { color: #333333; }

kbd { font-family: Consolas, "Liberation Mono", Courier, monospace; display: inline-block; color: black; font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -moz-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: #000; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #ddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #ddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #1ba3e1; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #00A1DF; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #00A1DF; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: #000; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 0 solid #eee; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Verdana, "Helvetica Neue", Helvetica, Arial, sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: black; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: #f5f5f5; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #eee; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #eee; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: gainsboro; margin-bottom: 1.25em; padding: 1.25em; background: #f5f5f5; -webkit-border-radius: 3px; border-radius: 3px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { .sect1 { padding-bottom: 1.25em; } }
.sect1 + .sect1 { border-top: 0 solid #eee; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #00A1DF; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #0d516f; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: #000; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Verdana, "Helvetica Neue", Helvetica, Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #ddd; color: #1ba3e1; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #d5d5d5; margin-bottom: 1.25em; padding: 1.25em; background: #eee; -webkit-border-radius: 3px; border-radius: 3px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: gainsboro; margin-bottom: 1.25em; padding: 1.25em; background: #f5f5f5; -webkit-border-radius: 3px; border-radius: 3px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: black; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #f8f8f8; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; word-wrap: break-word; padding: 0.75em 0.75em 0.625em 0.75em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #f8f8f8; background-color: #333; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 0.75em 0.75em 0.625em 0.75em; -webkit-border-radius: 3px; border-radius: 3px; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.6; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #ddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 0.75em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #00A1DF; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: black; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #1ba3e1; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 0.75em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #00A1DF; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: #1ba3e1; }

.quoteblock.abstract { margin: 0 0 0.75em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #ddd; }

table.grid-all th.tableblock, table.grid-all td.tableblock { border-width: 0 1px 1px 0; }

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock { border-width: 1px 1px 0 0; }

table.grid-cols th.tableblock, table.grid-cols td.tableblock { border-width: 0 1px 0 0; }

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-rows th.tableblock, table.grid-rows td.tableblock { border-width: 0 0 1px 0; }

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock { border-bottom-width: 0; }

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock { border-width: 1px 0 0 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: #f5f5f5; }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 0.25em; }

ul li ol { margin-left: 0; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1em; font-size: 0.85em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { width: 1em; position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 0.75em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 0.75em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px #fff; -webkit-box-shadow: 0 0 0 1px #ddd; box-shadow: 0 0 0 1px #ddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.05em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: black; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

body { font-family: Verdana, Georgia, "Times New Roman", Times, serif; padding-top: 5em; padding-bottom: 5em; }
body h1, body h2 { color: #00A1DF; }
body h3, body #toctitle, body .sidebarblock > .content > .title, body h4, body h5, body h6 { color: #1784bd; }

#header, #content { background-color: #fff; -moz-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); -webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); }

#content { -moz-border-radius: 0 0 6px 6px; -webkit-border-radius: 0; border-radius: 0 0 6px 6px; }

#header { background: url('images/MuleSoft_logo_299C.png'); -moz-border-radius: 6px 6px 0 0; -webkit-border-radius: 6px; border-radius: 6px 6px 0 0; margin-top: 2em; margin-bottom: 0; padding-bottom: 0.625em; padding-top: 300px; padding-bottom: 100px; background-size: 733px 216px; background-repeat: no-repeat; background-position: center top; }

#footer-text { text-align: center; }

#toc { margin-top: 2em; }

#toctitle { color: #00A1DF; }

.imageblock > .content { text-align: center; }
.imageblock > .title { text-align: center; font-style: italic; font-weight: normal; color: black; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Anypoint Platform Development: Production-Ready Integrations - Student Manual</h1>
<div class="details">
<span id="author" class="author">Mule runtime 4.4</span><br>
<span id="revdate">May 17, 2023</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#module-welcome">Introducing the course</a>
<ul class="sectlevel2">
<li><a href="#course-goals">Course goals and objectives</a></li>
<li><a href="#_product_component_and_tool_inventory">Product, component, and tool inventory</a></li>
<li><a href="#wt-begin-0">Walkthrough: Set up your development environment</a></li>
<li><a href="#_how_to_install_a_walkthrough_solution_project">How to install a walkthrough solution project</a></li>
<li><a href="#module-case-study">Introducing the AnyAirline case study</a></li>
</ul>
</li>
<li><a href="#module-invoking-apis">Module 1: Invoking web APIs and services</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-211">Walkthrough 1-1: Set up the starter code</a></li>
<li><a href="#wt-begin-212">Walkthrough 1-2: Invoke HTTP APIs using the HTTP Connector</a></li>
<li><a href="#wt-begin-213">Walkthrough 1-3: Map between HTTP requests and Mule events</a></li>
<li><a href="#wt-begin-214">Walkthrough 1-4: Enable an API client for OAuth 2.0</a></li>
<li><a href="#wt-begin-215">Walkthrough 1-5: Invoke a SOAP web service using mutual TLS authentication</a></li>
<li><a href="#wt-begin-216">Walkthrough 1-6: Implement an HTTP callback</a></li>
</ul>
</li>
<li><a href="#module-async-message-passing">Module 2: Passing messages asynchronously</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-221">Walkthrough 2-1: Publish messages to a VM queue</a></li>
<li><a href="#wt-begin-222">Walkthrough 2-2: Listen for messages in a VM queue</a></li>
<li><a href="#wt-begin-223">Walkthrough 2-3: Publish messages to an Anypoint MQ exchange</a></li>
<li><a href="#wt-begin-224">Walkthrough 2-4: Subscribe to messages in an Anypoint MQ queue</a></li>
</ul>
</li>
<li><a href="#module-validation">Module 3: Validating messages</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-231">Walkthrough 3-1: Validate Mule events</a></li>
<li><a href="#wt-begin-232">Walkthrough 3-2: Validate XML messages</a></li>
<li><a href="#wt-begin-233">Walkthrough 3-3: Validate JSON messages</a></li>
</ul>
</li>
<li><a href="#module-orchestration">Module 4: Orchestrating integration functionality</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-241">Walkthrough 4-1: Parallelize integration logic</a></li>
<li><a href="#wt-begin-242">Walkthrough 4-2: Trace transactions across an application network using correlation IDs</a></li>
<li><a href="#wt-begin-243">Walkthrough 4-3: Retry failed API invocations</a></li>
</ul>
</li>
<li><a href="#module-object-store">Module 5: Storing objects for persistence, performance, and resilience</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-251">Walkthrough 5-1: Persist data in an Object Store</a></li>
<li><a href="#wt-begin-252">Walkthrough 5-2: Cache expensive operations</a></li>
<li><a href="#wt-begin-253">Walkthrough 5-3: Apply a caching API policy</a></li>
</ul>
</li>
<li><a href="#module-components">Module 6: Componentizing reusable integration functionality</a>
<ul class="sectlevel2">
<li><a href="#wt-begin-261">Walkthrough 6-1: Create an XML SDK component</a></li>
<li><a href="#wt-begin-262">Walkthrough 6-2: Create a custom API policy</a></li>
</ul>
</li>
<li><a href="#module-coding-conventions">Appendix A: Coding conventions</a>
<ul class="sectlevel2">
<li><a href="#_general">A.1. General</a></li>
<li><a href="#_raml_definitions_and_api_designer_projects">A.2. RAML definitions and API Designer projects</a></li>
<li><a href="#_mule_apps">A.3. Mule apps</a></li>
<li><a href="#_cloudhub_deployments">A.4. CloudHub deployments</a></li>
<li><a href="#_api_manager">A.5. API Manager</a></li>
<li><a href="#_functional_monitors">A.6. Functional Monitors</a></li>
<li><a href="#_anypoint_mq">A.7. Anypoint MQ</a></li>
</ul>
</li>
<li><a href="#module-bibliography">Bibliography</a></li>
<li><a href="#module-colophon">Version history</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="module-welcome"><a class="anchor" href="#module-welcome"></a><a class="link" href="#module-welcome">Introducing the course</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This course is for developers who have already internalized the basics of creating Mule apps with Studio and Anypoint Platform and now want to apply these skills in the context of professional software development projects, creating production-ready integrations.</p>
</div>
<div class="sect2">
<h3 id="course-goals"><a class="anchor" href="#course-goals"></a><a class="link" href="#course-goals">Course goals and objectives</a></h3>
<div class="paragraph">
<p>At the end of this course, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Invoke REST APIs and SOAP web services using various client components taking into consideration the nonfunctional properties of API invocations.</p>
</li>
<li>
<p>Pass messages asynchronously reliably between Mule flows and Mule apps using the VM and Anypoint MQ connectors.</p>
</li>
<li>
<p>Assert contracts within and between Mule flows using the validation module and JSON/XML schema validation.</p>
</li>
<li>
<p>Apply common Enterprise Integration Patterns to orchestrate and parallelize integration logic.</p>
</li>
<li>
<p>Use the Object Store and related components to manage state for Mule apps and APIs to increase performance and resilience.</p>
</li>
<li>
<p>Identify and extract reusable Mule app code into different Mule runtime extensions.</p>
</li>
<li>
<p>Extract reusable integration functionality into XML SDK modules and custom API policies.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_product_component_and_tool_inventory"><a class="anchor" href="#_product_component_and_tool_inventory"></a><a class="link" href="#_product_component_and_tool_inventory">Product, component, and tool inventory</a></h3>
<div class="paragraph">
<p>This course uses the following products, components, and tools.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Product, Component or Tool</th>
<th class="tableblock halign-left valign-top">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anypoint Platform control plane</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MuleSoft-hosted U.S. production version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Studio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.15.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mule runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.4.0-20230522 EE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mule Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.8.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange Mule Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0.18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mule Extensions Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.5.0-20221117</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MUnit and MUnit Maven plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3.16</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">APIkit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.9.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure Configuration Properties module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure Properties tool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.4.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object Store Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web Service Consumer Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.8.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VM Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anypoint MQ Connector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.0.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tracing module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. MuleSoft products, components, and tools used in this course</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Product, Component, or Tool</th>
<th class="tableblock halign-left valign-top">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenJDK 8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Maven</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3 to 3.8.6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maven Resources plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recent</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="course-prerequs"><a class="anchor" href="#course-prerequs"></a><a class="link" href="#course-prerequs">Course prerequisites</a></h4>
<div class="ulist">
<div class="title">Third-party products, components, and tools used in this course</div>
<ul>
<li>
<p><a href="https://training.mulesoft.com/instructor-led-training/apdev-fundamentals4">Anypoint Platform Development: Fundamentals (Mule 4)</a></p>
</li>
<li>
<p>Solid understanding of essential Maven concepts.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.baeldung.com/maven">Apache Maven Tutorial</a></p>
</li>
<li>
<p><a href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">Maven in 5 Minutes</a></p>
</li>
<li>
<p><a href="https://maven.apache.org/guides/getting-started/index.html">Maven Getting Started Guide</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_understanding_the_approach_of_this_course"><a class="anchor" href="#_understanding_the_approach_of_this_course"></a><a class="link" href="#_understanding_the_approach_of_this_course">Understanding the approach of this course</a></h4>
<div class="paragraph">
<p>This course uses a case study  AnyAirline  to illustrate the topics it addresses.</p>
</div>
<div class="paragraph">
<p>The course revolves around walkthroughs, which are broken down into sections and steps.
You are expected to follow all walkthroughs in the given order, including all sections and all steps in each section.</p>
</div>
<div class="paragraph">
<p>The course&#8217;s source code distribution contains two source directory trees, one strictly mirroring the walkthroughs, and another for the complete, final solution to the case study, irrespective of any walkthroughs.</p>
</div>
<div class="paragraph">
<p>Each walkthrough step typically specifies <em>what</em> to achieve rather than <em>how</em> to achieve it.
This means, for example, that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API invocations are specified in terms of cURL commands, because this is a succinct, portable, text-only way of doing so. But this does not imply that you must use cURL. Use whatever tool you prefer to send HTTP requests and inspect HTTP responses, such as <a href="https://install.advancedrestclient.com/install">Advanced REST Client</a> or <a href="https://www.getpostman.com/">Postman</a>.</p>
</li>
<li>
<p>File-level operations are expressed in Unix-style and for bash. Again, this is because it is a precise, text-only way of doing so. But you can use any other means of achieving the same result, such as a different Unix shell, the Windows command prompt, or any file explorer on any operating system. The only important thing is that the outcome is the same as when the given bash commands were executed.</p>
</li>
<li>
<p>Editing of file contents that does not require Studio should be done in whatever text editor you prefer. This may well be Studio itself (which embeds capable XML and JSON editors) or any Eclipse plugin installed into Studio.</p>
</li>
<li>
<p>Mule flows are specified by their XML code. This does not mean that code must or should be entered in XML form. Use whatever approach works best for you, including, but not limited to, coding Mule apps entirely in the visual Mule config flow editor, or the Mule config flow XML editor, or a combination thereof, or even outside of Studio in a Mule-agnostic editor (if you really prefer that). All that matters is that the XML code you produce in this fashion is equivalent to the code shown here. Mule flow XML code is also what matters at runtime and what you will typically see when doing code reviews in GitHub and the like. So it is essential to be confident in reading Mule flow XML code.</p>
</li>
<li>
<p>For brevity, Mule flow XML code reproduced here omits doc:name and doc:id attributes and other code elements that have no effect at runtime. Your Mule app code does not have to  and probably should not  omit doc:name, doc:id and similar.</p>
</li>
<li>
<p>For brevity, Mule flow XML code reproduced here omits XML namespace declarations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some walkthrough steps are declared as Homework. These are steps that have already been performed in previous steps or walkthroughs in a similar fashion, so they are repetitive and there is nothing new to learn. Also, these steps are not strictly necessary for the successful continuation of the current and later walkthroughs. On the other hand, in a real-world project, these steps would be performed and, in fact, the walkthrough solutions in the source code distribution do contain the result of performing these steps. You are therefore advised to perform these steps if at all possible.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-0"><a class="anchor" href="#wt-begin-0"></a><a class="link" href="#wt-begin-0">Walkthrough: Set up your development environment</a></h3>
<div class="paragraph">
<p>In this walkthrough, you set up the local development environment you will use throughout class. It is essential that your development environment conforms in all aspects to the outcome of following this walkthrough.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new <strong>Anypoint Platform trial account</strong> and remember its <strong>username</strong> and <strong>password</strong>.</p>
</li>
<li>
<p>Assign the <strong>Anypoint Monitoring User</strong> and <strong>Visualizer Editor</strong> <strong>permissions</strong> to that Anypoint Platform user.</p>
</li>
<li>
<p>Install a recent build of <strong><a href="https://adoptopenjdk.net">OpenJDK 8</a></strong>, add both the JVM and the compiler to your <strong>path</strong>, and verify the installation from a command-line interface:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">java <span style="color: #b58900">-version</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">javac <span style="color: #b58900">-version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Both these commands must show the exact same build version  otherwise, you will inadvertently be using two different JDK installations.</em></p>
</div>
</div>
</div>
</li>
<li>
<p>Install a recent Maven version (3.6.3 to 3.8.6), add it to your path, and verify the installation from a command-line interface:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn <span style="color: #b58900">--version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This shows the Maven home (installation directory), which you will need shortly for configuring Studio.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This shows the Java version and installation directory used by Maven: The former must once more show the exact same JDK build version as in the previous step, while the latter you will need shortly for configuring Studio.</em></p>
</div>
</div>
</div>
</li>
<li>
<p>Back up and remove your local Maven configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> ~/.m2/
<span style="color: #586e75">mv</span> <span style="color: #b58900">-f</span> settings.xml settings.xml.before-apdevl2
<span style="color: #586e75">mv</span> <span style="color: #b58900">-f</span> repository repository.before-apdevl2</code></pre>
</div>
</div>
</li>
<li>
<p>Install Studio <strong>7.15.0</strong>, the Studio version required for this course, after downloading it from <strong><a href="https://www.mulesoft.com/lp/dl/studio" class="bare">https://www.mulesoft.com/lp/dl/studio</a></strong>.</p>
</li>
<li>
<p>Create a new empty Studio workspace and assign its absolute path to environment variable <strong>APDL2WS</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">export </span><span style="color: #586e75">APDL2WS</span><span style="color: #93a1a1">=</span>/path/to/studio/workspace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bat"><span style="color: #cb4b16">set</span> <span style="color: #cb4b16">APDL2WS</span><span style="color: #93a1a1">=</span><span style="color: #cb4b16">C</span>:\path\to\studio\workspace</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Launch</strong> and <strong>configure</strong> Studio:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the <strong>above workspace</strong>.</p>
</li>
<li>
<p>Select the <strong>above JDK</strong> in Installed JREs, using the JDK (not just JRE) installation directory shown as part of the Maven verification earlier.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Studio 7.15.0 has its own embedded JDK, but you use the one installed earlier for consistency with command-line interface usage.</em></p>
</div>
</li>
<li>
<p>Use the <strong>above Maven</strong> installation by pointing Studio at the Maven home shown earlier, and test it; this must display the same output as the earlier Maven verification from the command-line interface.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Studio has its own embedded Maven, but you use the one installed earlier for consistency with command-line interface usage.</em></p>
</div>
</li>
<li>
<p>Install <strong>Mule runtime 4.4.0 EE</strong> into Studio if it is not already installed; all Studio projects must be created with this version of the Mule runtime.</p>
</li>
<li>
<p>Under XML &gt; <strong>XML Files</strong> &gt; Editor, set line width 140, clear all blank lines, don&#8217;t format comments, don&#8217;t insert white space before closing tag, and indent using two spaces.</p>
</li>
<li>
<p>Authenticate to Anypoint Platform using the <strong>trial account</strong> credentials obtained above.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a new, trivial Mule app project in Studio and run it to confirm your setup is functional. Ensure that this and all future Studio projects use Mule runtime 4.4.0 EE.</p>
</li>
<li>
<p>Install an application for sending HTTP requests and inspecting HTTP responses, such as cURL, <a href="https://install.advancedrestclient.com/install">Advanced REST Client</a>, or <a href="https://www.getpostman.com/">Postman</a>.</p>
</li>
<li>
<p>Install/choose a text editor for editing XML files and the like.</p>
</li>
<li>
<p>Locate your course enrollment email and follow the instructions to download the student files ZIP.</p>
</li>
<li>
<p>Unpack the source code distribution package of this course revision and assign the absolute path of the filesystem directory to environment <strong>variable APDL2DIST</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span>     /path/to/course/directory
unzip  APDevPRInts<span style="color: #6c71c4">*</span>_studentFiles_<span style="color: #6c71c4">*</span>.zip
<span style="color: #586e75">cd     </span>APDevPRInts<span style="color: #6c71c4">*</span>_studentFiles_<span style="color: #6c71c4">*</span>
<span style="color: #586e75">export </span><span style="color: #586e75">APDL2DIST</span><span style="color: #93a1a1">=</span><span style="color: #d33682">$(</span><span style="color: #586e75">pwd</span><span style="color: #d33682">)</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Familiarize yourself with the <strong>source code distribution</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The source code distribution contains two code directory trees, one for the complete, "final" solution to the AnyAirline case study, including all Mule apps, and other artifacts, the other for the solutions and starters for individual walkthroughs, each one relating directly to a walkthrough in this document, and addressing the aspects of the final solution under consideration in that walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Install API Catalog CLI:</strong> In a command-line interface, run the npm install command for API Catalog CLI:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">npm <span style="color: #586e75">install</span> <span style="color: #b58900">-g</span> api-catalog-cli@latest</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If the command is not recognized, install Git and Node.js, then run the install command again.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="wt-end-0"></a>&#160;</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_how_to_install_a_walkthrough_solution_project"><a class="anchor" href="#_how_to_install_a_walkthrough_solution_project"></a><a class="link" href="#_how_to_install_a_walkthrough_solution_project">How to install a walkthrough solution project</a></h3>
<div class="paragraph">
<p>Under $APDL2DIST/walkthroughs, you find individual project directories for the solutions of all walkthroughs and the starters for some walkthroughs.</p>
</div>
<div class="paragraph">
<p>Typically, the solution to one walkthrough is the starter for the next walkthrough  unless a walkthrough has its own, explicit starter projects. When you follow the course from start to finish, you only have to install the explicit starter projects, and this is explained step-by-step as part of the walkthroughs that come with starter projects. However, when you cannot follow a walkthrough, you will typically have to install the solution projects for this walkthrough, so that you can continue with the subsequent walkthrough  unless that subsequent walkthrough has its own explicit starter projects.</p>
</div>
<div class="paragraph">
<p>Follow these steps to install the solution projects for a particular walkthrough  for example, walkthrough 3-1  into your Studio workspace.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Discover the solution projects and files for the given walkthrough; for example, $APDL2DIST/walkthroughs/devprd/module03/wt3-1_solution has one subdirectory, for check-in-papi, and so walkthrough 3-1 only comprises that one solution project, which captures the state of check-in-papi at the end of walkthrough 3-1. Files such as parent-pom/pom.xml and pom.xml complete the Maven build setup for all solution projects of this walkthrough.</p>
</li>
<li>
<p>Copy all solution projects and files into your Studio workspace:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">mkdir </span>before-wt3-1
<span style="color: #586e75">mv</span> <span style="color: #6c71c4">*</span> before-wt3-1/
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devprd/module02/wt2-5_solution/<span style="color: #6c71c4">*</span> ./</code></pre>
</div>
</div>
</li>
<li>
<p>Edit <strong>pom.xml</strong> in the newly copied project directories, following any <code>students:</code>-instructions in those files.</p>
</li>
<li>
<p>Edit the newly copied <strong>parent-pom/pom.xml</strong>, following any <code>students:</code>-instructions in that file.</p>
</li>
<li>
<p>Install <strong>bom/pom.xml and parent-pom/pom.xml</strong> into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>bom/pom.xml        <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>bom/pom.xml
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Build the solution projects in the required order (if applicable):</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Import the solution projects into Studio, without copying them into the workspace.</p>
</li>
<li>
<p>Create a Studio <strong>run configuration</strong> for the newly imported projects, setting <strong>VM arguments</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345
<span style="color: #b58900">-M-Danypoint</span>.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#160;</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="module-case-study"><a class="anchor" href="#module-case-study"></a><a class="link" href="#module-case-study">Introducing the AnyAirline case study</a></h3>
<div class="paragraph">
<p>AnyAirline is a regional airline and an existing MuleSoft customer. It uses the MuleSoft-hosted Anypoint Platform control plane, and CloudHub to support a mobile app and a few other, ad-hoc integrations.</p>
</div>
<div class="paragraph">
<p>This case study focuses on a small selected number of use cases within this system landscape.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="sect3">
<h4 id="section-requirements"><a class="anchor" href="#section-requirements"></a><a class="link" href="#section-requirements">Requirements</a></h4>
<div class="paragraph">
<p>The following systems are already deployed and functional, and form the immutable system landscape for this project, not to be changed but rather integrated with.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>mobile app:</strong> AnyAirlines native mobile app, the main strategic driver for this project.</p>
</li>
<li>
<p><strong>PayPal:</strong> For customer/passenger payments.</p>
</li>
<li>
<p><strong>Flights Management system:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Accessible via SOAP web services over mutually authenticated HTTPS.</p>
</li>
<li>
<p>Deployed on-premises in the AnyAirline data center.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Passenger Data system:</strong></p>
<div class="ulist">
<ul>
<li>
<p>In-house legacy PostgreSQL database to be accessed directly.</p>
</li>
<li>
<p>Deployed on-premises in the AnyAirline data center.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Salesforce CRM:</strong> Recently introduced.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_functional_requirements"><a class="anchor" href="#_functional_requirements"></a><a class="link" href="#_functional_requirements">Functional requirements</a></h5>
<div class="sect5">
<h6 id="_terminology"><a class="anchor" href="#_terminology"></a><a class="link" href="#_terminology">Terminology</a></h6>
<div class="ulist">
<ul>
<li>
<p><strong>Record Locator:</strong> A six- or seven-digit <a href="https://en.wikipedia.org/wiki/Record_locator">alphanumeric code that identifies a data record in an airline reservation system</a>, for example, RW4TAB or KZVGX5. The term Record Locator is usually used to refer to a PNR. In this case study we do not make use of the term Record Locator itself.</p>
</li>
<li>
<p><strong>PNR:</strong> <a href="https://en.wikipedia.org/wiki/Passenger_name_record">Passenger Name Record</a> contains personal information about a passenger, as well as their itinerary (for example, flights). For simplicity, in this case study, itineraries consist of only one flight, so that each PNR identifies exactly one passenger and their flight. Furthermore, in this case study, we do not deal with the Passenger Name Records themselves, just with Record Locators identifying those Passenger Name Records. Therefore, in this case study, the term PNR is used to always mean Record Locator referring to a Passenger Name Record.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_actors"><a class="anchor" href="#_actors"></a><a class="link" href="#_actors">Actors</a></h6>
<div class="ulist">
<ul>
<li>
<p><strong>Passenger:</strong> A customer of AnyAirline, in possession of an AnyAirline ticket.</p>
</li>
<li>
<p><strong>Third party check-in partner company:</strong> An external company that partners with AnyAirline to provide third party check-in for AnyAirline passengers.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_user_stories"><a class="anchor" href="#_user_stories"></a><a class="link" href="#_user_stories">User stories</a></h6>
<div class="paragraph">
<p>The following user stories will be designed and implemented in this project.</p>
</div>
<div class="openblock">
<div class="title"><a id="us1"></a>US1: mobile Check-In</div>
<div class="content">
<div class="paragraph">
<p>As a passenger, I want to be able to check in to an AnyAirline flight using the mobile app, by providing my PNR and last name and paying for any baggage using PayPal.</p>
</div>
<div class="paragraph">
<p>Preconditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Passenger holds an AnyAirline ticket and knows its PNR.</p>
</li>
<li>
<p>Passenger has a PayPal account.</p>
</li>
<li>
<p>Passenger has mobile app installed.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="title"><a id="us2"></a>US2: Flight Cancellation mobile Notifications</div>
<div class="content">
<div class="paragraph">
<p>As a passenger, I want to be notified through the mobile app if a flight to which I&#8217;ve checked in is canceled.</p>
</div>
<div class="paragraph">
<p>Preconditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Passenger has checked in to the flight using the mobile app.</p>
</li>
<li>
<p>This flight is canceled.</p>
</li>
<li>
<p>AnyAirline is notified of the flight cancellation by an external party via the Flights Management system.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="title"><a id="us3"></a>US3: Offline Check-In Submissions</div>
<div class="content">
<div class="paragraph">
<p>As a Third party check-in partner company ("company" for short), I want to be able to submit all check-in data that was accumulated while being offline.</p>
</div>
<div class="paragraph">
<p>Context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check-in must continue even if systems are offline due to an outage, so that normal online check-in using AnyAirlines online systems cannot be performed.</p>
</li>
<li>
<p>After coming online again, the Third party check-in partner company must submit to AnyAirline data about all check-ins performed during the offline period.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Preconditions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Company is a known partner of AnyAirline providing, check-in to AnyAirline passengers using AnyAirline online check-in services.</p>
</li>
<li>
<p>Company has suffered an outage so that it can&#8217;t use AnyAirlines' online check-in services.</p>
</li>
<li>
<p>Company has continued checking in passengers while offline.</p>
</li>
<li>
<p>Company has since restored full connectivity.</p>
</li>
<li>
<p>Company now wants to send all check-in data accumulated during the offline period to AnyAirline.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_nonfunctional_requirements"><a class="anchor" href="#_nonfunctional_requirements"></a><a class="link" href="#_nonfunctional_requirements">Nonfunctional requirements</a></h5>
<div class="paragraph">
<p>This is a small subset of nonfunctional requirements, namely those that are directly relevant to this project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>NFR1:</strong> Application components interacting directly with on-premises systems (Flights Management system, Passenger Data system) must be deployed on-premises in the AnyAirline data center. This applies, for example, to System APIs.</p>
</li>
<li>
<p><strong>NFR2:</strong> All application components interacting only with cloud-hosted systems (PayPal, Salesforce CRM) or APIs must be deployed to CloudHub 2.0.</p>
</li>
<li>
<p><strong>NFR3:</strong> All data must be encrypted in flight (for example, using HTTPS).</p>
</li>
<li>
<p><strong>NFR4:</strong> API-led connectivity should be followed unless performance considerations suggest otherwise.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect3">
<h4 id="section-aa-solution-arch"><a class="anchor" href="#section-aa-solution-arch"></a><a class="link" href="#section-aa-solution-arch">Solution architecture</a></h4>
<div class="paragraph">
<p>Abbreviations used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAPI for System API</p>
</li>
<li>
<p>PAPI for Process API</p>
</li>
<li>
<p>EAPI for Experience API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please note that, for the purpose of simplicity, this section does not differentiate between an API and its API implementation. For example, Flights Management SAPI is used to denote both the REST API  defined via a RAML definition or OpenAPI definition  as well as the Mule app implementing and exposing that REST API. (However, later sections will differentiate; for example, the API implementation of Flights Management SAPI will be called flights-management-sapi.)</p>
</div>
<div class="sect4">
<h5 id="aa-high-level-arch"><a class="anchor" href="#aa-high-level-arch"></a><a class="link" href="#aa-high-level-arch">High-level architecture</a></h5>
<div class="paragraph">
<p>The following diagram gives an overview of the relevant components and artifacts for this project, and where they interact to realize the use cases of this project. Deployment aspects of this diagram describe the production environment.</p>
</div>
<div id="img-case-study-sketch" class="imageblock">
<div class="content">
<img src="./images/case-study-sketch.png" alt="case study sketch" width="100%">
</div>
<div class="title">Figure 1. Components and artifacts under design and development in this project (yellow and blue), to be integrated with but not changed (grey), or out-of-scope for this project (transparent). A static view of all interactions between these components and artifacts is shown by arrows pointing from active to passive participant in the interaction. Dotted arrows signify interactions not directly addressed in this project. Deployment asepcts are for the production environment.</div>
</div>
</div>
<div class="sect4">
<h5 id="_user_story_realizations"><a class="anchor" href="#_user_story_realizations"></a><a class="link" href="#_user_story_realizations">User story realizations</a></h5>
<div class="sect5">
<h6 id="aa-us1-realization"><a class="anchor" href="#aa-us1-realization"></a><a class="link" href="#aa-us1-realization">US1: mobile Check-In</a></h6>
<div class="openblock">
<div class="title"><a id="us1-overview"></a>Overview</div>
<div class="content">
<div class="paragraph">
<p>The following diagram explains on a high level of detail the business process underlying US1: mobile Check-In.</p>
</div>
<div id="img-check-in-process" class="imageblock">
<div class="content">
<img src="./images/check-in-process.png" alt="check in process" width="100%">
</div>
<div class="title">Figure 2. Flowchart visualizing the process by which US1: mobile Check-In is to be realized on a high level. Processing steps and decisions that do not require human interaction are shown as rectangles and rhombi, respectively.</div>
</div>
</div>
</div>
<div id="pp-payments" class="openblock">
<div class="title"><a id="pp-payments"></a>PayPal payments</div>
<div class="content">
<div class="paragraph">
<p>Payments are implemented via PayPal. This affects and is visible to the API implementations processing payments, the mobile app, and the passenger.</p>
</div>
<div class="paragraph">
<p>Integration with PayPal as designed here uses v1 of the PayPal REST API, which is deprecated as of early 2019.</p>
</div>
<div class="paragraph">
<p>The general approach for integrating with PayPal is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the PayPal v1 REST APIs from the PayPal SAPI to first <a href="https://developer.paypal.com/docs/api/payments/v1/#payment_create">create a PayPal payment</a> and then, after approval by the passenger, to <a href="https://developer.paypal.com/docs/api/payments/v1/#payment_execute">execute that PayPal payment</a>.</p>
</li>
<li>
<p>Use the web-based <a href="https://developer.paypal.com/docs/checkout/how-to/server-integration/#1-set-up-your-client-to-call-your-server">PayPal Check-Out Button</a> from the mobile app to allow the passenger to <a href="https://developer.paypal.com/docs/integration/direct/payments/paypal-payments/#get-payment-approval">approve</a> a previously created PayPal payment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specifically, a PayPal payment must first be created by PayPal SAPI via a PayPal REST API invocation. The Payment ID created in the process by PayPal must then be used in the mobile app to present the passenger with a UI to approve that payment. In approving the payment, PayPal identifies the payer and hands its Payer ID to the mobile app. Finally, to execute a PayPal payment, PayPal SAPI must pass both the Payment ID and the Payer ID to PayPal in a PayPal REST API invocation.</p>
</div>
<div class="paragraph">
<p>Authentication of PayPal API clients follows the <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0 client credentials grant type</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At development time, a PayPal app representing the PayPal API client, which is PayPal SAPI, must be created or egistered with PayPal. In the process, PayPal generates a pair of client ID and secret for PayPal SAPI, for both the PayPal Sandbox and Production environments.</p>
</li>
<li>
<p>At runtime, client ID and secret must be <a href="https://developer.paypal.com/reference/get-an-access-token/">exchanged for a temporary bearer access token</a>. All further PayPal REST API invocations must then <a href="https://developer.paypal.com/docs/api/overview/#make-rest-api-calls">present that bearer access token</a> in the HTTP Authorization header. This process must be repeated once the bearer access token has expired.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="openblock">
<div class="title"><a id="detailed-interactions"></a>Detailed component interactions</div>
<div class="content">
<div class="paragraph">
<p>The following diagram shows how US1: mobile Check-In is realized through the interaction of all relevant components in the case where payment for bags needs to be made. In the case where there are no bags and no payment, the interaction simplifies accordingly.</p>
</div>
<div id="img-check-in" class="imageblock">
<div class="content">
<img src="./images/check-in.svg" alt="check in" width="100%">
</div>
<div class="title">Figure 3. Sequence diagram visualizing the detailed interaction of components in the realization of US1: mobile Check-In. The depicted case is when the number of bags is positive and hence payment needs to be collected.</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="aa-us2-realization"><a class="anchor" href="#aa-us2-realization"></a><a class="link" href="#aa-us2-realization">US2: Flight Cancellation mobile Notifications</a></h6>
<div class="paragraph">
<p>From AnyAirlines perspective, flight cancellations materialize from outside of AnyAirline in the Flights Management system.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SOAP clients to the Flights Management system, such as Flights Management SAPI, can register an HTTP callback (webhook), which will then be invoked by the Flights Management system when a flight cancellation occurs. That registration should occur at startup of Flights Management SAPI (duplicate registrations are ignored).</p>
</li>
<li>
<p>The HTTP callback delivers cancellation notifications from the Flights Management system to Flights Management SAPI in the form of a HTTP POST requests from the former to the latter.</p>
</li>
<li>
<p>One cancellation notification for each previously successful check-in, now affected by the cancellation, is sent per HTTP POST request. Each cancellation notification contains the PNR and last name of the passenger in XML format:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;CancellationNotification&gt;</span>
  <span style="color: #b58900">&lt;PNR&gt;</span>PNR123<span style="color: #b58900">&lt;/PNR&gt;</span>
  <span style="color: #b58900">&lt;PassengerLastName&gt;</span>Mule<span style="color: #b58900">&lt;/PassengerLastName&gt;</span>
<span style="color: #b58900">&lt;/CancellationNotification&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Flights Management SAPI uses the reliability pattern to accept a cancellation notification and immediately publish it onto a persistent VM queue. Then, asynchronously  in an XA transaction if supported by the message broker  the System API unqueues the notification, transforms it to a backend-neutral flight canceled event and publishes that event to an Anypoint MQ exchange (or, potentially, a JMS topic). A flight canceled event is JSON-formatted:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="json"><span style="color: #93a1a1">{</span><span style="color: #586e75">
 </span><span style="color: #586e75">"pnr"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"RW4TAB"</span><span style="color: #93a1a1">,</span><span style="color: #586e75">
 </span><span style="color: #586e75">"lastNameOfPassenger"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"Smith"</span><span style="color: #586e75">
</span><span style="color: #93a1a1">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Because the HTTP callback processes cancellation notifications asynchronously rather than synchronously, it returns a HTTP 202 ACCEPTED rather than a 200 OK response code to the Flights Management system, to inform it of that fact.</p>
</li>
<li>
<p>flight canceled events are then delivered via publish-subscribe messaging to an Experience-layer mobile app, mobile Notifications EApp, which delivers them to the mobile app via native mobile notifications (such as Apples APNs).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The component interactions to realize the first part of these steps, up to the publishing of flight canceled events to the Anypoint MQ exchange, are shown in the following sequence diagram.</p>
</div>
<div id="img-notifications-callbacks" class="imageblock">
<div class="content">
<img src="./images/notifications-callbacks.svg" alt="notifications callbacks" width="100%">
</div>
<div class="title">Figure 4. Sequence diagram visualizing the first part of the realization of US2: Flight Cancellation mobile Notifications: the registration of Flights Management SAPI with the Flights Management system to receive cancellation notifications, the delivery and transformation of cancellation notifications to flight canceled events, and the publishing of the latter to an Anypoint MQ exchange.</div>
</div>
</div>
<div class="sect5">
<h6 id="aa-us3-realization"><a class="anchor" href="#aa-us3-realization"></a><a class="link" href="#aa-us3-realization">US3: Offline Check-In Submissions</a></h6>
<div class="paragraph">
<p>Offline Check-In Submission Handler has a similar role to Check-In PAPI, with the difference that the former:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Processes batches of check-ins submitted in a flat file,</p>
</li>
<li>
<p>Does not deal with payments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Files are submitted per SFTP and are in CSV format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each submissions file contains zero to arbitrary many (typically tens of thousands) of records with one record on each line.</p>
</li>
<li>
<p>Each record contains data about a passengers check-in.</p>
</li>
<li>
<p>Each record is independent of all other records. There is no need to deal with records that pertain to duplicate check-ins of the same passenger to the same flight.</p>
</li>
<li>
<p>Each record must be individually passed to Flights Management SAPI via an API invocation, similar to what Check-In PAPI does.</p>
</li>
<li>
<p>Batches of records must be inserted into the Passenger Data system, similar to what Passenger Data SAPI does (but in batches, for efficiency).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="aa-deployment"><a class="anchor" href="#aa-deployment"></a><a class="link" href="#aa-deployment">Deployment</a></h5>
<div class="paragraph">
<p>All Mule apps are deployed to CloudHub 2.0 in the shared space in usa-e1 (N. Virginia) or usa-e2 (Ohio) under the control of the MuleSoft-hosted Anypoint Platform control plane in the U.S.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-invoking-apis"><a class="anchor" href="#module-invoking-apis"></a><a class="link" href="#module-invoking-apis">Module 1: Invoking web APIs and services</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you invoke REST APIs and SOAP web services using various client components taking into consideration the nonfunctional properties of API invocations.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set up the starter code</p>
</li>
<li>
<p>Invoke HTTP APIs using the HTTP Connector paying attention to the non-functional properties of API invocations.</p>
</li>
<li>
<p>Map between HTTP requests and Mule events</p>
</li>
<li>
<p>Enable an API client for OAuth 2.0.</p>
</li>
<li>
<p>Invoke a SOAP web service using mutual TLS authentication.</p>
</li>
<li>
<p>Implement an HTTP callback.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-211"><a class="anchor" href="#wt-begin-211"></a><a class="link" href="#wt-begin-211">Walkthrough 1-1: Set up the starter code</a></h3>
<div class="paragraph">
<p>This walkthrough starts with the latest state of check-in-papi and apps-commons as implemented in <em>Anypoint Platform Development: Production-Ready Development Practices</em>. The Mule app check-in-papi relies on the library-style Mule plugin apps-commons for common Mule app functionality in the areas of error handling and health checks. A library-style Mule plugin contains simple resources like Mule flow config files and is built from a Maven project with &lt;packaging /&gt; mule-application and &lt;classifier /&gt; mule-plugin.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you setup the starter code for check-in-papi, apps-commons, and their Maven build.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Setup starter code for check-in-papi">[Setup starter code for check-in-papi]</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_starting_file"><a class="anchor" href="#_starting_file"></a><a class="link" href="#_starting_file">Starting file</a></h4>
<div class="paragraph">
<p>To follow this walkthrough, you need the starter project at $APDL2DIST/walkthroughs/devint/module01/wt1-1_starter.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-starter-cipapii-appscomms"><a class="anchor" href="#setup-starter-cipapii-appscomms"></a><a class="link" href="#setup-starter-cipapii-appscomms">Set up starter code for check-in-papi</a></h4>
<div class="paragraph">
<p>In this section, you install a Maven settings.xml, which provides the credentials for authenticated access to several Maven repositories, and a parent POM and BOM, which form the basis of repeatable and convenient Maven builds for AnyAirline and this course. You then copy the starter code for apps-commons  a utility library-style Mule plugin for Mule apps  and check-in-papi into your Studio workspace, build them, and import them into Studio.</p>
</div>
<div class="paragraph">
<p>To run check-in-papi, you must disable autodiscovery, otherwise you would either have to create an API instance for Check-In PAPI in an Anypoint Platform organization you have access to or, alternatively, receive credentials to connect to AnyAirline&#8217;s Anypoint Platform organization, which already has an API instance with the API ID configured in check-in-papi: you decide against both of these options and instead disable autodiscovery entirely.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the <a href="#section-aa-solution-arch">Solution architecture</a> and in particular the <a href="#aa-high-level-arch">High-level architecture</a> and the <a href="#aa-us1-realization">design of US1: mobile Check-In</a>; note the dependencies of Check-In PAPI on Flights Management SAPI, Passenger Data SAPI, and PayPal SAPI for the core check-in functionality being implemented in check-in-papi.</p>
</li>
<li>
<p><strong>Install global settings.xml:</strong> Copy settings.xml from $APDL2DIST/etc to your ~/.m2/ directory and study its contents:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cp</span> <span style="color: #586e75">$APDL2DIST</span>/etc/settings.xml ~/.m2/</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This settings.xml provides the credentials needed for accessing various Maven repositories, such as the MuleSoft EE releases repository and the Exchange of AnyAirline.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There is also an entry for deploying to CloudHub 2.0 from the Mule Maven plugin, but this will not be used for the time being.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Locate EE releases credentials:</strong> In settings.xml, confirm the credentials for the MuleSoft EE releases repository to be <strong>muletraining.nexus</strong> and <strong>eApHMgTm</strong>.</p>
</li>
<li>
<p><strong>Create Exchange Viewer Connected App:</strong> In Anypoint Access Management, create a new Connected App that acts on its <strong>own behalf (client credentials)</strong>, for reading assets from Exchange, adding the <strong>Exchange Viewer</strong> scope and retrieve its client ID and secret.</p>
</li>
<li>
<p><strong>Update settings.xml:</strong> In a text editor, update settings.xml in ~/.m2/ with credentials for reading from your Anypoint Platform organization&#8217;s Exchange as a Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;settings&gt;</span>
  <span style="color: #b58900">&lt;servers&gt;</span>
    <span style="color: #b58900">&lt;server&gt;</span>
      <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3<span style="color: #b58900">&lt;/id&gt;</span>
      <span style="color: #b58900">&lt;username&gt;</span>~~~Client~~~<span style="color: #b58900">&lt;/username&gt;</span>
      <span style="color: #b58900">&lt;password&gt;</span>your-AP-Exchange-Viewer-cid~?~your-AP-Exchange-Viewer-secret<span style="color: #b58900">&lt;/password&gt;</span>
    <span style="color: #b58900">&lt;/server&gt;</span>
  <span style="color: #b58900">&lt;/servers&gt;</span>
<span style="color: #b58900">&lt;/settings&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can also use Anypoint Platform credentials for an account of your Anypoint Platform organization with which you were able to search your Exchange  such as the trial account credentials created previously. However, it is best practice to use a Connected App for security.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To use Connected App authentication, provide basic authentication and define the username as ~~~Client~~~ and the password as clientID~?~clientSecret. Replace clientID with the client ID. Replace clientSecret with the client secret.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Copy parent POMs:</strong> Copy AnyAirline&#8217;s BOM and parent POM into new <strong>bom</strong> and <strong>parent-pom</strong> directories, respectively, within your Studio workspace directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">mkdir </span>bom
<span style="color: #586e75">mkdir </span>parent-pom
<span style="color: #586e75">cp</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module01/wt1-1_starter/bom/pom.xml ./bom/pom.xml
<span style="color: #586e75">cp</span>  <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module01/wt1-1_starter/parent-pom/pom.xml ./parent-pom/pom.xml</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update parent POMs:</strong> Update all parent POMs adapting the Maven coordinates to match the <strong>groupId</strong> of your Anypoint Platform organization ID for the project and the parent:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
  <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    ...
  <span style="color: #b58900">&lt;/parent&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>These POMs use the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Configure Anypoint Platform organization ID groupId:</strong> Update the custom property with your Anypoint Platform organization ID used to configure the dependency groupId for apps-commons when referenced later:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;student.deployment.ap.orgid&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/student.deployment.ap.orgid&gt;</span>
<span style="color: #b58900">&lt;/properties&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Install, and study parent POMs:</strong> Install the parent POMs into your local Maven repository, and browse their contents:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>bom/pom.xml        <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>bom/pom.xml
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>AnyAirline&#8217;s BOM manages all Maven dependencies and plugins supported by AnyAirline and this course, thereby fixing their versions and providing the repositories to download them from.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>AnyAirline&#8217;s parent POM provides configuration of the Mule Maven plugin, MUnit Maven plugin, and other Maven aspects to facilitate build, test, and deploy of Mule apps.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Installation into the local Maven repository is necessary because MUnit Maven tooling currently does not resolve parent POMs from the filesystem location given in &lt;relativePath /&gt;.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Copy apps-commons starter:</strong> Copy the apps-commons starter project into your Studio workspace directory:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module01/wt1-1_starter/apps-commons ./</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Study Maven build:</strong> Familiarize yourself briefly with the Maven build configuration of apps-commons.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>This Maven project packages a library-style Mule plugin containing Mule flow config files.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Dependencies defined in provided scope must be provided by the context (Mule app, Mule runtime domain) in which apps-commons is imported and executed.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Reusable Maven plugin configuration is inherited from the parent POM and Maven dependency management from the BOM. The parent-pom/pom.xml is read from the Studio workspace directory, and therefore in turn imports bom/pom.xml from that same directory.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update groupId:</strong> Update pom.xml adapting the Maven coordinates to match the groupId of your Anypoint Platform organization ID for the project and the parent:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
 <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    ...
  <span style="color: #b58900">&lt;/parent&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM uses the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of apps-commons, installing the JAR into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> In Studio, import the apps-commons project as a Mule app, without copying it into the workspace, because it is already there; confirm that the import succeeded and update the classifier for the Mule Maven plugin configuration to output a mule-plugin:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;plugin&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;configuration&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/configuration&gt;</span>
<span style="color: #b58900">&lt;/plugin&gt;</span>`</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Importing the Mule app project into Studio changes the &lt;classifier /&gt; to mule-application and must be changed back.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The apps-commons project builds an artifact with Maven classifier mule-plugin but uses Maven packaging mule-application and so imports just like any other Mule app project into Studio.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Copy check-in-papi starter:</strong> Copy the check-in-papi starter project into your Studio workspace directory, renaming it to check-in-papi:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module01/wt1-1_starter/check-in-papi ./</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Adapt POM:</strong> In a text editor, adapt check-in-papi to your Maven build set-up by following the instructions in <strong>pom.xml</strong> including adapting the Maven coordinates of the parent POM to match the groupId of your Anypoint Platform organization ID for the project and the parent:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
 <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    ...
  <span style="color: #b58900">&lt;/parent&gt;</span>
  ...
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Maven build:</strong> Familiarize yourself briefly with the Maven build configuration of check-in-papi.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The Check-In PAPI API specification is loaded as a Maven dependency with artifact ID check-in-papi in the form of an OpenAPI definition from the AnyAirline Exchange Maven repo, which requires authentication entries in settings.xml, created previously.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The check-in-papi Mule app is assigned to the Process tier/layer in Visualizer.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Again, reusable Maven plugin configuration is inherited from the parent POM and Maven dependency management from the BOM. Both parent-pom/pom.xml and bom/pom.xml are read from the Studio workspace directory.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of check-in-papi including all MUnit tests, providing the required secure properties encryption key; this should succeed and all unit tests should pass:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> In Studio, import check-in-papi without copying it to the workspace, because it is already there; confirm that the import succeeded.</p>
</li>
<li>
<p><strong>Add run config disabling autodiscovery:</strong> Add a Studio run configuration (via the <strong>Run as &gt; Mule application (configure)</strong> dialog) for check-in-papi that sets <strong>encrypt.key</strong> and disables autodiscovery:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345
<span style="color: #b58900">-M-Danypoint</span>.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The API ID values configured in the properties files of check-in-papi for the various environments stem from the AnyAirline Anypoint Platform organization, to which you have not been given access; disabling autodiscovery works around this restriction by preventing the uplink to API Manager without requiring a code change (such as removing the autodiscovery configuration).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and invoke the exposed Check-In PAPI and health check endpoints; this should succeed, returning meaningful HTTP responses:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span>  <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">PAY-1AKD7482FAB9STATKO</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://localhost:8081/api/v1/tickets/N123/paymentApproval</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because this API implementation uses self-signed certificates, you must explicitly allow them when invoking these HTTPS endpoints.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study check-in-papi:</strong> Inspect check-in-papi so that you can explain the HTTP requests just performed, the HTTP responses received, and the MUnit tests executed in the previous Maven build.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-212"><a class="anchor" href="#wt-begin-212"></a><a class="link" href="#wt-begin-212">Walkthrough 1-2: Invoke HTTP APIs using the HTTP Connector</a></h3>
<div class="paragraph">
<p>The readiness endpoint as implemented in check-in-papi is just a placeholder: it does not actually check the availability of all API dependencies of check-in-papi, as a proper readiness endpoint implementation should.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you implement the readiness endpoint of check-in-papi by invoking the liveness endpoints of the API implementations of all its downstream API dependencies: Flights Management SAPI, Passenger Data SAPI, and PayPal SAPI using the plain HTTP Connector. In doing so, you address the validation of HTTP responses and various important nonfunctional aspects of API invocations.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_send_http_get_requests_using_the_http_connector">Send HTTP GET requests using the HTTP Connector</a>.</p>
</li>
<li>
<p><a href="#_log_http_traffic">Log HTTP traffic</a>.</p>
</li>
<li>
<p><a href="#_validate_the_http_status_code_returned_in_http_responses">Validate the HTTP status code returned in HTTP responses</a>.</p>
</li>
<li>
<p><a href="#_set_meaningfully_short_http_response_timeouts">Set meaningfully short HTTP response timeouts</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file"><a class="anchor" href="#_solution_file"></a><a class="link" href="#_solution_file">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_send_http_get_requests_using_the_http_connector"><a class="anchor" href="#_send_http_get_requests_using_the_http_connector"></a><a class="link" href="#_send_http_get_requests_using_the_http_connector">Send HTTP GET requests using the HTTP Connector</a></h4>
<div class="paragraph">
<p>In this section, you implement check-all-dependencies-are-alive of check-in-papi, which is invoked by api-ready in apps-commons; that is, the actual readiness endpoint implementation. You implement this Mule flow using &lt;http:request /&gt; to send HTTP GET requests to the liveness endpoints of the implementations of all API dependencies of check-in-papi  the three System APIs Flights Management SAPI, Passenger Data SAPI, and PayPal SAPI  in the matching environment of AnyAirline. So check-in-papi in the dev environment of your Anypoint Platform organization invokes AnyAirline&#8217;s dev endpoints of flights-management-sapi, passenger-data-sapi, and paypal-sapi, and similarly for test and prod.</p>
</div>
<div class="paragraph">
<p>It is a generic pattern that readiness endpoint implementations invoke liveness endpoints of all dependencies. If they were to invoke readiness endpoints then this would trigger a transitive invocation cascade with every readiness check.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Implement readiness checks:</strong> Implement <strong>check-all-dependencies-are-alive</strong> in health.xml to use a &lt;http:request /&gt; to invoke all three liveness endpoints using HTTP GET to the correct URLs, without referring to an HTTP Request configuration, following HTTP redirects, and using defaults for everything else:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span>
    <span style="color: #268bd2">url=</span><span style="color: #859900">"https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/alive"</span>
    <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span>
    <span style="color: #268bd2">url=</span><span style="color: #859900">"https://tngaa-passenger-data-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/alive"</span>
    <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span>
    <span style="color: #268bd2">url=</span><span style="color: #859900">"https://tngaa-paypal-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/alive"</span>
    <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is a recommended defensive practice to always transparently follow HTTP redirects when possible, even if this is not needed here.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This implementation of check-all-dependencies-are-alive can be improved along many dimensions, such as resilience and performance. You will do this shortly.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi in Studio and invoke its health check endpoints as before; both should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The readiness endpoint should take noticeably longer to return than the liveness endpoint.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Add props:</strong> Add environment-dependent and specific for all environments, such as the hostnames of the System API dependencies, and the root paths of their API and health check endpoints.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_log_http_traffic"><a class="anchor" href="#_log_http_traffic"></a><a class="link" href="#_log_http_traffic">Log HTTP traffic</a></h4>
<div class="paragraph">
<p>In this section, you increase the log output produced by the HTTP Connector such that HTTP requests and responses to/from check-in-papi are logged. This affects both &lt;http:listener /&gt; and &lt;http:request /&gt;.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p><strong>Set logger&#8217;s log level:</strong> In <strong>log4j2.xml</strong> decrease the log level of the relevant logger of the HTTP Connector to <strong>DEBUG</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">log4j2.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;Loggers&gt;</span>
  <span style="color: #b58900">&lt;AsyncLogger</span>
    <span style="color: #268bd2">name=</span><span style="color: #859900">"org.mule.service.http.impl.service.HttpMessageLogger"</span>
    <span style="color: #268bd2">level=</span><span style="color: #859900">"DEBUG"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/Loggers&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This entry is typically already present in Studio-generated log4j2.xml files and only needs to be commented-in.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is not necessary to decrease the log level of the root logger.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This Log4J configuration is used in all environments; only unit tests are governed by a different Log4J configuration file (log4j2-test.xml). It is often helpful to use different logging configurations in prod versus test and dev, but this is beyond the scope of this course.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and invoke the health check endpoints again; confirm that the HTTP interactions are logged and are as expected.</p>
</li>
<li>
<p><strong>Study threads:</strong> Inspect the log output for information about the threads which perform HTTP communication, as this gives important insight into Mule runtime thread handling.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_validate_the_http_status_code_returned_in_http_responses"><a class="anchor" href="#_validate_the_http_status_code_returned_in_http_responses"></a><a class="link" href="#_validate_the_http_status_code_returned_in_http_responses">Validate the HTTP status code returned in HTTP responses</a></h4>
<div class="paragraph">
<p>In this section, you enforce the agreed contract with health check endpoints in that the HTTP response must have a status code of 200. By default, &lt;http:request /&gt; considers all 2xx response codes to be successful, and raises errors for 4xx and 5xx response codes, while optionally following redirects denoted by 3xx response codes. So while default HTTP response code validation is sufficient for health checks, you explicitly enforce the contract by accepting only status code 200.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p><strong>Add status code validator:</strong> Add explicit HTTP status code validation to all &lt;http:request /&gt; elements, requiring a value of 200:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"..."</span> <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:response-validator&gt;</span>
    <span style="color: #b58900">&lt;http:success-status-code-validator</span> <span style="color: #268bd2">values=</span><span style="color: #859900">"200"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/http:response-validator&gt;</span>
<span style="color: #b58900">&lt;/http:request&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Status code ranges can also be expressed.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>An inverse status code validator that requires you to list error codes is also available.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and confirm that the readiness endpoint implementation still works correctly.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_set_meaningfully_short_http_response_timeouts"><a class="anchor" href="#_set_meaningfully_short_http_response_timeouts"></a><a class="link" href="#_set_meaningfully_short_http_response_timeouts">Set meaningfully short HTTP response timeouts</a></h4>
<div class="paragraph">
<p>In this section, you explore the impact of unavailable API dependencies and improve the responsiveness of the check-in-papi readiness endpoint implementation by setting a short timeout on the invocations of the downstream liveness endpoints.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p><strong>Misconfigure API dependency:</strong> In <strong>health.xml</strong> change the paypal-sapi URL to use a timeout simulator service, thereby making all invocations to that API fail:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span>
    <span style="color: #268bd2">url=</span><span style="color: #859900">"https://tngaa-http-simulator-service-zkvtif.rajrd4-1.usa-e1.cloudhub.io/wait"</span>
    <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:response-validator&gt;</span>
				<span style="color: #b58900">&lt;http:success-status-code-validator</span>
					<span style="color: #268bd2">values=</span><span style="color: #859900">"200"</span> <span style="color: #b58900">/&gt;</span>
			<span style="color: #b58900">&lt;/http:response-validator&gt;</span>
		<span style="color: #b58900">&lt;/http:request&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is a naive way of simulating one particular kind out of a whole range of possible communication issues that may occur when invoking this or any other API.</em></p>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Invoke the readiness endpoint, ideally timing its execution; this should hang for at least 10 seconds before <strong>failing</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">time </span>curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The exact amount of time that an ultimately failing API invocation  or other HTTP request-response interaction  hangs until it returns an error is hard to predict in the absence of explicit timeout configuration, because it depends on many factors, including the nature of the failure, network components between API client and API implementation, and operating system, JVM and Mule runtime configuration, and defaults. The current Mule runtime default is 10 seconds.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reflect:</strong> In Studio, follow the exact call chain that leads from the failed &lt;http:request /&gt; to the HTTP response just returned.</p>
</li>
<li>
<p><strong>Set timeout:</strong> Add a short but achievable response timeout of <strong>1000 milliseconds</strong> to all &lt;http:request /&gt; elements:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"..."</span> <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span>
  <span style="color: #268bd2">responseTimeout=</span><span style="color: #859900">"1000"</span><span style="color: #b58900">&gt;</span>
  ...
<span style="color: #b58900">&lt;/http:request&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>A meaningful value for the response timeout is the 95th percentile of the HTTP response time of the invoked API implementation when under typical load <a href="#Ref15">[Ref15]</a>, with the response time being measured from the point of view of the invoking API client. The response time thus depends on the performance characteristics and network location not only of the API implementation but also, to a certain extent, the API client.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This implementation of check-all-dependencies-are-alive can still be improved along many dimensions, such as resilience and performance. You will do this in later walkthroughs.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Invoke the readiness endpoint again, ideally timing its execution; this should fail much faster.</p>
</li>
<li>
<p><strong>Revert misconfiguration:</strong> Undo the misconfiguration of the paypal-sapi in <strong>health.xml</strong>.</p>
</li>
<li>
<p><strong>Homework:</strong> Analyze the commonalities in the three &lt;http:request /&gt; instances in check-all-dependencies-are-alive of check-in-papi and factor-out that commonality into a new helper flow in apps-commons. This helper flow can then be used in all similar implementations of check-all-dependencies-are-alive in all Mule apps.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-213"><a class="anchor" href="#wt-begin-213"></a><a class="link" href="#wt-begin-213">Walkthrough 1-3: Map between HTTP requests and Mule events</a></h3>
<div class="paragraph">
<p>The check-in functionality currently implemented in check-in-papi is just  a placeholder: it does not orchestrate any of the required downstream APIs to check-in a passenger.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you you begin the implementation of the required check-in functionality, invoking all its downstream API dependencies: Flights Management SAPI, Passenger Data SAPI, and PayPal SAPI. Including setting the required authentication and mapping HTTP request and responses to orchestrate multiple HTTP requests.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#wt1-2-config-rest-conns-to-send-cids">Configure the HTTP Connector to send client ID and secret via HTTP Basic Authentication</a>.</p>
</li>
<li>
<p><a href="#_invoke_downstream_system_apis_using_the_http_connector_with_full_control_over_the_http_message">Invoke downstream System APIs using the HTTP Connector with full control over the HTTP message</a>.</p>
</li>
<li>
<p><a href="#_handle_all_errors_raised_while_processing_an_incoming_http_request">Handle all errors raised while processing an incoming HTTP request</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_2"><a class="anchor" href="#_solution_file_2"></a><a class="link" href="#_solution_file_2">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="wt1-2-config-rest-conns-to-send-cids"><a class="anchor" href="#wt1-2-config-rest-conns-to-send-cids"></a><a class="link" href="#wt1-2-config-rest-conns-to-send-cids">Configure the HTTP Connector to send client ID and secret via HTTP Basic Authentication</a></h4>
<div class="paragraph">
<p>In this section, you configure the HTTP Connector for the three System APIs invoked by check-in-papi. This comprises supplying the endpoint URLs of the API instances which the HTTP Connector should invoke, as well as providing required security configuration.</p>
</div>
<div class="paragraph">
<p>In the case of the three System APIs, the API instances are protected by Client ID enforcement API policy instances, and hence require client ID and secret to be presented by API clients. client ID and secret could be sent in dedicated HTTP request headers or query parameters, but it is also possible to reuse the standard Authorization header defined by HTTP Basic Authentication. In the latter case, client ID and secret take the role of username and password in HTTP Basic Authentication, respectively. It is this approach that the Client ID enforcement API policy instances of all AnyAirline APIs take. Security configuration of the HTTP Connector therefore entails supplying username and password, which are really the client ID and secret supplied to you, for an API client already created.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Add HTTP Connector configs:</strong> In Studio, using the visual Mule config flow editor, add to <strong>global.xml</strong> a HTTP Connector configuration for Flights Management SAPI, Passenger Data SAPI, and PayPal SAPI, configuring the correct host and authentication with the supplied client ID and secret for an API client already created in Anypoint Platform:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request-config</span>
  <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsManagementSapiConfig"</span>
  <span style="color: #268bd2">basePath=</span><span style="color: #859900">"/api/v1"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection</span>
    <span style="color: #268bd2">host=</span><span style="color: #859900">"tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io"</span>
    <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:authentication&gt;</span>
      <span style="color: #b58900">&lt;http:basic-authentication</span>
        <span style="color: #268bd2">username=</span><span style="color: #859900">"e66105d66e8b4520b091127620221cce"</span>
        <span style="color: #268bd2">password=</span><span style="color: #859900">"A1c099D51C50420b84641D71b229EBac"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span>
<span style="color: #b58900">&lt;http:request-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"passengerDataSapiConfig"</span>
  <span style="color: #268bd2">basePath=</span><span style="color: #859900">"/api/v1"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection</span>
    <span style="color: #268bd2">host=</span><span style="color: #859900">"tngaa-passenger-data-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io"</span>
    <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:authentication&gt;</span>
      <span style="color: #b58900">&lt;http:basic-authentication</span>
        <span style="color: #268bd2">username=</span><span style="color: #859900">"e66105d66e8b4520b091127620221cce"</span>
        <span style="color: #268bd2">password=</span><span style="color: #859900">"A1c099D51C50420b84641D71b229EBac"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span>
<span style="color: #b58900">&lt;http:request-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"paypalSapiConfig"</span>
  <span style="color: #268bd2">basePath=</span><span style="color: #859900">"/api/v1"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection</span>
    <span style="color: #268bd2">host=</span><span style="color: #859900">"tngaa-paypal-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io"</span>
    <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:authentication&gt;</span>
      <span style="color: #b58900">&lt;http:basic-authentication</span>
        <span style="color: #268bd2">username=</span><span style="color: #859900">"e66105d66e8b4520b091127620221cce"</span>
        <span style="color: #268bd2">password=</span><span style="color: #859900">"A1c099D51C50420b84641D71b229EBac"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There are sample JSON files in the src/main/resources/examples directory for the request and response to use as metadata or as a guide.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Username and password refer to client ID and secret because the Client ID enforcement API policy on all APIs is configured to use HTTP Basic Authentication to pass client ID and secret.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Encrypt client ID and secret:</strong> Encrypt and store client ID and secret in dev-secure-properties.yaml using the usual encryption key (secure12345).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_invoke_downstream_system_apis_using_the_http_connector_with_full_control_over_the_http_message"><a class="anchor" href="#_invoke_downstream_system_apis_using_the_http_connector_with_full_control_over_the_http_message"></a><a class="link" href="#_invoke_downstream_system_apis_using_the_http_connector_with_full_control_over_the_http_message">Invoke downstream System APIs using the HTTP Connector with full control over the HTTP message</a></h4>
<div class="paragraph">
<p>In this section, you implement the essential parts of the check-in functionality of check-in-papi using the HTTP Connector modifying the HTTP request as required.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Invoke Flights Management SAPI check-in:</strong> In Studio, add to the <strong>check-in-flights-management</strong> flow in <strong>main.xml</strong> a simple invocation of the check-in functionality provided by Flights Management SAPI, using the data already available in that flow to prepare the request payload, and extracting just the API invocation proper into a subflow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/json
      ---
      {
        lastName: vars.checkIn.lastName,
        numBags:  vars.checkIn.numBags
      }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"flightsManagementSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"PUT"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/tickets/{PNR}/checkin"</span><span style="color: #b58900">&gt;</span>
			<span style="color: #b58900">&lt;http:uri-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"PNR" : vars.PNR
}]]]&gt;</span><span style="color: #b58900">&lt;/http:uri-params&gt;</span>
	<span style="color: #b58900">&lt;/http:request&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default the HTTP request body is taken from the payload, which is the approach used here, so that just the API invocation  and not the request payload creation  can be extracted into a subflow. This benefits testability.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Extract the API invocation into a subflow to improve testability.</p>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and invoke the check-in functionality it exposes; this should succeed, thereby confirming successful authentication with client ID and secret of check-in-papi against Flights Management SAPI in dev:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study check-in validation:</strong> In the <a href="#img-check-in">solution design</a>, review the validation of the check-in attempt performed as part of <strong>US1: mobile Check-In</strong>.</p>
</li>
<li>
<p><strong>Implement check-in validation:</strong> In main.xml, implement the validation of the check-in attempt, for which you first need to retrieve data for ticket and passenger, storing them directly in variables using the <strong>target</strong> attribute:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"checkIn"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[payload]"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"validate-ticket-passport-matches"</span> <span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"validate-ticket-passport-matches"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-ticket-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;choice&gt;</span>
    <span style="color: #b58900">&lt;when</span>
      <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[not vars.ticket.ticketHolderLastName == vars.checkIn.lastName]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:LASTNAME_MISMATCH"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/when&gt;</span>
  <span style="color: #b58900">&lt;/choice&gt;</span>

  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-passenger-data-by-passport"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;choice&gt;</span>
    <span style="color: #b58900">&lt;when</span>
      <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[not vars.passenger.lastName == vars.checkIn.lastName]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:LASTNAME_MISMATCH"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/when&gt;</span>
  <span style="color: #b58900">&lt;/choice&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-ticket-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"flightsManagementSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/tickets/{PNR}"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"ticket"</span> <span style="color: #268bd2">doc:name=</span><span style="color: #859900">"FMS Get Ticket"</span><span style="color: #b58900">&gt;</span>
			<span style="color: #b58900">&lt;http:uri-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"PNR" : vars.PNR
}]]]&gt;</span><span style="color: #b58900">&lt;/http:uri-params&gt;</span>
	<span style="color: #b58900">&lt;/http:request&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-passenger-data-by-passport"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"passenger"</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"passengerDataSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/passengers"</span><span style="color: #b58900">&gt;</span>
			<span style="color: #b58900">&lt;http:query-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"passportNo" : vars.ticket.ticketHolderPassPortNo
}]]]&gt;</span><span style="color: #b58900">&lt;/http:query-params&gt;</span>
	<span style="color: #b58900">&lt;/http:request&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There are sample JSON files in the src/main/resources/examples directory for the request and response to use as metadata or as a guide.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>HTTP response bodies are assigned to variables using the target attribute of the HTTP Connector.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Passenger Data SAPI invocation requires the passport number returned by the Flights Management SAPI.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Validation failures cause the custom application error APP:LASTNAME_MISMATCH to be raised.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Using a Choice router to perform validation is arguably not idiomatic: in a later walkthrough you will use the Validation module for cases such as this one.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and invoke the check-in functionality it exposes; this should execute and then return a HTTP 500 error with a particular payload:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>A HTTP 500 error is not appropriate in this situation, where the API client sent a check-in request that fails validation; this should result in a HTTP 4xx error response.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Error responses should never expose any Mule app internals.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Confirm APP:LASTNAME_MISMATCH raised:</strong> Inspect the log output to confirm that the APP:LASTNAME_MISMATCH error was raised and note the <strong>ticket holder last name</strong> actually returned from Flights Management SAPI.</p>
</li>
<li>
<p><strong>Explain HTTP response:</strong> Inspect all error handling code to explain why in the case of APP:LASTNAME_MISMATCH being raise this particular HTTP response body is returned.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The definition of api-error-handler in error-common.xml does not include a catch-all error handler, so the response payload is the payload at the time the error was raised. This is an important security leak you will correct later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The HTTP response status is determined by the HTTP Listener configuration in api-main in api.xml and is inappropriate for this situation, where a HTTP 4xx error code is expected.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Handle APP:LASTNAME_MISMATCH:</strong> Add error handling of APP:LASTNAME_MISMATCH to the appropriate Mule flow in <strong>api.xml</strong>, translating from the custom application error to an HTTP error response, taking this opportunity to simplify the setting of PNR:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"put:\tickets\(PNR)\checkin..."</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"PNR"</span>
    <span style="color: #268bd2">value=</span><span style="color: #859900">"#[attributes.uriParams.PNR]"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:LASTNAME_MISMATCH"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;set-payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">'#[output application/json --- {message: "Invalid passenger name record or bad data uploaded."}]'</span>
      <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;set-variable</span>
        <span style="color: #268bd2">variableName=</span><span style="color: #859900">"httpStatus"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"400"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is a client error (400) because the data sent by the API client does not pass validation.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the API implementation and invoke the API again as before; this should now result in a 400 error response that does not leak app internals.</p>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the API with the correct ticket holder last name; this should succeed and return a payment ID:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Study check-in-by-pnr:</strong> Confirm that check-in-by-pnr, after validation, invokes check-in-flights-management, register-passenger-data, and create-payment-for-bags, in that order.</p>
</li>
<li>
<p><strong>Raise custom error from check-in-flights-management:</strong> Add a catch-all error handler raising a custom application error to the existing implementation of check-in-flights-management, as a first step to implementing the check-in functionality itself:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue&gt;</span>
      <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:CANT_UPDATE_CHECKINS"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Implement register-passenger-data:</strong> Fill in the missing implementation of register-passenger-data, transforming the check-in date to UTC as required by Passenger Data SAPI, invoking Passenger Data SAPI, and raising a custom application error from a catch-all error handler:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-passenger-data"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/json
      ---
      {
        "date_checkin": now() &gt;</span>&gt; "UTC",
        "destination":  vars.ticket.destination,
        "flight_date":  vars.ticket.flightDate,
        "flight_no":    vars.ticket.flightNo,
        "origin":       vars.ticket.origin
      }]]&gt;<span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>

  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"passengerDataSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"POST"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/passengers/{LNO}/flights"</span><span style="color: #b58900">&gt;</span>
			<span style="color: #b58900">&lt;http:uri-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"LNO" : vars.passenger.loyaltyNo
}]]]&gt;</span><span style="color: #b58900">&lt;/http:uri-params&gt;</span>
	<span style="color: #b58900">&lt;/http:request&gt;</span>

  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue&gt;</span>
      <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:CANT_CREATE_PASSENGER_FLIGHT"</span>  <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There are sample JSON files in the src/main/resources/examples directory for the request and response to use as metadata or as a guide.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>DataWeave supports special syntax for time-zone conversions of dates.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the same custom application error approach as in the other System API invocations.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Extract the API invocation into a subflow to improve testability.</p>
</li>
<li>
<p><strong>Implement</strong> <strong>create-payment-for-bags:</strong> Fill in the missing implementation of create-payment-for-bags, assuming a constant cost per bag, invoking PayPal SAPI, and raising the already present custom application error from a catch-all error handler:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/json
      var numBags = vars.checkIn.numBags
      var bagRate = 33.3
      ---
      {
        description: "Check-In of $(numBags) bags at USD $(bagRate) each.",
        amount:      bagRate*numBags
      }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>

  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"paypalSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"POST"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/payments"</span><span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue&gt;</span>
      <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:CANT_CREATE_PAYMENT"</span>  <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>DataWeave supports the direct reading of configuration properties, the values of which are always strings and therefore often need to be type-converted.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>DataWeave supports string interpolation, that is, the evaluation of expressions embedded in strings and subsequent substitution of these expressions with their values.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Add to <strong>properties.yaml</strong> a configuration property for the constant cost per bag.</p>
</li>
<li>
<p><strong>Homework:</strong> Extract the API invocation into a subflow to improve testability.</p>
</li>
<li>
<p><strong>Return correct response from check-in-by-pnr:</strong> Complete this first implementation of check-in-by-pnr by returning the expected response payload, replacing the current hard-coded payload:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management"</span>  <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-passenger-data"</span>  <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags"</span>  <span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/json
      var paypalReturn = payload
      ---
      {
        paymentID: paypalReturn.paymentID
      }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"..."</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This code relies on create-payment-for-bags being the last invoked Mule flow before the response payload is constructed.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The return payload from check-in-by-pnr becomes the HTTP response body.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run check-in-papi and invoke the check-in functionality as before; this should succeed and return a payment ID and the logs should confirm your understanding of the integration logic.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If the invocation of any downstream API fails, then the entire check-in process fails. This will be addressed in later walkthroughs.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite of check-in-papi; this should fail because some assumptions embedded in that test suite no longer hold:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study failed test:</strong> Inspect the log output of the test execution and compare it with the MUnit implementation of the happy-path test for check-in-by-pnr.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>This unit test performs API invocations, which is counter the nature of unit tests; these must be mocked.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>A test assertion fails because of a payload mismatch.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Disable failing tests:</strong> To <strong>main-test-suite.xml</strong>, ignore the happy-path test for check-in-by-pnr:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-happy-path-test"</span> <span style="color: #268bd2">ignore=</span><span style="color: #859900">"true"</span><span style="color: #b58900">&gt;</span>
...
<span style="color: #b58900">&lt;/munit:test&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite of check-in-papi; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Adapt the MUnit test suite to changes in invoked APIs.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_handle_all_errors_raised_while_processing_an_incoming_http_request"><a class="anchor" href="#_handle_all_errors_raised_while_processing_an_incoming_http_request"></a><a class="link" href="#_handle_all_errors_raised_while_processing_an_incoming_http_request">Handle all errors raised while processing an incoming HTTP request</a></h4>
<div class="paragraph">
<p>In this section, you ensure that no HTTP error raised during the processing of an HTTP request accepted by an &lt;http:listener /&gt; goes unhandled, thereby fixing a potential issue observed previously in that an uncontrolled HTTP response may be sent back to the HTTP client if an error is not handled. This is a potential security leak.</p>
</div>
<div class="paragraph">
<p>This activity is directly related to how &lt;http:listener /&gt; and APIkit deal with errors during the processing of incoming HTTP requests. &lt;http:request /&gt; are a fertile source of errors, and so the issue addressed here is so prevalent as to be unavoidable whenever HTTP requests are being made.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="28">
<li>
<p><strong>Trace errors raised by &lt;http:request /&gt;:</strong> Inspecting all relevant source code, trace any error raised by the &lt;http:request /&gt; used to invoke the Flights Management SAPI back to the &lt;http:listener /&gt; that is responsible for sending the HTTP response back to the HTTP client.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>When an error is propagated by the top-level Mule flow in api.xml that handles the HTTP request, it reaches APIkit, which in turn propagates the error. The error is then processed by api-error-handler, the error handler of api-main.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The last opportunity for handling any such error is therefore in api-error-handler, which is defined in apps-commons.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add catch-all error handler:</strong> In <strong>apps-commons</strong>, add a catch-all on-error-propagate error handler to <strong>api-error-handler</strong> defined in error-common.xml:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">error-common.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;error-handler</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"api-error-handler"</span><span style="color: #b58900">&gt;</span>
...
  <span style="color: #b58900">&lt;on-error-propagate&gt;</span>
    <span style="color: #b58900">&lt;ee:transform&gt;</span>
      <span style="color: #b58900">&lt;ee:message&gt;</span>
        <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
        output application/json
        ---
        {message: "Internal server error"}]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
      <span style="color: #b58900">&lt;/ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:variables&gt;</span>
        <span style="color: #b58900">&lt;ee:set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"httpStatus"</span><span style="color: #b58900">&gt;</span>500<span style="color: #b58900">&lt;/ee:set-variable&gt;</span>
      <span style="color: #b58900">&lt;/ee:variables&gt;</span>
    <span style="color: #b58900">&lt;/ee:transform&gt;</span>
  <span style="color: #b58900">&lt;/on-error-propagate&gt;</span>
<span style="color: #b58900">&lt;/error-handler&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is an on-error-propagate error handler written in the chosen style to follow the example set by the other error handlers in api-error-handler.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of apps-commons, installing the JAR into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Refresh Studio project:</strong> Close and reopen the Studio project for <strong>check-in-papi</strong>, to force Studio to reload the new build of apps-commons.</p>
<div class="paragraph">
<p><em>Note:</em> <em>Inspect the contents of the apps-commons project library in check-in-papi to confirm that the new version was loaded.</em></p>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Prove that the implemented changes result in an HTTP error response being returned if any otherwise unhandled error is raised, for example by forcing a timeout error.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-214"><a class="anchor" href="#wt-begin-214"></a><a class="link" href="#wt-begin-214">Walkthrough 1-4: Enable an API client for OAuth 2.0</a></h3>
<div class="paragraph">
<p>PayPal uses OAuth 2.0 to protect its API endpoints, and paypal-sapi must therefore be an OAuth 2.0 client.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you add OAuth 2.0 client capabilities to paypal-sapi on top of an otherwise complete implementation of API client functionality based on the HTTP Connector.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_set_up_the_starter_code_for_paypal_sapi">Set up the starter code for paypal-sapi</a>.</p>
</li>
<li>
<p><a href="#_investigate_successful_and_unsuccessful_oauth_2_0_authentication">Investigate OAuth 2.0 authentication against PayPal</a>.</p>
</li>
<li>
<p><a href="#_add_oauth_2_0_authentication_to_an_api_client_using_the_http_connector">Enable paypal-sapi for OAuth 2.0 against PayPal</a>.</p>
</li>
<li>
<p><a href="#_log_and_confirm_oauth_2_0_interactions">Log and confirm OAuth 2.0 interactions</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_3"><a class="anchor" href="#_solution_file_3"></a><a class="link" href="#_solution_file_3">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_2"><a class="anchor" href="#_starting_file_2"></a><a class="link" href="#_starting_file_2">Starting file</a></h4>
<div class="paragraph">
<p>To follow this walkthrough, you need the starter project at $APDL2DIST/walkthroughs/devint/module01/wt1-4_starter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_set_up_the_starter_code_for_paypal_sapi"><a class="anchor" href="#_set_up_the_starter_code_for_paypal_sapi"></a><a class="link" href="#_set_up_the_starter_code_for_paypal_sapi">Set up the starter code for paypal-sapi</a></h4>
<div class="paragraph">
<p>In this section, you copy a basically functional starter implementation of paypal-sapi into your workspace and adapt it to build and run locally. To achieve this, you must once again disable autodiscovery.</p>
</div>
<div class="paragraph">
<p>The imported starter code for paypal-sapi lacks the required OAuth 2.0 authentication against PayPal, which is why it is not fully functional. You close this feature gap shortly.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the <a href="#section-aa-solution-arch">Solution architecture</a> and in particular the <a href="#aa-us1-realization">design of US1: mobile Check-In</a> and <a href="#pp-payments">PayPal payments</a>; note the interaction of PayPal SAPI with PayPal and the usage of OAuth 2.0 in this interaction.</p>
</li>
<li>
<p><strong>Copy paypal-sapi starter:</strong> Copy the paypal-sapi starter project at <strong>$APDL2DIST/walkthroughs/devint/module01/wt1-4_starter/paypal-sapi</strong> into your Studio workspace directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module01/wt1-4_starter/paypal-sapi ./</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Maven build:</strong> Familiarize yourself briefly with the Maven build configuration of paypal-sapi.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The PayPal SAPI API specification is loaded as a Maven dependency with artifact ID paypal-sapi in the form of a RAML definition from the AnyAirline Exchange Maven repo, which requires authentication entries in settings.xml, created in a previous walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The paypal-sapi Mule app is assigned to the System layer in Visualizer.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As usual, reusable Maven plugin configuration is inherited from the parent POM and Maven dependency management from the BOM. Both parent-pom/pom.xml and bom/pom.xml are read from the Studio workspace directory.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update groupId:</strong> Update pom.xml adapting the Maven coordinates to match the groupId of your Anypoint Platform organization ID for the project and the parent:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
 <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    ...
  <span style="color: #b58900">&lt;/parent&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of paypal-sapi including all MUnit tests, providing the required secure properties encryption key; this should succeed and all unit tests should pass:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/paypal-sapi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> In Studio, import paypal-sapi without copying it to the workspace, because it is already there; confirm that the import succeeded.</p>
</li>
<li>
<p><strong>Add temporary env property:</strong> In Studio, near the top of <strong>global.xml</strong>, define a property <strong>encrypt.key</strong> to default the property required by the Studio tooling instance:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;global-property</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"encrypt.key"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"secure12345"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The encrypt.key property should not be defaulted and should be removed. This is a temporary solution to provide the runtime property to the Studio tooling instance, required to utilize DataSense metadata support.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add run config disabling autodiscovery:</strong> Add a Studio run configuration (via the <strong>Run as &gt; Mule application (configure)</strong> dialog) for paypal-sapi that sets <strong>encrypt.key</strong> and disables autodiscovery:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345
<span style="color: #b58900">-M-Danypoint</span>.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The API ID values configured in the properties files of paypal-sapi for the various environments stem from the AnyAirline Anypoint Platform organization, to which you have not been given access; disabling autodiscovery works around this restriction by preventing the uplink to API Manager without requiring a code change (such as removing the autodiscovery configuration).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run paypal-sapi and invoke the exposed PayPal SAPI and health check endpoints; the health checks should succeed but invoking PayPal SAPI should fail externally with a 500 error and internally with a 4xx error when invoking PayPal, because PayPal requires API clients to authenticate with OAuth 2.0, which this version of paypal-sapi does not yet do:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> POST <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">amount</span><span style="color: #d33682">\"</span><span style="color: #859900">: 12.34, </span><span style="color: #d33682">\"</span><span style="color: #859900">description</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">something</span><span style="color: #d33682">\"</span><span style="color: #859900">}"</span> https://localhost:8081/api/v1/payments</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">}"</span> https://localhost:8081/api/v1/payments/PAY-1B56960729604235TKQQIYVY/approval</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because this API implementation uses self-signed certificates, you must explicitly allow them when invoking these HTTPS endpoints.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study paypal-sapi:</strong> Inspect paypal-sapi so that you can explain the HTTP requests just performed, the HTTP responses received, and the MUnit tests executed in the previous Maven build.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_investigate_successful_and_unsuccessful_oauth_2_0_authentication"><a class="anchor" href="#_investigate_successful_and_unsuccessful_oauth_2_0_authentication"></a><a class="link" href="#_investigate_successful_and_unsuccessful_oauth_2_0_authentication">Investigate successful and unsuccessful OAuth 2.0 authentication</a></h4>
<div class="paragraph">
<p>In this section, you investigate how the API invocations of paypal-sapi to PayPal currently fail because the former does not honor the OAuth 2.0 authentication constraint enforced by the latter. You discover that PayPal uses the client credentials grant type for these invocations. You perform the required API invocations manually, such as from a command-line interface.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><strong>Check log:</strong> In the paypal-sapi logs from the previous API invocations, locate evidence of a PayPal invocation, and the failure thereof; you should see that the invocation of PayPal failed with an HTTP 401 Unauthorized response status.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If you see timeout errors instead, then either try again or increase the PayPal response timeout in dev-properties.yaml.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The PayPal endpoint invoked by paypal-sapi in the dev environment is that of a fake PayPal API implementation, at <a href="https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io" class="bare">https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io</a>.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Get PayPal access token:</strong> In the PayPal developer documentation for v1 of the PayPal REST API at <a href="https://developer.paypal.com/reference/get-an-access-token/" class="bare">https://developer.paypal.com/reference/get-an-access-token/</a> find the HTTP request details for getting an access token from PayPal via any of the documented methods (cURL or <a href="https://www.getpostman.com/">Postman</a>), and perform such an API invocation against the PayPal endpoint used by paypal-sapi; this should return a token response similar to that shown in the PayPal developer documentation:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-i</span> <span style="color: #b58900">-X</span> POST  <span style="color: #b58900">-H</span> <span style="color: #859900">"Accept: application/json"</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Accept-Language: en_US"</span> <span style="color: #b58900">-u</span> <span style="color: #859900">"APP-80ANYAIRLINE8184JT3:1929FHDUAL8392K9ABKSNMM"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"grant_type=client_credentials"</span> https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io/v1/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Authentication of the token request is with client ID and secret known to be acceptable to this fake PayPal implementation.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This results in an HTTP POST request with content type application/x-www-form-urlencoded.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is the first step of OAuth 2.0 authentication with the client credentials grant type.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The current implementation of paypal-sapi does not perform this step.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract access token</strong> From the PayPal HTTP response body, extract the value of the access token, either through copying and pasting or tool support:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">atoken</span><span style="color: #93a1a1">=</span><span style="color: #d33682">$(</span>curl <span style="color: #b58900">-X</span> POST <span style="color: #b58900">-H</span> <span style="color: #859900">"Accept: application/json"</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Accept-Language: en_US"</span> <span style="color: #b58900">-u</span> <span style="color: #859900">"APP-80ANYAIRLINE8184JT3:1929FHDUAL8392K9ABKSNMM"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"grant_type=client_credentials"</span> https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io/v1/oauth2/token | jq <span style="color: #b58900">-r</span> <span style="color: #859900">'.access_token'</span><span style="color: #d33682">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This cURL command is configured to only return the HTTP response body, otherwise parsing the output as JSON fails.</em></p>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-X</span> POST <span style="color: #b58900">-H</span> <span style="color: #859900">"Accept: application/json"</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Accept-Language: en_US"</span> <span style="color: #b58900">-u</span> <span style="color: #859900">"APP-80ANYAIRLINE8184JT3:1929FHDUAL8392K9ABKSNMM"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"grant_type=client_credentials"</span> https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io/v1/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must manually copy and paste the access token if not using tooling such as jq.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create PayPal payment:</strong> In the PayPal developer documentation for v1 of the PayPal REST API at <a href="https://developer.paypal.com/docs/api/payments/v1/#payment_create" class="bare">https://developer.paypal.com/docs/api/payments/v1/#payment_create</a>, find the HTTP request details for creating a PayPal payment via any of the documented methods (cURL or <a href="https://www.getpostman.com/">Postman</a>), and perform such an API invocation against the PayPal endpoint used by paypal-sapi, passing the previously extracted access token as a <strong>bearer token</strong>; this should successfully return a JSON payment creation response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-i</span> <span style="color: #b58900">-X</span> POST <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Authorization: Bearer </span><span style="color: #586e75">$atoken</span><span style="color: #859900">"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">intent</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">sale</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">payer</span><span style="color: #d33682">\"</span><span style="color: #859900">:{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payment_method</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">paypal</span><span style="color: #d33682">\"</span><span style="color: #859900"> }, </span><span style="color: #d33682">\"</span><span style="color: #859900">transactions</span><span style="color: #d33682">\"</span><span style="color: #859900">:[ { </span><span style="color: #d33682">\"</span><span style="color: #859900">amount</span><span style="color: #d33682">\"</span><span style="color: #859900">:{ </span><span style="color: #d33682">\"</span><span style="color: #859900">total</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">80.00</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">currency</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">USD</span><span style="color: #d33682">\"</span><span style="color: #859900"> }, </span><span style="color: #d33682">\"</span><span style="color: #859900">description</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">Check-In Baggage.</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">custom</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">ANYAIRLINE_90048630024435</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">invoice_number</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">48787589673</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">payment_options</span><span style="color: #d33682">\"</span><span style="color: #859900">:{ </span><span style="color: #d33682">\"</span><span style="color: #859900">allowed_payment_method</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">INSTANT_FUNDING_SOURCE</span><span style="color: #d33682">\"</span><span style="color: #859900"> }, </span><span style="color: #d33682">\"</span><span style="color: #859900">soft_descriptor</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">ANYAIRLINE BAGGAGE</span><span style="color: #d33682">\"</span><span style="color: #859900"> } ], </span><span style="color: #d33682">\"</span><span style="color: #859900">note_to_payer</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Be happy.</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io/v1/payments/payment</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">SET <span style="color: #586e75">atoken</span><span style="color: #93a1a1">=</span><span style="color: #859900">"VALUE RETURNED FROM PREVIOUS CURL REQUEST IF NOT USING JQ"</span>
curl <span style="color: #b58900">-i</span> <span style="color: #b58900">-X</span> POST <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Authorization: Bearer %atoken%"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">intent</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">sale</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">payer</span><span style="color: #d33682">\"</span><span style="color: #859900">:{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payment_method</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">paypal</span><span style="color: #d33682">\"</span><span style="color: #859900"> }, </span><span style="color: #d33682">\"</span><span style="color: #859900">transactions</span><span style="color: #d33682">\"</span><span style="color: #859900">:[ { </span><span style="color: #d33682">\"</span><span style="color: #859900">amount</span><span style="color: #d33682">\"</span><span style="color: #859900">:{ </span><span style="color: #d33682">\"</span><span style="color: #859900">total</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">80.00</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">currency</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">USD</span><span style="color: #d33682">\"</span><span style="color: #859900"> }, </span><span style="color: #d33682">\"</span><span style="color: #859900">description</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">Check-In Baggage.</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">custom</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">ANYAIRLINE_90048630024435</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">invoice_number</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">48787589673</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">payment_options</span><span style="color: #d33682">\"</span><span style="color: #859900">:{ </span><span style="color: #d33682">\"</span><span style="color: #859900">allowed_payment_method</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">INSTANT_FUNDING_SOURCE</span><span style="color: #d33682">\"</span><span style="color: #859900"> }, </span><span style="color: #d33682">\"</span><span style="color: #859900">soft_descriptor</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">ANYAIRLINE BAGGAGE</span><span style="color: #d33682">\"</span><span style="color: #859900"> } ], </span><span style="color: #d33682">\"</span><span style="color: #859900">note_to_payer</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Be happy.</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io/v1/payments/payment</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can copy the sample request from <a href="https://developer.paypal.com/docs/api/payments/v1/#payment_create" class="bare">https://developer.paypal.com/docs/api/payments/v1/#payment_create</a> but first you need to paste it into a text editor so that you can edit the URL and token.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This API invocation is to the now deprecated v1 of the PayPal API, which is implemented by the endpoints used here.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is the second step when invoking an API protected by OAuth 2.0 with the client credentials grant type.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The current implementation of paypal-sapi performs this step but does not pass an access token and therefore receives a HTTP 4xx error response.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Compare to OAuth 2.0 spec:</strong> Compare the above interactions to the client credentials section in the OAuth 2.0 specification at <a href="https://tools.ietf.org/html/rfc6749" class="bare">https://tools.ietf.org/html/rfc6749</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_add_oauth_2_0_authentication_to_an_api_client_using_the_http_connector"><a class="anchor" href="#_add_oauth_2_0_authentication_to_an_api_client_using_the_http_connector"></a><a class="link" href="#_add_oauth_2_0_authentication_to_an_api_client_using_the_http_connector">Add OAuth 2.0 authentication to an API client using the HTTP Connector</a></h4>
<div class="paragraph">
<p>In this section, you add OAuth 2.0 client support through the OAuth module to paypal-sapi. Because this module must store tokens retrieved from the downstream OAuth 2.0-protected API, it is a stateful component. To store state, the OAuth module requires an Object Store, and you therefore also add the Object Store Connector.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p><strong>Confirm Maven dependency management:</strong> In <strong>bom/pom.xml</strong>, locate the existing dependency management entries for the <strong>OAuth module</strong> and the <strong>Object Store Connector</strong>.</p>
</li>
<li>
<p><strong>Add Maven dependencies:</strong> Add the corresponding Maven dependencies to the <strong>POM</strong> of paypal-sapi; confirm that Studio loads both modules:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of paypal-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-objectstore-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-oauth-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; elements so that the versions managed in the BOM take effect.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add OAuth 2.0 and Object Store config:</strong> To the existing HTTP Request configuration in <strong>global.xml</strong> add authentication via the <strong>client credentials</strong> grant type, configuring an inline token manager referencing a new Object Store with suitable sizing and expiration settings:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of paypal-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request-config</span>
  <span style="color: #268bd2">name=</span><span style="color: #859900">"paypalServerHttpRequestConfig"</span>
  <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span>
  <span style="color: #268bd2">responseTimeout=</span><span style="color: #859900">"${paypal.responseTimeoutMillis}"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection&gt;</span>
    <span style="color: #b58900">&lt;http:authentication&gt;</span>
      <span style="color: #b58900">&lt;oauth:client-credentials-grant-type</span>
        <span style="color: #268bd2">clientId=</span><span style="color: #859900">"APP-80ANYAIRLINE8184JT3"</span>
        <span style="color: #268bd2">clientSecret=</span><span style="color: #859900">"1929FHDUAL8392K9ABKSNMM"</span>
        <span style="color: #268bd2">tokenUrl=</span><span style="color: #859900">"https://training-paypal-fake-api-sandbox-mjf1rw.5sc6y6-1.usa-e2.cloudhub.io/v1/oauth2/token"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;oauth:token-manager</span> <span style="color: #268bd2">objectStore=</span><span style="color: #859900">"tokenStore"</span> <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/oauth:client-credentials-grant-type&gt;</span>
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span>

<span style="color: #b58900">&lt;os:object-store</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"tokenStore"</span>
  <span style="color: #268bd2">maxEntries=</span><span style="color: #859900">"1000"</span>
  <span style="color: #268bd2">entryTtl=</span><span style="color: #859900">"60"</span> <span style="color: #268bd2">entryTtlUnit=</span><span style="color: #859900">"MINUTES"</span>
  <span style="color: #268bd2">expirationInterval=</span><span style="color: #859900">"30"</span> <span style="color: #268bd2">expirationIntervalUnit=</span><span style="color: #859900">"MINUTES"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The values for client ID and secret and the token URL are the same as in the previous manual token request.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The default expressions for extracting the access token and expiration duration from the HTTP response to the retrieve token request match the response you have seen previously being returned from PayPal.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The token Object Store is persistent by default, and this is also required here so that tokens are shared between multiple workers in a replicated CloudHub deployment.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You limit the number of tokens that may be stored in the token Object Store to protect against attacks. This number can be small as all tokens authenticate paypal-sapi against PayPal (there is no user authentication in the client credentials grant type).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You also limit the lifetime (TTL) of each token and explicitly specify at what interval this will be enforced. This client-side expiration is layered on top of the server-side expiration of tokens performed by PayPal.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run paypal-sapi and invoke the exposed PayPal SAPI as before; this should now succeed, proving that paypal-sapi now interacts via OAuth 2.0 with PayPal:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> POST <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">amount</span><span style="color: #d33682">\"</span><span style="color: #859900">: 12.34, </span><span style="color: #d33682">\"</span><span style="color: #859900">description</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">something</span><span style="color: #d33682">\"</span><span style="color: #859900">}"</span> https://localhost:8081/api/v1/payments</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">}"</span> https://localhost:8081/api/v1/payments/PAY-1B56960729604235TKQQIYVY/approval</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The only change needed to make paypal-sapi perform the OAuth 2.0 dance was to add appropriate configuration to the HTTP Request configuration  the individual &lt;http:request /&gt; usages remained untouched.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Extract config props:</strong> Extract all hard-coded configuration values, for all supported environments, into appropriate configuration properties  environment-dependent and/or environment-independent, encrypted and/or cleartext, as appropriate.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of paypal-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request-config</span>
  <span style="color: #268bd2">name=</span><span style="color: #859900">"paypalServerHttpRequestConfig"</span>
  <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span>
  <span style="color: #268bd2">responseTimeout=</span><span style="color: #859900">"${paypal.responseTimeoutMillis}"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection&gt;</span>
    <span style="color: #b58900">&lt;http:authentication&gt;</span>
      <span style="color: #b58900">&lt;oauth:client-credentials-grant-type</span>
        <span style="color: #268bd2">clientId=</span><span style="color: #859900">"${secure::app.client_id}"</span>
        <span style="color: #268bd2">clientSecret=</span><span style="color: #859900">"${secure::app.client_secret}"</span>
        <span style="color: #268bd2">tokenUrl=</span><span style="color: #859900">"${paypal.tokenUrl}"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;oauth:token-manager</span> <span style="color: #268bd2">objectStore=</span><span style="color: #859900">"tokenStore"</span> <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/oauth:client-credentials-grant-type&gt;</span>
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span>

<span style="color: #b58900">&lt;os:object-store</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"tokenStore"</span>
  <span style="color: #268bd2">maxEntries=</span><span style="color: #859900">"${paypal.tokenStore.maxEntries}"</span>
  <span style="color: #268bd2">entryTtl=</span><span style="color: #859900">"${paypal.tokenStore.entryTtlMins}"</span>
  <span style="color: #268bd2">entryTtlUnit=</span><span style="color: #859900">"MINUTES"</span>
  <span style="color: #268bd2">expirationInterval=</span><span style="color: #859900">"${paypal.tokenStore.expirationIntervalMins}"</span>
  <span style="color: #268bd2">expirationIntervalUnit=</span><span style="color: #859900">"MINUTES"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can use the same approach as in a previous walkthrough of associating just one pair of client ID and secret with the Mule app for invoking backend systems  PayPal, in this case. This works fine for a System API such as paypal-sapi, because it typically invokes only one backend system. It also works fine for a Process API such as check-in-papi, because when the System APIs it invokes are all managed by Anypoint Platform then the same client ID and secret pair is used for all these invocations (as was shown in a previous walkthrough).</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_log_and_confirm_oauth_2_0_interactions"><a class="anchor" href="#_log_and_confirm_oauth_2_0_interactions"></a><a class="link" href="#_log_and_confirm_oauth_2_0_interactions">Log and confirm OAuth 2.0 interactions</a></h4>
<div class="paragraph">
<p>In this section, you turn on logging of all HTTP traffic and confirm that the HTTP requests performed by the OAuth module are equivalent to those you have previously performed manually, just as required by the client credentials OAuth 2.0 grant type.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="21">
<li>
<p><strong>Check log:</strong> In the log output shown in Studio for the previous invocation of PayPal SAPI, try to trace OAuth 2.0-related interactions with PayPal; they are currently not logged directly.</p>
</li>
<li>
<p><strong>Log HTTP traffic:</strong> In <strong>log4j2.xml</strong>, turn-on logging of HTTP traffic by setting the log level of the appropriate logger to <strong>DEBUG</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">log4j2.xml of paypal-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;Loggers&gt;</span>
  <span style="color: #b58900">&lt;AsyncLogger</span>
  	<span style="color: #268bd2">name=</span><span style="color: #859900">"org.mule.service.http.impl.service.HttpMessageLogger"</span>
  	<span style="color: #268bd2">level=</span><span style="color: #859900">"DEBUG"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/Loggers&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As always, this Log4J configuration applies to all environments, including prod, but not to unit tests.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Restart paypal-sapi, invoke PayPal SAPI again, in the log find OAuth 2.0-related log entries, and confirm that this traffic fits the client credentials grant type and the manual HTTP requests you have performed previously.</p>
<div class="paragraph">
<p><em>Note:</em> <em>The token retrieved by the OAuth module is the same that the module later sends in the Authorization HTTP request header.</em></p>
</div>
</li>
<li>
<p><strong>Confirm token re-use:</strong> Perform a second invocation to confirm that the OAuth module reuses a previously retrieved token.</p>
</li>
<li>
<p><strong>Homework:</strong> <strong>Test token expiration:</strong> Await the server-side and client-side token expiration timeouts and confirm that the OAuth module handles these cases correctly.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-215"><a class="anchor" href="#wt-begin-215"></a><a class="link" href="#wt-begin-215">Walkthrough 1-5: Invoke a SOAP web service using mutual TLS authentication</a></h3>
<div class="paragraph">
<p>The Flights Management system exposes a SOAP web service over an HTTPS endpoint that is protected by mutual TLS authentication (mTLS). The flights-management-sapi Mule app must implement Flights Management SAPI by invoking this SOAP web service.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you start with a skeleton of flights-management-sapi that does not interact with the Flights Management system at all, and add invocations of the Flights Management system SOAP web service that address both the functional and nonfunctional aspects of this interaction, including, but not limited to, the presentation of a client certificate to pass mutual TLS authentication.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_setup_the_starter_code_for_flights_management_sapi">Setup the starter code for flights-management-sapi</a>.</p>
</li>
<li>
<p><a href="#_configure_web_service_consumer_connector_to_access_a_soap_web_service">Configure Web Service Consumer Connector to access the Flights Management system SOAP web service</a>.</p>
</li>
<li>
<p><a href="#_send_a_client_certificate_to_pass_mutual_tls_authentication">Send a client certificate to pass mutual TLS authentication</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_4"><a class="anchor" href="#_solution_file_4"></a><a class="link" href="#_solution_file_4">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-5_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_3"><a class="anchor" href="#_starting_file_3"></a><a class="link" href="#_starting_file_3">Starting file</a></h4>
<div class="paragraph">
<p>To follow this walkthrough, you need the starter project at $APDL2DIST/walkthroughs/devint/module01/wt1-5_starter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setup_the_starter_code_for_flights_management_sapi"><a class="anchor" href="#_setup_the_starter_code_for_flights_management_sapi"></a><a class="link" href="#_setup_the_starter_code_for_flights_management_sapi">Setup the starter code for flights-management-sapi</a></h4>
<div class="paragraph">
<p>In this section, you copy a minimal starter implementation of flights-management-sapi into your workspace and adapt it to build and run locally. To achieve this, you must disable autodiscovery, as done previously.</p>
</div>
<div class="paragraph">
<p>The imported starter code for flights-management-sapi exposes Flights Management SAPI over HTTPS but lacks all interaction with the Flights Management system. You implement this shortly.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the <a href="#section-aa-solution-arch">Solution architecture</a> and in particular the <a href="#aa-us1-realization">design of US1: mobile Check-In</a>; note the interaction of Flights Management SAPI with the Flights Management system and the usage of mTLS in this interaction.</p>
</li>
<li>
<p><strong>Copy flights-management-sapi starter:</strong> Copy the flights-management-sapi starter project at <strong>$APDL2DIST/walkthroughs/devint/module01/wt1-5_starter/flights-management-sapi</strong> into your Studio workspace directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module01/wt1-5_starter/flights-management-sapi ./</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Maven build:</strong> Familiarize yourself briefly with the Maven build configuration of flights-management-sapi.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The Flights Management SAPI API specification is loaded in the form of a RAML definition from the AnyAirline Exchange Maven repository, which requires an authentication entry in settings.xml, which you have created in a previous walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Flights Management SAPI API specification imports and hence depends on RAML fragments.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The flights-management-sapi Mule app is assigned to the System layer in Visualizer.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As always, reusable Maven plugin configuration is done in a parent POM and Maven dependency management in a BOM. Both parent POM and BOM are read from the parent directory of flights-management-sapi.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update groupId:</strong> Update pom.xml adapting the Maven coordinates to match the groupId of your Anypoint Platform organization ID for the project and the parent:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;project&gt;</span>
 <span style="color: #b58900">&lt;parent&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
    ...
  <span style="color: #b58900">&lt;/parent&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  ...
<span style="color: #b58900">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run a full Maven build of flights-management-sapi including all unit tests using the same secure properties encryption key used in previous walkthroughs:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/flights-management-sapi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> In Studio, import flights-management-sapi without copying it to the workspace, because it is already there; confirm that the import succeeded.</p>
</li>
<li>
<p><strong>Add temporary env property:</strong> In Studio, near the top of <strong>global.xml</strong>, define a property <strong>encrypt.key</strong> to default the property required by the Studio tooling instance:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;global-property</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"encrypt.key"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"secure12345"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The encrypt.key property should not be defaulted and should be removed. This is a temporary solution to provide the runtime property to the Studio tooling instance, required to utilize DataSense metadata support.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add run config disabling autodiscovery:</strong> Add a Studio run configuration (via the <strong>Run as &gt; Mule application (configure)</strong> dialog) for flights-management-sapi that sets <strong>encrypt.key</strong> and disables autodiscovery:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345
<span style="color: #b58900">-M-Danypoint</span>.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The API ID configured in the environment-dependent properties files of flights-management-sapi stems from the AnyAirline Anypoint Platform organization, to which you have not been given access; disabling autodiscovery works around this restriction by preventing the uplink to API Manager without requiring a code change (such as removing the autodiscovery configuration).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run flights-management-sapi and invoke the exposed Flights Management SAPI; this should succeed, returning hard-coded HTTP responses:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/api/v1/tickets/PNR123</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study flights-management-sapi:</strong> Inspect flights-management-sapi so that you can explain the HTTP requests just performed and the HTTP responses received, including the health check endpoints in your investigation.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configure_web_service_consumer_connector_to_access_a_soap_web_service"><a class="anchor" href="#_configure_web_service_consumer_connector_to_access_a_soap_web_service"></a><a class="link" href="#_configure_web_service_consumer_connector_to_access_a_soap_web_service">Configure Web Service Consumer Connector to access a SOAP web service</a></h4>
<div class="paragraph">
<p>In this section, you enable flights-management-sapi to invoke the SOAP web service exposed by the Flights Management system. This SOAP web service is exposed over HTTPS and enforces mTLS. To ease development of API clients, however, the deployments of Flights Management system in the dev and test environments expose additional HTTPS endpoints that do not require mTLS. You first invoke the non-mTLS dev endpoint of Flights Management system, before adding mTLS support later.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><strong>Get WSDL:</strong> Retrieve the WSDL of the <strong>Flights Management system SOAP web service</strong> in the <strong>dev</strong> environment:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://tngaa-flights-management-devx-9yj2rh.d5n5q8.usa-e1.cloudhub.io/api/v1/FlightsManagementService?wsdl</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This sends a HTTP GET request to a public endpoint of the Mule app that uses the default TLS context of a CloudHub 2.0 Private Space without mTLS configured.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Confirm Maven dependency management:</strong> In <strong>bom/pom.xml</strong>, locate the existing dependency management entries for the <strong>Web Service Consumer Connector</strong>, which has artifact ID <strong>mule-wsc-connector</strong>.</p>
</li>
<li>
<p><strong>Add Maven dependency:</strong> Add the corresponding Maven dependency for the Web Service Consumer Connector to the POM of flights-management-sapi; confirm that Studio loads the module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-wsc-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; element so that the version managed in the BOM takes effect.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Config Web Service Consumer Connector:</strong> In <strong>global.xml</strong>, add configuration for the Web Service Consumer Connector, using information from the WSDL retrieved previously: configure a bespoke HTTP transport configuration pointing to a new HTTP Request configuration that requires HTTPS and in turn points to a new global TLS context configuration:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;wsc:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsWSCConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;wsc:connection</span>
    <span style="color: #268bd2">wsdlLocation=</span><span style="color: #859900">"https://tngaa-flights-management-devx-9yj2rh.d5n5q8.usa-e1.cloudhub.io/api/v1/FlightsManagementService?wsdl"</span>
    <span style="color: #268bd2">service=</span><span style="color: #859900">"FlightsManagementService"</span>
    <span style="color: #268bd2">port=</span><span style="color: #859900">"FlightsManagementPort"</span>
    <span style="color: #268bd2">address=</span><span style="color: #859900">"https://tngaa-flights-management-devx-9yj2rh.d5n5q8.usa-e1.cloudhub.io/api/v1/FlightsManagementService"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;/wsc:connection&gt;</span>
<span style="color: #b58900">&lt;/wsc:config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As per typical SOAP conventions, the WSDL location (URL) is simply derived from the endpoint address (URL).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Call SOAP web service:</strong> In <strong>main.xml</strong>, in the <strong>check-in-by-pnr</strong> flow, replace the placeholder with the actual SOAP call, that is, consume the Flights Management system SOAP web service, transforming the data to the SOAP request body inline:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flights-wsc-check-in"</span> <span style="color: #b58900">/&gt;</span>
    ...
  <span style="color: #b58900">&lt;/try&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flights-wsc-check-in"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;wsc:consume</span> <span style="color: #268bd2">operation=</span><span style="color: #859900">"checkIn"</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"flightsWSCConfig"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;wsc:message&gt;</span>
        <span style="color: #b58900">&lt;wsc:body&gt;</span><span style="color: #b58900">&lt;![CDATA[#[%dw 2.0
      output application/xml
      ns ns0 http://flightsMgmt.sword.com/
     ---
      {
        ns0#checkIn: {
          pnr:               vars.PNR,
          passengerLastName: payload.lastName,
          numOfBags:         payload.numBags
       }
      }]]]&gt;</span><span style="color: #b58900">&lt;/wsc:body&gt;</span>
      <span style="color: #b58900">&lt;/wsc:message&gt;</span>
  <span style="color: #b58900">&lt;/wsc:consume&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This syntax assumes that the message payload contains the SOAP request body.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must specify the correct XML namespace in DataWeave to construct an XML document that obeys the SOAP web service contract expressed in the WSDL.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is only the SOAP request body, which will be wrapped into a SOAP envelope by the Web Service Consumer Connector.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If Studio fails to load the WSDL at design time, then it can&#8217;t assist you in designing this transformation.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Log HTTP traffic:</strong> In <strong>log4j2.xml</strong>, turn on logging of HTTP traffic.</p>
</li>
<li>
<p><strong>Run and invoke:</strong> Run flights-management-sapi and invoke the check-in functionality of the exposed Flights Management SAPI; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Check log:</strong> Scan the log output for all SOAP-related traffic.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The Web Service Consumer Connector retrieves the WSDL before invoking the SOAP operation for the first time.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>SOAP invocations are by definition HTTP POST requests.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The SOAP request body is a faithful XML rendering of the output of the above DataWeave transform expression.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The SOAP response is essentially a boolean wrapped into a SOAP body wrapped into a SOAP envelope.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Unwrap SOAP response and return:</strong> In <strong>main.xml</strong>, in the <strong>check-in-by-pnr</strong>, set the payload to the boolean contained in the SOAP response body, replacing the existing setting of the payload to a hard-coded JSON response, so that this flow returns the boolean returned by the SOAP call:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;set-payload</span>
    <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/java --- payload.body.checkInResponse.return as Boolean]"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This encapsulates the handling of SOAP messages in main.xml.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If desired, XML namespaces can be ignored when reading an XML document in DataWeave.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Return API responses:</strong> In <strong>api.xml</strong>, handle the boolean returned from the check-in-by-pnr flow by creating a suitable HTTP response, either a success response as previously created in main.xml, or a new error response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">api.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"put:\tickets\(PNR)\checkin:application\json:apiConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"PNR"</span>
    <span style="color: #268bd2">value=</span><span style="color: #859900">"#[attributes.uriParams.PNR]"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;choice&gt;</span>
    <span style="color: #b58900">&lt;when</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[payload]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;set-payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {message: 'Passenger check-in successful.'}]"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/when&gt;</span>
    <span style="color: #b58900">&lt;otherwise&gt;</span>
      <span style="color: #b58900">&lt;set-payload</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {message: 'Invalid passenger name record given.'}]"</span> <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"httpStatus"</span>
        <span style="color: #268bd2">value=</span><span style="color: #859900">"400"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/otherwise&gt;</span>
  <span style="color: #b58900">&lt;/choice&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This encapsulates the construction of API responses in api.xml.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run flights-management-sapi and invoke the check-in functionality again; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite of Flights Management SAPI.</p>
</li>
<li>
<p><strong>Homework:</strong> Implement the get-ticket-by-pnr flow including the invocation of the Flights Management system SOAP web service and the transformations to/from the SOAP payloads.</p>
</li>
<li>
<p><strong>Homework:</strong> Improve the nonfunctional properties of the SOAP web service invocations by setting a meaningfully short response timeout.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_send_a_client_certificate_to_pass_mutual_tls_authentication"><a class="anchor" href="#_send_a_client_certificate_to_pass_mutual_tls_authentication"></a><a class="link" href="#_send_a_client_certificate_to_pass_mutual_tls_authentication">Send a client certificate to pass mutual TLS authentication</a></h4>
<div class="paragraph">
<p>In this section, you configure a keystore to be used by the Web Service Consumer Connector through which flights-management-sapi invokes the Flights Management system SOAP web service. That keystore must contain a public/private keypair, of which the public key is sent to the HTTPS server (the Flights Management system). The HTTPS server, in turn, must be configured with that public key so that it can authenticate clients.</p>
</div>
<div class="paragraph">
<p>For the purposes of this walkthrough, the client&#8217;s public/private keypair has already been generated and packaged into a keystore, and the Flights Management system (or, more precisely, the CloudHub 2.0 Private Space hosting the Flights Management system) has already been configured to allow access from clients that send the public key from that keypair. What remains to be done in this section is the corresponding configuration of flights-management-sapi.</p>
</div>
<div class="paragraph">
<p>First you change flights-management-sapi to access a differnet public endpoint of the Flights Management system SOAP web service that requires mutual TLS authentication.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="25">
<li>
<p><strong>Change SOAP web service endpoint:</strong> In <strong>global.xml</strong>, change the SOAP web service endpoint being invoked, by changing both the address and the derived WSDL location in the Web Service Consumer Connector configuration:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;wsc:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsWSCConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;wsc:connection</span>
    <span style="color: #268bd2">wsdlLocation=</span><span style="color: #859900">"https://tngaa-flights-management-devx.nonprod-internalps.anyair.net/api/v1/FlightsManagementService?wsdl"</span>
    <span style="color: #268bd2">service=</span><span style="color: #859900">"FlightsManagementService"</span>
    <span style="color: #268bd2">port=</span><span style="color: #859900">"FlightsManagementPort"</span>
    <span style="color: #268bd2">address=</span><span style="color: #859900">"https://tngaa-flights-management-devx.nonprod-internalps.anyair.net/api/v1/FlightsManagementService"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;/wsc:connection&gt;</span>
<span style="color: #b58900">&lt;/wsc:config&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the check-in functionality of Flights Management SAPI; this should fail with a HTTP 500 error that was triggered internally by a HTTP 4xx error when calling the Flights Management system SOAP web service, because the HTTP client did not send the client-side certificate needed for mTLS.</p>
</li>
<li>
<p><strong>Locate client&#8217;s keystores:</strong> Inspect the PKCS12 keystores containing the public/private RSA keypairs to be used for clients to the Flights Management system, provided to you in <strong>src/main/resources/certs</strong>.</p>
</li>
<li>
<p><strong>Use keystore:</strong>  Add and configure a bespoke HTTP transport configuration pointing to a new HTTP Request configuration that requires HTTPS and in turn points to a new global TLS context configuration a keystore configuration referencing the client&#8217;s <strong>nonprod</strong> keystore, which will be used when the Web Service Consumer Connector connects over HTTPS to a SOAP web service:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;wsc:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsWSCConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;wsc:connection</span>
    <span style="color: #268bd2">wsdlLocation=</span><span style="color: #859900">"https://tngaa-flights-management-devx.nonprod-internalps.anyair.net/api/v1/FlightsManagementService?wsdl"</span>
    <span style="color: #268bd2">service=</span><span style="color: #859900">"FlightsManagementService"</span>
    <span style="color: #268bd2">port=</span><span style="color: #859900">"FlightsManagementPort"</span>
    <span style="color: #268bd2">address=</span><span style="color: #859900">"https://tngaa-flights-management-devx.nonprod-internalps.anyair.net/api/v1/FlightsManagementService"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;wsc:custom-transport-configuration&gt;</span>
      <span style="color: #b58900">&lt;wsc:http-transport-configuration</span>
        <span style="color: #268bd2">requesterConfig=</span><span style="color: #859900">"flightsWSHTTPConfig"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/wsc:custom-transport-configuration&gt;</span>
  <span style="color: #b58900">&lt;/wsc:connection&gt;</span>
<span style="color: #b58900">&lt;/wsc:config&gt;</span>

<span style="color: #b58900">&lt;http:request-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsWSHTTPConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection</span> <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span>
    <span style="color: #268bd2">tlsContext=</span><span style="color: #859900">"flightsWSTLSContext"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span>

<span style="color: #b58900">&lt;tls:context</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsWSTLSContext"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;tls:key-store</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"pkcs12"</span>
    <span style="color: #268bd2">path=</span><span style="color: #859900">"certs/clients-to-nonprod-internalps.p12"</span>
    <span style="color: #268bd2">password=</span><span style="color: #859900">"muleclient2021"</span>
    <span style="color: #268bd2">keyPassword=</span><span style="color: #859900">"muleclient2021"</span>
    <span style="color: #268bd2">alias=</span><span style="color: #859900">"client"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/tls:context&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Following PKCS12, both key and keystore share the same password. The alias was specified when creating the keystore.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This keystore and the keypair it contains were created using the Java keytool.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the check-in API; this should succeed, proving that mutual TLS authentication of HTTPS client and HTTPS server succeeded.</p>
</li>
<li>
<p><strong>Homework:</strong> <strong>Extract config props:</strong> Extract all hard-coded configuration values, for all supported environments, into appropriate configuration properties  environment-dependent and/or environment-independent, encrypted and/or cleartext, as appropriate.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-216"><a class="anchor" href="#wt-begin-216"></a><a class="link" href="#wt-begin-216">Walkthrough 1-6: Implement an HTTP callback</a></h3>
<div class="paragraph">
<p>The Flights Management system can notify its clients about flight cancellations by performing a HTTP POST request to a callback endpoint exposed by the API client  a so-called webhook.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you extend flights-management-sapi to expose such a webhook and register it with the Flights Management system. This requires you to think about network topology and different types of API clients.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_expose_an_http_callback">Expose an HTTP callback from flights-management-sapi</a>.</p>
</li>
<li>
<p><a href="#_register_the_http_callback_with_an_http_service">Register the HTTP callback with the Flights Management system</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_5"><a class="anchor" href="#_solution_file_5"></a><a class="link" href="#_solution_file_5">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-6_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_4"><a class="anchor" href="#_starting_file_4"></a><a class="link" href="#_starting_file_4">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-6_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_expose_an_http_callback"><a class="anchor" href="#_expose_an_http_callback"></a><a class="link" href="#_expose_an_http_callback">Expose an HTTP callback</a></h4>
<div class="paragraph">
<p>In this section, you expose an HTTP callback from flights-management-sapi that will be invoked by the Flights Management system when a flight has been cancelled.</p>
</div>
<div class="paragraph">
<p>Rather than defining a new HTTP Listener configuration for the callback endpoint, you reuse the HTTP Listener configuration through which the main API exposed by flights-management-sapi, namely Flights Management SAPI, is exposed.</p>
</div>
<div class="paragraph">
<p>This implies that flights-management-sapi listens on the same network interface and port for invocations from (upstream) clients to Flights Management SAPI as well as for callback invocations from the (downstream) Flights Management system.</p>
</div>
<div class="paragraph">
<p>These two types of API clients to flights-management-sapi are of a different nature, however, and so you decide that the callback shall not be defined in the API specification of Flights Management SAPI. This API specification defines the interface, which has business purpose, for upstream API clients, which are typically Process APIs such as check-in-papi. On the other hand, the HTTP callback is a technical detail of the interaction with the Flights Management system, and is mandated by the Flights Management system interface.</p>
</div>
<div class="paragraph">
<p>This distinction between API clients to flights-management-sapi also applies to versioning: The Check-In PAPI API specification is under the control of AnyAirline. When the version of that API specification changes, then flights-management-sapi has to implement that updated version when it is ready to do so. The HTTP callback, on the other hand, must be implemented by flights-management-sapi as required by the Flights Management system. When the Flights Management system changes its requirements for this callback, then flights-management-sapi has to change its implementation thereof immediately. Thus flights-management-sapi exposes two types of APIs, for two different audiences, with two different lifecycles, and with two different versioning approaches.</p>
</div>
<div class="paragraph">
<p>Because the HTTP callback is not defined by an API specification, flights-management-sapi does not use APIkit for its implementation.</p>
</div>
<div class="paragraph">
<p>Also, the HTTP callback endpoint does not use autodiscovery, is not under API Manager control and hence no API policies can be applied to the HTTP callback.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the <a href="#section-aa-solution-arch">Solution architecture</a> and in particular the <a href="#aa-us2-realization">design of US2: Flight Cancellation mobile Notifications</a>; note how flights-management-sapi registers a HTTP callback with the Flights Management system, and how the Flights Management system POSTs cancellation notifications to that callback.</p>
</li>
<li>
<p><strong>Expose and implement HTTP callback:</strong> In <strong>main.xml</strong> of <strong>flights-management-sapi</strong> add a flow exposing the HTTP callback, using the same HTTP Listener configuration used for exposing Flights Management SAPI, and assuming an appropriate configuration property for the path:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span>
    <span style="color: #268bd2">path=</span><span style="color: #859900">"/api/cancelFlight"</span>
    <span style="color: #268bd2">allowedMethods=</span><span style="color: #859900">"POST"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"apiHttpListenerConfig"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:response</span> <span style="color: #268bd2">statusCode=</span><span style="color: #859900">"#[vars.httpStatus default 202]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;http:body&gt;</span>#[output text/plain --- vars.response default 'OK']<span style="color: #b58900">&lt;/http:body&gt;</span>
    <span style="color: #b58900">&lt;/http:response&gt;</span>
  <span style="color: #b58900">&lt;/http:listener&gt;</span>

  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span>
    <span style="color: #268bd2">message=</span><span style="color: #859900">"Received Cancellation Notification"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You return HTTP 202 ACCEPTED rather than HTTP 200 OK to inform the Flights Management system that the cancellation notification has been accepted for later asynchronous processing.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This implementation just logs the cancellation notification; you will validate and use it in a later walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In a later walkthrough, you will add defensive error handling because this endpoint is not protected by API Manager policies.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Turn the hard-coded path into a property.</p>
</li>
<li>
<p><strong>Run and invoke:</strong> Run the Mule app and POST a cancellation notification to the HTTP callback just like the Flights Management system would; this should succeed:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_register_the_http_callback_with_an_http_service"><a class="anchor" href="#_register_the_http_callback_with_an_http_service"></a><a class="link" href="#_register_the_http_callback_with_an_http_service">Register the HTTP callback with an HTTP service</a></h4>
<div class="paragraph">
<p>In this section, you extend flights-management-sapi to invoke a SOAP web service operation on the Flights Management system to register the HTTP callback exposed by flights-management-sapi. Registration is done just once, shortly after the startup of flights-management-sapi, and from that moment on, the Flights Management system sends HTTP POST requests to that callback whenever a flight is cancelled.</p>
</div>
<div class="paragraph">
<p>The callback URL to be registered with the Flights Management system must be that of a load balancer in front of a (typically) replicated deployment of flights-management-sapi. In environments where flights-management-sapi is deployed to a CloudHub 2.0 Shared Space, this must be based on the DNS entry for flights-management-sapi that maps to the CloudHub Shared Space Load Balancer (such as <a href="https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io" class="bare">https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io</a>). Other deployment topologies might require a different address, such as the DNS entry of customer-provisioned load balancer. In any case, the Flights Management system must eventually send HTTP POST requests to that load-balanced callback URL. And for flights-management-sapi to register that URL with the Flights Management system, flights-management-sapi must be configured with its own load balancer hostname in each environment.</p>
</div>
<div class="paragraph">
<p>The network topology of AnyAirline does not allow the Flights Management system installations in any environment to reach a HTTP callback endpoint exposed on your development machine (localhost). The invocation by the Flights Management system of the callback exposed by flights-management-sapi can therefore only be tested by deploying flights-management-sapi to CloudHub.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p><strong>Register callback URL:</strong> To <strong>main.xml</strong>, add a flow that is scheduled to run after startup and registers the HTTP callback URL, stored in a property, by invoking the Flights Management system SOAP web service:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-callback"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;scheduler&gt;</span>
    <span style="color: #b58900">&lt;scheduling-strategy&gt;</span>
      <span style="color: #b58900">&lt;fixed-frequency</span>
        <span style="color: #268bd2">frequency=</span><span style="color: #859900">"365000"</span> <span style="color: #268bd2">timeUnit=</span><span style="color: #859900">"DAYS"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/scheduling-strategy&gt;</span>
  <span style="color: #b58900">&lt;/scheduler&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/xml
      ns ns0 http://flightsMgmt.sword.com/
      ---
      {
        ns0#registerForCancellationNotifications: {
          callbackURL: p("api.callback.url")
        }
      }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-for-cancellation-notifications"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;error-handler&gt;</span>
      <span style="color: #b58900">&lt;on-error-continue&gt;</span>
        <span style="color: #b58900">&lt;raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"APP:CANT_REGISTER_CALLBACK"</span> <span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
    <span style="color: #b58900">&lt;/error-handler&gt;</span>
  <span style="color: #b58900">&lt;/try&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-for-cancellation-notifications"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;wsc:consume</span>
    <span style="color: #268bd2">operation=</span><span style="color: #859900">"registerForCancellationNotifications"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"flightsWSCConfig"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This scheduler configuration runs this flow effectively only once after startup of the Mule app.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>DataWeave expressions can directly refer to configuration properties.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The callback URL to be invoked must be configured for each environment, because it cannot be determined automatically.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add callback URL prop:</strong> To <strong>properties.yaml</strong>, add the callback URL as a function of an environment-dependent base URL:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">properties.yaml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">callback</span><span style="color: #93a1a1">:</span>
    <span style="color: #268bd2">path</span><span style="color: #93a1a1">:</span>   <span style="color: #859900">"</span><span style="color: #859900">/api/cancelFlight"</span>
    <span style="color: #268bd2">url</span><span style="color: #93a1a1">:</span>    <span style="color: #859900">"</span><span style="color: #859900">${api.callback.base}${api.callback.path}"</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add base URL prop for dev:</strong> To <strong>dev-properties.yaml</strong>, add the callback base URL:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">dev-properties.yaml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">callback</span><span style="color: #93a1a1">:</span>
    <span style="color: #268bd2">base</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">https://flights-management-sapi-dev-uniqid.shard.usa-e2.cloudhub.io"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The uniqid and shard in the URL is just a placeholder for now. The complete URL with the unique id for your application will be generated once you deploy to CloudHub 2.0 next. You will update this value later.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update Mule app and dependencies to release versions:</strong> Update the <strong>BOM</strong>, <strong>parent POM</strong>, <strong>apps-commons</strong> and <strong>flights-management-sapi</strong> artifact version and references to a release version and not a SNAPSHOT:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...
<span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;apps-commons.version&gt;</span>1.0.0<span style="color: #b58900">&lt;/apps-commons.version&gt;</span>
  ...
<span style="color: #b58900">&lt;/properties&gt;</span>
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">parent-pom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-bom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../bom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pom.xml of apps-commons</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Although Exchange supports SNAPSHOT versions, not all Anypoint Platform components support them such as RTF. Therefore, for consistency you will use release versions for all dependencies and release and increase version numbers before every CloudHub 2.0 deployment.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Install, and study parent POMs:</strong> Install the parent POMs into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>bom/pom.xml        <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>bom/pom.xml
mvn <span style="color: #586e75">install</span>:install-file <span style="color: #b58900">-Dfile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml <span style="color: #b58900">-DpomFile</span><span style="color: #93a1a1">=</span>parent-pom/pom.xml</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of apps-commons, installing the JAR into your local Maven repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of flights-management-sapi including all unit tests using the same secure properties encryption key used in previous walkthroughs:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/flights-management-sapi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create Exchange Contributor Connected App:</strong> In <strong>Anypoint Access Management</strong>, create a new <strong>Connected App</strong> that acts on its <strong>own behalf (client credentials)</strong>, for writing assets to Exchange, adding the <strong>Exchange Contributor</strong> scope and retrieve its client ID and secret.</p>
</li>
<li>
<p><strong>Update settings.xml:</strong> Change in settings.xml the credentials of the matching <strong>server</strong> entry for the repository defined in the distributionManagement section of the bom/pom.xml to use the Connected App credentials created previously for writing to that repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;server&gt;</span>
  <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
  <span style="color: #b58900">&lt;username&gt;</span>~~~Client~~~<span style="color: #b58900">&lt;/username&gt;</span>
  <span style="color: #b58900">&lt;password&gt;</span>your-capp-contributor-cid~?~your-capp-contributor-secret<span style="color: #b58900">&lt;/password&gt;</span>
<span style="color: #b58900">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Only the Exchange Connected App is configured the Maven settings.xml, not the CloudHub Connected App as the Mule Maven plugin does not support using Connected App client ID and secret as Maven credentials and must be configured directly in the plugin configuration.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can also use Anypoint Platform credentials for an account of your Anypoint Platform organization with which you were able to search your Exchange  such as the trial account credentials created previously. However, it is best practice to use a Connected App for security.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To use Connected App authentication, provide basic authentication and define the username as ~~~Client~~~ and the password as clientID~?~clientSecret. Replace clientID with the client ID. Replace clientSecret with the client secret.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy parent POMs to Exchange:</strong> Deploy the <strong>BOM</strong> and <strong>parent POM</strong> used by apps-commons to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/bom
mvn deploy <span style="color: #b58900">-f</span> pom.xml <span style="color: #b58900">-Pdeploy-to-exchange-v3</span>

<span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/parent-pom
mvn deploy <span style="color: #b58900">-f</span> pom.xml <span style="color: #b58900">-Pdeploy-to-exchange-v3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a SNAPSHOT version is deployed to Exchange, it is created in the development lifecycle phase allowing the asset version to be overwritten and permanently deleted, whenever. When a stable asset version is deployed, Exchange will treat the asset as a production asset and enforce the standard Exchange rules upon it. Such as locking the version number so it cannot be overwritten and only allowing permanent deletion within the first 7 days.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy custom library to Exchange:</strong> Deploy apps-commons to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/apps-commons
mvn deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule Maven plugin is automatically integrated with Exchange Mule Maven plugin, therefore there is no need to define the Exchange Mule Maven plugin configuration as well. It is only needed to directly reference the Exchange Mule Maven plugin when deploying non-Mule artifacts such as custom libraries and POMs. If both are configured, deployment will happen twice, and the second deployment will fail with a conflict.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API enables you to both create your asset and set the mutable data describing it in the same request. The mutable data of an asset includes tags, custom fields, categories, and documentation pages. The final solution includes a complete example of creating a API policy with documentation and tags.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy:</strong> In <strong>Runtime Manager</strong>, deploy the packaged flights-management-sapi artifact from the <strong>target</strong> directory using the application name: <strong>flights-management-sapi-dev</strong>, selecting the <strong>CloudHub 2.0 US East Ohio Shared Space</strong> as a deployment target, enabling <strong>Last-Mile Security</strong> on the Ingress and adding <strong>properties</strong> that sets encrypt.key and disables autodiscovery:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">encrypt.key<span style="color: #93a1a1">=</span>secure12345
anypoint.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>As the application exposes a HTTPs endpoint itself, this option must be checked to forward the traffic from the CloudHub Shared Space Load Balancer to the application itself. This ensures the "Last-Mile" traffic between the CloudHub Shared Space Load Balancer and the application are encrypted.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Locate fully qualified domain name:</strong> In the Runtime Manager dashboard, check the fully qualified domain name of the Mule app and copy the API&#8217;s endpoint URL with the additional six-character uniq-id and shard.</p>
</li>
<li>
<p><strong>Update base URL prop for dev:</strong> To <strong>dev-properties.yaml</strong>, update the callback base URL with your fully qualified domain name:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">dev-properties.yaml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="yaml"><span style="color: #268bd2">api</span><span style="color: #93a1a1">:</span>
  <span style="color: #268bd2">callback</span><span style="color: #93a1a1">:</span>
    <span style="color: #268bd2">base</span><span style="color: #93a1a1">:</span> <span style="color: #859900">"</span><span style="color: #859900">https://flights-management-sapi-dev-uniqid.shard.usa-e2.cloudhub.io"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Ensure to replace the placeholders for the six-character unique id and shard for your individual application.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build: and Redeploy:</strong> In <strong>Runtime Manager</strong> Run a full Maven build of flights-management-sapi again and redeploy the packaged flights-management-sapi artifact from the <strong>target</strong> directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/flights-management-sapi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Check log:</strong> Study the log output of flights-management-sapi; the logs should show the callback being registered with the Flights Management system in the dev environment and the return invocations of the callback.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If the callback is not invoked, check in a passenger; the Flights Management system will then cancel these flights:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://flights-management-sapi-dev-uniqid.shard.usa-e2.cloudhub.io/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Ensure to replace the placeholders for the six-character unique id and shard for your individual application.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-async-message-passing"><a class="anchor" href="#module-async-message-passing"></a><a class="link" href="#module-async-message-passing">Module 2: Passing messages asynchronously</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you set up queues using the VM Connector to pass messages asynchronously and reliably between Mule flows and use Anypoint MQ exchanges and Anypoint MQ queues to pass messages asynchronously and reliably between Mule apps.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Publish messages to a VM queue.</p>
</li>
<li>
<p>Listen for messages in a VM queue.</p>
</li>
<li>
<p>Publish messages to an Anypoint MQ exchange.</p>
</li>
<li>
<p>Subscribe to messages in an Anypoint MQ queue.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-221"><a class="anchor" href="#wt-begin-221"></a><a class="link" href="#wt-begin-221">Walkthrough 2-1: Publish messages to a VM queue</a></h3>
<div class="paragraph">
<p>When the Flights Management system sends a cancellation notification to flights-management-sapi, it does so in the body of a HTTP POST request to the callback exposed by flights-management-sapi.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you extend the implementation of that HTTP callback to perform the first phase of the reliability pattern, the reliable acquisition flow, by sending the HTTP POST body unchanged to a VM queue. In doing so you must guard against DoS attacks by always limiting the size of VM queues.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_configure_a_vm_connector_and_persistent_vm_queues">Configure a VM Connector and persistent VM queues</a>.</p>
</li>
<li>
<p><a href="#_publish_xml_messages_to_a_vm_queue">Publish cancellation notification XML messages to a VM queue</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_6"><a class="anchor" href="#_solution_file_6"></a><a class="link" href="#_solution_file_6">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_5"><a class="anchor" href="#_starting_file_5"></a><a class="link" href="#_starting_file_5">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-5_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configure_a_vm_connector_and_persistent_vm_queues"><a class="anchor" href="#_configure_a_vm_connector_and_persistent_vm_queues"></a><a class="link" href="#_configure_a_vm_connector_and_persistent_vm_queues">Configure a VM Connector and persistent VM queues</a></h4>
<div class="paragraph">
<p>In this section, you add the VM Connector as a Maven dependency to flights-management-sapi and configure it with two size-limited VM queues, one for cancellation notifications received from the Flights Management system and the other a Dead Letter Queue.</p>
</div>
<div class="paragraph">
<p>The first queue is an essential part of the reliability pattern, because it is a reliable buffer of cancellation notifications sent by the Flights Management system. You want to accept cancellation notifications and send them to this queue as quickly and reliably as possible, so that none are lost. Later, asynchronously, these cancellation notifications will be processed.</p>
</div>
<div class="paragraph">
<p>You also configure a Dead Letter Queue to send those cancellation notifications to that cannot be processed. This is done in a later walkthrough.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the solution design for US2: Flight Cancellation mobile Notifications in the <a href="#section-aa-solution-arch">Solution architecture</a>.</p>
</li>
<li>
<p><strong>Add managed VM Connector Maven dependency:</strong> In Studio, add to flights-management-sapi a managed dependency on the VM Connector in <strong>pom.xml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-vm-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of <strong>flights-management-sapi</strong> and run a Maven build of this Mule app, providing the required secure properties encryption key; this should succeed and all unit tests
should pass:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/flights-management-sapi
mvn clean verify <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add VM Connector config:</strong> To <strong>global.xml</strong>, add a VM Connector configuration declaring these VM queues as persistent and limiting their size:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;vm:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"vmConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:queues&gt;</span>
    <span style="color: #b58900">&lt;vm:queue</span>
      <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-q"</span>
      <span style="color: #268bd2">queueType=</span><span style="color: #859900">"PERSISTENT"</span>
      <span style="color: #268bd2">maxOutstandingMessages=</span><span style="color: #859900">"100"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;vm:queue</span>
      <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-dlq"</span>
      <span style="color: #268bd2">queueType=</span><span style="color: #859900">"PERSISTENT"</span>
      <span style="color: #268bd2">maxOutstandingMessages=</span><span style="color: #859900">"1000"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/vm:queues&gt;</span>
<span style="color: #b58900">&lt;/vm:config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>VM queues must be declared to be used.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The reliability pattern also strongly suggests that the queues should be persistent.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Explicitly setting the queue type to persistent in the queue configuration is only honored by standalone customer-hosted deployments. Configuring persistent VM queues differs per deployment topology. Some topologies have many more options, such as cluster-wide, in-memory replication, or persistence on disk or in a database, but may require management of persistent storage. It is also possible to use an external broker for reliable messaging such as Anypoint MQ which you will look at in a later walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If messages are dequeued slower than they are enqueued  for instance in the case of a DoS attack on the HTTP callback  then the Mule app will ultimately fail with an out-of-memory error: to guard against this it is good practice to always limit the size of VM queues.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Extract the hard-coded queue size into an environment-dependent configuration property, sizing it more generously in the prod environment.</p>
</li>
<li>
<p><strong>Homework:</strong> Extract the hard-coded queue names into environment-independent configuration properties.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_publish_xml_messages_to_a_vm_queue"><a class="anchor" href="#_publish_xml_messages_to_a_vm_queue"></a><a class="link" href="#_publish_xml_messages_to_a_vm_queue">Publish XML messages to a VM queue</a></h4>
<div class="paragraph">
<p>In this section, you publish cancellation notifications received from the Flights Management system to the configured VM queue.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p><strong>Publish message:</strong> In <strong>main.xml</strong>, send the HTTP POST body received by the HTTP callback to the appropriate VM queue, to be processed later, asynchronously:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;vm:publish</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-q"</span>
    <span style="color: #268bd2">sendCorrelationId=</span><span style="color: #859900">"ALWAYS"</span>
    <span style="color: #268bd2">timeout=</span><span style="color: #859900">"5000"</span> <span style="color: #268bd2">timeoutUnit=</span><span style="color: #859900">"MILLISECONDS"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This sends the current payload to the VM queue. No other parts of the current Mule event, such as attributes or variables, are sent  with the exception of the correlation ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule event&#8217;s correlation ID is typically created by the &lt;http:listener /&gt;, unless it was sent by the HTTP client.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>An explicit timeout ensures that sending to the queue does not block indefinitely in case of an error.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If the queue size has been reached, this enqueue operation blocks until either a message has been dequeued or the timeout has been reached.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Errors in sending the message to the VM queue are currently handled by logging a misleading error log entry: you will fix this in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send a few cancellation notifications to the callback; observe the corresponding log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR456&lt;/PNR&gt;&lt;PassengerLastName&gt;Max&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/plain"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"invalid content type and content"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>All HTTP POST bodies are sent to the VM queue, even obviously invalid ones; In a later walkthrough you will add validation of the received message, before it is sent to the queue.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Turn the hard-coded timeout into an environment-dependent property.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-222"><a class="anchor" href="#wt-begin-222"></a><a class="link" href="#wt-begin-222">Walkthrough 2-2: Listen for messages in a VM queue</a></h3>
<div class="paragraph">
<p>cancellation notifications POSTed from the Flights Management system to flights-management-sapi are sent to a persistent VM queue, to ensure they are not lost. But they are not currently processed: What is missing is the second phase of the reliability pattern, the application logic flow.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you extend flights-management-sapi to asynchronously retrieve messages from that VM queue and start processing them as cancellation notifications. Despite processing logic being simple for now, this nonetheless requires you to think about processing errors, a redelivery policy for dealing with those errors, and the transactionality of message processing. VM queues are transactional resources that can participate in local and XA transactions.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_create_a_flow_that_listens_on_a_vm_queue_in_a_local_transaction">Create a flow that listens on a VM queue in a local transaction</a>.</p>
</li>
<li>
<p><a href="#_set_a_redelivery_policy_when_consuming_messages_from_a_vm_queue">Set a redelivery policy when consuming cancellation notifications</a>.</p>
</li>
<li>
<p><a href="#_avoid_redelivery_of_invalid_messages">Avoid reprocessing of invalid cancellation notifications</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_7"><a class="anchor" href="#_solution_file_7"></a><a class="link" href="#_solution_file_7">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_6"><a class="anchor" href="#_starting_file_6"></a><a class="link" href="#_starting_file_6">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_flow_that_listens_on_a_vm_queue_in_a_local_transaction"><a class="anchor" href="#_create_a_flow_that_listens_on_a_vm_queue_in_a_local_transaction"></a><a class="link" href="#_create_a_flow_that_listens_on_a_vm_queue_in_a_local_transaction">Create a flow that listens on a VM queue in a local transaction</a></h4>
<div class="paragraph">
<p>In this section, you create a Mule flow with a &lt;vm:listener /&gt; as the message source to receive putative cancellation notifications from a VM queue. You transform the cancellation notifications to flight canceled events and begin to understand the effect of errors that may be raised in that transformation.</p>
</div>
<div class="paragraph">
<p>cancellation notifications are sent in a format not under AnyAirline&#8217;s control. It is essential to insulate AnyAirline from changes in that message format, such as by transforming to the internally controlled format of flight canceled events.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the solution design for US2: Flight Cancellation mobile Notifications in the <a href="#section-aa-solution-arch">Solution architecture</a>.</p>
</li>
<li>
<p><strong>Listen for notification messages:</strong> In Studio, add to <strong>main.xml</strong> a flow with a message source that listens on the cancellation notifications VM queue in a new local transaction and logs the received message:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-q"</span>
    <span style="color: #268bd2">transactionalAction=</span><span style="color: #859900">"ALWAYS_BEGIN"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Received"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, messages are retrieved from the VM queue concurrently; this is OK because cancellation notifications are not inherently ordered.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The transaction starts with the de-queuing of the message, ends at the end of the Mule flow, and involves the VM Connector as the only transactional resource (is a resource-local transaction).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send several HTTP POST requests  valid cancellation notifications and invalid messages  to the HTTP callback as before; observe the log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR456&lt;/PNR&gt;&lt;PassengerLastName&gt;Max&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/plain"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"invalid content type and content"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Messages are retrieved from the VM queue immediately after they have been added to it.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Transform XML messages to JSON:</strong> In <strong>deliver-flight-cancelled-event</strong>, transform each XML-formatted cancellation notification into a JSON-formatted flight canceled event, immediately after logging the received message:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
      output application/json
      ---
      {
        pnr:                 payload.CancellationNotification.PNR,
        lastNameOfPassenger: payload.CancellationNotification.PassengerLastName
      }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In a later walkthrough, you will send this flight canceled event to an Anypoint MQ exchange, for now you just log it.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi again and post one valid and one invalid cancellation notification to the HTTP callback; observe the log and note the error being raised.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The HTTP client  which, in real use, is the Flights Management system  sees no difference between valid and invalid cancellation notifications.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When asynchronously processing an invalid cancellation notification, an error such as MULE:EXPRESSION is raised when transforming it to a flight canceled event, which causes the transaction and hence the dequeuing of the message to roll back. This leads to an infinite loop as the same invalid message is received and processed again and again, always failing with the same error.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_set_a_redelivery_policy_when_consuming_messages_from_a_vm_queue"><a class="anchor" href="#_set_a_redelivery_policy_when_consuming_messages_from_a_vm_queue"></a><a class="link" href="#_set_a_redelivery_policy_when_consuming_messages_from_a_vm_queue">Set a redelivery policy when consuming messages from a VM queue</a></h4>
<div class="paragraph">
<p>In this section, you limit the number of times the same message is dequeued from a VM queue after it had previously caused an error during message processing. This is done by setting a redelivery policy on the &lt;vm:listener /&gt;. After redeliveries have been exhausted, you send the message to the Dead Letter Queue.</p>
</div>
<div class="paragraph">
<p>A redelivery policy must decide when a message being dequeued is the same message as a previously dequeued message. By default the identity criterion is a hash of the message payload. But this approach is inappropriate for XML message like the cancellation notification, which can be formatted differently while still representing the same XML content. Instead, you use the correlation ID that was explicitly sent with the message to the VM queue.</p>
</div>
<div class="paragraph">
<p>A redelivery policy is a stateful component because it needs to store the IDs and counts of previously processed messages: it requires an Object Store to maintain this state between invocations, and uses the default Object Store if none is explicitly configured.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p><strong>Configure redelivery policy:</strong> Add a redelivery policy to the &lt;vm:listener /&gt; in main.xml, add, using the correlation ID rather than the payload as the identity criterion:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-q"</span>
    <span style="color: #268bd2">transactionalAction=</span><span style="color: #859900">"ALWAYS_BEGIN"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;redelivery-policy</span>
      <span style="color: #268bd2">maxRedeliveryCount=</span><span style="color: #859900">"3"</span>
      <span style="color: #268bd2">idExpression=</span><span style="color: #859900">"#[correlationId]"</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/vm:listener&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The correlation ID of the current Mule event is available as a predefined variable in DataWeave.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The default Object Store, which is persistent, is used by the redelivery policy.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi again and note the errors being raised; the Mule app should automatically start processing messages from the persistent VM queue.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>After the last permissible redelivery of a message has also failed, a MULE:REDELIVERY_EXHAUSTED error is raised.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add Dead Letter error handling:</strong> Add an error handler for MULE:REDELIVERY_EXHAUSTED that sends the message to the Dead Letter Queue:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue</span>
      <span style="color: #268bd2">type=</span><span style="color: #859900">"MULE:REDELIVERY_EXHAUSTED"</span>
      <span style="color: #268bd2">enableNotifications=</span><span style="color: #859900">"false"</span>
      <span style="color: #268bd2">logException=</span><span style="color: #859900">"false"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"ERROR"</span>
        <span style="color: #268bd2">message=</span><span style="color: #859900">"Giving up"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"send-to-vm-dlq"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"send-to-vm-dlq"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:publish</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-dlq"</span>
    <span style="color: #268bd2">timeout=</span><span style="color: #859900">"5000"</span> <span style="color: #268bd2">timeoutUnit=</span><span style="color: #859900">"MILLISECONDS"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Set timeout values as usual when sending to a VM queue, as the send operation may fail, for example when the Dead Letter Queue is full.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The default is for the correlation ID to be sent to the VM queue if one is present, which there is in this case.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The trigger of the REDELIVERY_EXHAUSTED error is caused by the arrival of a new event, and no context is kept between the original failing events and the new one. Therefore the event is in its original state with the original payload and no variables.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Consume Dead Letter messages:</strong> In main.xml, add a simple Mule flow with a &lt;vm:listener /&gt; consuming messages sent to the <strong>Dead Letter Queue</strong>:</p>
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"handle-dlq"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"flight-cancel-notifs-dlq"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;redelivery-policy</span>
      <span style="color: #268bd2">maxRedeliveryCount=</span><span style="color: #859900">"3"</span>
      <span style="color: #268bd2">idExpression=</span><span style="color: #859900">"#[correlationId]"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/vm:listener&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span>
    <span style="color: #268bd2">message=</span><span style="color: #859900">"Processing message from DLQ"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi again; it should drain all messages from the VM queue, sending invalid ones to the Dead Letter Queue after the third retry.</p>
</li>
<li>
<p><strong>Invoke:</strong> Send an individual valid and invalid cancellation notification to flights-management-sapi and follow the processing of each.</p>
</li>
<li>
<p><strong>Homework:</strong> Extract all hard-coded values into environment-dependent configuration properties.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_avoid_redelivery_of_invalid_messages"><a class="anchor" href="#_avoid_redelivery_of_invalid_messages"></a><a class="link" href="#_avoid_redelivery_of_invalid_messages">Avoid redelivery of invalid messages</a></h4>
<div class="paragraph">
<p>In this section, you address a fundamental inefficiency in the current redelivery configuration for cancellation notifications in flights-management-sapi. If a message retrieved from the VM queue is inherently invalid, then it will never be possible to treat this message as a cancellation notification and transform it to a valid flight canceled event. But in the current redelivery configuration, these messages are redelivered and reprocessed several time, before finally being sent to the Dead Letter Queue. This kind of permanent errors should not waste resources and should be dealt with by sending the corresponding messages straight to the Dead Letter Queue.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p><strong>Add localized Dead Letter error handling:</strong> Add a Try scope around the transformation of an (assumed) cancellation notification to a flight canceled event, treating all raised errors as permanent and sending the message to the Dead Letter Queue. Set a boolean <strong>msgValid</strong> variable for processors outside of the Try scope to determine whether validation was successful:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span>
    <span style="color: #268bd2">transactionalAction=</span><span style="color: #859900">"ALWAYS_BEGIN"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/vm:listener&gt;</span>
  <span style="color: #b58900">&lt;try</span>
    <span style="color: #268bd2">transactionalAction=</span><span style="color: #859900">"BEGIN_OR_JOIN"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;ee:transform&gt;</span>...<span style="color: #b58900">&lt;/ee:transform&gt;</span>
    <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"msgValid"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[true]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;error-handler&gt;</span>
      <span style="color: #b58900">&lt;on-error-continue</span>
        <span style="color: #268bd2">enableNotifications=</span><span style="color: #859900">"false"</span>
        <span style="color: #268bd2">logException=</span><span style="color: #859900">"false"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"send-to-vm-dlq"</span> <span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"msgValid"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
    <span style="color: #b58900">&lt;/error-handler&gt;</span>
  <span style="color: #b58900">&lt;/try&gt;</span>
  <span style="color: #b58900">&lt;error-handler&gt;</span>...<span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Try scope serves just to isolate any errors raised during preparing the flight canceled event and must therefore participate in the ongoing transaction started by the &lt;vm:listener /&gt;.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Errors during transforming to the flight canceled event must be handled with an on-error-continue so as to consume the message and not trigger redeliveries.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because errors within the Try scope are consumed by an on-error-continue to not trigger redeliveries, future processors outside of the Try scope are unaware an error occurred and need another way of filtering invalid messages.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The trigger of the REDELIVERY_EXHAUSTED error is caused by the arrival of a new event, and no context is kept between the original failing. Therefore the event is in its original state with the original payload and no variables.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Store original payload:</strong> Add a variable that stores the original payload so that this can be sent to the Dead Letter Queue:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;set-variable</span>
      <span style="color: #268bd2">variableName=</span><span style="color: #859900">"originalPayload"</span>
      <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output text/plain --- payload.^raw]"</span>
    <span style="color: #b58900">/&gt;</span>
    ...
  <span style="color: #b58900">&lt;/try&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"send-to-vm-dlq"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:publish&gt;</span>
    <span style="color: #b58900">&lt;vm:content&gt;</span>#[vars.originalPayload]<span style="color: #b58900">&lt;/vm:content&gt;</span>
  <span style="color: #b58900">&lt;/vm:publish&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>At this point in the Mule flow, the error is not triggered by a REDELIVERY_EXHAUSTED event, therefore the payload must be manually reverted to its original state before publishing to the Dead Letter Queue.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and post invalid cancellation notifications to it; confirm that they are sent to the Dead Letter Queue straight away.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-223"><a class="anchor" href="#wt-begin-223"></a><a class="link" href="#wt-begin-223">Walkthrough 2-3: Publish messages to an Anypoint MQ exchange</a></h3>
<div class="paragraph">
<p>In this walkthrough, you extend the processing of VM messages in flights-management-sapi to publish flight canceled events to an Anypoint MQ exchange.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_configure_an_anypoint_mq_connector_for_message_publishing">Configure an Anypoint MQ Connector for message publishing</a>.</p>
</li>
<li>
<p><a href="#_publish_json_messages_to_an_anypoint_mq_exchange">Publish flight canceled events to an Anypoint MQ exchange</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_8"><a class="anchor" href="#_solution_file_8"></a><a class="link" href="#_solution_file_8">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_7"><a class="anchor" href="#_starting_file_7"></a><a class="link" href="#_starting_file_7">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configure_an_anypoint_mq_connector_for_message_publishing"><a class="anchor" href="#_configure_an_anypoint_mq_connector_for_message_publishing"></a><a class="link" href="#_configure_an_anypoint_mq_connector_for_message_publishing">Configure an Anypoint MQ Connector for message publishing</a></h4>
<div class="paragraph">
<p>In this section, you add the Anypoint MQ Connector to flights-management-sapi as a Maven dependency and configure it to connect to the us-e1 (N. Virginia) Anypoint MQ broker using the client ID and secret of a pre-created Anypoint MQ client app.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p><strong>Study Solution Architecture:</strong> Study the solution design for US2: Flight Cancellation mobile Notifications in the <a href="#section-aa-solution-arch">Solution architecture</a> paying particular attention to the role of Anypoint MQ.
.</p>
</li>
<li>
<p><strong>Add managed Anypoint MQ Connector Maven dependency:</strong> In Studio, add to flights-management-sapi a managed dependency on the Anypoint MQ Connector in <strong>pom.xml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>com.mulesoft.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>anypoint-mq-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add Anypoint MQ Connector global config:</strong> To <strong>global.xml</strong>, add &lt;anypoint-mq:config /&gt; with the supplied client ID and secret for an Anypoint MQ client app already created in Anypoint Platform:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">&lt;anypoint-mq:config <span style="color: #586e75">name</span><span style="color: #93a1a1">=</span><span style="color: #859900">"amqConfig"</span><span style="color: #93a1a1">&gt;</span>
  &lt;anypoint-mq:connection
    <span style="color: #586e75">clientId</span><span style="color: #93a1a1">=</span><span style="color: #859900">"b58581e1242d4e10bdca4103cee00181"</span>
    <span style="color: #586e75">clientSecret</span><span style="color: #93a1a1">=</span><span style="color: #859900">"b063BAe915a449A8A00AAe4f1e2aA3D4"</span>
    <span style="color: #586e75">url</span><span style="color: #93a1a1">=</span><span style="color: #859900">"https://mq-us-east-1.anypoint.mulesoft.com/api/v1/organizations/a63e6d25-8aaf-4512-b36d-d91b90a55c4a/environments/129441e8-ae69-4cf9-a70b-cdabca4823ff"</span>/&gt;
&lt;/anypoint-mq:config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Anypoint MQ Connector configuration is called &lt;anypoint-mq:config /&gt; both for sending and receiving messages to/from an Anypoint MQ broker.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Use the client ID and secret of an Anypoint MQ client app created previously.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Since v4.x of the Anypoint MQ Connector, the Anypoint Platform organization ID and the Anypoint Platform environment ID must be supplied in the Anypoint MQ URL. This URL can be copied from the Anypoint MQ UI.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_publish_json_messages_to_an_anypoint_mq_exchange"><a class="anchor" href="#_publish_json_messages_to_an_anypoint_mq_exchange"></a><a class="link" href="#_publish_json_messages_to_an_anypoint_mq_exchange">Publish JSON messages to an Anypoint MQ exchange</a></h4>
<div class="paragraph">
<p>In this section, you use the previously configured Anypoint MQ Connector to publish messages containing JSON flight canceled events to an Anypoint MQ destination.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p><strong>Publish flight canceled event to an Anypoint MQ destination:</strong> In Studio, add to <strong>main.xml</strong> the operation to publish a flight canceled event with a custom message ID to its Anypoint MQ destination within a Choice router filtering any invalid messages:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;try</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;choice&gt;</span>
    <span style="color: #b58900">&lt;when</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[vars.msgValid]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;anypoint-mq:publish</span>
        <span style="color: #268bd2">destination=</span><span style="color: #859900">"cancelled-flights-exchg-dev"</span>
        <span style="color: #268bd2">messageId=</span><span style="color: #859900">"#[correlationId]"</span>
        <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"amqConfig"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/when&gt;</span>
  <span style="color: #b58900">&lt;/choice&gt;</span>
  <span style="color: #b58900">&lt;error-handler</span> <span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, the Anypoint MQ message body is taken from the current payload.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the correlation ID that has been passed along this message from the start as the ID of the Anypoint MQ message. If you do not specify a message ID, then Anypoint MQ creates a new one.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Transformation to the flight canceled event is performed in the Try scope, so that publishing to Anypoint MQ is under the control of the flow-level error handler, resulting in the correct retry behavior.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because errors within the Try scope are consumed by an on-error-continue to not trigger redeliveries, future processors outside of the Try scope are unaware an error occurred and need another way of filtering invalid messages.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and POST a cancellation notification to the HTTP callback; observe the logs:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Because HTTP traffic is logged, you can observe the API invocation of the Anypoint MQ REST API.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Confirm that when the Anypoint MQ Connector authenticates towards the Anypoint MQ broker, it sends the correct client ID and secret and receives the Anypoint Platform organization ID of AnyAirline.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Confirm that the message ID sent to the Anypoint MQ broker is the correlation ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The content type of the Anypoint MQ message is correctly set to application/json because that&#8217;s the output set in the DataWeave transformation to the flight canceled event.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Extract all configuration values hard-coded in this walkthrough into appropriate configuration properties, environment-dependent or independent and encrypted, as fitting. Note that you have not been given an Anypoint MQ client app for the test and prod environments.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-224"><a class="anchor" href="#wt-begin-224"></a><a class="link" href="#wt-begin-224">Walkthrough 2-4: Subscribe to messages in an Anypoint MQ queue</a></h3>
<div class="paragraph">
<p>Flight cancellation events sent to the cancelled-flights-exchg Anypoint MQ exchange are distributed to the cancelled-flights-mobile-queue Anypoint MQ queue. This walkthrough creates mobile-notifications-eapp as a Mule app located in the Experience API tier that consumes messages from Anypoint MQ queue and forwards them to the mobile app (simulated).</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you first set-up the starter code for mobile-notifications-eapp. You then implement a Mule flow to subscribe to an Anypoint MQ queue, manual acknowledging received messages, and forwarding them onto a mobile app simulated via the VM Connector. You then implement a circuit breaker to control subscription to the Anypoint MQ queue if the mobile app network is unavailable.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_create_mobile_notifications_eapp">Create mobile-notifications-eapp</a>.</p>
</li>
<li>
<p><a href="#_configure_the_anypoint_mq_connector_for_message_subscription">Configure the Anypoint MQ Connector for message subscription</a>.</p>
</li>
<li>
<p><a href="#_subscribe_to_messages_in_an_anypoint_mq_queue">Subscribe to messages in an Anypoint MQ queue</a>.</p>
</li>
<li>
<p><a href="#_control_anypoint_mq_message_subscription_with_a_circuit_breaker">Control Anypoint MQ message subscription with a Circuit Breaker</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_9"><a class="anchor" href="#_solution_file_9"></a><a class="link" href="#_solution_file_9">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_8"><a class="anchor" href="#_starting_file_8"></a><a class="link" href="#_starting_file_8">Starting file</a></h4>
<div class="paragraph">
<p>To follow this walkthrough, you need the starter project at $APDL2DIST/walkthroughs/devint/module02/wt2-4_starter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_mobile_notifications_eapp"><a class="anchor" href="#_create_mobile_notifications_eapp"></a><a class="link" href="#_create_mobile_notifications_eapp">Create mobile-notifications-eapp</a></h4>
<div class="paragraph">
<p>In this section, you copy the starter code for mobile-notifications-eapp  a Mule app for receiving Flight cancellation events in the Experience API layer into your Studio workspace, build and import it into Studio.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Copy mobile-notifications-eapp starter:</strong> Copy the <strong>mobile-notifications-eapp</strong> starter project into your Studio workspace directory, renaming it to mobile-notifications-eapp:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>
<span style="color: #586e75">cp</span> <span style="color: #b58900">-r</span> <span style="color: #586e75">$APDL2DIST</span>/walkthroughs/devint/module02/wt2-4_starter/mobile-notifications-eapp ./</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study Maven build:</strong> Familiarize yourself briefly with the Maven build configuration of mobile-notifications-eapp.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Again, a reusable Maven plugin configuration is inherited from the parent POM and Maven dependency management from the BOM. Both parent-pom/pom.xml and bom/pom.xml are read from the Studio workspace directory.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of mobile-notifications-eapp including all MUnit tests, providing the required secure properties encryption key; this should succeed and all unit tests should pass:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/mobile-notifications-eapp
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> In Studio, import mobile-notifications-eapp without copying it to your workspace, as it is already there; confirm that the import succeeded.</p>
</li>
<li>
<p><strong>Add temporary env property:</strong> In Studio, near the top of global.xml, define a property <strong>encrypt.key</strong> to default the property required by the Studio tooling instance:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;global-property</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"encrypt.key"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"secure12345"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The encrypt.key property should not be defaulted and should be removed. This is a temporary solution to provide the runtime property to the Studio tooling instance, required to utilize DataSense metadata support.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add run config :</strong> Add a Studio run configuration (via the <strong>Run as &gt; Mule application (configure)</strong> dialog) for mobile-notifications-eapp that sets <strong>encrypt.key</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #b58900">-M-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configure_the_anypoint_mq_connector_for_message_subscription"><a class="anchor" href="#_configure_the_anypoint_mq_connector_for_message_subscription"></a><a class="link" href="#_configure_the_anypoint_mq_connector_for_message_subscription">Configure the Anypoint MQ Connector for message subscription</a></h4>
<div class="paragraph">
<p>In this section, you configure the Anypoint MQ Connector with the client ID and secret for a new Anypoint MQ client app.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p><strong>Add Anypoint MQ Connector global config:</strong> To <strong>global.xml</strong>, add &lt;anypoint-mq:config /&gt; with the client ID and secret (<strong>b58581e1242d4e10bdca4103cee00181</strong> and <strong>b063BAe915a449A8A00AAe4f1e2aA3D4</strong>):</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">&lt;anypoint-mq:config <span style="color: #586e75">name</span><span style="color: #93a1a1">=</span><span style="color: #859900">"amqConfig"</span><span style="color: #93a1a1">&gt;</span>
  &lt;anypoint-mq:connection
    <span style="color: #586e75">clientId</span><span style="color: #93a1a1">=</span><span style="color: #859900">"b58581e1242d4e10bdca4103cee00181"</span>
    <span style="color: #586e75">clientSecret</span><span style="color: #93a1a1">=</span><span style="color: #859900">"b063BAe915a449A8A00AAe4f1e2aA3D4"</span>
    <span style="color: #586e75">url</span><span style="color: #93a1a1">=</span><span style="color: #859900">"https://mq-us-east-1.anypoint.mulesoft.com/api/v1/organizations/a63e6d25-8aaf-4512-b36d-d91b90a55c4a/environments/129441e8-ae69-4cf9-a70b-cdabca4823ff"</span>/&gt;
&lt;/anypoint-mq:config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It is best practice to create a new application for each Mule app and environment combination.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_subscribe_to_messages_in_an_anypoint_mq_queue"><a class="anchor" href="#_subscribe_to_messages_in_an_anypoint_mq_queue"></a><a class="link" href="#_subscribe_to_messages_in_an_anypoint_mq_queue">Subscribe to messages in an Anypoint MQ queue</a></h4>
<div class="paragraph">
<p>In this section, you create a Mule flow with a &lt;anypoint-mq:subscriber /&gt; as the message source to receive flight canceled events from an Anypoint MQ queue. You transform the flight canceled events and publish to a simple VM queue simulating a downstream mobile app.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p><strong>Select a queue:</strong> Choose an individual <strong>cancelled-flights-mobile-queue-student-XX</strong> Anypoint MQ queue, where XX represents a student number, from 01 to 15, for example, 01, 02, etc.</p>
</li>
<li>
<p><strong>Listen for notification messages:</strong> In Studio, add to <strong>main.xml</strong> a flow with a message source that subscribes on the cancelled-flights-mobile-queue-student-XX Anypoint MQ queue with <strong>MANUAL</strong> acknowledgment and a reconnection strategy to reconnect forever and logs the received message:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;anypoint-mq:subscriber</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"amqConfig"</span> <span style="color: #268bd2">destination=</span><span style="color: #859900">"cancelled-flights-mobile-queue-dev-student05"</span> <span style="color: #268bd2">acknowledgementMode=</span><span style="color: #859900">"MANUAL"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;reconnect-forever</span> <span style="color: #268bd2">frequency=</span><span style="color: #859900">"1000"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/anypoint-mq:subscriber&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Received"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Default property values are predefined in properties.yaml.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As Anypoint MQ is a remote service and used to trigger a Mule flow, it is best practice to set a reconnection strategy to reconnect if there are any connectivity issues.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You reference an Anypoint MQ queue to subscribe, whereas you previously published to an Anypoint MQ exchange.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run <strong>mobile-notifications-eapp</strong>, invoke the <strong>AnyAirline</strong> hosted <strong>flights-management-sapi</strong> to populate the queue sand observe the mobile-notifications-eapp log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If more than one client subscribes to the same queue, you must send multiple requests as they will be competing consumers, consuming the message before another client can.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Transform to mobile app JSON format:</strong> Transform each JSON-formatted message to the new format required by the mobile app immediately after logging the received message:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
        output application/json
        ---
        {
          pnr: payload.pnr,
          lastName: payload.lastNameOfPassenger
        }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
    <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add VM Connector config:</strong> To <strong>global.xml</strong>, add a VM Connector configuration declaring a VM queue simulating the mobile app network:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;vm:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"mobileAppNetworkVMConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:queues&gt;</span>
    <span style="color: #b58900">&lt;vm:queue</span> <span style="color: #268bd2">queueName=</span><span style="color: #859900">"mobile-app-native-notifs-q"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/vm:queues&gt;</span>
<span style="color: #b58900">&lt;/vm:config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Default property values are predefined in properties.yaml.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>VM queues must be declared to be used.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Publish message:</strong> In <strong>main.xml</strong>, send the transformed JSON payload received by Anypoint MQ subscriber to the VM queue:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;vm:publish</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"mobileAppNetworkVMConfig"</span> <span style="color: #268bd2">queueName=</span><span style="color: #859900">"mobile-app-native-notifs-q"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This sends the current payload to the VM queue. Except for the correlation ID, no other parts of the Mule event, such as attributes or variables.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Wait and observe:</strong> Run mobile-notifications-eapp again; observe the log and note the same messages are being received.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Messages will continue to be received until the flow acknowledges the message as the acknowledgement mode is manual.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This is difficult to demonstrate if there are multiple clients consuming from the same queue.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Store acknowledgment token:</strong> In <strong>main.xml</strong>, set a variable to store the acknowledgment token received from the attributes of the Anypoint MQ message before the &lt;vm:publish /&gt;:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"mqAckToken"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[attributes.ackToken]"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;vm:publish</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"mobileAppNetworkVMConfig"</span> <span style="color: #268bd2">queueName=</span><span style="color: #859900">"mobile-app-native-notifs-q"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The token must be stored prior to crossing a transport barrier to be used later as attributes are overwritten.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Manually acknowledge the message:</strong> In <strong>main.xml</strong>, manually acknowledge the message has been successfully processed after publishing to the VM queue using the stored <strong>mqAckToken</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;anypoint-mq:ack</span> <span style="color: #268bd2">ackToken=</span><span style="color: #859900">"#[vars.mqAckToken]"</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"amqConfig"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Explicitly Not Acknowledge a message:</strong> Add an error handler and send a <strong>NACK</strong> to put the message back on the queue using the same stored <strong>mqAckToken</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-propagate&gt;</span>
      <span style="color: #b58900">&lt;anypoint-mq:nack</span> <span style="color: #268bd2">ackToken=</span><span style="color: #859900">"#[vars.mqAckToken]"</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"amqConfig"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-propagate&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Manual acknowledgement gives you flexibility to choose which error types result in an ACK or NACK.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_control_anypoint_mq_message_subscription_with_a_circuit_breaker"><a class="anchor" href="#_control_anypoint_mq_message_subscription_with_a_circuit_breaker"></a><a class="link" href="#_control_anypoint_mq_message_subscription_with_a_circuit_breaker">Control Anypoint MQ message subscription with a Circuit Breaker</a></h4>
<div class="paragraph">
<p>When an external service is not available (the VM Connector simulating the mobile app network in this case), every attempt to process messages results in a failure, forcing the app to retrieve messages that cannot succeed and are eventually moved to a Dead Letter Queue. You can avoid this behavior by notifying the subscriber of the error in a way that prevents it from consuming more messages for some time.</p>
</div>
<div class="paragraph">
<p>If a Mule flow finishes its execution with an error the &lt;anypoint-mq:subscriber /&gt;, will check if the error is one of a preconfigured error type that indicates an external service error, and counts consecutive occurrences until a configurable threshold is reached. When the threshold is reached, the circuit trips into an Open state and stops polling for new messages for the duration of a specified configurable trip timeout.</p>
</div>
<div class="paragraph">
<p>Once the timeout has elapsed, the circuit goes into a Half-Open, state consuming a single message from the Anypoint MQ queue to test if the external error has been resolved. If successful, the circuit goes back into a Closed state and the &lt;anypoint-mq:subscriber /&gt; continues normal message processing. If unsuccessful, the circuit goes back into an Open state until the timeout has elapsed once again.</p>
</div>
<div class="paragraph">
<p>By default, the circuit breaking feature is disabled. In this section, you augment the &lt;anypoint-mq:subscriber /&gt; with circuit breaking capability, to control how the Anypoint MQ Connector handles errors that occur while processing a consumed message.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p><strong>Add Anypoint MQ Connector global Circuit Breaker:</strong> To <strong>global.xml</strong>, add &lt;anypoint-mq:circuit-breaker /&gt; to trip using the error types from the VM connector:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;anypoint-mq:circuit-breaker</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"vmConnectCircuitBreaker"</span>
  <span style="color: #268bd2">onErrorTypes=</span><span style="color: #859900">"VM:CONNECTIVITY, VM:QUEUE_TIMEOUT"</span>
  <span style="color: #268bd2">errorsThreshold=</span><span style="color: #859900">"1"</span>
  <span style="color: #268bd2">tripTimeout=</span><span style="color: #859900">"120"</span>
  <span style="color: #268bd2">tripTimeoutUnit=</span><span style="color: #859900">"SECONDS"</span><span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The errorThreshold argument configures the max number of the configured error type that must occur for the circuit breaker to trip into an open state.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The tripTimeout argument configures how long the circuit remains in an open state once the errors threshold is reached.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You configure error types on which to trip the circuit. In this case, errors from the VM namespace; a VM queue is simulating the downstream system.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>An error occurrence counts only when the flow finishes with an error. By default, all error types count as a circuit failure.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>These values are artificially low for testing purposes.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Configure subscriber with Circuit Breaker:</strong> In <strong>main.xml</strong>, add to the &lt;anypoint-mq:subscriber /&gt; a reference to the global Circuit Breaker configuration:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;anypoint-mq:subscriber</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"amqConfig"</span> <span style="color: #268bd2">destination=</span><span style="color: #859900">"cancelled-flights-mobile-queue-dev"</span> <span style="color: #268bd2">acknowledgementMode=</span><span style="color: #859900">"MANUAL"</span> <span style="color: #268bd2">circuitBreaker=</span><span style="color: #859900">"vmConnectCircuitBreaker"</span><span style="color: #b58900">&gt;</span>
  ...
<span style="color: #b58900">&lt;/anypoint-mq:subscriber&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Simulate VM Connector error:</strong> To <strong>global.xml</strong>, modify the VM Connector configuration to only allow one outstanding message on the queue:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;vm:config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"mobileAppNetworkVMConfig"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:queues&gt;</span>
    <span style="color: #b58900">&lt;vm:queue</span> <span style="color: #268bd2">queueName=</span><span style="color: #859900">"mobile-app-native-notifs-q"</span> <span style="color: #268bd2">maxOutstandingMessages=</span><span style="color: #859900">"1"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/vm:queues&gt;</span>
<span style="color: #b58900">&lt;/vm:config&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Tune log config:</strong> Change <strong>log4j2-test.xml</strong> to show DEBUG log entries created by the <strong>com.mulesoft.extension.mq</strong> logger:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">log4j2.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;AsyncLogger</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"com.mulesoft.extension.mq"</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"DEBUG"</span><span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run <strong>mobile-notifications-eapp</strong>, invoke the <strong>AnyAirline</strong> hosted <strong>flights-management-sapi</strong> to populate the queue and observe the mobile-notifications-eapp log entries, paying close attention to the Notify Circuit messages and the delay between attempts at picking up messages which should correspond with the configured trip timeout property:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If more than one client subscribes to the same queue, you must send multiple requests as they will be competing consumers, consuming the message before another client can.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Extract all hard-coded configuration values into environment-dependent and independent configuration properties as necessary.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-validation"><a class="anchor" href="#module-validation"></a><a class="link" href="#module-validation">Module 3: Validating messages</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you use various modules and techniques to implement message validation across Mule flows and Mule apps.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Validate Mule events.</p>
</li>
<li>
<p>Validate XML messages.</p>
</li>
<li>
<p>Validate JSON messages.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-231"><a class="anchor" href="#wt-begin-231"></a><a class="link" href="#wt-begin-231">Walkthrough 3-1: Validate Mule events</a></h3>
<div class="paragraph">
<p>The flights-management-sapi Mule app implemented earlier receives flight from the Flights Management system in XML format via an HTTP callback. Because this HTTP callback endpoint does not use APIkit for contract enforcement and is not protected by API Manager policies, invalid messages can be published to the VM queue.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you enhance flights-management-sapi to validate that the minimum pre-conditions are met before storing the cancellation notifications.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_filter_http_post_requests_with_empty_bodies_or_the_wrong_content_type_using_the_validation_module">Filter HTTP POST requests with empty bodies or the wrong content-type using the Validation module</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_10"><a class="anchor" href="#_solution_file_10"></a><a class="link" href="#_solution_file_10">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module03/wt3-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_9"><a class="anchor" href="#_starting_file_9"></a><a class="link" href="#_starting_file_9">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module02/wt2-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filter_http_post_requests_with_empty_bodies_or_the_wrong_content_type_using_the_validation_module"><a class="anchor" href="#_filter_http_post_requests_with_empty_bodies_or_the_wrong_content_type_using_the_validation_module"></a><a class="link" href="#_filter_http_post_requests_with_empty_bodies_or_the_wrong_content_type_using_the_validation_module">Filter HTTP POST requests with empty bodies or the wrong content-type using the Validation module</a></h4>
<div class="paragraph">
<p>In this section, you use the Validation module to validate that the received HTTP request meets the minimum requirements before publishing to the VM queue.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Confirm Maven dependency management:</strong> In <strong>bom/pom.xml</strong>, locate the existing dependency management entries for the Validation module, which has artifact ID mule-validation-module.</p>
</li>
<li>
<p><strong>Add Maven dependency:</strong> Add the corresponding Maven dependency for the Validation module to the <strong>POM</strong> of <strong>flights-management-sapi</strong>; confirm that Studio loads the module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-validation-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; element so that the version managed in the BOM takes effect.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Validate Content-type:</strong> Immediately after the &lt;http:listener /&gt; that accepts HTTP POST requests from the Flights Management system, add a Validation module component configured with a DataWeave expression that validates the Content-type HTTP header is an XML variant: text/xml or application/xml:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;validation:is-true</span>
    <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[var ct = attributes.headers.'content-type' --- ((not isBlank(ct)) and (lower(ct) contains '/xml'))]"</span><span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You store the content-type header in a variable first as it is accessed multiple times.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You first verify the header is not empty before performing String operations upon it.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You lowercase the header value to perform consistent String comparisons.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Validate payload:</strong> Add another Validation module component, this time validating the payload is not empty:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;validation:is-not-blank-string</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[payload.^raw]"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Payload is missing"</span><span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the specific is-not-blank-string operation from the Validation module; You can use other Validation module operations in conjunction with DataWeave expressions to configure the same functionality.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the raw DataWeave selector to validate the raw underlying String, instead of the DataWeave object automatically created.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Store original payload:</strong> Immediately after the &lt;http:listener /&gt; store the original payload in a variable as plain text, avoiding issues with invalid payloads:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"originalPayload"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output text/plain --- payload.^raw]"</span><span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This variable will be used to return to clients in case of errors.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the raw payload value output in a simplistic text/plain format as the payload has not been validated at this point and could contain anything.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Catch validation errors:</strong> Add an error handler containing an on-error-continue scope that sets the appropriate HTTP status code and response body to the original payload stored previously:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #b58900">/&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue</span> <span style="color: #268bd2">when=</span><span style="color: #859900">"#[['VALIDATION'] contains error.errorType.namespace]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"httpStatus"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"400"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"response"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output text/plain --- vars.originalPayload]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>No further validation is done before sending the XML doc to the VM queue in order not to slow down accepting these HTTP POST requests.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use an array of module namespaces as others will be added in a later walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send a few cancellation notifications to the callback; observe the corresponding log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/plain"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"invalid content type"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">""</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"invalid content"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Most invalid requests are now correctly validated before being sent to the VM queue. Some invalid HTTP POST bodies are still sent to the VM queue as they are not are syntactically checked. In the next walkthrough, you will add syntactical validation before sending it to the queue.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-232"><a class="anchor" href="#wt-begin-232"></a><a class="link" href="#wt-begin-232">Walkthrough 3-2: Validate XML messages</a></h3>
<div class="paragraph">
<p>The flights-management-sapi Mule app implemented earlier receives flight cancellation notifications from the Flights Management system in XML format via an HTTP POST request. Each notification is transformed into JSON-formatted flight canceled events, which are sent to an Anypoint MQ exchange. Because message-based integration of this kind is not covered by an automatically enforced contract like an API specification, neither the incoming XML messages nor the outgoing JSON messages are syntactically checked.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you enhance flights-management-sapi to validate incoming XML messages against an XML-Schema.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_import_xml_module">Import XML module</a>.</p>
</li>
<li>
<p><a href="#_create_an_xml_schema">Create an XML-Schema</a>.</p>
</li>
<li>
<p><a href="#_validate_an_xml_document_against_an_xml_schema">Validate an XML document against an XML-Schema</a>.</p>
</li>
<li>
<p><a href="#_validate_an_xml_document_leniently">Validate an XML document leniently</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_11"><a class="anchor" href="#_solution_file_11"></a><a class="link" href="#_solution_file_11">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module03/wt3-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_10"><a class="anchor" href="#_starting_file_10"></a><a class="link" href="#_starting_file_10">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module03/wt3-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_import_xml_module"><a class="anchor" href="#_import_xml_module"></a><a class="link" href="#_import_xml_module">Import XML module</a></h4>
<div class="paragraph">
<p>In this section, you import the XML module in flights-management-sapi to use utility operations for validating XML Messages against a XML-Schema.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Confirm Maven dependency management:</strong> In <strong>bom/pom.xml</strong>, locate the existing dependency management entries for the XML module, which has artifact ID mule-xml-module.</p>
</li>
<li>
<p><strong>Add Maven dependency:</strong> Add the corresponding Maven dependency for the XML module to the <strong>POM</strong> of flights-management-sapi; confirm that Studio loads the module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-xml-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; element so that the version managed in the BOM takes effect.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_an_xml_schema"><a class="anchor" href="#_create_an_xml_schema"></a><a class="link" href="#_create_an_xml_schema">Create an XML-Schema</a></h4>
<div class="paragraph">
<p>In this section, you generate an XML-Schema for validating XML Messages against using a sample XML document.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Generate cancellation notifications XML-Schema:</strong> In the XML-Schema at <strong><a href="https://www.freeformatter.com/xsd-generator.html" class="bare">https://www.freeformatter.com/xsd-generator.html</a></strong> generate an XML-Schema from the sample cancellation notifications XML:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;CancellationNotification&gt;</span>
  <span style="color: #b58900">&lt;PNR&gt;</span>PNR123<span style="color: #b58900">&lt;/PNR&gt;</span>
  <span style="color: #b58900">&lt;PassengerLastName&gt;</span>Mule<span style="color: #b58900">&lt;/PassengerLastName&gt;</span>
<span style="color: #b58900">&lt;/CancellationNotification&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create XML-Schema file:</strong> Create XML-Schema file <strong>CancellationNotification.xsd</strong> in a new directory <strong>src/main/resources/schemas</strong> copying the contents of the generated XML-Schema:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">CancellationNotification.xsd of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;xs:schema</span> <span style="color: #268bd2">attributeFormDefault=</span><span style="color: #859900">"unqualified"</span> <span style="color: #268bd2">elementFormDefault=</span><span style="color: #859900">"qualified"</span> <span style="color: #268bd2">xmlns:xs=</span><span style="color: #859900">"http://www.w3.org/2001/XMLSchema"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;xs:element</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"CancellationNotification"</span><span style="color: #b58900">&gt;</span>
  	<span style="color: #b58900">&lt;xs:complexType&gt;</span>
	  <span style="color: #b58900">&lt;xs:sequence&gt;</span>
		  <span style="color: #b58900">&lt;xs:element</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"xs:string"</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"PNR"</span> <span style="color: #268bd2">minOccurs=</span><span style="color: #859900">"1"</span><span style="color: #b58900">/&gt;</span>
		  <span style="color: #b58900">&lt;xs:element</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"xs:string"</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"PassengerLastName"</span> <span style="color: #268bd2">minOccurs=</span><span style="color: #859900">"1"</span><span style="color: #b58900">/&gt;</span>
	  <span style="color: #b58900">&lt;/xs:sequence&gt;</span>
    <span style="color: #b58900">&lt;/xs:complexType&gt;</span>
  <span style="color: #b58900">&lt;/xs:element&gt;</span>
<span style="color: #b58900">&lt;/xs:schema&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_validate_an_xml_document_against_an_xml_schema"><a class="anchor" href="#_validate_an_xml_document_against_an_xml_schema"></a><a class="link" href="#_validate_an_xml_document_against_an_xml_schema">Validate an XML document against an XML-Schema</a></h4>
<div class="paragraph">
<p>In this section, you use the &lt;xml-module:validate-schema /&gt; component to validate incoming XML Messages against the generated XML-Schema.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p><strong>Validate XML messages against an XML-Schema:</strong> Replace the Validation module component validating the payload with an &lt;xml-module:validate-schema /&gt; component defining the location of CancellationNotification.xsd created previously:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #b58900">/&gt;</span>
  ...
  <span style="color: #b58900">&lt;xml-module:validate-schema</span> <span style="color: #268bd2">schemas=</span><span style="color: #859900">"schemas/CancellationNotification.xsd"</span><span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>XML-Schema validation overrides the need to validate empty payloads.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Catch validation errors:</strong> Add to the error handler, the XML module namespace to catch any validation errors:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #b58900">/&gt;</span>
  ...
  <span style="color: #b58900">&lt;error-handler&gt;</span>
    <span style="color: #b58900">&lt;on-error-continue</span> <span style="color: #268bd2">when=</span><span style="color: #859900">"#[['VALIDATION', 'XML-MODULE'] contains error.errorType.namespace]"</span><span style="color: #b58900">&gt;</span>
    ...
    <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
  <span style="color: #b58900">&lt;/error-handler&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send a few cancellation notifications to the callback; observe the corresponding log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/plain"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"invalid content type"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">""</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"invalid content"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>All invalid requests are now correctly validated before being sent to the VM queue.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_validate_an_xml_document_leniently"><a class="anchor" href="#_validate_an_xml_document_leniently"></a><a class="link" href="#_validate_an_xml_document_leniently">Validate an XML document leniently</a></h4>
<div class="paragraph">
<p>The Robustness principle, also known as Postels Law, states that you should be conservative in what you send and liberal in what you accept from others. In this section, you update the XML-Schema, to implement the Robustness principle and leniently validate the received cancellation notifications, only validating required fields to make integrations more resilient to changes from other systems.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send cancellation notifications to the callback with an additional field for the Passenger&#8217;s first name; this should fail:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;PassengerFirstName&gt;Max&lt;/PassengerFirstName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Update XML-Schema file:</strong> Update <strong>CancellationNotification.xsd</strong> adding an xsd:any element with lax validation to the CancellationNotification complex type:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">CancellationNotification.xsd of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;xs:schema</span> <span style="color: #268bd2">attributeFormDefault=</span><span style="color: #859900">"unqualified"</span> <span style="color: #268bd2">elementFormDefault=</span><span style="color: #859900">"qualified"</span> <span style="color: #268bd2">xmlns:xs=</span><span style="color: #859900">"http://www.w3.org/2001/XMLSchema"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;xs:element</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"CancellationNotification"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;xs:complexType&gt;</span>
    <span style="color: #b58900">&lt;xs:sequence&gt;</span>
     <span style="color: #b58900">&lt;xs:element</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"xs:string"</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"PNR"</span> <span style="color: #268bd2">minOccurs=</span><span style="color: #859900">"1"</span><span style="color: #b58900">/&gt;</span>
     <span style="color: #b58900">&lt;xs:element</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"xs:string"</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"PassengerLastName"</span> <span style="color: #268bd2">minOccurs=</span><span style="color: #859900">"1"</span><span style="color: #b58900">/&gt;</span>
     <span style="color: #b58900">&lt;xs:any</span> <span style="color: #268bd2">processContents=</span><span style="color: #859900">"lax"</span> <span style="color: #268bd2">minOccurs=</span><span style="color: #859900">"0"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/xs:sequence&gt;</span>
    <span style="color: #b58900">&lt;/xs:complexType&gt;</span>
  <span style="color: #b58900">&lt;/xs:element&gt;</span>
<span style="color: #b58900">&lt;/xs:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The &lt;xs:any /&gt; element enables the author to extend the XML document with elements not specified by the schema.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>A minOccurs value of 0 allows zero or more occurrences of that element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Setting the processContents flag to lax instructs the XML processor to not validate any elements where the schema cannot be obtained.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Similar functionality exists for JSON-Schema using the additionalProperties keyword.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Other approaches to lenient validation include extracting individual fields using DataWeave or XPath and validating them using the Validation module.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send cancellation notifications to the callback with an additional field for the passenger&#8217;s first name; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;PassengerFirstName&gt;Max&lt;/PassengerFirstName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-233"><a class="anchor" href="#wt-begin-233"></a><a class="link" href="#wt-begin-233">Walkthrough 3-3: Validate JSON messages</a></h3>
<div class="paragraph">
<p>In flights-management-sapi Mule app, cancellation notifications are transformed into internally controlled JSON-formatted flight canceled events. Although internally controlled, it can be advantageous to use defensive programming methods such as Design By Contract(DBC) to improve code quality and understanding.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you enhance flights-management-sapi to validate outgoing JSON messages against a JSON-Schema.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_import_json_module">Import JSON module</a>.</p>
</li>
<li>
<p><a href="#_create_a_json_schema">Create a JSON-Schema</a>.</p>
</li>
<li>
<p><a href="#_validate_a_json_document_against_a_json_schema">Validate a JSON document against a JSON-Schema</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_12"><a class="anchor" href="#_solution_file_12"></a><a class="link" href="#_solution_file_12">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module03/wt3-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_11"><a class="anchor" href="#_starting_file_11"></a><a class="link" href="#_starting_file_11">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module03/wt3-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_import_json_module"><a class="anchor" href="#_import_json_module"></a><a class="link" href="#_import_json_module">Import JSON module</a></h4>
<div class="paragraph">
<p>In this section, you import the JSON module in flights-management-sapi to use utility operations for validating JSON Messages against a JSON-Schema.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Confirm Maven dependency management:</strong> In <strong>bom/pom.xml</strong>, locate the existing dependency management entries for the JSON module, which has artifact ID mule-json-module.</p>
</li>
<li>
<p><strong>Add Maven dependency:</strong> Add the corresponding Maven dependency for the JSON module to the <strong>POM</strong> of flights-management-sapi; confirm that Studio loads the module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-json-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; element so that the version managed in the BOM takes effect.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_json_schema"><a class="anchor" href="#_create_a_json_schema"></a><a class="link" href="#_create_a_json_schema">Create a JSON-Schema</a></h4>
<div class="paragraph">
<p>In this section, you generate an JSON-Schema for validating JSON Messages against using a sample JSON document.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Generate flight canceled events JSON-Schema:</strong> At <strong><a href="https://jsonschema.net/" class="bare">https://jsonschema.net/</a></strong>, generate a JSON-Schema from the sample flight canceled events JSON:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">{
  "pnr":"PNR123",
  "lastNameOfPassenger":"Mule"
}</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create JSON-Schema file:</strong> Create JSON-Schema file <strong>FlightCancelledEvent.schema.json</strong> in <strong>src/main/resources/schemas</strong> copying the contents of the generated JSON-Schema:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">FlightCancelledEvent.schema.json of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">{
   "definitions": {},
   "$schema": "http://json-schema.org/draft-07/schema#",
   "$id": "http://training.mulesoft.com/FlightCancelledEvent.schema.json",
   "type": "object",
   "title": "FlightCancelledEvent",
   "properties": {
     "pnr": {
       "$id": "#/properties/pnr",
       "type": "string",
       "examples": [
         "PNR123"
       ]
     },
     "lastNameOfPassenger": {
       "$id": "#/properties/lastNameOfPassenger",
       "type": "string",
       "examples": [
         "Mule"
       ]
     }
   },
   "required": ["pnr", "lastNameOfPassenger"]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As the data structure is internally controlled, you can make use of the first statement of Postel&#8217;s Law, to be conservative in what you send.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_validate_a_json_document_against_a_json_schema"><a class="anchor" href="#_validate_a_json_document_against_a_json_schema"></a><a class="link" href="#_validate_a_json_document_against_a_json_schema">Validate a JSON document against a JSON-Schema</a></h4>
<div class="paragraph">
<p>In this section, you use the &lt;json-module:validate-schema /&gt; component to validate outgoing JSON Messages against the generated JSON-Schema.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p><strong>Validate JSON messages against a JSON-Schema:</strong> Add a &lt;json-module:validate-schema /&gt; component defining the location of FlightCancelledEvent.schema.json created previously:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;ee:transform</span> <span style="color: #268bd2">doc:name=</span><span style="color: #859900">"To Flight Cancelled Event"</span><span style="color: #b58900">&gt;</span>
      ...
    <span style="color: #b58900">&lt;/ee:transform&gt;</span>

    <span style="color: #b58900">&lt;json:validate-schema</span> <span style="color: #268bd2">schema=</span><span style="color: #859900">"schemas/FlightCancelledEvent.schema.json"</span> <span style="color: #b58900">/&gt;</span>
    ...
  <span style="color: #b58900">&lt;/try&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Although the JSON format is internally controlled, you use Design by Contract (DBC) postconditions to assert the transformation correctly changed the message state. You can disable this in production environments for performance.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The existing on-error-continue error handler already handles all validation errors and commits the ongoing transaction, thereby preventing redelivery of the message.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Modify JSON-Schema:</strong> Temporarily modify FlightCancelledEvent.schema.json configuring pnr to be a number type:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">FlightCancelledEvent.schema.json of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">{
   ...
   "properties": {
     "pnr": {
       "$id": "#/properties/pnr",
       "type": "number",
       "examples": [
         "PNR123"
       ]
     },
     ...
  }
}</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send valid cancellation notifications to the callback; observe the corresponding log entries for the validation errors:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Revert JSON-Schema:</strong> Revert FlightCancelledEvent.schema.json configuring pnr back to a string type:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">FlightCancelledEvent.schema.json of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">{
   ...
   "properties": {
     "pnr": {
       "$id": "#/properties/pnr",
       "type": "string",
       "examples": [
         "PNR123"
       ]
     },
     ...
  }
}</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-orchestration"><a class="anchor" href="#module-orchestration"></a><a class="link" href="#module-orchestration">Module 4: Orchestrating integration functionality</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you apply essential Enterprise Integration Patterns to orchestrate multiple Mule apps and API invocations.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parallelize integration logic.</p>
</li>
<li>
<p>Trace transactions across an application network.</p>
</li>
<li>
<p>Retry failed API invocations.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-241"><a class="anchor" href="#wt-begin-241"></a><a class="link" href="#wt-begin-241">Walkthrough 4-1: Parallelize integration logic</a></h3>
<div class="paragraph">
<p>The invocations of the three System APIs in the check-in functionality of check-in-papi are independent of each other and should therefore be performed in parallel to reduce the overall latency. This walkthrough enhances check-in-papi with parallel API invocations using the Scatter-Gather router.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you parallelize the three System API invocations using the Scatter-Gather router. Importantly, you implement error handling to compensate for successful API invocations in the case that at least one of the other API invocations have failed.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_invoke_independent_apis_concurrently_using_the_scatter_gather_router">Invoke independent APIs concurrently using the Scatter-Gather router</a>.</p>
</li>
<li>
<p><a href="#_handle_errors_in_one_or_more_routes_of_a_scatter_gather_router">Handle errors in one or more routes of a Scatter-Gather router</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_13"><a class="anchor" href="#_solution_file_13"></a><a class="link" href="#_solution_file_13">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module04/wt4-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_12"><a class="anchor" href="#_starting_file_12"></a><a class="link" href="#_starting_file_12">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module01/wt1-4_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_invoke_independent_apis_concurrently_using_the_scatter_gather_router"><a class="anchor" href="#_invoke_independent_apis_concurrently_using_the_scatter_gather_router"></a><a class="link" href="#_invoke_independent_apis_concurrently_using_the_scatter_gather_router">Invoke independent APIs concurrently using the Scatter-Gather router</a></h4>
<div class="paragraph">
<p>In this section, you parallelize all independent System API invocations using the Scatter-Gather router and modify any post-processing to use the newly created event structure.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study current check-in logic:</strong> In <strong>check-in-by-pnr</strong> of check-in-papi <strong>main.xml</strong>, review the flow references for each System API dependency and note that all are independent from one another but still sequentially called.</p>
</li>
<li>
<p><strong>Parallelize flow references:</strong> Encapsulate the flow references for each System API in a Scatter-Gather router:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;scatter-gather&gt;</span>
    <span style="color: #b58900">&lt;route&gt;</span>
      <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/route&gt;</span>
    <span style="color: #b58900">&lt;route&gt;</span>
      <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-passenger-data"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/route&gt;</span>
    <span style="color: #b58900">&lt;route&gt;</span>
      <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/route&gt;</span>
  <span style="color: #b58900">&lt;/scatter-gather&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Scatter-Gather router combines the Mule events returned by each processing route into a new Mule event that is passed to the next event processor only after every route completes successfully.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Access route result:</strong> Modify the transformation to access the result of the PayPal SAPI create-payment-for-bags flow reference:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;scatter-gather&gt;</span>
    ...
  <span style="color: #b58900">&lt;/scatter-gather&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
        output application/json
        var paypalReturn = payload['2'].payload
        ---
        {
          paymentID: paypalReturn.paymentID
        }]]&gt;</span><span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The combined Mule event is a map structure where each key is an integer that identifies the index of each route. The create-payment-for-bags is the third route called and the Scatter-Gather router uses a zero-based index, so the result is accessed using index two.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite of check-in-papi; this should fail because the exception path tests assume an error type that is subsumed by the Scatter-Gather router:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Disable failing tests:</strong> To <strong>main-test-suite.xml</strong>, ignore the test for <strong>check-in-by-pnr-exception-path-test</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main-test-suite.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;munit:test</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr-exception-path-test"</span> <span style="color: #268bd2">ignore=</span><span style="color: #859900">"true"</span><span style="color: #b58900">&gt;</span>
...
<span style="color: #b58900">&lt;/munit:test&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>MUnit-test:</strong> Run the MUnit test suite; this should now succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> <strong>Update tests.</strong> Adapt the MUnit test suite to changes in invoked APIs.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_handle_errors_in_one_or_more_routes_of_a_scatter_gather_router"><a class="anchor" href="#_handle_errors_in_one_or_more_routes_of_a_scatter_gather_router"></a><a class="link" href="#_handle_errors_in_one_or_more_routes_of_a_scatter_gather_router">Handle errors in one or more routes of a Scatter-Gather router</a></h4>
<div class="paragraph">
<p>Sending messages to multiple APIs, whether sequentially or in parallel, does not provide transactional guarantees: One API invocation may succeed while the next API invocation may fail, leaving the overall system in an inconsistent state. Sequential API invocations may stop any subsequent API invocations if a failure occurs, but any previous successful API invocations may still leave the system in an inconsistent state. Parallelizing API invocations with the Scatter-Gather router increases the number of successful API invocations if a failure occurs in any particular route thus increasing the amount of system inconsistency. However, some actions can be reversed, for example, a passenger successfully checked-in to a flight can be removed if the payment for bags fails.</p>
</div>
<div class="paragraph">
<p>In this section, you handle errors raised from the Scatter-Gather router. Using the Scatter-Gather router results, calculate any successful routes, invoking specific Mule flows to compensate for or reverse any actions created by the route.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p><strong>Study test failures:</strong> Observe the log and note the error being raised of the expected error type no longer matching the actual error type: <strong>MULE:COMPOSITE_ROUTING</strong>.</p>
</li>
<li>
<p><strong>Catch routing errors:</strong> Encapsulate the entire processing in a Try scope configured with an error handler containing an on-error-propagate scope catching the MULE:COMPOSITE_ROUTING. The scope should set two variables identifying all successful and failed routes:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;scatter-gather&gt;</span>
    ...
    <span style="color: #b58900">&lt;/scatter-gather&gt;</span>
    <span style="color: #b58900">&lt;error-handler&gt;</span>
      <span style="color: #b58900">&lt;on-error-propagate</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"MULE:COMPOSITE_ROUTING"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successfulRouteIndexes"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[(error.errorMessage.payload.results pluck $$ as Number)]"</span><span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"failedRouteIndexes"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[(error.errorMessage.payload.failures pluck $$ as Number)]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/on-error-propagate&gt;</span>
    <span style="color: #b58900">&lt;/error-handler&gt;</span>
  <span style="color: #b58900">&lt;/try&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Errors occurring in any route, causing the route to fail, will in turn cause the Scatter-Gather router to throw a MULE:COMPOSITE_ROUTING error.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a failure occurs, the results of both the successful and failed routes are contained in the error itself.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If a failure occurs in one route, it does not affect other routes as they are executed in parallel. This can lead to inconsistent data across each of the System APIs. To remedy this, you can use compensating transactions that can undo any event caused by the successful routes, which will lead to eventual consistency across each of the System APIs.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The DataWeave pluck function is used to iterate over the returned object and create an array of all successful and failed route indexes using the $$ operator to retrieve the key of each route. These two arrays of route indexes can then be used to determine any compensation logic required for successful routes.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create compensation Mule flows:</strong> To <strong>main.xml</strong>, add the three Mule flows, one for each of the routes of the Scatter-Gather router, and store each flow name with its corresponding route index in a variable before invoking the Scatter-Gather router:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"allCompensationFlows"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[ ['check-in-flights-management-compensate', 'register-passenger-data-compensate', 'create-payment-for-bags-compensate'] ]"</span><span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;scatter-gather&gt;</span>
    ...
    <span style="color: #b58900">&lt;/scatter-gather&gt;</span>
  <span style="color: #b58900">&lt;/try&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-flights-management-compensate"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Must compensate for successful check-in-flights-management"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"register-passenger-data-compensate"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Must compensate for successful register-passenger-data"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"create-payment-for-bags-compensate"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Must compensate for successful create-payment-for-bags"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This implementation just logs when the compensation route is invoked. Realistically, each flow would contain logic to undo any action performed by the corresponding route, for example, executing an API invocation to remove a passenger from a flight.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reflect:</strong> Discuss what each of these compensation API resources would have to do in practice.</p>
</li>
<li>
<p><strong>Invoke compensation Mule flows:</strong> To the error handler in check-in-by-pnr add a variable to calculate the successful route indexes and create a list of all compensation Mule flows to be invoked. Create and reference a new Mule flow to iterate the list of successful routes and dynamically invoke the corresponding compensation flow:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;scatter-gather&gt;</span>
    ...
    <span style="color: #b58900">&lt;/scatter-gather&gt;</span>
    <span style="color: #b58900">&lt;error-handler&gt;</span>
      <span style="color: #b58900">&lt;on-error-propagate</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"MULE:COMPOSITE_ROUTING"</span><span style="color: #b58900">&gt;</span>
        ...
         <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successfulRouteIndexes"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[(error.errorMessage.payload.results pluck $$ as Number)]"</span><span style="color: #b58900">/&gt;</span>
         <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"failedRouteIndexes"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[(error.errorMessage.payload.failures pluck $$ as Number)]"</span><span style="color: #b58900">/&gt;</span>
         <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"compensationFlows"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[vars.successfulRouteIndexes map vars.allCompensationFlows[$]]"</span><span style="color: #b58900">/&gt;</span>
		    <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"compensate-successful-routes-of-check-in-by-pnr"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/on-error-propagate&gt;</span>
    <span style="color: #b58900">&lt;/error-handler&gt;</span>
  <span style="color: #b58900">&lt;/try&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"compensate-successful-routes-of-check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;foreach</span> <span style="color: #268bd2">collection=</span><span style="color: #859900">"#[vars.compensationFlows]"</span><span style="color: #b58900">&gt;</span>
	<span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"#[payload]"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/foreach&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Misconfigure API dependency:</strong> In global.xml, prepend <strong>X</strong> to the host property for PayPal SAPI, thereby making all invocations to that API fail:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"paypalSapiConfig"</span>
  <span style="color: #268bd2">basePath=</span><span style="color: #859900">"..."</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection</span>
    <span style="color: #268bd2">host=</span><span style="color: #859900">"Xtngaa-paypal-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io"</span><span style="color: #b58900">&gt;</span>
      ...
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app, and invoke the check-in API, and observe the check-in-papi log entries, paying close attention the log statements from the corresponding compensation flows:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Revert misconfiguration:</strong> Undo the misconfiguration of the host in global.xml.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-242"><a class="anchor" href="#wt-begin-242"></a><a class="link" href="#wt-begin-242">Walkthrough 4-2: Trace transactions across an application network using correlation IDs</a></h3>
<div class="paragraph">
<p>flight canceled events in the mobile-notifications-eapp originate from multiple distributed Mule apps in the application network. cancellation notifications are POSTed from the Flights Management system to the flights-management-sapi, sent to a persistent VM queue, and subsequently transformed to flight canceled events and sent to an Anypoint MQ queue. Only then is the mobile-notifications-eapp aware of the message.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you trace cancellation notifications from flights-management-sapi through to flight canceled events in mobile-notifications-eapp. You review how correlation IDs propagate across various transports. Then you modify the publishing and consuming of flight canceled events to use an Anypoint MQ custom property to manually propagate correlation IDs.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_follow_transactions_across_api_invocations">Follow transactions across API invocations</a>.</p>
</li>
<li>
<p><a href="#_follow_transactions_propagated_via_vm_messages">Follow transactions propagated via VM messages</a>.</p>
</li>
<li>
<p><a href="#_follow_transactions_propagated_via_anypoint_mq_messages">Follow transactions propagated via Anypoint MQ messages</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_14"><a class="anchor" href="#_solution_file_14"></a><a class="link" href="#_solution_file_14">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module04/wt4-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_13"><a class="anchor" href="#_starting_file_13"></a><a class="link" href="#_starting_file_13">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module03/wt3-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_follow_transactions_across_api_invocations"><a class="anchor" href="#_follow_transactions_across_api_invocations"></a><a class="link" href="#_follow_transactions_across_api_invocations">Follow transactions across API invocations</a></h4>
<div class="paragraph">
<p>In this section, you  using an account with sufficient entitlements, or an instructor, perform a distributed log search in Anypoint Monitoring to track a distributed transaction across multiple Mule apps. This is a licensed feature that is not available with trial accounts, which is why you must have an account with sufficient entitlements or demonstrated by an instructor.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study Solution Architecture:</strong> Study the solution design for US2: Flight Cancellation mobile Notifications in the <a href="#section-aa-solution-arch">Solution architecture</a>.</p>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Invoke <strong>check-in-papi</strong>, inspect the log entries, and copy logged correlation ID:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Navigate to Anypoint Monitoring:</strong> Using credentials with sufficient permissions, log in to the AnyAirline Anypoint Platform organization and navigate to Anypoint Monitoring.</p>
</li>
<li>
<p><strong>Search logs:</strong> Using the correlation ID, perform a distributed log search and inspect the search results spanning multiple Mule apps, including the downstream System APIs.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Surround the search string in double quotes for an exact match:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #859900">"65f8af40-0d30-11eb-93c7-12742c9eae8f"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Expand your time range if there is no matching data.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Mule automatically generates a correlation ID for every Mule event unless one is already set or propagated from another Mule app.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The HTTP Connector makes use of the X-CORRELATION-ID HTTP request header to propagate the correlation ID across HTTP requests.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Transports like HTTP automatically send the correlation ID by default, this can be configured on each transports global configuration.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, correlation IDs are a Java Universally Unique Identifier (UUID) string. You can override the default format by using the global configuration component and setting the DataWeave expression for generating correlation IDs. Although it is best to avoid making changes to the correlation ID generator, you might need to format the correlation ID for the events if your company has its own standard or format for correlation IDs, for example.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_follow_transactions_propagated_via_vm_messages"><a class="anchor" href="#_follow_transactions_propagated_via_vm_messages"></a><a class="link" href="#_follow_transactions_propagated_via_vm_messages">Follow transactions propagated via VM messages</a></h4>
<div class="paragraph">
<p>In this section, you publish cancellation notifications received from the Flights Management system to the configured VM queue and review how the correlation ID is propagated across the VM transport barrier.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p><strong>Review cancellation notifications VM queues:</strong> In <strong>main.xml</strong> of flights-management-sapi, review the Mule flows responsible for receiving an HTTP request, publishing to a VM queue, and reading from the VM queue:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"receive-cancellation-notification"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:listener</span> <span style="color: #b58900">/&gt;</span>
  ...
  <span style="color: #b58900">&lt;vm:publish</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"${vm.cancelNotif.q.name}"</span>
    <span style="color: #268bd2">sendCorrelationId=</span><span style="color: #859900">"ALWAYS"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span>
    <span style="color: #268bd2">queueName=</span><span style="color: #859900">"${vm.cancelNotif.q.name}"</span>
    <span style="color: #268bd2">transactionalAction=</span><span style="color: #859900">"ALWAYS_BEGIN"</span>
    <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"vmConfig"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;redelivery-policy</span>
      <span style="color: #268bd2">maxRedeliveryCount=</span><span style="color: #859900">"${vm.maxRedeliveryCount}"</span>
      <span style="color: #268bd2">idExpression=</span><span style="color: #859900">"#[correlationId]"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/vm:listener&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This code does not set or specify the correlation ID but rather just that redelivery of an event is identified by that event&#8217;s correlation ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The correlation ID is sent and propagated automatically.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The correlation ID of the current Mule event is available as a predefined variable in DataWeave.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run flights-management-sapi and send a cancellation notification to the callback; observe the corresponding log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule event&#8217;s correlation ID is typically created by the &lt;http:listener /&gt;, unless the correlation ID was sent by the HTTP client.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The default is for the correlation ID to be sent to the VM queue if one is present, which there is in this case.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Manually invoke with custom correlation ID:</strong> Modify the HTTP request to specify an <strong>X-CORRELATION-ID</strong> header and send a cancellation notification to the callback; observe the corresponding log entries:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"X-CORRELATION-ID: PNR123"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://localhost:8081/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As a custom correlation ID was set by the HTTP client, the &lt;http:listener /&gt; does not generate one. This is how a correlation ID can be passed from one API to another.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_follow_transactions_propagated_via_anypoint_mq_messages"><a class="anchor" href="#_follow_transactions_propagated_via_anypoint_mq_messages"></a><a class="link" href="#_follow_transactions_propagated_via_anypoint_mq_messages">Follow transactions propagated via Anypoint MQ messages</a></h4>
<div class="paragraph">
<p>In this section, you observe mobile-notifications-eapp consuming flight canceled events from an Anypoint MQ exchange and review how the correlation ID is propagated across the Anypoint MQ transport barrier. You modify the publishing and consuming of flight canceled events, to use a custom property to propagate correlation IDs, and use the Tracing module to update the correlation ID for a given Mule flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p><strong>Check log:</strong> Run <strong>mobile-notifications-eapp</strong> and observe the log entries from consuming the flight canceled events resulting from the previous cancellation notification requests.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The Anypoint MQ connector does not automatically propagate correlation IDs (in contrast to the JMS, VM, and HTTP connectors, for example).</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Publish:</strong> Update the Anypoint MQ publish operation in <strong>flights-management-sapi</strong> to send the correlationId as a custom property:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of flights-management-sapi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"deliver-flight-cancelled-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;vm:listener</span> <span style="color: #b58900">/&gt;</span>
  ...
  <span style="color: #b58900">&lt;choice&gt;</span>
    <span style="color: #b58900">&lt;when</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[vars.msgValid]"</span><span style="color: #b58900">&gt;</span>
      <span style="color: #b58900">&lt;anypoint-mq:publish</span>
        <span style="color: #268bd2">destination=</span><span style="color: #859900">"cancelled-flights-exchg-dev"</span>
        <span style="color: #268bd2">messageId=</span><span style="color: #859900">"#[correlationId]"</span>
        <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"amqConfig"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;anypoint-mq:properties</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
        ---
        {
          "correlationId" : correlationId
        }]]]&gt;</span>
        <span style="color: #b58900">&lt;/anypoint-mq:properties&gt;</span>
      <span style="color: #b58900">&lt;/anypoint-mq:publish&gt;</span>
    <span style="color: #b58900">&lt;/when&gt;</span>
  <span style="color: #b58900">&lt;/choice&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The ID of an Anypoint MQ message must be unique. Make sure to choose a unique custom ID to avoid unwanted side effects of duplicated IDs. In FIFO queues, messages with duplicate IDs are overwritten.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If you do not specify a message ID, then Anypoint MQ creates a new one.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the correlation ID that has been passed along this message from the start as the ID of the Anypoint MQ message.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Anypoint MQ messageId has no effect on the Mule message correlation ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>It may not be enough to rely on messageId for propagating the correlationId due to the unique constraints of the field. Therefore, it is recommended to use a custom property for propagating the correlation ID. You can define properties for outgoing messages, for example, to provide compatibility with other messaging systems or to communicate the content type of a message.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Log custom correlationId property:</strong> In <strong>mobile-notifications-eapp</strong>, after receiving the flight canceled event, update the log statement to log the correlationId user property field:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;anypoint-mq:subscriber</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"#['Retrieve cancellation event from queue: ' ++ (attributes.properties.correlationId default '')]"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use DataWeave to extract the custom user property from the received Anypoint MQ message.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Without additional modules, the Mule message correlationId field is immutable and can only be set by an event source. Therefore, when using Anypoint MQ, the value is always regenerated and you have to instead rely on a custom user property for tracing the transaction.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run <strong>mobile-notifications-eapp</strong>, invoke the AnyAirline-hosted <strong>flights-management-sapi</strong> in the <strong>dev</strong> environment to populate the queue, and observe the mobile-notifications-eapp log entries, paying close attention to the message correlation ID versus the logged user property correlation ID:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type:text/xml"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"&lt;CancellationNotification&gt;&lt;PNR&gt;PNR123&lt;/PNR&gt;&lt;PassengerLastName&gt;Mule&lt;/PassengerLastName&gt;&lt;/CancellationNotification&gt;"</span> https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/cancelFlight</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must send multiple requests as there are multiple clients subscribing to the same queue and consuming the message in a round-robin fashion.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add managed library dependency:</strong> Locate the existing dependency management of mule-tracing-module in the <strong>BOM</strong> and add a matching entry to the mobile-notifications-eapp <strong>POM</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
  	<span style="color: #b58900">&lt;artifactId&gt;</span>mule-tracing-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Process Mule flow with modified correlation ID:</strong> Wrap the entire Mule flow processing, including error handlers, inside a Try scope within a With Correlation ID scope setting the Mule event correlation ID to the correlationId user property field:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of mobile-notifications-eapp</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retrieve-cancellation-event"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;anypoint-mq:subscriber</span> <span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;tracing:with-correlation-id</span> <span style="color: #268bd2">correlationId=</span><span style="color: #859900">"#[attributes.properties.correlationId]"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;try&gt;</span>
    ...
    <span style="color: #b58900">&lt;/try&gt;</span>
  <span style="color: #b58900">&lt;/tracing:with-correlation-id&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Tracing module enables you to use the With Correlation ID scope to modify the correlation ID during the execution of said scope.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use a Try scope so that any errors raised within the With Correlation ID scope use the overriden correlation ID. Any error handlers outside of the With Correlation ID scope will use the original correlation ID if the With Correlation ID scope failed and prevented the scope from setting the new correlation ID.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run <strong>mobile-notifications-eapp</strong> and invoke the AnyAirline-hosted <strong>flights-management-sapi</strong> in the <strong>dev</strong> environment as before; log entries should now show the modified correlation ID.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-243"><a class="anchor" href="#wt-begin-243"></a><a class="link" href="#wt-begin-243">Walkthrough 4-3: Retry failed API invocations</a></h3>
<div class="paragraph">
<p>The check-in-papi Mule app implemented in previous walkthroughs invokes three System APIs and is only successful if all System API invocations are successful. Because each individual instance of an API invocation may fail for various reasons (many of them transient in nature), it is essential to retry failed API invocations to increase the chance of ultimate success.</p>
</div>
<div class="paragraph">
<p>When retrying API invocations, it is essential that the corresponding API implementation is idempotent. According to the HTTP spec, the implementations of GET, HEAD, OPTIONS, PUT, and DELETE (but not POST) to RESTful resources must be idempotent. This is the case for the three System APIs invoked by check-in-papi, so it&#8217;s legitimate to retry here. This walkthrough adds retry logic to check-in-papi.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you use the Until Successful scope to add retry logic to the flights-management-sapi HTTP Request configuration determining transient and permanent errors.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_use_the_until_successful_scope_to_retry_failed_api_invocations">Use the Until Successful scope to retry failed API invocations</a>.</p>
</li>
<li>
<p><a href="#_differentiate_between_transient_and_permanent_errors">Differentiate between transient and permanent errors</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_15"><a class="anchor" href="#_solution_file_15"></a><a class="link" href="#_solution_file_15">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module04/wt4-3_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_14"><a class="anchor" href="#_starting_file_14"></a><a class="link" href="#_starting_file_14">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module04/wt4-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_the_until_successful_scope_to_retry_failed_api_invocations"><a class="anchor" href="#_use_the_until_successful_scope_to_retry_failed_api_invocations"></a><a class="link" href="#_use_the_until_successful_scope_to_retry_failed_api_invocations">Use the Until Successful scope to retry failed API invocations</a></h4>
<div class="paragraph">
<p>In this section, you use the Until Successful scope with one of the System API HTTP Request configuration to retry failed API invocations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and invoke the check-in functionality it exposes; this should succeed, thereby confirming successful authentication with client ID and secret of check-in-papi against Flights Management SAPI in dev:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Misconfigure API dependency:</strong> In global.xml, prepend <strong>X</strong> to the username property for flights-management-sapi, thereby making all invocations to the flights-management-sapi fail:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http:request-config</span>
  <span style="color: #268bd2">name=</span><span style="color: #859900">"flightsManagementSapiConfig"</span>
  <span style="color: #268bd2">basePath=</span><span style="color: #859900">"/api/v1"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request-connection</span>
    <span style="color: #268bd2">host=</span><span style="color: #859900">"tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io"</span>
    <span style="color: #268bd2">protocol=</span><span style="color: #859900">"HTTPS"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:authentication&gt;</span>
      <span style="color: #b58900">&lt;http:basic-authentication</span>
        <span style="color: #268bd2">username=</span><span style="color: #859900">"X&lt;insert-your-client-id&gt;"</span>
        <span style="color: #268bd2">password=</span><span style="color: #859900">"&lt;insert-your-client-secret&gt;"</span> <span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/http:authentication&gt;</span>
  <span style="color: #b58900">&lt;/http:request-connection&gt;</span>
<span style="color: #b58900">&lt;/http:request-config&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the check-in API; this should fail, triggered internally by a <strong>HTTP:UNAUTHORIZED</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Retry flights-management-sapi HTTP Request configuration:</strong> In <strong>get-ticket-by-pnr</strong> of <strong>check-in-papi</strong> main.xml, encapsulate the Flights Management SAPI GET ticket HTTP Request configuration in an Until Successful scope configured to retry any failures a maximum of <strong>3 times</strong> with a <strong>1000 millisecond delay</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-ticket-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;until-successful</span> <span style="color: #268bd2">maxRetries=</span><span style="color: #859900">"#[3]"</span> <span style="color: #268bd2">millisBetweenRetries=</span><span style="color: #859900">"#[1000]"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"flightsManagementSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/tickets/{PNR}"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"ticket"</span> <span style="color: #268bd2">doc:name=</span><span style="color: #859900">"FMS Get Ticket"</span> <span style="color: #268bd2">doc:id=</span><span style="color: #859900">"2aaf810a-33e3-476d-9080-28ce3465dc2a"</span><span style="color: #b58900">&gt;</span>
			  <span style="color: #b58900">&lt;http:uri-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"PNR" : vars.PNR
}]]]&gt;</span><span style="color: #b58900">&lt;/http:uri-params&gt;</span>
	  <span style="color: #b58900">&lt;/http:request&gt;</span>
  <span style="color: #b58900">&lt;/until-successful&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Both configuration arguments support expressions.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This operation performs an HTTP GET requests and is expected to be idempotent. Therefore it can be retried upon failure.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Until Successful scope is synchronous and blocks further flow execution until complete.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If the Until Successful scope is ultimately unsuccessful, a MULE:RETRY_EXHAUSTED error is raised.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the check-in API; this should still ultimately fail, but the log should indicate that the request was retried three times:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Any error types propagated from the Until Successful scope are subsumed by the MULE:RETRY_EXHAUSTED error type.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Review error types:</strong> Review the possible error types that can be raised by the HTTP Connector.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>All error types, regardless whether they are transient in nature, are retried. Retrying permanent errors,such as HTTP:UNAUTHORIZED, is wasteful and increases overall latency as retries are unlikely to solve the issue.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_differentiate_between_transient_and_permanent_errors"><a class="anchor" href="#_differentiate_between_transient_and_permanent_errors"></a><a class="link" href="#_differentiate_between_transient_and_permanent_errors">Differentiate between transient and permanent errors</a></h4>
<div class="paragraph">
<p>In this section, you modify the Until Successful scope to only retry API invocations that are transient in nature.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p><strong>Catch permanent errors:</strong> Encapsulate the HTTP Request configuration operation in a Try scope configured with an error handler. Configure the error handler with an on-error-propagate scope to rethrow transient errors and an on-error-continue scope to consume known permanent errors and non-transient errors that originate from the same namespace so they are not retried. Configure a final on-error-propagate scope to rethrow non-transient errors that are unknown and originate outside of the module namespace. All error handlers must set a Boolean successful variable to false that is defaulted to true after invoking the Until Successful scope:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-ticket-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;until-successful</span> <span style="color: #268bd2">maxRetries=</span><span style="color: #859900">"#[3]"</span> <span style="color: #268bd2">millisBetweenRetries=</span><span style="color: #859900">"#[1000]"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;try&gt;</span>
      <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"flightsManagementSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/tickets/{PNR}"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"ticket"</span> <span style="color: #268bd2">doc:name=</span><span style="color: #859900">"FMS Get Ticket"</span> <span style="color: #268bd2">doc:id=</span><span style="color: #859900">"2aaf810a-33e3-476d-9080-28ce3465dc2a"</span><span style="color: #b58900">&gt;</span>
			  <span style="color: #b58900">&lt;http:uri-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"PNR" : vars.PNR
}]]]&gt;</span><span style="color: #b58900">&lt;/http:uri-params&gt;</span>
	  <span style="color: #b58900">&lt;/http:request&gt;</span>
    <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successful"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[true]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;error-handler&gt;</span>
        <span style="color: #b58900">&lt;on-error-propagate</span> <span style="color: #268bd2">when=</span><span style="color: #859900">"#[(['TOO_MANY_REQUESTS','INTERNAL_SERVER_ERROR','SERVICE_UNAVAILABLE','TIMEOUT','CONNECTIVITY'] contains error.errorType.identifier)]"</span><span style="color: #b58900">&gt;</span>
          <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successful"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;/on-error-propagate&gt;</span>
        <span style="color: #b58900">&lt;on-error-continue</span> <span style="color: #268bd2">when=</span><span style="color: #859900">"#[((error.errorType.namespace == 'HTTP') or (['EXPRESSION','STREAM_MAXIMUM_SIZE_EXCEEDED'] contains error.errorType.identifier))]"</span><span style="color: #b58900">&gt;</span>
          <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successful"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
        <span style="color: #b58900">&lt;on-error-propagate&gt;</span>
          <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successful"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;/on-error-propagate&gt;</span>
      <span style="color: #b58900">&lt;/error-handler&gt;</span>
    <span style="color: #b58900">&lt;/try&gt;</span>
  <span style="color: #b58900">&lt;/until-successful&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Although the HTTP Connector uses standard HTTP error types, it is not as simple as treating all 4xx HTTP statuses as permanent and all 5xx statuses as transient. For example, some 5xx error codes can be retried (such as 504 - Gateway Timeout, which may be transient). But others such as 501  Not Implemented are likely to be permanent in nature. Some HTTP APIs go as far as providing a HTTP response header indicating whether or not a request can be retried.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The error handler makes use of DataWeave expressions to validate only the error identifier for known transient errors, regardless of namespace. This will be useful later in the walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Handle MULE:RETRY_EXHAUSTED:</strong> Encapsulate the Until Successful scope operation in a Try scope configured with an error handler to consume the MULE:RETRY_EXHAUSTED error type if any errors ultimately fail:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-ticket-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;try&gt;</span>
    <span style="color: #b58900">&lt;until-successful&gt;</span>
      ...
    <span style="color: #b58900">&lt;/until-successful&gt;</span>
    <span style="color: #b58900">&lt;error-handler&gt;</span>
      <span style="color: #b58900">&lt;on-error-continue&gt;</span>
        <span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"successful"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;/on-error-continue&gt;</span>
    <span style="color: #b58900">&lt;/error-handler&gt;</span>
  <span style="color: #b58900">&lt;/try&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The multiple error handler levels are used to provide a consistent interface, otherwise transient errors would ultimately propagate and return an error after execution, whereas permanent errors would not.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the check-in API; this should still ultimately fail with APP:LASTNAME_MISMATCH indicating that only transient error types are in fact retried:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add Validation module Maven dependency:</strong> In check-in-papi, add the corresponding Maven dependency for the Validation module to the <strong>POM</strong> of flights-management-sapi and then confirm that Studio loads the module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.modules<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-validation-module<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; element so that the version managed in the BOM takes effect.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Validate success:</strong> Validate whether the API invocation was successful and map to a custom error type <strong>EXT:CANT_RETRIEVE_TICKET_DATA</strong> if it was not:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-ticket-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;validation:is-true</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[vars.successful]"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"Error getting ticket data"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;error-mapping</span> <span style="color: #268bd2">targetType=</span><span style="color: #859900">"EXT:CANT_RETRIEVE_TICKET_DATA"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/validation:is-true&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must explicitly validate the result as the flow no longer returns errors to stop flow processing.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Revert misconfiguration:</strong> Undo the misconfiguration of the client_id in global.xml.</p>
</li>
<li>
<p><strong>Homework:</strong> Analyze the retry commonalities in the three System API Mule flows of check-in-papi and factor out those commonalities into a new helper flow in apps-commons. This helper flow can then be used in all similar API invocations across all Mule apps. Repeat this for the PayPal SAPI and Passenger Data SAPI HTTP Request configurations in main.xml of check-in-papi and the HTTP Request configurations in health-common.xml of apps-commons.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-object-store"><a class="anchor" href="#module-object-store"></a><a class="link" href="#module-object-store">Module 5: Storing objects for persistence, performance, and resilience</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you use various techniques and Anypoint Platform components to store and manage state in an application network to increase performance and resilience.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Persist data in an Object Store.</p>
</li>
<li>
<p>Avoid expensive operations with the Cache scope.</p>
</li>
<li>
<p>Apply a caching API policy.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-251"><a class="anchor" href="#wt-begin-251"></a><a class="link" href="#wt-begin-251">Walkthrough 5-1: Persist data in an Object Store</a></h3>
<div class="paragraph">
<p>This walkthrough extends check-in-papi by handling approved payments in payment-approval-by-pnr in addition to modifying the previously implemented check-in functionality. In doing so, it becomes apparent that ticket and check-in data available during check-in must be preserved for later handling of approved payments. Temporary persistent storage of this kind, for example, caching  is a good use case for an Object Store.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you configure a persistent Object Store using the Object Store Connector to temporarily persist data across Mule flow invocations before deploying to CloudHub 2.0 and inspecting the CloudHub Object Store v2 implementation.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_configure_a_persistent_object_store">Configure a persistent Object Store</a>.</p>
</li>
<li>
<p><a href="#_access_entries_in_an_object_store">Access entries in an Object Store</a>.</p>
</li>
<li>
<p><a href="#_store_entries_in_an_object_store">Store entries in an Object Store</a>.</p>
</li>
<li>
<p><a href="#_deploy_to_cloudhub_2_0_and_use_object_store_v2">Deploy to CloudHub 2.0 and use Object Store v2</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_16"><a class="anchor" href="#_solution_file_16"></a><a class="link" href="#_solution_file_16">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module05/wt5-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_15"><a class="anchor" href="#_starting_file_15"></a><a class="link" href="#_starting_file_15">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module04/wt4-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configure_a_persistent_object_store"><a class="anchor" href="#_configure_a_persistent_object_store"></a><a class="link" href="#_configure_a_persistent_object_store">Configure a persistent Object Store</a></h4>
<div class="paragraph">
<p>In this section, you study the current architecture and the state requirements across the check-in and payment approval Mule flows before beginning the approved payment handling implementation. You add the Object Store Connector and configure a persistent Object Store to store state across Mule flow invocations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Study System APIs invoked by check-in-papi:</strong> Review the <a href="#section-aa-solution-arch">Solution architecture</a>, particularly the <a href="#aa-high-level-arch">High-level architecture</a> and the <a href="#aa-us1-realization">design of US1: mobile Check-In</a>. Note the dependency of check-in-papi on paypal-sapi for the core handling of approved payments being implemented in payment-approval-by-pnr. Also notice the logic required to display a boarding pass is contained within check-in-papi without dependencies.</p>
</li>
<li>
<p><strong>Review stubbed payment-approval-by-pnr logic:</strong> Review the current implementation of payment-approval-by-pnr of check-in-papi main.xml. Note the two skeleton Mule flows invoked: <strong>update-approvals</strong> and <strong>get-boarding-pass</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>This is the simplest, nonfunctional implemenation of payment-approval-by-pnr. The update-approvals Mule flow uses a Transform Message component to return a stub status response from PayPal SAPI. You will implement the logic to invoke PayPal SAPI shortly.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app in Studio and invoke the API via cURL, supplying an arbitrary PNR and example JSON request body; this should return an HTTP 200 OK response:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span>  <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">PAY-1AKD7482FAB9STATKO</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://localhost:8081/api/v1/tickets/N123/paymentApproval</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Implement payment-approval-by-pnr logic:</strong> In <strong>update-approvals</strong>, invoke PayPal SAPI, building the required POST body:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;set-variable</span> <span style="color: #268bd2">variableName=</span><span style="color: #859900">"payerID"</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {payerID: payload.payerID}]"</span><span style="color: #b58900">/&gt;</span>

<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"update-approvals"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"paypalSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"PUT"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/payments/{PaymentID}/approval"</span> <span style="color: #268bd2">doc:id=</span><span style="color: #859900">"24f7105a-3034-4603-a6a6-d5610080374f"</span><span style="color: #b58900">&gt;</span>	<span style="color: #b58900">&lt;error-mapping</span> <span style="color: #268bd2">sourceType=</span><span style="color: #859900">"HTTP:BAD_REQUEST"</span> <span style="color: #268bd2">targetType=</span><span style="color: #859900">"APP:INVALID_PAYMENT"</span><span style="color: #b58900">/&gt;</span>
		<span style="color: #b58900">&lt;http:body</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[vars.payerID]]]&gt;</span><span style="color: #b58900">&lt;/http:body&gt;</span>
			<span style="color: #b58900">&lt;http:uri-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"PaymentID" : payload.paymentID
}]]]&gt;</span><span style="color: #b58900">&lt;/http:uri-params&gt;</span>
	<span style="color: #b58900">&lt;/http:request&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There are sample JSON files in the src/main/resources/examples directory for the request and response to use as metadata or as a guide.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You build a payerID JSON object and store it in a variable for later use by the HTTP Connector.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If the HTTP Request operation operation fails with a HTTP:BAD_REQUEST, the error is mapped to a custom APP:INVALID_PAYMENT error type.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Use the common retry flow from the previous homework.</p>
</li>
<li>
<p><strong>Build boarding pass:</strong> In <strong>get-boarding-pass</strong>, update the Transform Message component to start building the boarding pass assuming the payload will eventually contain a <strong>ticket</strong> and <strong>checkIn</strong> object with the missing required data:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-boarding-pass"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
    <span style="color: #b58900">&lt;ee:message&gt;</span>
      <span style="color: #b58900">&lt;ee:set-payload&gt;</span><span style="color: #b58900">&lt;![CDATA[%dw 2.0
        output application/json
        var numBags = if (payload.checkIn.numBags &gt;</span> 0) payload.checkIn.numBags else 0
        ---
        {
          PNR:           vars.PNR,
          lastName:      payload.ticket.ticketHolderLastName,
          airportArrive: payload.ticket.destination,
          airportDepart: payload.ticket.origin,
          bagsCount:     numBags,
          flight:        payload.ticket.flightNo,
          flightDate:    payload.ticket.flightDate,
          depart:        payload.ticket.depart,
          boarding:      payload.ticket.boarding,
          class:         payload.ticket.class,
          gate:          payload.ticket.gate,
          seat:          payload.ticket.seat
        }]]&gt;<span style="color: #b58900">&lt;/ee:set-payload&gt;</span>
    <span style="color: #b58900">&lt;/ee:message&gt;</span>
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Only the PNR is available at this point. For now, assume the existence of a payload object that contains a checkIn object and a ticket object with the required data.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Reflect:</strong> The majority of the information needed is not available at this point in time of the Mule flow. Note that this information was available at the end of the check-in-by-pnr. If this data could be persisted between the two isolated and separate flow invocations, then payment-approval-by-pnr could make use of it. One way to store state in Mule is to use an Object Store.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Mule event state is lost between subsequent executions of Mule flows.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>A MuleSoft Object Store is a key-value store available as a service to all Mule runtimes, where the implementation of that service differs by deployment model (standalone versus cluster versus CloudHub).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Object Store component was designed to store state information between Mule flow invocations.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>From Mule application code, an Object Store is typically accessed via the Object Store Connector.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Confirm Maven dependency management:</strong> In <strong>bom/pom.xml</strong>, locate the existing dependency management entries for the Object Store Connector, which has artifact ID mule-objectstore-connector.</p>
</li>
<li>
<p><strong>Add Maven dependency:</strong> Add the corresponding Maven dependency for the Object Store Connector to the <strong>POM</strong> of check-in-papi; confirm that Studio loads the module:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependency&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>mule-objectstore-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
<span style="color: #b58900">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Omit the &lt;version /&gt; element so that the version managed in the BOM takes effect.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create persistent Object Store:</strong> In global.xml, create a persistent Object Store named <strong>pnrObjectStore</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;os:object-store</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"pnrObjectStore"</span> <span style="color: #268bd2">persistent=</span><span style="color: #859900">"true"</span><span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, each Mule application has an Object Store that is persistent and is always available to the Mule app. Here, however, we are creating a named persistent Object Store instead.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Persistence usually refers to storage that is copied to disk or some external storage, or replicated across several nodes, depending on the deployment model.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In-memory usually refers to data that is only stored in the JVM memory of one Mule runtime. When the persistent argument is set to false, the Object Store is transient, storing data only in-memory.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_access_entries_in_an_object_store"><a class="anchor" href="#_access_entries_in_an_object_store"></a><a class="link" href="#_access_entries_in_an_object_store">Access entries in an Object Store</a></h4>
<div class="paragraph">
<p>In this section, you configure the Object Store Connector to preemptively retrieve the check-in data to be stored by check-in-by-pnr, validate the key exists in the Object Store, and remove entries from the Object Store when no longer required.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><strong>Retrieve missing data from Object Store:</strong> In <strong>get-boarding-pass</strong>, retrieve from the Object Store using the PNR as the key. If they key is found, it will eventually return an object containing the missing <strong>ticket</strong> and <strong>checkIn</strong> data. Add a default value to return an empty object if the PNR is not found:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-boarding-pass"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;os:retrieve</span> <span style="color: #268bd2">key=</span><span style="color: #859900">"#[vars.PNR]"</span> <span style="color: #268bd2">objectStore=</span><span style="color: #859900">"pnrObjectStore"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;os:default-value&gt;</span>#[{}]<span style="color: #b58900">&lt;/os:default-value&gt;</span>
  <span style="color: #b58900">&lt;/os:retrieve&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
  ...
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>There is no query mechanism; objects are only retrievable by key.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If a key is not found and no default value is configured, an OS:KEY_NOT_FOUND error will be raised.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The maximum number of characters in a key is currently 256.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The values can be any serializable Java object.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Validate Object Store contains missing data:</strong> Before invoking get-boarding-pass, use the Object Store Connector to verify that the Object Store contains an entry keyed under the specified PNR. Store the result in a variable before using the Validation module to validate that the Object Store does in fact contain data under the specified key:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"payment-approval-by-pnr"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;os:contains</span> <span style="color: #268bd2">key=</span><span style="color: #859900">"#[vars.PNR]"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"existsPNR"</span> <span style="color: #268bd2">objectStore=</span><span style="color: #859900">"pnrObjectStore"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;validation:is-true</span> <span style="color: #268bd2">expression=</span><span style="color: #859900">"#[vars.existsPNR]"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"PNR check-in expired for this passenger. Passenger needs to check in again."</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;error-mapping</span> <span style="color: #268bd2">targetType=</span><span style="color: #859900">"EXT:BAD_REQUEST"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/validation:is-true&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"update-approvals"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-boarding-pass"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Although isolated processes, the check-in-by-pnr Mule flow must be invoked before the payment-approval-by-pnr Mule flow. Validating that the check-in-by-pnr was in fact invoked and stored the required data in the Object Store provides a degree of safety.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>If the Object Store does not contain any data keyed by the PNR, a validation error is thrown and mapped to the EXT:BAD_REQUEST error type.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Remove used Object Store data:</strong> In <strong>get-boarding-pass</strong>, after building the boarding pass object, remove the Object Store entry keyed under the specified PNR:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-boarding-pass"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;ee:transform&gt;</span>
  ...
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
  <span style="color: #b58900">&lt;os:remove</span> <span style="color: #268bd2">key=</span><span style="color: #859900">"#[vars.PNR]"</span> <span style="color: #268bd2">objectStore=</span><span style="color: #859900">"pnrObjectStore"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The payment approval handling process can only be completed once per check-in. Therefore it safe to remove the Object Store entry to prevent duplicate payment approvals.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_store_entries_in_an_object_store"><a class="anchor" href="#_store_entries_in_an_object_store"></a><a class="link" href="#_store_entries_in_an_object_store">Store entries in an Object Store</a></h4>
<div class="paragraph">
<p>In this section, you configure the Object Store Connector to store the check-in data required by payment-approval-by-pnr.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p><strong>Store missing data from Object Store:</strong> In <strong>check-in-by-pnr</strong>, before building the check-in response, store the missing checkIn and ticket data required by payment-approval-by-pnr in the expected object structure keyed by the PNR:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-in-by-pnr"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;os:store</span> <span style="color: #268bd2">key=</span><span style="color: #859900">"#[vars.PNR]"</span> <span style="color: #268bd2">objectStore=</span><span style="color: #859900">"pnrObjectStore"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;os:value&gt;</span><span style="color: #b58900">&lt;![CDATA[#[{
      checkIn: vars.checkIn,
      ticket: vars.ticket
    }]]]&gt;</span><span style="color: #b58900">&lt;/os:value&gt;</span>
  <span style="color: #b58900">&lt;/os:store&gt;</span>

  <span style="color: #b58900">&lt;ee:transform&gt;</span>
  ...
  <span style="color: #b58900">&lt;/ee:transform&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You build the object inline, directly within the operation itself.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The value can be any serializable Java object. There is currently a 10MB max value size restriction.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run the Mule app and invoke the paymentApproval API with no prior check-in; this should fail, triggered internally by an EXT:BAD_REQUEST, which indicates no value was found in the Object Store for the given key:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span>  <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">PAY-1AKD7482FAB9STATKO</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://localhost:8081/api/v1/tickets/N123/paymentApproval</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the checkIn API via cURL, supplying a PNR and example JSON request body; this should return an HTTP 200 OK :</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Extract paymentID:</strong> From the checkIn HTTP response body, extract the value of the paymentID, either by copy and pasting or by using tool support:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">paymentID</span><span style="color: #93a1a1">=</span><span style="color: #d33682">$(</span>curl <span style="color: #b58900">-k</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin | jq <span style="color: #b58900">-r</span> <span style="color: #859900">".paymentID"</span><span style="color: #d33682">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This cURL command is configured to only return the HTTP response body, otherwise parsing the output as JSON fails.</em></p>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-k</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must manually copy and paste the payment ID if not using tooling such as jq.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Invoke paymentApproval:</strong> Invoke the paymentApproval via cURL, supplying matching PNRs and the extracted paymentID; this should return a HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">'Content-Type: application/json'</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #586e75">$paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://localhost:8081/api/v1/tickets/PNR123/paymentApproval</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">SET <span style="color: #586e75">paymentID</span><span style="color: #93a1a1">=</span><span style="color: #859900">"VALUE RETURNED FROM PREVIOUS CURL REQUEST IF NOT USING JQ"</span>
curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">'Content-Type: application/json'</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{ </span><span style="color: #d33682">\"</span><span style="color: #859900">payerID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">STJ8222K092ST</span><span style="color: #d33682">\"</span><span style="color: #859900">, </span><span style="color: #d33682">\"</span><span style="color: #859900">paymentID</span><span style="color: #d33682">\"</span><span style="color: #859900">: </span><span style="color: #d33682">\"</span><span style="color: #859900">%paymentID%</span><span style="color: #d33682">\"</span><span style="color: #859900"> }"</span> https://localhost:8081/api/v1/tickets/PNR123/paymentApproval</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The two endpoints(checkIn and paymentApproval) act as part of a session-based cache when one Mule flow relies on the temporal storing of data from the other. Therefore it is important that each endpoint is invoked in order.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Review Object Store configuration:</strong> In <strong>global.xml</strong>, review the global configuration of the Object Store Connector and configure it with meaningful values to evict data entries after <strong>one hour</strong> and check for expired entries every <strong>30 minutes</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;os:object-store</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"pnrObjectStore"</span> <span style="color: #268bd2">entryTtl=</span><span style="color: #859900">"1"</span> <span style="color: #268bd2">entryTtlUnit=</span><span style="color: #859900">"HOURS"</span> <span style="color: #268bd2">expirationInterval=</span><span style="color: #859900">"30"</span> <span style="color: #268bd2">persistent=</span><span style="color: #859900">"true"</span><span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can configure how long data gets stored in an Object Store using entryTtl specified in the global configuration parameters for the Object Store Connector. This argument determines when to evict key-value pairs from the store. The values should be configured on a use-case basis depending on how long the stored resource is required. An Object Store, although being persistent, should not be used for permanent storage.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>For Object Store v2, since Mule 4.2.1, the entryTTL is rolling by default. If no entryTTL value is configured, the default is used and as long as an entry is accessed at least once a week, the TTL is extended for a further 30 days automatically. If an entryTTL is configured, the TTL is static and tne entry will be evicted once the entryTTL expires, regardless of how often it is accessed.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The standard Mule Object Store, the original on premise based Object Store that is part of Mule Runtime has no limit on the TTL value and is always static.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The maximum time to live (TTL) is 2592000 seconds (30 days).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Object Stores in Mule versions earlier than 4.2.1 have a static TTL of 30 days by default.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You will be working with these settings in more detail in the next walkthrough.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_to_cloudhub_2_0_and_use_object_store_v2"><a class="anchor" href="#_deploy_to_cloudhub_2_0_and_use_object_store_v2"></a><a class="link" href="#_deploy_to_cloudhub_2_0_and_use_object_store_v2">Deploy to CloudHub 2.0 and use Object Store v2</a></h4>
<div class="paragraph">
<p>In this section, you deploy Check-In PAPI to CloudHub 2.0 and view the Object Store v2 implementation.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="20">
<li>
<p><strong>Update Mule app and dependencies to release versions:</strong> Update the artifact version and references to a release version and not a SNAPSHOT:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You already updated the parent POMs versions in a previous walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> Run a full Maven build of check-in-papi skipping all unit tests using the same secure properties encryption key used in previous walkthroughs:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/check-in-papi
mvn clean verify <span style="color: #b58900">-U</span> <span style="color: #b58900">-Dencrypt</span>.key<span style="color: #93a1a1">=</span>secure12345 <span style="color: #b58900">-DskipTests</span><span style="color: #93a1a1">=</span><span style="color: #586e75">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You skip unit tests as you now need to update the payment-approval-by-pnr-happy-path-test to pre-seed the Object Store with a check-in, otherwise it will fail validation as seen previously in this walkthrough.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy:</strong> In <strong>Runtime Manager</strong>, deploy the packaged check-in-papi artifact from the <strong>target</strong> directory using an application named: <strong>check-in-papi-dev</strong>, selecting the <strong>CloudHub 2.0 US East Ohio Shared Space</strong> as a deployment target, enabling <strong>Object Store v2</strong> on the deployment settings, enabling <strong>Last-Mile Security</strong> on the Ingress and adding <strong>properties</strong> that sets encrypt.key and disables autodiscovery:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">encrypt.key<span style="color: #93a1a1">=</span>secure12345
anypoint.platform.gatekeeper<span style="color: #93a1a1">=</span>disabled</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the API using its endpoint URL; this should return an HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Ensure to replace the placeholders for the six-character unique id and shard for your individual application.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Inspect Object Store:</strong> In Runtime Manager, select the Object Store navigate through the partition, and view the stored keys.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Object Store v2 is the latest version of the CloudHub Object Store. It is a cloud-native implementation of the Object Store interface that is external to the Mule app and used by CloudHub-deployed applications.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The only way non-CloudHub Mule apps can access Object Store v2 is through the Object Store REST API, not through the Object Store Connector.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>A non-persistent Object Store does not use the Object Store v2 service. The Object Store is implemented locally in each CloudHub replica and data is isolated within each CloudHub replica.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Object Store v2 instance used by each Mule app is located in the same region as the worker where the Mule app is initially deployed. For example, if you deploy to the Singapore region, the Object Store persists in the Singapore region. If, after the initial deployment, you move the app to a different region, the Object Store v2 instance remains in the original region to avoid data loss. Your use of Object Store v2 never moves from one region to another.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The key for each entry is visible and human-readable. However, the value is stored as binary regardless whether the value was stored as JSON or as an object. Behind the scenes, Mule 4 executes binary serialization with the Mule internal serializer. The user interface cannot deserialize the object; hence, it can only tell you that the value is now binary in the Anypoint Platform user interface.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The TTL can be either rolling or static depending whether it should restart from every update to a key or just continue from the initial creation.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-252"><a class="anchor" href="#wt-begin-252"></a><a class="link" href="#wt-begin-252">Walkthrough 5-2: Cache expensive operations</a></h3>
<div class="paragraph">
<p>The previous walkthrough demonstrates storing state between separate Mule flows temporarily as part of a session-based cache when one Mule flow relies on the temporary storing of data from the other. Caching can also improve performance of client-side applications by avoiding transferring the same data over the network repeatedly. Rather than sending each and every request to a downstream API, you can use a cache to store previous responses and return a cached response instead where appropriate. One technique to caching in a Mule app is to use the Object Store Connector to manually store and retrieve data based on a key. However, for this particular use case, Mule also provides a Cache scope, which still uses the Object Store behind the scenes but provides a simplified interface.</p>
</div>
<div class="paragraph">
<p>Similar to retrying API invocations, it is essential that the API implementation being cached is idempotent and also safe to cache. Caching works well with HTTP GET requests because, for the same HTTP request data (including the URL) repeated invocation does not change the response. Operations invoked by check-in-papi to retrieve Passengers by their passport number from passenger-data-sapi is matching use case. This walkthrough adds caching logic to check-in-papi.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you use the Cache scope to add caching logic to a Passenger Data SAPI request to limit calls to the Passenger Data SAPI API.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_create_a_persistent_object_store_and_cache_strategy">Create a persistent Object Store and cache strategy</a>.</p>
</li>
<li>
<p><a href="#_store_data_using_the_cache_scope_and_a_cache_strategy">Store data using the Cache scope and a cache strategy</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_17"><a class="anchor" href="#_solution_file_17"></a><a class="link" href="#_solution_file_17">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module05/wt5-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_16"><a class="anchor" href="#_starting_file_16"></a><a class="link" href="#_starting_file_16">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module05/wt5-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_persistent_object_store_and_cache_strategy"><a class="anchor" href="#_create_a_persistent_object_store_and_cache_strategy"></a><a class="link" href="#_create_a_persistent_object_store_and_cache_strategy">Create a persistent Object Store and cache strategy</a></h4>
<div class="paragraph">
<p>In this section, you configure a global cache strategy with a persistent Object Store for storing cached passenger data.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Reflect:</strong> In Studio, inspect the current check-in logic paying close attention to get-passenger-data-by-passport for retrieving passenger data via a passport number.</p>
</li>
<li>
<p><strong>Create persistent Object Store cache strategy:</strong> In <strong>global.xml</strong>, create a cache strategy with an inline, private named <strong>persistent</strong> Object Store named <strong>passengerObjectStore</strong> that caches values for <strong>30 days</strong> and then set the cache key to a DataWeave expression to extract the passenger&#8217;s passport number:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">global.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;ee:object-store-caching-strategy</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"passengerCachingStrategy"</span> <span style="color: #268bd2">keyGenerationExpression=</span><span style="color: #859900">"#[vars.ticket.ticketHolderPassPortNo]"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;os:private-object-store</span> <span style="color: #268bd2">alias=</span><span style="color: #859900">"passengerObjectStore"</span> <span style="color: #268bd2">persistent=</span><span style="color: #859900">"true"</span> <span style="color: #268bd2">maxEntries=</span><span style="color: #859900">"10000"</span> <span style="color: #268bd2">entryTtl=</span><span style="color: #859900">"30"</span> <span style="color: #268bd2">entryTtlUnit=</span><span style="color: #859900">"DAYS"</span> <span style="color: #268bd2">expirationInterval=</span><span style="color: #859900">"1"</span> <span style="color: #268bd2">expirationIntervalUnit=</span><span style="color: #859900">"DAYS"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/ee:object-store-caching-strategy&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, the Cache scope uses a cache strategy that stores data in an in-memory Object Store. You can instead use a custom Object Store by overriding the cache strategy.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can reference a standard existing Object Store instead if necessary. The benefit of using an inline private Object Store is that other components cannot interfere with the cache.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You set the entryTtl and expirationInterval to evict cached entries. The values should be configured on a use-case basis depending on how likely the cached resource will change and on the performance requirements of the client application. In this case, the maximum of 30 days has been used because the data being cached is unlikely to change.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The cache is set with a maxEntries value of <strong>10000</strong>. This has been roughly calculated based on the size of the payload being cached and the entryTTL to avoid the cache consuming too much JVM heap (in-memory) or too much disk space (persistent).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The keyGenerationExpression is a DataWeave expression to determine if two requests are considered equal. If a cache entry has a matching key, it is considered a cache hit and the cached value is returned. Otherwise, it is considered a cache miss and the downstream API will be invoked and the resulting response cached under the generated key (if the response is repeatable).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>By default, the Cache scope uses an SHA256KeyGenerator and an SHA256 digest of the message payload to generate a unique key. However, you can set up your own key through a custom Caching Strategy as shown here.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Only the Mule message is cached  variables are not.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_store_data_using_the_cache_scope_and_a_cache_strategy"><a class="anchor" href="#_store_data_using_the_cache_scope_and_a_cache_strategy"></a><a class="link" href="#_store_data_using_the_cache_scope_and_a_cache_strategy">Store data using the Cache scope and a cache strategy</a></h4>
<div class="paragraph">
<p>In this section, you encapsulate a cache-safe passenger-data-sapi request operation in a Cache scope and modify the Mule event to correctly set required variables.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Cache safe request operation:</strong> In <strong>main.xml</strong>, locate <strong>get-passenger-data-by-passport</strong> and encapsulate the HTTP request operation in a Cache scope, referencing the cache strategy created previously:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-passenger-data-by-passport"</span><span style="color: #b58900">&gt;</span>
 <span style="color: #b58900">&lt;ee:cache</span> <span style="color: #268bd2">cachingStrategy-ref=</span><span style="color: #859900">"passengerCachingStrategy"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"passengerDataSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/passengers"</span> <span style="color: #268bd2">doc:id=</span><span style="color: #859900">"c08b805e-bf4c-49ec-a56d-d5edd5c90f5d"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;http:query-params&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"passportNo" : vars.ticket.ticketHolderPassPortNo
}]]]&gt;</span><span style="color: #b58900">&lt;/http:query-params&gt;</span>
    <span style="color: #b58900">&lt;/http:request&gt;</span>
  <span style="color: #b58900">&lt;/ee:cache&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a message enters the Cache scope, it uses the referenced cache strategy to determine if the Object Store already contains the key. If not, the nested operation is invoked, the Cache scope determines whether the message payload is nonrepeatable, and it stores the result for future invocations.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can configure a cache strategy to be synchronized if concurrent cache access should not be allowed.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi and invoke the exposed check-in endpoint twice; the first request should succeed with an HTTP 200 OK response and the second should fail with an HTTP 400 Bad Request:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The ticket validation is performed against the cached operation, which stores the result in a target variable passenger. The Cache scope does not cache variables. Therefore it is important that no variables or targets are set within a Cache scope that are relied upon outside of the scope itself.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Move target variable:</strong> Move the setting of the target <strong>passenger</strong> variable outside of the Cache scope, from <strong>get-passenger-data-by-passport</strong> to the flow reference in <strong>validate-ticket-passport-matches</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">main.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"validate-ticket-passport-matches"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;flow-ref</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-passenger-data-by-passport"</span> <span style="color: #268bd2">target=</span><span style="color: #859900">"passenger"</span><span style="color: #b58900">/&gt;</span>
  ...
<span style="color: #b58900">&lt;/flow&gt;</span>
<span style="color: #b58900">&lt;flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"get-passenger-data-by-passport"</span><span style="color: #b58900">&gt;</span>
 <span style="color: #b58900">&lt;ee:cache</span> <span style="color: #268bd2">cachingStrategy-ref=</span><span style="color: #859900">"passengerCachingStrategy"</span> <span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">config-ref=</span><span style="color: #859900">"passengerDataSapiConfig"</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">path=</span><span style="color: #859900">"/passengers"</span> <span style="color: #268bd2">doc:id=</span><span style="color: #859900">"c08b805e-bf4c-49ec-a56d-d5edd5c90f5d"</span><span style="color: #b58900">&gt;</span>
		<span style="color: #b58900">&lt;http:query-params</span> <span style="color: #b58900">&gt;</span><span style="color: #b58900">&lt;![CDATA[#[output application/java
---
{
	"passportNo" : vars.ticket.ticketHolderPassPortNo
}]]]&gt;</span><span style="color: #b58900">&lt;/http:query-params&gt;</span>
	  <span style="color: #b58900">&lt;/http:request&gt;</span>
  <span style="color: #b58900">&lt;/ee:cache&gt;</span>
<span style="color: #b58900">&lt;/flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Tune log config:</strong> Change <strong>log4j2-test.xml</strong> to show DEBUG log entries created by the <strong>com.mulesoft.mule.runtime.cache</strong> logger:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">log4j2.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;AsyncLogger</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"com.mulesoft.mule.runtime.cache"</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"DEBUG"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run check-in-papi again, making sure to <strong>clear application data</strong> and invoke the exposed Check-In PAPI check-in endpoint <strong>twice</strong> and paying close attention to the cache hit messages on subsequent requests:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Mule</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The first request should result in a cache miss as it is the first time the API is invoked.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Subsequent requests should result in a cache hit with the timer showing subsequent requests being more performant.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Application data refers to any state stored by the Mule runtime, such as Object Store data whether manually stored via the Object Store Connector, or stored by other components such as watermarks and OAuth tokens.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can configure and clear application data from the Studio Run Configuration.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can manually clear application data in ARM via the Application Data page of a deployed Mule app.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-253"><a class="anchor" href="#wt-begin-253"></a><a class="link" href="#wt-begin-253">Walkthrough 5-3: Apply a caching API policy</a></h3>
<div class="paragraph">
<p>The previous walkthrough demonstrates caching data on the client side to avoid transferring the same data over the network repeatedly. This avoids unnecessary network calls and improves overall application performance. This is all governed by each individual API client. However, there is another scenario where the API implementation may want to enlist its own caching functionality on the server side to optimize against computationally expensive processing such as executing expensive database operations. In this scenario, API clients still make network calls, but it is generally dictated by the server whether data is returned from the cache or not. When implementing this style of caching, the same constraints on cache-safe data apply.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you apply and configure HTTP caching as an automated policy to implement a server-side cache.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_apply_an_api_policy_for_http_caching">Apply an API policy for HTTP caching</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_18"><a class="anchor" href="#_solution_file_18"></a><a class="link" href="#_solution_file_18">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module05/wt5-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apply_an_api_policy_for_http_caching"><a class="anchor" href="#_apply_an_api_policy_for_http_caching"></a><a class="link" href="#_apply_an_api_policy_for_http_caching">Apply an API policy for HTTP caching</a></h4>
<div class="paragraph">
<p>In this section, you apply HTTP caching as an API policy to passenger-data-sapi in the dev environment.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Navigate to API Manager:</strong> Navigate to API Manager and using credentials with sufficient permissions, log in to your Anypoint Platform organization and navigate to API Manager.</p>
</li>
<li>
<p><strong>Manage API:</strong> Manage passenger-data-sapi using the <strong>Create new API</strong> option as an <strong>HTTP API</strong>. Create a new <strong>Endpoint with Proxy</strong> with the following implementation endpoint URL: <strong><a href="https://tngaa-passenger-data-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io" class="bare">https://tngaa-passenger-data-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io</a></strong> deployed to <strong>CloudHub 2.0</strong> and the proxy application name: <strong>passenger-data-sapi-dev</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>You use the HTTP API option over managing an API from Exchange to save time.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Apply API policy:</strong> In API Manager apply the HTTP caching API policy to <strong>passenger-data-sapi</strong>, with <strong>attributes.requestUri</strong> as the cachingKey, <strong>2592000</strong> as the Entry Time To Live (in Seconds), <strong>10000</strong> as the Maximum Cache Entries, enabling <strong>Persistent Cache</strong> and set the Invalidation Header to <strong>X-CACHE-INVALIDATE</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The DataWeave expression: attributes.requestUri uses the <strong>cachingKey</strong>, which contains the query parameter passportNo.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The cache is set as distributed because passenger-data-sapi is deployed to multiple CloudHub workers and you consider it more important to avoid accessing the Passenger Data system than to avoid invoking the CloudHub Object Store v2 implementation (which is also a remote service).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In the cache, the Entry Time To Live (in Seconds) value is set to 2592000, which is the maximum Object Store TTL of 30 days, because the data being cached is unlikely to change.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>In the cache, the Maximum Cache Entries value is set to 10000. This has been roughly calculated on the size of the payload being cached and the entry TTL to avoid the cache consuming too much JVM heap (in-memory) or too much disk space (persistent).</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You leave the default expression to cache only GET and HEAD requests as these are the only cache-safe methods exposed by passenger-data-sapi.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can set up a custom expression to invalidate cache entries if a certain condition in the request is met.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Enable Object Store v2:</strong> In <strong>Runtime Manager</strong>, locate the proxy application created for Passenger Data SAPI in the <strong>dev</strong> and enable <strong>Object Store v2</strong>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>Object Store v2 must be enabled on the application to use persistent caching for the HTTP caching API policy.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Locate fully qualified domain name:</strong> In the Runtime Manager dashboard, check the fully qualified domain name of the Mule app and copy the API&#8217;s endpoint URL with the additional six-character uniq-id and shard.</p>
</li>
<li>
<p><strong>Invoke:</strong> Invoke the <strong>passenger-data-sapi</strong> proxy endpoint multiple times, timing its execution with an existing <strong>passportNo</strong> and the client ID and secret for the <strong>dev</strong> instances of Passenger Data SAPI; each should succeed with an HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">time </span>curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> GET <span style="color: #b58900">-u</span> e66105d66e8b4520b091127620221cce:A1c099D51C50420b84641D71b229EBac <span style="color: #859900">"http://gl-passenger-data-sapi-dev-uniqid.shard.usa-e2.cloudhub.io/api/v1/passengers?passportNo=P3JR0BZ2OY"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Ensure to replace the placeholders for the six-character unique id and shard for your individual application.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The scheme is HTTP not HTTPS.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You use the same client ID and secret that you configured as part of check-in-papi for <strong>passenger-data-sapi</strong> in a previous walkthrough.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The first request should result in a cache miss as it is the first time the API is invoked.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Subsequent requests should result in a cache hit, returning an 'age' HTTP header indicating how long in seconds the resource has been cached for and the timer showing subsequent requests being more performant.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Verify cache:</strong> In <strong>Runtime Manager</strong>, verify the Object Store for the Passenger Data SAPI proxy application in the <strong>dev</strong>  contains a matching key for the request path containing the passportNo.</p>
</li>
<li>
<p><strong>Invalidate cache:</strong> Invoke Passenger Data SAPI, specifying the cache invalidation header; this should succeed with an HTTP 200 OK response:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">time </span>curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> GET <span style="color: #b58900">-u</span> &lt;insert-your-client-id&gt;:&lt;insert-your-client-secret&gt; <span style="color: #b58900">-H</span> <span style="color: #859900">"X-CACHE-INVALIDATE:invalidate"</span> <span style="color: #859900">"http://gl-passenger-data-sapi-dev-uniqid.shard.usa-e2.cloudhub.io/api/v1/passengers?passportNo=P3JR0BZ2OY"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The hostname will be different for you.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The scheme is HTTP not HTTPS.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This request will not return an 'age' HTTP header as it will invalidate the matching cache entry and bypass the cache.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The timer should indicate the request taking longer as it is bypassing the cache.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The header value invalidate will invalidate a cache entry with a matching cache key. You can also specify the value invalidate-all, which will invalidate all the key-value pairs from the cache.</em></p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-components"><a class="anchor" href="#module-components"></a><a class="link" href="#module-components">Module 6: Componentizing reusable integration functionality</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this module, you identify and extract reusable Mule app code from multiple Mule apps and the apps-commons library-style Mule plugin. Then you use it in two separate first-class Mule runtime extensions: an XML SDK module and a custom API policy.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an XML SDK component.</p>
</li>
<li>
<p>Create a custom API policy.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="wt-begin-261"><a class="anchor" href="#wt-begin-261"></a><a class="link" href="#wt-begin-261">Walkthrough 6-1: Create an XML SDK component</a></h3>
<div class="paragraph">
<p>The current check-all-dependencies-are-alive implementation of check-in-papi shares many commonalities across the three &lt;http:request /&gt; instances. If you completed the optional homework, this logic is reused via the apps-commons shared library. This implementation is currently verbose and awkward to reuse and can further be improved along many dimensions, such as resilience and performance.</p>
</div>
<div class="paragraph">
<p>In this walkthrough, you create a custom XML SDK module to encapsulate and reuse the logic to check whether an endpoint is alive and to retry HTTP requests.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#generate-sdk-module">Generate an XML SDK module from a Maven archetype</a>.</p>
</li>
<li>
<p><a href="#sdk-operations">Create XML SDK module operations</a>.</p>
</li>
<li>
<p><a href="#reuse-sdk-module-operations">Reuse XML SDK module operations</a>.</p>
</li>
<li>
<p><a href="#deploy-module-exchange">Deploy an XML SDK module to Exchange</a>.</p>
</li>
<li>
<p><a href="#import-sdk-module">Import an XML SDK module into another Mule app</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_19"><a class="anchor" href="#_solution_file_19"></a><a class="link" href="#_solution_file_19">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module06/wt6-1_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_file_17"><a class="anchor" href="#_starting_file_17"></a><a class="link" href="#_starting_file_17">Starting file</a></h4>
<div class="paragraph">
<p>If you did not complete the previous walkthrough, you can get a starting file located in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module05/wt5-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="generate-sdk-module"><a class="anchor" href="#generate-sdk-module"></a><a class="link" href="#generate-sdk-module">Generate an XML SDK module from a Maven archetype</a></h4>
<div class="paragraph">
<p>In this section, you run the mule-extensions-xml-archetype to generate the skeleton for the new custom XML SDK module and modify the generated XML SDK module to inherit from a parent POM to gain access to common dependencies.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Execute archetype:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of your Studio workspace and run the Maven archetype, replacing the groupId with your Anypoint Platform organization ID; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>

mvn <span style="color: #b58900">-B</span> <span style="color: #b58900">-f</span> bom/pom.xml archetype:generate <span style="color: #b58900">-DarchetypeGroupId</span><span style="color: #93a1a1">=</span>org.mule.extensions <span style="color: #b58900">-DarchetypeArtifactId</span><span style="color: #93a1a1">=</span>mule-extensions-xml-archetype <span style="color: #b58900">-DarchetypeVersion</span><span style="color: #93a1a1">=</span>1.2.0 <span style="color: #b58900">-DgroupId</span><span style="color: #93a1a1">=</span>your-AP-organization-id <span style="color: #b58900">-DartifactId</span><span style="color: #93a1a1">=</span>resilience-mule-extension <span style="color: #b58900">-DmuleConnectorName</span><span style="color: #93a1a1">=</span>resilience-mule-extension <span style="color: #b58900">-DextensionName</span><span style="color: #93a1a1">=</span>resilience <span style="color: #b58900">-Dpackage</span><span style="color: #93a1a1">=</span><span style="color: #586e75">.</span> <span style="color: #b58900">-DoutputDirectory</span><span style="color: #93a1a1">=</span>../</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>

mvn <span style="color: #b58900">-B</span> <span style="color: #b58900">-f</span> bom/pom.xml archetype:generate <span style="color: #b58900">-DarchetypeGroupId</span><span style="color: #93a1a1">=</span>org.mule.extensions <span style="color: #b58900">-DarchetypeArtifactId</span><span style="color: #93a1a1">=</span>mule-extensions-xml-archetype <span style="color: #b58900">-DarchetypeVersion</span><span style="color: #93a1a1">=</span>1.2.0 <span style="color: #b58900">-DgroupId</span><span style="color: #93a1a1">=</span>your-AP-organization-id <span style="color: #b58900">-DartifactId</span><span style="color: #93a1a1">=</span>resilience-mule-extension <span style="color: #b58900">-DmuleConnectorName</span><span style="color: #93a1a1">=</span>resilience-mule-extension <span style="color: #b58900">-DextensionName</span><span style="color: #93a1a1">=</span>resilience <span style="color: #b58900">-Dpackage</span><span style="color: #93a1a1">=</span><span style="color: #586e75">.</span> <span style="color: #b58900">-DoutputDirectory</span><span style="color: #93a1a1">=</span>C:<span style="color: #d33682">\w</span>indows<span style="color: #d33682">\f</span>ull<span style="color: #d33682">\p</span>ath<span style="color: #d33682">\t</span>o<span style="color: #d33682">\y</span>our<span style="color: #d33682">\w</span>orkspace</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The archetype artifact is retrieved from the mulesoft-releases repository already defined in the BOM.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The muleConnectorName argument is the fully qualified name of the module project.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The extensionName argument is used to create the namespace prefix for module operations.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The package argument is set to create the module-resilience.xml file in the root directory of src/main/resources.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>This POM uses the Anypoint Platform organization ID for the groupId, as this is a prerequisite for publishing to Exchange, which you will do later.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API does not support dynamic parameters within groupIds such as ${aa.ap.org.id}, and it requires the value to be the hardcoded Anypoint Platform organization ID.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Import into Studio:</strong> Import the module into Studio by creating a <strong>New</strong> <strong>General</strong> <strong>Project</strong>, setting the project name as <strong>resilience-mule-extension</strong>, and changing the default location to the location of your generated module.</p>
</li>
<li>
<p><strong>Browse the generated artifact:</strong> Inspect the generated directory structure of the newly created XML SDK module named resilience-mule-extension.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>The module-resilience.xml file in the src/main/resources directory defines the module including all its operations.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The assertion-munit-test.xml file in the src/test/munit directory contains a generated test-suite for the generated operations defined in module-resilience.xml.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Turn POM into child POM:</strong> Turn the XML SDK module into a Maven child project of your existing <strong>parent POM</strong> in its parent directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>a63e6d25-8aaf-4512-b36d-d91b90a55c4a<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The mule.version property must be defined despite not being directly referenced from within the POM, as it is indirectly used by mule-extensions-maven-plugin.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Remove the now unnecessary properties, dependency, and plugin versions managed by the inherited BOM.</p>
</li>
<li>
<p><strong>Add managed HTTP Connector dependency:</strong> Add a dependency entry for the HTTP Connector without a version to &lt;dependencies /&gt; in the resilience-mule-extension <strong>POM</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.connectors<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>mule-http-connector<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Disable tests:</strong> Back up and disable the MUnit test by renaming <strong>assertion-munit-test.xml</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/resilience-mule-extension

<span style="color: #586e75">mv </span>src/test/munit/assertion-munit-test.xml src/test/munit/assertion-munit-test.xml.bkp</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The generated MUnit test suite contains the original target namespace and schemaLocations that must be manually kept in sync with the module. The operation tests are soon to be obsolete as you implement your own custom operations.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Module Testing Framework leverages MUnit to test custom modules. The Maven Resources plugin must copy the MUnit resources to the target directory for the MUnit Maven plugin to find and run the tests.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of resilience-mule-extension and run a Maven build of this XML SDK module; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/resilience-mule-extension

mvn clean verify</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Adapt the MUnit test suite to the correct module&#8217;s namespace and operations.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="sdk-operations"><a class="anchor" href="#sdk-operations"></a><a class="link" href="#sdk-operations">Create XML SDK module operations</a></h4>
<div class="paragraph">
<p>In this section, you modify the module template to create a new operation: is-endpoint-alive to encapsulate the reusable logic for checking whether an endpoint is alive.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p><strong>Refactor generated module:</strong> In Studio, modify the namespace <strong>prefix</strong>, <strong>tns</strong>, and <strong>schemaLocation</strong>, removing <strong>module-</strong> as well as removing Smart Connector from the module name and removing all the autogenerated operations:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;module</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"Resilience Smart Connector"</span>
  <span style="color: #268bd2">prefix=</span><span style="color: #859900">"resilience"</span>
  <span style="color: #268bd2">xmlns:tns=</span><span style="color: #859900">"http://www.mulesoft.org/schema/mule/resilience"</span>
  <span style="color: #268bd2">xsi:schemaLocation=</span><span style="color: #859900">"
    http://www.mulesoft.org/schema/mule/resilience http://www.mulesoft.org/schema/mule/resilience/current/mule-resilience.xsd"</span><span style="color: #b58900">&gt;</span>
<span style="color: #b58900">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>At the time of this writing, Studio does not support the project type of XML SDK modules.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The term Smart Connector is a legacy term no longer in use.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study existing Mule flows:</strong> Study the &lt;http:request /&gt; instances, the variables and properties required by <strong>check-all-dependencies-are-alive</strong> of <strong>check-in-papi</strong> and any additional parameters that will be required to retry HTTP requests.</p>
</li>
<li>
<p><strong>Add operations:</strong> Add a new operation to <strong>module-resilience.xml</strong> called <strong>is-endpoint-alive</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;module</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"Resilience"</span>
  <span style="color: #268bd2">prefix=</span><span style="color: #859900">"resilience"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"is-endpoint-alive"</span><span style="color: #b58900">&gt;</span>
    ...
  <span style="color: #b58900">&lt;/operation&gt;</span>
<span style="color: #b58900">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The combination of the prefix resilience and the operation name is-endpoint-alive will result in clients calling the operation using resilience:is-endpoint-alive.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Add parameters:</strong> Add parameters for <strong>url</strong>, <strong>responseTimeoutInMillis</strong>, <strong>maxRetries</strong>, and <strong>millisBetweenRetries</strong> that will be required by the &lt;http:request /&gt;:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"is-endpoint-alive"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;parameters&gt;</span>
    <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"url"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"URL"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"string"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"REQUIRED"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"responseTimeoutMillis"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Response Timeout in Milliseconds"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"maxRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Max Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[3]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"millisBetweenRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Milliseconds Between Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/parameters&gt;</span>
<span style="color: #b58900">&lt;/operation&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Each parameter will become an XML attribute on the operation element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Parameters are locally scoped to each operation and must be passed on each invocation. If you want to pass global configuration that affects all operations of an XML SDK component instance in a project, you can use a &lt;property /&gt; instead. Properties are defined at the root of the module, outside of any operation element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To define parameter data types with complex structures, you can create a catalog of data types that you can use within the module. This catalog of data types can make use of both XML-Schema and JSON-Schema.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The XML SDK is strongly typed, so the data type of defined parameters for every operation is statically set for both the input and output.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Retry a generic HTTP Request configuration:</strong> Add an Until Successful scope and a generic &lt;http:request /&gt; to the body of the operation with a matching <strong>global configuration</strong>, <strong>namespace</strong>, and <strong>schemaLocation</strong>. Refactor the attributes to use the new operation parameters as variables. Handle any errors with an error handler containing an on-error-continue scope consuming all errors and sets a Boolean successful variable to false, which defaults to true after invoking the Until Successful scope:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;module</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"Resilience Smart Connector"</span>
  <span style="color: #268bd2">prefix=</span><span style="color: #859900">"resilience"</span>
  <span style="color: #268bd2">xmlns:http=</span><span style="color: #859900">"http://www.mulesoft.org/schema/mule/http"</span>
  <span style="color: #268bd2">xsi:schemaLocation=</span><span style="color: #859900">"
   http://www.mulesoft.org/schema/mule/http
   http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd"</span><span style="color: #b58900">&gt;</span>

  <span style="color: #b58900">&lt;http:request-config</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"httpRequestConfig"</span><span style="color: #b58900">/&gt;</span>

  <span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"is-endpoint-alive"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;parameters&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"url"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"URL"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"string"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"REQUIRED"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"responseTimeoutMillis"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Response Timeout in Milliseconds"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"maxRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Max Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[3]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"millisBetweenRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Milliseconds Between Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/parameters&gt;</span>
    <span style="color: #b58900">&lt;body&gt;</span>
      <span style="color: #b58900">&lt;mule:until-successful</span> <span style="color: #268bd2">maxRetries=</span><span style="color: #859900">"#[vars.maxRetries]"</span> <span style="color: #268bd2">millisBetweenRetries=</span><span style="color: #859900">"#[vars.millisBetweenRetries]"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;mule:try&gt;</span>
          <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"#[vars.url]"</span> <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span> <span style="color: #268bd2">responseTimeout=</span><span style="color: #859900">"#[vars.responseTimeoutMillis]"</span><span style="color: #b58900">&gt;</span>
            <span style="color: #b58900">&lt;http:response-validator&gt;</span>
              <span style="color: #b58900">&lt;http:success-status-code-validator</span> <span style="color: #268bd2">values=</span><span style="color: #859900">"200..299"</span><span style="color: #b58900">/&gt;</span>
            <span style="color: #b58900">&lt;/http:response-validator&gt;</span>
          <span style="color: #b58900">&lt;/http:request&gt;</span>
          <span style="color: #b58900">&lt;mule:set-payload</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[true]"</span><span style="color: #b58900">/&gt;</span>
          <span style="color: #b58900">&lt;mule:error-handler&gt;</span>
            <span style="color: #b58900">&lt;mule:on-error-continue&gt;</span>
              <span style="color: #b58900">&lt;mule:set-payload</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
            <span style="color: #b58900">&lt;/mule:on-error-continue&gt;</span>
          <span style="color: #b58900">&lt;/mule:error-handler&gt;</span>
        <span style="color: #b58900">&lt;/mule:try&gt;</span>
      <span style="color: #b58900">&lt;/mule:until-successful&gt;</span>
    <span style="color: #b58900">&lt;/body&gt;</span>
  <span style="color: #b58900">&lt;/operation&gt;</span>
<span style="color: #b58900">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The target namespace is that of the connector itself, not the standard core Mule namespace as seen in Studio applications. Thereforem it is required to prefix any core Mule element with the namespace prefix defined in the module (root) element: mule:</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Each operation parameter becomes a variable scoped to the enclosing operation.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Define output type:</strong> Add the expected output type to the operation, i.e., a Boolean indicating whether or not the endpoint is alive:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"is-endpoint-alive"</span><span style="color: #b58900">&gt;</span>
  ...
  <span style="color: #b58900">&lt;output</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"boolean"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/operation&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The output type must be the last element of an operation.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can set the output to void by removing the element. This prevents the operation from setting the payload of the calling Mule flow&#8217;s Mule event, even if the operation&#8217;s internal behavior involves modifying the payload.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To define output types with complex structures, you can create a catalog of data types that you can use within the module. This catalog of data types can make use of both XML-Schema and JSON-Schema.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of resilience-mule-extension and run a Maven build of this module; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Parameterize other configuration values that can make the module more flexible.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="reuse-sdk-module-operations"><a class="anchor" href="#reuse-sdk-module-operations"></a><a class="link" href="#reuse-sdk-module-operations">Reuse XML SDK module operations</a></h4>
<div class="paragraph">
<p>In some cases, operations have repeated message processors, on which you can rely if they are encapsulated in a new operation and called from other places.</p>
</div>
<div class="paragraph">
<p>Each operation element defined in a module element can be reused in the same module if the operation does not have cyclic dependencies.</p>
</div>
<div class="paragraph">
<p>In this section, you create retry functionality to retry HTTP requests in a new operation that can be used internally by the module or externally by a Mule app. Then you refactor is-endpoint-alive to reuse this functionality internally instead of making its own HTTP requests.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p><strong>Create new retry-http operation:</strong> Move the existing Until Successful scope and &lt;http:request /&gt; logic to a new operation named <strong>retry-http</strong>, supplying the same operation parameters as previously used:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;module&gt;</span>
  ...
  <span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retry-http"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;parameters&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"url"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"URL"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"string"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"REQUIRED"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"responseTimeoutMillis"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Response Timeout in Milliseconds"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"maxRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Max Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[3]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"millisBetweenRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Milliseconds Between Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/parameters&gt;</span>
    <span style="color: #b58900">&lt;body&gt;</span>
      <span style="color: #b58900">&lt;mule:until-successful</span> <span style="color: #268bd2">maxRetries=</span><span style="color: #859900">"#[vars.maxRetries]"</span> <span style="color: #268bd2">millisBetweenRetries=</span><span style="color: #859900">"#[vars.millisBetweenRetries]"</span><span style="color: #b58900">&gt;</span>
        <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"#[vars.url]"</span>
          <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span>
          <span style="color: #268bd2">responseTimeout=</span><span style="color: #859900">"#[vars.responseTimeoutMillis]"</span><span style="color: #b58900">&gt;</span>
          <span style="color: #b58900">&lt;http:response-validator&gt;</span>
            <span style="color: #b58900">&lt;http:success-status-code-validator</span> <span style="color: #268bd2">values=</span><span style="color: #859900">"200..299"</span><span style="color: #b58900">/&gt;</span>
          <span style="color: #b58900">&lt;/http:response-validator&gt;</span>
        <span style="color: #b58900">&lt;/http:request&gt;</span>
     <span style="color: #b58900">&lt;/mule:until-successful&gt;</span>
    <span style="color: #b58900">&lt;/body&gt;</span>
  <span style="color: #b58900">&lt;/operation&gt;</span>
<span style="color: #b58900">&lt;/module&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Handle errors and define output and error types:</strong> Catch any errors raised from the Until Successful scope component with an on-error-continue error handler and map them to a new module-specific error via the raise-error component, setting the output type to <strong>any</strong> and declaring the new <strong>error</strong> type:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;module&gt;</span>
  ...
  <span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"retry-http"</span><span style="color: #b58900">&gt;</span>
    ...
    <span style="color: #b58900">&lt;body&gt;</span>
      <span style="color: #b58900">&lt;mule:try&gt;</span>
        <span style="color: #b58900">&lt;mule:until-successful</span> <span style="color: #268bd2">maxRetries=</span><span style="color: #859900">"#[vars.maxRetries]"</span> <span style="color: #268bd2">millisBetweenRetries=</span><span style="color: #859900">"#[vars.millisBetweenRetries]"</span><span style="color: #b58900">&gt;</span>
          <span style="color: #b58900">&lt;http:request</span> <span style="color: #268bd2">method=</span><span style="color: #859900">"GET"</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"#[vars.url]"</span> <span style="color: #268bd2">followRedirects=</span><span style="color: #859900">"true"</span> <span style="color: #268bd2">responseTimeout=</span><span style="color: #859900">"#[vars.responseTimeoutMillis]"</span><span style="color: #b58900">&gt;</span>
            <span style="color: #b58900">&lt;http:response-validator&gt;</span>
              <span style="color: #b58900">&lt;http:success-status-code-validator</span> <span style="color: #268bd2">values=</span><span style="color: #859900">"200..299"</span><span style="color: #b58900">/&gt;</span>
            <span style="color: #b58900">&lt;/http:response-validator&gt;</span>
          <span style="color: #b58900">&lt;/http:request&gt;</span>
        <span style="color: #b58900">&lt;/mule:until-successful&gt;</span>
        <span style="color: #b58900">&lt;mule:error-handler&gt;</span>
          <span style="color: #b58900">&lt;mule:on-error-continue&gt;</span>
            <span style="color: #b58900">&lt;mule:raise-error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"RESILIENCE:RETRIES_EXHAUSTED"</span> <span style="color: #268bd2">description=</span><span style="color: #859900">"Exhausted re-tries executing http request"</span><span style="color: #b58900">/&gt;</span>
          <span style="color: #b58900">&lt;/mule:on-error-continue&gt;</span>
        <span style="color: #b58900">&lt;/mule:error-handler&gt;</span>
      <span style="color: #b58900">&lt;/mule:try&gt;</span>
    <span style="color: #b58900">&lt;/body&gt;</span>
    <span style="color: #b58900">&lt;output</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"any"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;errors&gt;</span>
      <span style="color: #b58900">&lt;error</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"RETRIES_EXHAUSTED"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/errors&gt;</span>
  <span style="color: #b58900">&lt;/operation&gt;</span>
<span style="color: #b58900">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The errors element declares the error types the XML SDK can raise (or map) within the operation body.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Defined errors can be discovered when using the Studio UI.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Invoke internal operation:</strong> In the <strong>is-endpoint-alive</strong> operation, replace the previous &lt;http:request /&gt; logic with an internal reference to the new <strong>retry-http</strong> operation, adding the same operation parameters and forwarding them on to the new operation:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">module-resilience.xml of resilience-mule-extension</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;module</span> <span style="color: #268bd2">xmlns:tns=</span><span style="color: #859900">"http://www.mulesoft.org/schema/mule/resilience"</span>
 <span style="color: #268bd2">xsi:schemaLocation=</span><span style="color: #859900">"... http://www.mulesoft.org/schema/mule/resilience http://www.mulesoft.org/schema/mule/resilience/current/mule-resilience.xsd"</span><span style="color: #b58900">&gt;</span>

<span style="color: #b58900">&lt;module&gt;</span>
 ...
 <span style="color: #b58900">&lt;operation</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"is-endpoint-alive"</span><span style="color: #b58900">&gt;</span>
    <span style="color: #b58900">&lt;parameters&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"url"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"URL"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"string"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"REQUIRED"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"responseTimeoutMillis"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Response Timeout in Milliseconds"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"maxRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Max Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[3]"</span><span style="color: #b58900">/&gt;</span>
      <span style="color: #b58900">&lt;parameter</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"millisBetweenRetries"</span> <span style="color: #268bd2">displayName=</span><span style="color: #859900">"Milliseconds Between Retries"</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"number"</span> <span style="color: #268bd2">use=</span><span style="color: #859900">"OPTIONAL"</span> <span style="color: #268bd2">defaultValue=</span><span style="color: #859900">"#[2000]"</span><span style="color: #b58900">/&gt;</span>
    <span style="color: #b58900">&lt;/parameters&gt;</span>
    <span style="color: #b58900">&lt;body&gt;</span>
      <span style="color: #b58900">&lt;mule:try&gt;</span>
        <span style="color: #b58900">&lt;tns:retry-http</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"#[vars.url]"</span> <span style="color: #268bd2">responseTimeoutMillis=</span><span style="color: #859900">"#[vars.responseTimeoutMillis]"</span>
          <span style="color: #268bd2">maxRetries=</span><span style="color: #859900">"#[vars.maxRetries]"</span> <span style="color: #268bd2">millisBetweenRetries=</span><span style="color: #859900">"#[vars.millisBetweenRetries]"</span><span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;mule:set-payload</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[true]"</span><span style="color: #b58900">/&gt;</span>
        <span style="color: #b58900">&lt;mule:error-handler&gt;</span>
          <span style="color: #b58900">&lt;mule:on-error-continue&gt;</span>
            <span style="color: #b58900">&lt;mule:set-payload</span> <span style="color: #268bd2">value=</span><span style="color: #859900">"#[false]"</span><span style="color: #b58900">/&gt;</span>
          <span style="color: #b58900">&lt;/mule:on-error-continue&gt;</span>
        <span style="color: #b58900">&lt;/mule:error-handler&gt;</span>
      <span style="color: #b58900">&lt;/mule:try&gt;</span>
    <span style="color: #b58900">&lt;/body&gt;</span>
    <span style="color: #b58900">&lt;output</span> <span style="color: #268bd2">type=</span><span style="color: #859900">"boolean"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/operation&gt;</span>
<span style="color: #b58900">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Both operations are visible to any Mule app using the module. If you want an operation to be truly internal, you can mark the visibility attribute as PRIVATE on the operation element.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>As this is an internal reference, you use the tns namespace identifier defined in the module element.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of resilience-mule-extension and run a Maven build of this module; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn clean <span style="color: #586e75">install</span></code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploy-module-exchange"><a class="anchor" href="#deploy-module-exchange"></a><a class="link" href="#deploy-module-exchange">Deploy an XML SDK module to Exchange</a></h4>
<div class="paragraph">
<p>With the Anypoint Exchange Maven Facade API, Apache Maven clients can publish and consume Exchange assets, including Mule 4 extensions.</p>
</div>
<div class="paragraph">
<p>Mule 4 Extensions that declare dependencies that dont exist in Maven Central or the MuleSoft Maven repositories are not currently supported. Therefore, any artifact deployed to Exchange that relies on a custom asset, such as the parent POM and BOM introduced in the previous sections, is required to deploy to Exchange prior to the extension.</p>
</div>
<div class="paragraph">
<p>The steps to publish an asset with Maven are slightly different for each asset type, and different assets use different Maven plugins. In this case, you will use the Exchange Mule Maven plugin to deploy each POM as a custom asset and finally deploy resilience-mule-extension to Exchange.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="22">
<li>
<p><strong>Study BOM:</strong> Browse the content of bom/pom.xml, identifying the <strong>Exchange Mule Maven plugin</strong> configuration located in a Maven profile with the ID <strong>deploy-to-exchange-v3</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;profile&gt;</span>
  <span style="color: #b58900">&lt;id&gt;</span>deploy-to-exchange-v3<span style="color: #b58900">&lt;/id&gt;</span>
  <span style="color: #b58900">&lt;build&gt;</span>
    <span style="color: #b58900">&lt;plugins&gt;</span>
      <span style="color: #b58900">&lt;plugin&gt;</span>
        <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
        <span style="color: #b58900">&lt;artifactId&gt;</span>exchange-mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
        <span style="color: #b58900">&lt;version&gt;</span>${exchange.mule.maven.plugin.version}<span style="color: #b58900">&lt;/version&gt;</span>
        <span style="color: #b58900">&lt;executions&gt;</span>
          <span style="color: #b58900">&lt;execution&gt;</span>
            <span style="color: #b58900">&lt;id&gt;</span>validate<span style="color: #b58900">&lt;/id&gt;</span>
            <span style="color: #b58900">&lt;phase&gt;</span>validate<span style="color: #b58900">&lt;/phase&gt;</span>
            <span style="color: #b58900">&lt;goals&gt;</span>
              <span style="color: #b58900">&lt;goal&gt;</span>exchange-pre-deploy<span style="color: #b58900">&lt;/goal&gt;</span>
            <span style="color: #b58900">&lt;/goals&gt;</span>
          <span style="color: #b58900">&lt;/execution&gt;</span>
          <span style="color: #b58900">&lt;execution&gt;</span>
            <span style="color: #b58900">&lt;id&gt;</span>deploy<span style="color: #b58900">&lt;/id&gt;</span>
            <span style="color: #b58900">&lt;phase&gt;</span>deploy<span style="color: #b58900">&lt;/phase&gt;</span>
            <span style="color: #b58900">&lt;goals&gt;</span>
              <span style="color: #b58900">&lt;goal&gt;</span>exchange-deploy<span style="color: #b58900">&lt;/goal&gt;</span>
            <span style="color: #b58900">&lt;/goals&gt;</span>
          <span style="color: #b58900">&lt;/execution&gt;</span>
        <span style="color: #b58900">&lt;/executions&gt;</span>
      <span style="color: #b58900">&lt;/plugin&gt;</span>
    <span style="color: #b58900">&lt;/plugins&gt;</span>
  <span style="color: #b58900">&lt;/build&gt;</span>
<span style="color: #b58900">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Mule extensions can reuse the Exchange Mule Maven plugin configuration because extensions are built using the Mule Extensions Maven plugin and not the Mule Maven plugin, therefore not causing multiple deployments.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The exchange-pre-deploy goal must be run to prevalidate the asset with Exchange, where the plugin checks various pre-conditions such as unique asset versions. Without explicitly running this goal, the Exchange API can return a status code of 412 (Precondition Failed). The plugin goal can be bound to other phases such as the validate phase, but it is set to the deploy phase in this course to not interfere with local builds.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API does not support dynamic parameters within groupIds such as ${aa.ap.org.id}, and it requires the value to be the hardcoded Anypoint Platform organization ID.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API requires that every asset deployed must have an artifact name element defined in the POM.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API requires a Maven property named type with the value set custom for custom assets.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Study BOM distributionManagement:</strong> Notice the custom property with your Anypoint Platform organization used to configure <strong>&lt;distributionManagement /&gt;</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">bom/pom.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;properties&gt;</span>
  ...
  <span style="color: #b58900">&lt;student.deployment.ap.orgid&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/student.deployment.ap.orgid&gt;</span>
<span style="color: #b58900">&lt;/properties&gt;</span>
...
<span style="color: #b58900">&lt;repositories&gt;</span>
  <span style="color: #b58900">&lt;repository&gt;</span>
    <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
    <span style="color: #b58900">&lt;name&gt;</span>Anypoint Exchange<span style="color: #b58900">&lt;/name&gt;</span>
    <span style="color: #b58900">&lt;url&gt;</span>https://maven.anypoint.mulesoft.com/api/v3/maven<span style="color: #b58900">&lt;/url&gt;</span>
  <span style="color: #b58900">&lt;/repository&gt;</span>
  ...
<span style="color: #b58900">&lt;/repositories&gt;</span>
<span style="color: #b58900">&lt;distributionManagement&gt;</span>
  <span style="color: #b58900">&lt;repository&gt;</span>
    <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
    <span style="color: #b58900">&lt;name&gt;</span>AnyAirline Anypoint Exchange<span style="color: #b58900">&lt;/name&gt;</span>
    <span style="color: #b58900">&lt;url&gt;</span>https://maven.anypoint.mulesoft.com/api/v3/organizations/${student.deployment.ap.orgid}/maven<span style="color: #b58900">&lt;/url&gt;</span>
    <span style="color: #b58900">&lt;layout&gt;</span>default<span style="color: #b58900">&lt;/layout&gt;</span>
  <span style="color: #b58900">&lt;/repository&gt;</span>
<span style="color: #b58900">&lt;/distributionManagement&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Mule Maven plugin also requires the Exchange v3 API to publish custom assets, which is reflected in the repository URL.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create Exchange Contributor Connected App:</strong> In Anypoint Access Management, create a new Connected App that acts on its <strong>own behalf (client credentials)</strong>, for writing assets to Exchange, adding the <strong>Exchange Contributor</strong> scope and retrieve its client ID and secret.</p>
</li>
<li>
<p><strong>Update settings.xml:</strong> In <strong>settings.xml</strong>, change the credentials of the matching server entry for the repository (defined in the distributionManagement section of bom/pom.xml to use the Connected App credentials created previously for writing to that repository):</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;server&gt;</span>
  <span style="color: #b58900">&lt;id&gt;</span>anypoint-exchange-v3-student-deployment<span style="color: #b58900">&lt;/id&gt;</span>
  <span style="color: #b58900">&lt;username&gt;</span>~~~Client~~~<span style="color: #b58900">&lt;/username&gt;</span>
  <span style="color: #b58900">&lt;password&gt;</span>your-capp-contributor-cid~?~your-capp-contributor-secret<span style="color: #b58900">&lt;/password&gt;</span>
<span style="color: #b58900">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can also use Anypoint Platform credentials for an account of your Anypoint Platform organization with which you were able to search your Exchange, such as the trial account credentials created previously. However, it is best practice to use a Connected App for security.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>To use Connected App authentication, provide basic authentication and define the username as ~~~Client~~~ and the password as clientID~?~clientSecret. Replace clientID with the client ID. Replace clientSecret with the client secret.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy parent POMs to Exchange:</strong> Deploy the <strong>BOM</strong> and <strong>parent POM</strong> used by resilience-mule-extension to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/bom
mvn deploy <span style="color: #b58900">-f</span> pom.xml <span style="color: #b58900">-Pdeploy-to-exchange-v3</span>

<span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/parent-pom
mvn deploy <span style="color: #b58900">-f</span> pom.xml <span style="color: #b58900">-Pdeploy-to-exchange-v3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>When a SNAPSHOT version is deployed to Exchange, it is created in the development lifecycle phase allowing the asset version to be overwritten and permanently deleted, whenever. When a stable asset version is deployed, Exchange will treat the asset as a production asset and enforce the standard Exchange rules upon it. Such as locking the version number so it cannot be overwritten and only allowing permanent deletion within the first 7 days.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy XML SDK module to Exchange:</strong> Deploy resilience-mule-extension to your remote Exchange repository:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/resilience-mule-extension
mvn deploy <span style="color: #b58900">-Pdeploy-to-exchange-v3</span></code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="import-sdk-module"><a class="anchor" href="#import-sdk-module"></a><a class="link" href="#import-sdk-module">Import an XML SDK module into another Mule app</a></h4>
<div class="paragraph">
<p>In this section, you import resilience-mule-extension as a Maven dependency into check-in-papi to reuse the operations of the XML SDK module.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="28">
<li>
<p><strong>Add managed XML SDK module dependency:</strong> Locate the existing dependency management of resilience-mule-extension in the <strong>BOM</strong> and add a matching entry to the check-in-papi <strong>POM</strong>:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;dependencies&gt;</span>
  ...
  <span style="color: #b58900">&lt;dependency&gt;</span>
    <span style="color: #b58900">&lt;groupId&gt;</span>${student.deployment.ap.orgid}<span style="color: #b58900">&lt;/groupId&gt;</span>
    <span style="color: #b58900">&lt;artifactId&gt;</span>resilience-mule-extension<span style="color: #b58900">&lt;/artifactId&gt;</span>
    <span style="color: #b58900">&lt;classifier&gt;</span>mule-plugin<span style="color: #b58900">&lt;/classifier&gt;</span>
  <span style="color: #b58900">&lt;/dependency&gt;</span>
<span style="color: #b58900">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Refresh Studio project:</strong> In Studio, close and reopen the <strong>check-in-papi</strong> project; Studio should resolve the resilience-mule-extension dependency and show it as a project dependency.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><em>Note:</em> <em>If Studio does not find resilience-mule-extension, then you may need to force reloading Maven dependencies from a command-line interface with the <code>-U</code> option, and then close and reopen the check-in-papi Studio project:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn clean verify <span style="color: #b58900">-U</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Replace imported Flow references:</strong> In <strong>check-all-dependencies-are-alive</strong> of health.xml replace each &lt;flow-ref /&gt; with the new <strong>resilience:is-endpoint-alive</strong> operation with the relevant URL property:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">health.xml of check-in-papi</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;sub-flow</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"check-all-dependencies-are-alive"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;resilience:is-endpoint-alive</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"${external.flightsManagementSapi.aliveUrl}"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;resilience:is-endpoint-alive</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"${external.passengerDataSapi.aliveUrl}"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;resilience:is-endpoint-alive</span> <span style="color: #268bd2">url=</span><span style="color: #859900">"${external.paypalSapi.aliveUrl}"</span><span style="color: #b58900">/&gt;</span>
<span style="color: #b58900">&lt;/sub-flow&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run and invoke:</strong> Run check-in-papi in Studio and invoke its readiness health check endpoint as usual; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> https://localhost:8081/ready</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Homework:</strong> Update the operation to only retry failed API invocations if the error is transient in nature.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="wt-begin-262"><a class="anchor" href="#wt-begin-262"></a><a class="link" href="#wt-begin-262">Walkthrough 6-2: Create a custom API policy</a></h3>
<div class="paragraph">
<p>In this walkthrough, you create a custom API policy for operational logging of HTTP requests and responses. You then apply this API policy both offline in Studio and online via API Manager using an automated policy.</p>
</div>
<div class="paragraph">
<p>You will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#generate-policy">Generate a custom API policy skeleton from a Maven archetype</a>.</p>
</li>
<li>
<p><a href="#develop-policy">Develop a custom API policy to log HTTP requests and responses</a>.</p>
</li>
<li>
<p><a href="#apply-offline-policy">Apply an offline custom API policy</a>.</p>
</li>
<li>
<p><a href="#apply-online-policy">Apply an online custom API policy</a>.</p>
</li>
<li>
<p><a href="#develop-complex-policy">Develop complex policies using Handlebars</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_solution_file_20"><a class="anchor" href="#_solution_file_20"></a><a class="link" href="#_solution_file_20">Solution file</a></h4>
<div class="paragraph">
<p>You can see the end state of following this walkthrough in the solutions folder of the student files ZIP located in the Course Resources: $APDL2DIST/walkthroughs/devint/module06/wt6-2_solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="generate-policy"><a class="anchor" href="#generate-policy"></a><a class="link" href="#generate-policy">Generate a custom API policy skeleton from a Maven archetype</a></h4>
<div class="paragraph">
<p>In this section, you generate a custom API policy skeleton project from a Maven archetype.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Execute archetype:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of your Studio workspace and run the Maven archetype with your Anypoint Platform organization ID; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Unix variants</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>

mvn <span style="color: #b58900">-B</span> <span style="color: #b58900">-f</span> bom/pom.xml archetype:generate <span style="color: #b58900">-DarchetypeGroupId</span><span style="color: #93a1a1">=</span>org.mule.tools <span style="color: #b58900">-DarchetypeArtifactId</span><span style="color: #93a1a1">=</span>api-gateway-custom-policy-archetype <span style="color: #b58900">-DarchetypeVersion</span><span style="color: #93a1a1">=</span>1.2.0 <span style="color: #b58900">-DgroupId</span><span style="color: #93a1a1">=</span>your-AP-organization-id <span style="color: #b58900">-DartifactId</span><span style="color: #93a1a1">=</span>custom-message-logging-policy <span style="color: #b58900">-Dversion</span><span style="color: #93a1a1">=</span>1.0.0-SNAPSHOT <span style="color: #b58900">-Dpackage</span><span style="color: #93a1a1">=</span>mule-policy <span style="color: #b58900">-DpolicyDescription</span><span style="color: #93a1a1">=</span><span style="color: #859900">"Policy for logging messages"</span> <span style="color: #b58900">-DpolicyName</span><span style="color: #93a1a1">=</span><span style="color: #859900">"Custom Message Logging"</span> <span style="color: #b58900">-DoutputDirectory</span><span style="color: #93a1a1">=</span>../</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>

mvn <span style="color: #b58900">-B</span> <span style="color: #b58900">-f</span> bom/pom.xml archetype:generate <span style="color: #b58900">-DarchetypeGroupId</span><span style="color: #93a1a1">=</span>org.mule.tools <span style="color: #b58900">-DarchetypeArtifactId</span><span style="color: #93a1a1">=</span>api-gateway-custom-policy-archetype <span style="color: #b58900">-DarchetypeVersion</span><span style="color: #93a1a1">=</span>1.2.0 <span style="color: #b58900">-DgroupId</span><span style="color: #93a1a1">=</span>your-AP-organization-id <span style="color: #b58900">-DartifactId</span><span style="color: #93a1a1">=</span>custom-message-logging-policy <span style="color: #b58900">-Dversion</span><span style="color: #93a1a1">=</span>1.0.0-SNAPSHOT <span style="color: #b58900">-Dpackage</span><span style="color: #93a1a1">=</span>mule-policy <span style="color: #b58900">-DpolicyDescription</span><span style="color: #93a1a1">=</span><span style="color: #859900">"Policy for logging messages"</span> <span style="color: #b58900">-DpolicyName</span><span style="color: #93a1a1">=</span><span style="color: #859900">"Custom Message Logging"</span> <span style="color: #b58900">-DoutputDirectory</span><span style="color: #93a1a1">=</span>C:<span style="color: #d33682">\w</span>indows<span style="color: #d33682">\f</span>ull<span style="color: #d33682">\p</span>ath<span style="color: #d33682">\t</span>o<span style="color: #d33682">\y</span>our<span style="color: #d33682">\w</span>orkspace</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Maven groupId is required to be an Anypoint Platform organization ID in order to successfully deploy to Exchange. Refer to the final solution to see an advanced Maven configuration that supports maintaining two POM files: One for deploying to Exchange and one for standard development processes.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Browse the generated artifact:</strong> Inspect the generated directory structure of the newly created API policy named custom-message-logging-policy.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="develop-policy"><a class="anchor" href="#develop-policy"></a><a class="link" href="#develop-policy">Develop a custom API policy to log HTTP requests and responses</a></h4>
<div class="paragraph">
<p>In this section, you modify the generated API policy to inherit from a parent POM to gain access to the repository settings. Then you modify the policy template to log messages before and after receiving HTTP requests.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Import into Studio:</strong> Import the API policy into Studio by creating a <strong>New</strong> <strong>General</strong> <strong>Project</strong>, setting the project name as <strong>custom-message-logging-policy</strong>, and changing the default location to the location of your generated API policy.</p>
</li>
<li>
<p><strong>Turn POM into child POM:</strong> Turn the API policy into a Maven child project of your existing <strong>parent POM</strong> in its parent directory and remove the &lt;properties /&gt;, &lt;distributionManagement /&gt;, and  &lt;plugins /&gt; elements except for the Mule Maven plugin:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;parent&gt;</span>
  <span style="color: #657b83">&lt;!-- students: replace with your AP org ID --&gt;</span>
  <span style="color: #b58900">&lt;groupId&gt;</span>a63e6d25-8aaf-4512-b36d-d91b90a55c4a<span style="color: #b58900">&lt;/groupId&gt;</span>
  <span style="color: #b58900">&lt;artifactId&gt;</span>solutions-parent-pom<span style="color: #b58900">&lt;/artifactId&gt;</span>
  <span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
  <span style="color: #b58900">&lt;relativePath&gt;</span>../parent-pom/pom.xml<span style="color: #b58900">&lt;/relativePath&gt;</span>
<span style="color: #b58900">&lt;/parent&gt;</span>
<span style="color: #b58900">&lt;groupId&gt;</span>your-AP-organization-id<span style="color: #b58900">&lt;/groupId&gt;</span>
<span style="color: #b58900">&lt;artifactId&gt;</span>custom-message-logging-policy<span style="color: #b58900">&lt;/artifactId&gt;</span>
<span style="color: #b58900">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color: #b58900">&lt;/version&gt;</span>
<span style="color: #b58900">&lt;name&gt;</span>Custom Message Logging<span style="color: #b58900">&lt;/name&gt;</span>
<span style="color: #b58900">&lt;description&gt;</span>Policy for logging messages<span style="color: #b58900">&lt;/description&gt;</span>
<span style="color: #b58900">&lt;packaging&gt;</span>mule-policy<span style="color: #b58900">&lt;/packaging&gt;</span>
<span style="color: #b58900">&lt;build&gt;</span>
  <span style="color: #b58900">&lt;plugins&gt;</span>
    <span style="color: #b58900">&lt;plugin&gt;</span>
      <span style="color: #b58900">&lt;groupId&gt;</span>org.mule.tools.maven<span style="color: #b58900">&lt;/groupId&gt;</span>
      <span style="color: #b58900">&lt;artifactId&gt;</span>mule-maven-plugin<span style="color: #b58900">&lt;/artifactId&gt;</span>
      <span style="color: #b58900">&lt;extensions&gt;</span>true<span style="color: #b58900">&lt;/extensions&gt;</span>
    <span style="color: #b58900">&lt;/plugin&gt;</span>
  <span style="color: #b58900">&lt;/plugins&gt;</span>
<span style="color: #b58900">&lt;/build&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The mule.maven.plugin.version overrides the Mule Maven plugin version defined in the BOM, which uses a newer, incompatible configuration that will cause the overall build to fail.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The default Exchange URL added is the v2 API whereas this course uses a newer v3 API.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The archetype generates a Maven Deploy plugin configuration that is rendered obsolete by the v3 API.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of custom-message-logging-policy and run a Maven build of this API policy; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/custom-message-logging-policy
mvn clean verify</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Log:</strong> Add log statements to the <strong>http-policy:proxy</strong> in <strong>template.xml</strong> before and after the <strong>http-policy:execute-next</strong> element parameterizing the message using handlebar syntax and logging input and output for each HTTP request received:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">template.xml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http-policy:proxy</span>
    <span style="color: #268bd2">name=</span><span style="color: #859900">"{{{policyId}}}-custom-policy"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http-policy:source&gt;</span>
    <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span>
      <span style="color: #268bd2">message=</span><span style="color: #859900">"{{{message}}}"</span>
      <span style="color: #268bd2">category=</span><span style="color: #859900">"org.mule.runtime.logging.policy-{{{policyId}}}"</span><span style="color: #b58900">/&gt;</span>

    <span style="color: #b58900">&lt;http-policy:execute-next</span> <span style="color: #b58900">/&gt;</span>

    <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span>
      <span style="color: #268bd2">message=</span><span style="color: #859900">"{{{message}}}"</span>
      <span style="color: #268bd2">category=</span><span style="color: #859900">"org.mule.runtime.logging.policy-{{{policyId}}}"</span><span style="color: #b58900">/&gt;</span>
  <span style="color: #b58900">&lt;/http-policy:source&gt;</span>
<span style="color: #b58900">&lt;/http-policy:proxy&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Any Mule event operation that is defined before the http-policy:execute-next element will be executed before the start of a flow with an HTTP Listener.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The http-policy:execute-next element is required to continue the Mule event processing. The http-policy:execute-next element can trigger other policies or the application flow. Any policy can stop the Mule event processing chain by not executing http-policy:execute-next.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Mule event operations defined after the http-policy:execute-next element will be executed after the flow completes. These Mule Event processors are able to process the Mule Event returned from the flow.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You remove the http-transform:add-headers element because it is not needed in this case. This element is available from mule-http-policy-transform-extension plugin that can be used to modify HTTP requests within an API policy.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Whereas the http-policy:source element intercepts incoming HTTP requests to &lt;http:listener /&gt; elements, the http-policy:operation element can intercept outgoing HTTP requests made be the &lt;http:request /&gt;.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Configure user parameters:</strong> In <strong>custom-message-logging-policy.yaml</strong>, add the configuration for the parameterized values used in our template:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">custom-message-logging-policy.yaml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">id: Custom Message Logging
name: Custom Message Logging
description: Policy for logging messages
category: Custom
type: custom
resourceLevelSupported: true
encryptionSupported: false
standalone: true
requiredCharacteristics: []
providedCharacteristics: []
configuration:
   propertyName: message
    name: Message
    description: |
      Mule Expression for extracting information from the message to log.
      e.g. #[attributes.headers['id']]
    type: expression
    optional: false</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Every parameter listed here is rendered as an expected user input in API Managers UI.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can use propertyName to specify the internal name of the parameter. This value must be unique within the policy.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Parameters can have various types, including expression, string etc. Parameters also be masked, mandated and defaulted via configuration. Each option influences how the policy configuration page is displayed in API Managers UI</em>.</p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Maven-build:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of custom-message-logging-policy and run a Maven build of this API policy; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/custom-message-logging-policy

mvn clean package</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="apply-offline-policy"><a class="anchor" href="#apply-offline-policy"></a><a class="link" href="#apply-offline-policy">Apply an offline custom API policy</a></h4>
<div class="paragraph">
<p>In this section, you test the API policy locally by applying it as an offline API policy directly to the runtime and not through API Manager.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p><strong>Go to MULE_HOME policies directory:</strong> In a command-line interface, navigate to the <strong>MULE_HOME</strong> directory of the Studio-embedded Mule runtime:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> &lt;MULE_HOME&gt;/policies</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You can find the MULE_HOME location by searching for MULE_HOME in a running Studio console.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Copy policy:</strong> In a command-line interface, copy the packaged policy from the <strong>target</strong> directory to the local <strong>policy-templates</strong> directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cp</span> <span style="color: #586e75">$APDL2WS</span>/custom-message-logging-policy/target/custom-message-logging-policy-1.0.0-SNAPSHOT-mule-policy.jar &lt;MULE_HOME&gt;/policies/policy-templates</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Create offline policy definition:</strong> In a text editor, create a new file named <strong>custom-message-logging-policy-definition.json</strong>, supplying the API ID for check-in-papi from dev-properties.yaml in the <strong>&lt;MULE_HOME&gt;/policies/offline-policies</strong> directory:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">custom-message-logging-policy-definition.json</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="json"><span style="color: #93a1a1">{</span><span style="color: #586e75">
 </span><span style="color: #586e75">"template"</span><span style="color: #586e75"> </span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #93a1a1">{</span><span style="color: #586e75">
   </span><span style="color: #586e75">"groupId"</span><span style="color: #586e75"> </span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"&lt;your-ap-organization-id&gt;"</span><span style="color: #93a1a1">,</span><span style="color: #586e75">
   </span><span style="color: #586e75">"assetId"</span><span style="color: #586e75"> </span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"custom-message-logging-policy"</span><span style="color: #93a1a1">,</span><span style="color: #586e75">
   </span><span style="color: #586e75">"version"</span><span style="color: #586e75"> </span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"1.0.0-SNAPSHOT"</span><span style="color: #586e75">
 </span><span style="color: #93a1a1">},</span><span style="color: #586e75">
 </span><span style="color: #586e75">"api"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #93a1a1">[</span><span style="color: #586e75">
   </span><span style="color: #93a1a1">{</span><span style="color: #586e75">
     </span><span style="color: #586e75">"id"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"&lt;insert-your-api-id&gt;"</span><span style="color: #586e75">
   </span><span style="color: #93a1a1">}</span><span style="color: #586e75">
 </span><span style="color: #93a1a1">],</span><span style="color: #586e75">
 </span><span style="color: #586e75">"order"</span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">1</span><span style="color: #93a1a1">,</span><span style="color: #586e75">
 </span><span style="color: #586e75">"configuration"</span><span style="color: #586e75"> </span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #93a1a1">{</span><span style="color: #586e75">
   </span><span style="color: #586e75">"message"</span><span style="color: #586e75"> </span><span style="color: #93a1a1">:</span><span style="color: #586e75"> </span><span style="color: #859900">"#['Hello']"</span><span style="color: #586e75">
 </span><span style="color: #93a1a1">}</span><span style="color: #586e75">
</span><span style="color: #93a1a1">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>These values are configured by API Managers UI when using an online policy.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must manually specify all the API IDs for the APIs to which you want this policy to apply.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>You must specify the Exchange groupId, assetId, and version of the template used to deploy the offline policy definition.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Run, invoke, and check log:</strong> Run check-in-papi from Studio, invoke the API using cURL as before, and study the log entries originating from the API policy:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">curl <span style="color: #b58900">-ik</span> <span style="color: #b58900">-X</span> PUT <span style="color: #b58900">-H</span> <span style="color: #859900">"Content-Type: application/json"</span> <span style="color: #b58900">-d</span> <span style="color: #859900">"{</span><span style="color: #d33682">\"</span><span style="color: #859900">lastName</span><span style="color: #d33682">\"</span><span style="color: #859900">:</span><span style="color: #d33682">\"</span><span style="color: #859900">Smith</span><span style="color: #d33682">\"</span><span style="color: #859900">,</span><span style="color: #d33682">\"</span><span style="color: #859900">numBags</span><span style="color: #d33682">\"</span><span style="color: #859900">:2}"</span> https://localhost:8081/api/v1/tickets/PNR123/checkin</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="apply-online-policy"><a class="anchor" href="#apply-online-policy"></a><a class="link" href="#apply-online-policy">Apply an online custom API policy</a></h4>
<div class="paragraph">
<p>In this section, you deploy custom-message-logging-policy to Exchange and apply it as an online API policy through API Manager.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p><strong>Update to release version:</strong> Update the artifact version from a SNAPSHOT to a release version:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;version&gt;</span>1.0.0<span style="color: #b58900">&lt;/version&gt;</span>
..</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>API Manager does not allow you to choose development assets versions of policies such as Maven snapshots deployed via Exchange Mule Maven plugin.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>All stable policy versions are immutable. After a stable policy is deployed to Exchange, that version number can no longer be changed or reused. Therefore, you must increase the artifact version for every deployment to Exchange.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy to Exchange:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of custom-message-logging-policy and run a Maven deploy of this API policy; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash"><span style="color: #586e75">cd</span> <span style="color: #586e75">$APDL2WS</span>/custom-message-logging-policy
mvn deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Mule Maven plugin is automatically integrated with the Exchange Mule Maven plugin; therefore, there is no need to define the Exchange Mule Maven plugin configuration as well. It is only needed to directly reference the Exchange Mule Maven plugin when deploying non-Mule artifacts such as custom libraries and POMs. If both are configured, deployment will happen twice, and the second deployment will fail with a conflict.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The parent POMs this policy relies on were deployed in the previous walkthrough. If they had not been, deployment would be required prior to deploying anAPI policy.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Apply automated policy:</strong> In the API Manager <strong>dev</strong> environment, apply a new automated policy.</p>
</li>
<li>
<p><strong>Configure custom-message-logging-policy:</strong> Select the latest custom-message-logging-policy API policy, logging a custom message:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">#['Hello']</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="develop-complex-policy"><a class="anchor" href="#develop-complex-policy"></a><a class="link" href="#develop-complex-policy">Develop complex policies using Handlebars</a></h4>
<div class="paragraph">
<p>In this section, you use the Handlebars templating framework to decide which sections of the policy are applied depending on the user configuration. Specifically, you use the if helper to conditionally render which logger element is added to the policy dependent on whether the user has chosen to log requests before or after an HTTP request.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="17">
<li>
<p><strong>Configure conditional parameters:</strong> In <strong>custom-message-logging-policy.yaml</strong>, add the configuration options to log before or after an HTTP request is received:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">custom-message-logging-policy.yaml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">id: Custom Message Logging
name: Custom Message Logging
description: Policy for logging messages
category: Custom
type: custom
resourceLevelSupported: true
encryptionSupported: false
standalone: true
requiredCharacteristics: []
providedCharacteristics: []
configuration:
   propertyName: message
    name: Message
    description: |
      Mule Expression for extracting information from the message to log.
      e.g. #[attributes.headers['id']]
    type: expression
    optional: false

   propertyName: beforeRequest
    name: Before Calling API
    type: boolean
    optional: false
    defaultValue: true

   propertyName: afterRequest
    name: After Calling API
    type: boolean
    optional: false
    defaultValue: false</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p><strong>Conditionally log:</strong> In <strong>template.xml</strong>, wrap the log statements before and after <strong>http-policy:execute-next</strong> with if blocks that validate the beforeRequest and afterRequest conditions, respectively:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">template.xml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;http-policy:proxy</span> <span style="color: #268bd2">name=</span><span style="color: #859900">"{{{policyId}}}-custom-policy"</span><span style="color: #b58900">&gt;</span>
  <span style="color: #b58900">&lt;http-policy:source&gt;</span>
    {{#if beforeRequest}}
    <span style="color: #b58900">&lt;logger:logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"{{{message}}}"</span> <span style="color: #268bd2">category=</span><span style="color: #859900">"org.mule.runtime.logging.policy-{{{policyId}}}"</span><span style="color: #b58900">/&gt;</span>
    {{/if}}
    <span style="color: #b58900">&lt;http-policy:execute-next</span> <span style="color: #b58900">/&gt;</span>
    {{#if afterRequest}}
    <span style="color: #b58900">&lt;logger</span> <span style="color: #268bd2">level=</span><span style="color: #859900">"INFO"</span> <span style="color: #268bd2">message=</span><span style="color: #859900">"{{{message}}}"</span> <span style="color: #268bd2">category=</span><span style="color: #859900">"org.mule.runtime.logging.policy-{{{policyId}}}"</span><span style="color: #b58900">/&gt;</span>
    {{/if}}
  <span style="color: #b58900">&lt;/http-policy:source&gt;</span>
<span style="color: #b58900">&lt;/http-policy:proxy&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>Handlebars also supports other built-in helper blocks such as else, each and unless.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Bump Maven artifact version:</strong> In <strong>pom.xml</strong>, bump the patch version of custom-message-logging-policy:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">pom.xml of custom-message-logging-policy</div>
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml">...
<span style="color: #b58900">&lt;version&gt;</span>1.0.1<span style="color: #b58900">&lt;/version&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>API Manager does not allow you to choose SNAPSHOT versions of policies.</em></p>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>All stable policy versions are immutable. After a stable policy is deployed to Exchange, that version number can no longer be changed or reused. Therefore, you must increase the artifact version for every deployment to Exchange.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Deploy to Exchange:</strong> In a command-line interface, navigate to the <strong>base directory</strong> of custom-message-logging-policy and run a Maven deploy of this API policy; this should succeed:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="bash">mvn clean deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note:</em> <em>The Exchange Maven Facade API enables you to both create your asset and set the mutable data describing it in the same request. The mutable data of an asset includes tags, custom fields, categories, and documentation pages. The final solution includes a complete example of creating an API policy with documentation and tags.</em></p>
</div>
</div>
</div>
</li>
<li>
<p><strong>Apply new automated policy version:</strong> In the API Manager <strong>dev</strong> environment, apply the new automated policy, removing the previous policy.</p>
</li>
<li>
<p><strong>Configure custom-message-logging-policy:</strong> Select the latest custom-message-logging-policy API policy, logging a custom message as before, but this time choose to log only before an API invocation.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-coding-conventions"><a class="anchor" href="#module-coding-conventions"></a><a class="link" href="#module-coding-conventions">Appendix A: Coding conventions</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_general"><a class="anchor" href="#_general"></a><a class="link" href="#_general">A.1. General</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Importing API specifications into a Studio project:</strong> Dont import from API Designer but import a well-defined version of the API specification (RAML definition or OpenAPI definition) from Exchange using the API Sync feature available in Studio 7.4.0 or later.</p>
</li>
<li>
<p><strong>Abbreviations:</strong> Use wherever space is limited, such as for API Designer project names, Mule app names, and the like:</p>
<div class="ulist">
<ul>
<li>
<p>SAPI for System API</p>
</li>
<li>
<p>PAPI for Process API</p>
</li>
<li>
<p>EAPI for Experience API</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Definition of Done:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Implementation meets all functional and nonfunctional requirements.</p>
</li>
<li>
<p>Readiness endpoint checks liveness of all the Mule app&#8217;s dependencies.</p>
</li>
<li>
<p>MUnit tests assert all functional requirements and all tests pass.</p>
</li>
<li>
<p>Functional Monitors source code checked in to src/test/funmon.</p>
</li>
<li>
<p>Mule app deployed to all CloudHub environments using Maven and scripts to invoke Maven.</p>
</li>
<li>
<p>Functional Monitors deployed for all Anypoint Platform environments and all statuses displayed in green.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_raml_definitions_and_api_designer_projects"><a class="anchor" href="#_raml_definitions_and_api_designer_projects"></a><a class="link" href="#_raml_definitions_and_api_designer_projects">A.2. RAML definitions and API Designer projects</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>API Designer project</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Use a business-friendly project name, choose name of dominant RAML object and keep all other naming defaults:</p>
<div class="ulist">
<ul>
<li>
<p>Project name for RAML definition: Passenger Data SAPI</p>
<div class="ulist">
<ul>
<li>
<p>title: Passenger Data SAPI</p>
</li>
<li>
<p>Defaults:</p>
<div class="ulist">
<ul>
<li>
<p>RAML file: passenger-data-sapi.raml (visible in API implementation)</p>
</li>
<li>
<p>Exchange asset ID: passenger-data-sapi</p>
</li>
<li>
<p>Exchange name: Passenger Data SAPI (visible to all Exchange users)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Project name for RAML type or RAML library containing that type: PaymentApproval</p>
<div class="ulist">
<ul>
<li>
<p>Type name: PaymentApproval</p>
</li>
<li>
<p>Defaults:</p>
<div class="ulist">
<ul>
<li>
<p>RAML file: paymentapproval.raml</p>
</li>
<li>
<p>Exchange asset ID: paymentapproval</p>
</li>
<li>
<p>Exchange name: PaymentApproval (visible to all Exchange users)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Combine RAML type with examples into a <strong>RAML library</strong>, don&#8217;t just use a RAML type fragment</p>
</li>
<li>
<p>Use subdirectories within project:</p>
<div class="ulist">
<ul>
<li>
<p>For RAML type: types</p>
</li>
<li>
<p>For examples: examples</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>API specification attributes:</strong></p>
<div class="ulist">
<ul>
<li>
<p>title: Check-In PAPI, see above</p>
</li>
<li>
<p>version: v1</p>
</li>
<li>
<p>baseUri: use the one from the prod environment, for example <a href="https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1" class="bare">https://check-in-papi-uniqid.shard.usa-e2.cloudhub.io/api/v1</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_mule_apps"><a class="anchor" href="#_mule_apps"></a><a class="link" href="#_mule_apps">A.3. Mule apps</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Project-level:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Maven &lt;groupId /&gt;: com.mulesoft.training.anyairline</p>
</li>
<li>
<p>Studio project name = Maven &lt;artifactId /&gt; = Maven project name:</p>
<div class="ulist">
<ul>
<li>
<p>For API implementation: passenger-data-sapi = Exchange asset ID of API exposed by that API implementation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Mule flows:</strong> check-all-dependencies-are-alive, register-passenger-data</p>
<div class="ulist">
<ul>
<li>
<p>Also correct names autogenerated by Studio</p>
</li>
<li>
<p><strong>Prefer subflows</strong> over flows where possible, for example, unless error handling or a message source is needed in the flow</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Global config elements:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use camelCase: apiHttpListenerConfig</p>
</li>
<li>
<p>With the exception of global error handlers (which are conceptually more like flows): api-error-handler</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>doc:name:</strong></p>
<div class="ulist">
<ul>
<li>
<p>For event processors: sentence case without punctuation: "Set PNR from query param</p>
<div class="ulist">
<ul>
<li>
<p>Such that the entire graphical representation of each flow reads as much as possible like a paragraph in a story</p>
</li>
</ul>
</div>
</li>
<li>
<p>For &lt;set-variable /&gt; include the name of the variable and further detail only if really helpful) "origPayload"</p>
</li>
<li>
<p>For &lt;raise-error /&gt; use the type of error being raised, omitting the APP namespace but including all other namespaces</p>
</li>
<li>
<p>For &lt;flow-ref /&gt; use the name of the flow being invoked: check-all-dependencies-are-alive</p>
<div class="ulist">
<ul>
<li>
<p>Flow names should be descriptive already</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>File-level:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use double quotes (") for XML attributes and single quotes for DataWeave strings (so that an XML formatter can enforce XML file layout):</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #586e75"><code data-lang="xml"><span style="color: #b58900">&lt;set-payload</span>
  <span style="color: #268bd2">value=</span><span style="color: #859900">"#[output application/json --- {message: 'Invalid passenger name record given.'}]"</span>
  <span style="color: #268bd2">doc:name=</span><span style="color: #859900">"error"</span> <span style="color: #b58900">/&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Mule flow config files:</p>
<div class="ulist">
<ul>
<li>
<p>error.xml for global error handlers</p>
</li>
<li>
<p>global.xml for global definitions that are not error handlers</p>
</li>
<li>
<p>api.xml for top-level, API-related Mule flows called from APIkit</p>
</li>
<li>
<p>main.xml for main integration logic (and additional Mule flow config files if helpful)</p>
</li>
<li>
<p>health.xml for liveness and readiness endpoints (see below)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configuration properties files:</p>
<div class="ulist">
<ul>
<li>
<p>properties.yaml for environment-independent config</p>
</li>
<li>
<p>dev-properties.yaml, dev-secure-properties.yaml for env-dependent config for the dev environment</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Endpoints:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use <strong>http.port</strong> or  <strong>https.port</strong> for the name of the configuration property that holds the port at which the API is exposed</p>
</li>
<li>
<p>API endpoint for the one API exposed by an API implementation: /api/v1 for the API itself and /console/v1 for API Console for that API (assuming major version v1)</p>
</li>
<li>
<p>Health check endpoints: Mule apps expose endpoints for Kubernetes-style "probes":</p>
<div class="ulist">
<ul>
<li>
<p>For a liveness probe at /alive, returning 200 if alive or 500 if not</p>
</li>
<li>
<p>For a readiness probe at /ready, returning 200 if ready or 500 if not</p>
<div class="ulist">
<ul>
<li>
<p>Readiness requires the Mule app to verify that all its dependencies are alive. For API dependencies, this means invoking /alive</p>
</li>
</ul>
</div>
</li>
<li>
<p>These should use the same HTTP Listener configuration as the main API endpoints</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Logging:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Merge two or more subsequent loggers into one</p>
</li>
<li>
<p>Log-levels:</p>
<div class="ulist">
<ul>
<li>
<p>INFO for start and end of externally visible flow, but not those delegated to by APIkit because they use Message Logging API policy</p>
</li>
<li>
<p>INFO before and after every invocation of an external system</p>
</li>
<li>
<p>INFO before raising error</p>
</li>
<li>
<p>DEBUG for internal flows and other log entries</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Error handling:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Use descriptive error types: APP:INVALID_CHECKIN_RESPONSE</p>
</li>
<li>
<p>By default, define all custom application error types in the APP namespace</p>
<div class="ulist">
<ul>
<li>
<p>Omit that namespace in doc:name and the like because it is assumed to be the most common namespace</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define all custom application errors that should be communicated to a client (if possible) in the EXT namespace and always supply description for client: EXT:CANT_CHECKIN, EXT:BAD_REQUEST etc.</p>
</li>
<li>
<p>Raise errors only for error conditions, not to control happy-path message processing</p>
</li>
<li>
<p>Reuse common error response creation encapsulated in error-common.xml in apps-commons</p>
<div class="ulist">
<ul>
<li>
<p>Specially handles EXT:BAD_REQUEST and all errors in the EXT namespace</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>MUnit tests:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Do not test the APIkit-generated main flow (containing the APIkit Router) and console flow</p>
</li>
<li>
<p>Do not test for validations already performed by APIkit: required parameters, data types of parameters, payload message format, etc.</p>
</li>
<li>
<p>Do not enable flow sources for HTTP/S and do not test APIs by invoking them over HTTP/S. Instead, refactor Mule flows that do actual work so that they are easy to test and independent of APIkit, and then test those flows directly</p>
</li>
<li>
<p>In general, do not accept any incoming network communication and do not perform any outgoing network communication from unit tests: MUnit tests must run in isolation in a sandboxed Mule runtime without connectivity or dependency on remote components</p>
</li>
<li>
<p>Use a synchronous logger configuration for tests, with all relevant log levels set to DEBUG</p>
</li>
<li>
<p>Testable Mule flows:</p>
<div class="ulist">
<ul>
<li>
<p>Avoid nested XML elements in event processors: they cant be mocked or spied on in MUnit tests. Instead, make them trivial so that they cant fail</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Functional Monitors:</strong></p>
<div class="ulist">
<ul>
<li>
<p>To be implemented in code and checked in underneath src/test/funmon for each environment the Mule app is deployed to</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Reconnection strategies:</strong></p>
<div class="ulist">
<ul>
<li>
<p>All global configurations for connectors that are likely to pool or cache connections (Database Connector, JMS Connector, etc.) should define a modest, finite reconnection strategy, such as reconnect 3 times with 1 second intervals. This then applies by default to all operations using this connector config and blocks the operation until completed</p>
<div class="ulist">
<ul>
<li>
<p>No other global connector configurations should define a reconnection strategy</p>
</li>
<li>
<p>Most connector operations require retry logic using Until Successful scope and Try scope, irrespective of any reconnection strategy</p>
</li>
</ul>
</div>
</li>
<li>
<p>All listeners should define &lt;reconnect-forever /&gt; with a realistic interval locally to the listener itself, thereby overriding any globally defined reconnection strategy</p>
<div class="ulist">
<ul>
<li>
<p>The only exception is listeners that cannot realistically re-establish connectivity once lost, such as &lt;http:listener /&gt;</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>General:</strong></p>
<div class="ulist">
<ul>
<li>
<p>Avoid absolute file system paths in Mule apps if at all possible; most often, a relative path suffices</p>
<div class="ulist">
<ul>
<li>
<p>Relative paths do not work for the sslrootcert in the PostgreSQL JDBC URL</p>
</li>
</ul>
</div>
</li>
<li>
<p>Reconnection strategies: Do not fail deployment when backend systems are down, and dont retry forever as this blocks requests when the backend system is down</p>
</li>
<li>
<p>Use Choice router for content-based routing, not to validate dynamic data</p>
</li>
<li>
<p>Use the Validation module validators to validate dynamic data and specifically to enforce invariants, preconditions, postconditions, assertions, expected service responses, and the like</p>
<div class="ulist">
<ul>
<li>
<p>Raise descriptive custom application errors from within the validators (by error mapping all errors to such a custom error)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cloudhub_deployments"><a class="anchor" href="#_cloudhub_deployments"></a><a class="link" href="#_cloudhub_deployments">A.4. CloudHub deployments</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>CloudHub deployment names:</strong></p>
<div class="ulist">
<ul>
<li>
<p>tngaa-flights-management-sapi-dev for a Mule app called flights-management-sapi deployed to the dev environment</p>
</li>
<li>
<p>tngaa-flights-management-sapi for the same Mule app deployed to the prod environment</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_api_manager"><a class="anchor" href="#_api_manager"></a><a class="link" href="#_api_manager">A.5. API Manager</a></h3>
<div class="ulist">
<ul>
<li>
<p>Use <strong>automated policies</strong> as much as possible, instead of repetitively defining the same policies on every API instance</p>
</li>
<li>
<p>Set the <strong>consumer endpoint</strong> of every API instance to the correct endpoint URL of the CloudHub deployment of the API implementation in that environment: <a href="https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/v1" class="bare">https://tngaa-flights-management-sapi-dev-9yj2rh.rajrd4-2.usa-e1.cloudhub.io/api/v1</a> for Flights Management SAPI in dev environment</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_functional_monitors"><a class="anchor" href="#_functional_monitors"></a><a class="link" href="#_functional_monitors">A.6. Functional Monitors</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Functional Monitors names</strong> and <strong>asset IDs</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>flights-management-sapi-dev-funmon for flights-management-sapi in dev</p>
</li>
<li>
<p>flights-management-sapi-prod-funmon for the same Mule app in prod (which exposes its API on <a href="https://tngaa-flights-management-sapi-zkvtif.rajrd4-1.usa-e1.cloudhub.io/api/v1" class="bare">https://tngaa-flights-management-sapi-zkvtif.rajrd4-1.usa-e1.cloudhub.io/api/v1</a>)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Functional Monitors must execute in a <strong>different CloudHub/AWS region</strong> than the Mule app they are monitoring is deployed to: usa-e2 (Ohio) if Mule app runs in usa-e1 (N. Virginia)</p>
</li>
<li>
<p>Report violations by posting to appropriate <strong>Slack channel</strong> via webhook</p>
</li>
<li>
<p>For any Mule app that supports it, Functional Monitors should invoke the <strong>liveness and readiness endpoints</strong> exposed by that Mule app</p>
</li>
<li>
<p>For Experience APIs, Functional Monitors should also invoke a real, read-only business transaction that exercises as many nodes in the application network as possible</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_anypoint_mq"><a class="anchor" href="#_anypoint_mq"></a><a class="link" href="#_anypoint_mq">A.7. Anypoint MQ</a></h3>
<div class="ulist">
<ul>
<li>
<p>Consider <strong>encrypting</strong> messages in prod but not in dev and test</p>
</li>
<li>
<p>Every "normal" Anypoint MQ queue should be associated with a <strong>Dead Letter Queue</strong>, the TTL of which should be as long as possible (currently 14 days)</p>
</li>
<li>
<p><strong>Anypoint MQ exchange names:</strong></p>
<div class="ulist">
<ul>
<li>
<p>cancelled-flights-exchg-dev for an Anypoint MQ exchange in the dev environment</p>
</li>
<li>
<p>cancelled-flights-exchg for the equivalent Anypoint MQ exchange in the prod environment</p>
<div class="ulist">
<ul>
<li>
<p>Note that technically the same name could be used in all environments</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Anypoint MQ queue and corresponding Dead Letter Queue names:</strong></p>
<div class="ulist">
<ul>
<li>
<p>cancelled-flights-mobile-queue-dev for an Anypoint MQ queue in dev</p>
</li>
<li>
<p>cancelled-flights-mobile-queue for the equivalent Anypoint MQ queue in prod</p>
<div class="ulist">
<ul>
<li>
<p>Note that technically the same name could be used in all environments</p>
</li>
</ul>
</div>
</li>
<li>
<p>cancelled-flights-mobile-dlq for the Dead Letter Queue belonging to cancelled-flights-mobile-queue (and therefore in prod)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-bibliography"><a class="anchor" href="#module-bibliography"></a><a class="link" href="#module-bibliography">Bibliography</a></h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="Ref1"></a>[Ref1] MuleSoft, "Mule Runtime", <a href="https://docs.mulesoft.com/mule-runtime" class="bare">https://docs.mulesoft.com/mule-runtime</a>. 2019.</p>
</li>
<li>
<p><a id="Ref2"></a>[Ref2] MuleSoft, "Design Center", <a href="https://docs.mulesoft.com/design-center" class="bare">https://docs.mulesoft.com/design-center</a>. 2019.</p>
</li>
<li>
<p><a id="Ref3"></a>[Ref3] MuleSoft, "API Manager", <a href="https://docs.mulesoft.com/api-manager" class="bare">https://docs.mulesoft.com/api-manager</a>. 2019.</p>
</li>
<li>
<p><a id="Ref4"></a>[Ref4] MuleSoft, "Anypoint Exchange", <a href="https://docs.mulesoft.com/exchange" class="bare">https://docs.mulesoft.com/exchange</a>. 2019.</p>
</li>
<li>
<p><a id="Ref5"></a>[Ref5] MuleSoft, "Runtime Manager", <a href="https://docs.mulesoft.com/runtime-manager" class="bare">https://docs.mulesoft.com/runtime-manager</a>. 2019.</p>
</li>
<li>
<p><a id="Ref6"></a>[Ref6] MuleSoft, "Access Management", <a href="https://docs.mulesoft.com/access-management" class="bare">https://docs.mulesoft.com/access-management</a>. 2019.</p>
</li>
<li>
<p><a id="Ref7"></a>[Ref7] MuleSoft, "Anypoint Monitoring", <a href="https://docs.mulesoft.com/monitoring" class="bare">https://docs.mulesoft.com/monitoring</a>. 2019.</p>
</li>
<li>
<p><a id="Ref8"></a>[Ref8] MuleSoft, "Anypoint MQ", <a href="https://docs.mulesoft.com/mq" class="bare">https://docs.mulesoft.com/mq</a>. 2019.</p>
</li>
<li>
<p><a id="Ref9"></a>[Ref9] MuleSoft, "Anypoint Studio", <a href="https://docs.mulesoft.com/studio" class="bare">https://docs.mulesoft.com/studio</a>, 2019.</p>
</li>
<li>
<p><a id="Ref10"></a>[Ref10] MuleSoft, "MUnit", <a href="https://docs.mulesoft.com/munit" class="bare">https://docs.mulesoft.com/munit</a>, 2019.</p>
</li>
<li>
<p><a id="Ref11"></a>[Ref11] MuleSoft, "API Functional Monitoring", <a href="https://docs.mulesoft.com/api-functional-monitoring" class="bare">https://docs.mulesoft.com/api-functional-monitoring</a>, 2019.</p>
</li>
<li>
<p><a id="Ref12"></a>[Ref12] MuleSoft, "APIkit", <a href="https://docs.mulesoft.com/apikit" class="bare">https://docs.mulesoft.com/apikit</a>, 2019.</p>
</li>
<li>
<p><a id="Ref13"></a>[Ref13] MuleSoft, "Object Store v2", <a href="https://docs.mulesoft.com/object-store" class="bare">https://docs.mulesoft.com/object-store</a>, 2019.</p>
</li>
<li>
<p><a id="Ref14"></a>[Ref14] Wikipedia, "Monorepo", <a href="https://en.wikipedia.org/wiki/Monorepo" class="bare">https://en.wikipedia.org/wiki/Monorepo</a>, 2020.</p>
</li>
<li>
<p><a id="Ref15"></a>[Ref15] M.T. Nygard, <em>Release It! Second Edition</em>. Raleigh, NC: Pragmatic Bookshelf, 2018.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="module-colophon"><a class="anchor" href="#module-colophon"></a><a class="link" href="#module-colophon">Version history</a></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-05-17</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.4.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">replace REST connectors with HTTP connector;API Manager CH2 support;upgraded dependencies;minor bug fixes;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-11-23</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.3.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;Minor bug fixes;DIYs;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-10-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.2.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.14.0;Minor bug fixes;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-09-07</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.0.1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">Minor bug fixes and studentFiles use flat RAMLs;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-08-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">4.0.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">CloudHub 2.0 Overhaul;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-08-04</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.3.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.13.0;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-06-27</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.2.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;bump MMP and update for version 3.6.3+ as no longer needs build parameter -DskipASTValidations;added back all wt and module numbering;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-05-20</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.1.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.12.1;Bump MMP and update for version 3.6.0+ to include an additional build parameter -DskipASTValidations;Removed steps where student logs in to AA org, this is due to upcoming MFA. Any client creds required are now directly provided in the manual;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-05-04</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">3.0.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">removed all numbering from walkthroughs and modules except for student file solutions;upgraded dependencies;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-03-31</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.4.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies including Studio.7.12;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-03-09</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.3.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies;Exchange Lifecycle support for SNAPSHOT dependencies;Update doc since fixed issue: MULE-19915: Redelivery Policy: infinite loop when the redelivery is exhausted in a source configured with transactions in <a href="#wt-begin-221">walkthrough 2-1</a>; Update doc as Windows does not support relative path in -DoutputDirectory arg for arechetype in <a href="#wt-begin-261">walkthrough 6-1</a>;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2022-01-10</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.2.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies incl. Studio 7.11.1, app.runtime and munit post Log4j resolutions;parent-pom.xml refactored to correct pom.xml naming convention contained in its own directory parent-pom/pom.xml;bom.xml refactored to correct pom.xml naming convention contained in its own directory bom/pom.xml;editorial updates so the courses work for self-paced without instructor demos;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-10-05</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2.0.0</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies, incl. Studio 7.11.0; Added Mule 4.4 tracing module and With Correlation ID scope section to <a href="#wt-begin-242">walkthrough 4-2</a>; Removed json-logger from all walkthroughs including json logger policy is a standard logger policy in <a href="#wt-begin-262">walkthrough 6-2</a>; Added Exchange V3 and deployment of apps-commons and parent POMs to <a href="#wt-begin-211">walkthrough 1-1</a> and deployment of module-resilience.xml in <a href="#wt-begin-261">walkthrough 6-1</a>; Switch to use Connected Apps instead of credentials in <a href="#wt-begin-211">walkthrough 1-1</a>, <a href="#wt-begin-261">walkthrough 6-1</a> and <a href="#wt-begin-262">walkthrough 6-2</a>;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-08-03</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.9.1</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">fixed student files</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-07-30</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.9</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">explained downgrade of maven-deploy-plugin in <a href="#apply-online-policy">walkthrough 6-2</a>; added project/app name to all code snippets; upgraded dependencies, incl. Studio 7.10.0</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-04-29</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.8</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">upgraded dependencies, incl. Studio 7.9.0, improved DW expression to extract SGR routes in <a href="#wt-begin-241">walkthrough 4-1</a>, introduced choice router in <a href="#wt-begin-223">walkthrough 2-3</a> and boolean var for FMSSAPI validation failures in in <a href="#wt-begin-223">walkthrough 2-2</a> to filter invalid messages and stop AMQ publishing</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">2021-03-29</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">1.7</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small">initial public release</span></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>